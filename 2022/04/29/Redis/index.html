<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Helvetica:300,300italic,400,400italic,700,700italic%7CMenlo:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ssssv11.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://ssssv11.github.io/2022/04/29/Redis/index.html">
<meta property="og:site_name" content="Ssssv">
<meta property="og:description" content="Redis">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/98160f6c57976b8fce706c0da5031070.jpg">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/v2-3036a75a8358d30a8433786839a497e9_720w.jpg">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/v2-05967df1adcf64a26f0edfe54d879b5f_720w.jpg">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/QQ20220418161747.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/79246ba78da4898308a7ca3d0a80c674.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/QQ20220418164219.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/1614350-20201107154043136-1912792479.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/pubsub1.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/pubsub2.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/aHR0cHM6Ly9xaW5pdS5nYW9iaW56aGFuLmNvbS8yMDIwLzA2LzAzLzczNTFiMzg5NTRhYjkucG5n.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/aHR0cHM6Ly9xaW5pdS5nYW9iaW56aGFuLmNvbS8yMDIwLzA2LzA0LzY1YjBlNzYzZjRmZDIucG5n.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/33e280b274e04fb2214335b8438991e7.jpg">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/QQ20220418185141.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/5afd7713f9a97615dc3a0b1d3bc7db27.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/QQ20220418194935.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/1614350-20201209082514905-1720451943.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/QQ20220418195434.png">
<meta property="og:image" content="https://s1.imagehub.cc/images/2022/04/18/QQ20220418195601.png">
<meta property="article:published_time" content="2022-04-29T13:48:42.463Z">
<meta property="article:modified_time" content="2022-04-29T13:48:46.892Z">
<meta property="article:author" content="Ssssv11">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.imagehub.cc/images/2022/04/18/98160f6c57976b8fce706c0da5031070.jpg">


<link rel="canonical" href="https://ssssv11.github.io/2022/04/29/Redis/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>Redis | Ssssv</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ssssv</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">24</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">41</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.</span> <span class="nav-text">Redis数据库</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NoSQL%E6%A6%82%E8%AE%BA"><span class="nav-number">2.</span> <span class="nav-text">NoSQL概论</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis"><span class="nav-number">3.</span> <span class="nav-text">使用Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Redis"><span class="nav-number">3.1.</span> <span class="nav-text">安装Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AERedis"><span class="nav-number">3.2.</span> <span class="nav-text">配置Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Redis"><span class="nav-number">3.3.</span> <span class="nav-text">测试Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">3.3.1.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0"><span class="nav-number">3.3.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.3.3.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">4.</span> <span class="nav-text">Redis基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">4.1.</span> <span class="nav-text">切换数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%A7%E5%B0%8F"><span class="nav-number">4.2.</span> <span class="nav-text">查看数据库大小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Set%E4%B8%8EGet"><span class="nav-number">4.3.</span> <span class="nav-text">Set与Get</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E9%94%AE"><span class="nav-number">4.4.</span> <span class="nav-text">删除键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%94%AE"><span class="nav-number">4.5.</span> <span class="nav-text">修改键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E9%94%AE%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">4.6.</span> <span class="nav-text">判断键是否存在</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%89%80%E6%9C%89%E7%9A%84%E9%94%AE"><span class="nav-number">4.7.</span> <span class="nav-text">查看数据库中所有的键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%85%E7%A9%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">4.8.</span> <span class="nav-text">清空数据库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8%E9%94%AE"><span class="nav-number">4.9.</span> <span class="nav-text">移动键</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E9%94%AE%E7%9A%84%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="nav-number">4.10.</span> <span class="nav-text">设置键的过期时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%94%AE%E6%89%80%E5%AD%98%E5%80%BC%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.11.</span> <span class="nav-text">获取键所存值的类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">5.</span> <span class="nav-text">Redis数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#String"><span class="nav-number">5.1.</span> <span class="nav-text">String</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%BD%E5%8A%A0"><span class="nav-number">5.1.1.</span> <span class="nav-text">追加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%A2%9E%E8%87%AA%E5%87%8F"><span class="nav-number">5.1.2.</span> <span class="nav-text">自增自减</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6"><span class="nav-number">5.1.3.</span> <span class="nav-text">获取字符串长度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%AA%E5%8F%96"><span class="nav-number">5.1.4.</span> <span class="nav-text">截取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2"><span class="nav-number">5.1.5.</span> <span class="nav-text">替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setex-%E4%B8%8E-setnx"><span class="nav-number">5.1.6.</span> <span class="nav-text">setex 与 setnx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-%E5%AF%B9%E8%B1%A1"><span class="nav-number">5.1.7.</span> <span class="nav-text">set 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getset"><span class="nav-number">5.1.8.</span> <span class="nav-text">getset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">5.1.9.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#List"><span class="nav-number">5.2.</span> <span class="nav-text">List</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Push"><span class="nav-number">5.2.1.</span> <span class="nav-text">Push</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pop"><span class="nav-number">5.2.2.</span> <span class="nav-text">pop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9F%90%E5%A4%84%E7%9A%84%E5%80%BC"><span class="nav-number">5.2.3.</span> <span class="nav-text">获取某处的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%9F%90%E5%A4%84%E7%9A%84%E5%80%BC"><span class="nav-number">5.2.4.</span> <span class="nav-text">删除某处的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E5%89%AA"><span class="nav-number">5.2.5.</span> <span class="nav-text">修剪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E6%8C%87%E5%AE%9A%E5%85%83%E7%B4%A0%E5%89%8D-x2F-%E5%90%8E%E6%8F%92%E5%85%A5"><span class="nav-number">5.2.6.</span> <span class="nav-text">向指定元素前&#x2F;后插入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96List%E9%95%BF%E5%BA%A6"><span class="nav-number">5.2.7.</span> <span class="nav-text">获取List长度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%ADList%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%AA%E5%85%83%E7%B4%A0"><span class="nav-number">5.2.8.</span> <span class="nav-text">判断List中是否存在某个元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0List%E4%B8%AD%E7%9A%84%E5%80%BC"><span class="nav-number">5.2.9.</span> <span class="nav-text">更新List中的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97"><span class="nav-number">5.2.10.</span> <span class="nav-text">阻塞队列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E6%8C%87%E4%BB%A4"><span class="nav-number">5.2.11.</span> <span class="nav-text">组合指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-1"><span class="nav-number">5.2.12.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Set"><span class="nav-number">5.3.</span> <span class="nav-text">Set</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0"><span class="nav-number">5.3.1.</span> <span class="nav-text">添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96"><span class="nav-number">5.3.2.</span> <span class="nav-text">获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%ADset%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%AA%E6%88%90%E5%91%98"><span class="nav-number">5.3.3.</span> <span class="nav-text">判断set中是否存在某个成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96set%E4%B8%AD%E6%88%90%E5%91%98%E6%95%B0"><span class="nav-number">5.3.4.</span> <span class="nav-text">获取set中成员数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">5.3.5.</span> <span class="nav-text">删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%BB%E5%8A%A8"><span class="nav-number">5.3.6.</span> <span class="nav-text">移动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set%E7%9A%84%E8%BF%90%E7%AE%97"><span class="nav-number">5.3.7.</span> <span class="nav-text">set的运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-2"><span class="nav-number">5.3.8.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sorted-Set"><span class="nav-number">5.4.</span> <span class="nav-text">Sorted Set</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-1"><span class="nav-number">5.4.1.</span> <span class="nav-text">添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">5.4.2.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4-1"><span class="nav-number">5.4.3.</span> <span class="nav-text">删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96set%E4%B8%AD%E6%88%90%E5%91%98%E6%95%B0-1"><span class="nav-number">5.4.4.</span> <span class="nav-text">获取set中成员数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-3"><span class="nav-number">5.4.5.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hash"><span class="nav-number">5.5.</span> <span class="nav-text">Hash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#set%E4%B8%8Eget"><span class="nav-number">5.5.1.</span> <span class="nav-text">set与get</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4-2"><span class="nav-number">5.5.2.</span> <span class="nav-text">删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Hash%E7%9A%84%E9%95%BF%E5%BA%A6"><span class="nav-number">5.5.3.</span> <span class="nav-text">获取Hash的长度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A4%E6%96%ADHash%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E6%9F%90%E4%B8%AA%E9%94%AE"><span class="nav-number">5.5.4.</span> <span class="nav-text">判断Hash中是否存在某个键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E9%94%AE-x2F-%E5%80%BC"><span class="nav-number">5.5.5.</span> <span class="nav-text">获取所有键&#x2F;值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%A2%9E%E8%87%AA%E5%87%8F-1"><span class="nav-number">5.5.6.</span> <span class="nav-text">自增自减</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-4"><span class="nav-number">5.5.7.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Geospatial"><span class="nav-number">5.6.</span> <span class="nav-text">Geospatial</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GEOADD"><span class="nav-number">5.6.1.</span> <span class="nav-text">GEOADD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEOPOS"><span class="nav-number">5.6.2.</span> <span class="nav-text">GEOPOS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEODIST"><span class="nav-number">5.6.3.</span> <span class="nav-text">GEODIST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEORADIUSBYMEMBER"><span class="nav-number">5.6.4.</span> <span class="nav-text">GEORADIUSBYMEMBER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEORADIUS"><span class="nav-number">5.6.5.</span> <span class="nav-text">GEORADIUS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEOHASH"><span class="nav-number">5.6.6.</span> <span class="nav-text">GEOHASH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEOSEARCH"><span class="nav-number">5.6.7.</span> <span class="nav-text">GEOSEARCH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEOSEARCHSTORE"><span class="nav-number">5.6.8.</span> <span class="nav-text">GEOSEARCHSTORE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E4%B8%8E%E5%88%A0%E9%99%A4"><span class="nav-number">5.6.9.</span> <span class="nav-text">查询与删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hyperloglog"><span class="nav-number">5.7.</span> <span class="nav-text">Hyperloglog</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%95%B0"><span class="nav-number">5.7.1.</span> <span class="nav-text">基数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-2"><span class="nav-number">5.7.2.</span> <span class="nav-text">添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%88%E5%B9%B6"><span class="nav-number">5.7.3.</span> <span class="nav-text">合并</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-5"><span class="nav-number">5.7.4.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Bitmap"><span class="nav-number">5.8.</span> <span class="nav-text">Bitmap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-3"><span class="nav-number">5.8.1.</span> <span class="nav-text">添加</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-1"><span class="nav-number">5.8.2.</span> <span class="nav-text">获取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1"><span class="nav-number">5.8.3.</span> <span class="nav-text">统计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E7%AE%97"><span class="nav-number">5.8.4.</span> <span class="nav-text">运算</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97Bitmaps%E7%9A%84%E4%BA%A4%E9%9B%86%E7%9A%84%E6%95%B0%E9%87%8F"><span class="nav-number">5.8.4.1.</span> <span class="nav-text">计算Bitmaps的交集的数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97Bitmaps%E7%9A%84%E5%B9%B6%E9%9B%86%E7%9A%84%E6%95%B0%E9%87%8F"><span class="nav-number">5.8.4.2.</span> <span class="nav-text">计算Bitmaps的并集的数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97Bitmaps%E7%9A%84%E9%9D%9E%E9%9B%86%E7%9A%84%E6%95%B0%E9%87%8F"><span class="nav-number">5.8.4.3.</span> <span class="nav-text">计算Bitmaps的非集的数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97Bitmaps%E7%9A%84%E5%BC%82%E6%88%96%E9%9B%86%E7%9A%84%E6%95%B0%E9%87%8F"><span class="nav-number">5.8.4.4.</span> <span class="nav-text">计算Bitmaps的异或集的数量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97Bitmaps%E4%B8%AD%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%80%BC%E4%B8%BAtargetBit%E7%9A%84%E5%81%8F%E7%A7%BB%E9%87%8F"><span class="nav-number">5.8.4.5.</span> <span class="nav-text">计算Bitmaps中第一个值为targetBit的偏移量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-6"><span class="nav-number">5.8.5.</span> <span class="nav-text">使用场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1"><span class="nav-number">6.</span> <span class="nav-text">事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">6.0.1.</span> <span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">6.0.2.</span> <span class="nav-text">乐观锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Jedis"><span class="nav-number">7.</span> <span class="nav-text">Jedis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-1"><span class="nav-number">7.1.</span> <span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1-1"><span class="nav-number">7.2.</span> <span class="nav-text">事务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88"><span class="nav-number">8.</span> <span class="nav-text">SpringBoot整合</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">8.1.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89RedisTemplate"><span class="nav-number">8.2.</span> <span class="nav-text">自定义RedisTemplate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RedisUtils"><span class="nav-number">8.3.</span> <span class="nav-text">RedisUtils</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis-conf"><span class="nav-number">9.</span> <span class="nav-text">Redis.conf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NETWORK"><span class="nav-number">9.1.</span> <span class="nav-text">NETWORK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GENERAL"><span class="nav-number">9.2.</span> <span class="nav-text">GENERAL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SNAPSHOTTING"><span class="nav-number">9.3.</span> <span class="nav-text">SNAPSHOTTING</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#REPLICATION"><span class="nav-number">9.4.</span> <span class="nav-text">REPLICATION</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SECURITY"><span class="nav-number">9.5.</span> <span class="nav-text">SECURITY</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CLIENTS"><span class="nav-number">9.6.</span> <span class="nav-text">CLIENTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MEMORY-MANAGEMENT"><span class="nav-number">9.7.</span> <span class="nav-text">MEMORY MANAGEMENT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APPEND-ONLY-MODE"><span class="nav-number">9.8.</span> <span class="nav-text">APPEND ONLY MODE</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">10.</span> <span class="nav-text">持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RDB-Redis-DataBase"><span class="nav-number">10.1.</span> <span class="nav-text">RDB(Redis DataBase)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sava-%E8%A7%A6%E5%8F%91"><span class="nav-number">10.1.1.</span> <span class="nav-text">sava 触发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bgsave-%E8%A7%A6%E5%8F%91"><span class="nav-number">10.1.2.</span> <span class="nav-text">bgsave 触发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6"><span class="nav-number">10.1.3.</span> <span class="nav-text">自动触发机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D"><span class="nav-number">10.1.4.</span> <span class="nav-text">文件恢复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AOF-Append-Only-File"><span class="nav-number">10.2.</span> <span class="nav-text">AOF(Append Only File)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF-%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">10.2.1.</span> <span class="nav-text">AOF 实现方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF-%E9%87%8D%E5%86%99%E6%9C%BA%E5%88%B6"><span class="nav-number">10.2.2.</span> <span class="nav-text">AOF 重写机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF-%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D"><span class="nav-number">10.2.3.</span> <span class="nav-text">AOF 文件恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8DAOF%E6%96%87%E4%BB%B6"><span class="nav-number">10.2.4.</span> <span class="nav-text">修复AOF文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">10.3.</span> <span class="nav-text">混合持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E5%BC%8F"><span class="nav-number">10.3.1.</span> <span class="nav-text">持久化方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D-1"><span class="nav-number">10.3.2.</span> <span class="nav-text">文件恢复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">10.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="nav-number">11.</span> <span class="nav-text">Redis发布订阅</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="nav-number">11.1.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E5%91%BD%E4%BB%A4"><span class="nav-number">11.2.</span> <span class="nav-text">Redis发布订阅命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">11.3.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-7"><span class="nav-number">11.4.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">12.</span> <span class="nav-text">Redis主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%95%E6%9C%BA%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">12.1.</span> <span class="nav-text">单机的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-number">12.2.</span> <span class="nav-text">主从复制的概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">12.3.</span> <span class="nav-text">主从复制的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">12.4.</span> <span class="nav-text">配置主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E"><span class="nav-number">12.4.1.</span> <span class="nav-text">一主二从</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="nav-number">12.4.2.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6"><span class="nav-number">12.5.</span> <span class="nav-text">复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="nav-number">12.5.1.</span> <span class="nav-text">全量复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="nav-number">12.5.2.</span> <span class="nav-text">增量复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-number">12.6.</span> <span class="nav-text">哨兵模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">12.6.1.</span> <span class="nav-text">概念</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-number">12.7.</span> <span class="nav-text">开启哨兵模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6sentinel-conf"><span class="nav-number">12.7.1.</span> <span class="nav-text">配置文件sentinel.conf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">12.7.2.</span> <span class="nav-text">启动</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%81%9A%E7%BC%93%E5%AD%98"><span class="nav-number">13.</span> <span class="nav-text">使用Redis做缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mybatis%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">13.1.</span> <span class="nav-text">Mybatis二级缓存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E5%A4%A7%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="nav-number">14.</span> <span class="nav-text">三大缓存问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="nav-number">14.1.</span> <span class="nav-text">缓存穿透</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">14.1.1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">14.1.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BA%E6%95%B0%E6%8D%AE%E4%B8%8E%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E6%AF%94%E8%BE%83"><span class="nav-number">14.1.3.</span> <span class="nav-text">缓存空数据与布隆过滤器的比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="nav-number">14.2.</span> <span class="nav-text">缓存击穿</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-1"><span class="nav-number">14.2.1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">14.2.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">14.3.</span> <span class="nav-text">缓存雪崩</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98-2"><span class="nav-number">14.3.1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="nav-number">14.3.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ssssv11"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">Ssssv11</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Ssssv11" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ssssv11" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ssssv11.github.io/2022/04/29/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="Ssssv11">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ssssv">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-04-29 21:48:42 / Modified: 21:48:46" itemprop="dateCreated datePublished" datetime="2022-04-29T21:48:42+08:00">2022-04-29</time>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>Redis</center>



<span id="more"></span>

<h1 id="Redis数据库"><a href="#Redis数据库" class="headerlink" title="Redis数据库"></a>Redis数据库</h1><p>MySQL 数据库是一种传统的关系型数据库，我们可以使用 MySQL 来更好地管理和组织我们的数据。</p>
<p>虽然在小型 Web 应用下，只需要一个 MySQL + Mybatis 自带的缓存系统就可以胜任大部分的数据存储工作。但是 MySQL 的缺点也很明显，它的数据始终是存储在硬盘上的，对于我们的用户信息这种不需要经常发生修改的内容，使用 MySQL 存储确实可以，但是如果是快速更新或是频繁使用的数据，比如微博热搜、双十一秒杀，这些数据不仅要求服务器需要提供更高的响应速度，而且还需要面对短时间内上百万甚至上千万次访问，而 MySQL 的磁盘 IO 读写性能完全不能满足上面的需求，能够满足上述需求的只有内存，因为速度远高于磁盘 IO。</p>
<p>因此，我们需要寻找一种更好的解决方案，来存储上述这类特殊数据，弥补 MySQL 的不足，以应对大数据时代的重重考验。</p>
<br/>

<h1 id="NoSQL概论"><a href="#NoSQL概论" class="headerlink" title="NoSQL概论"></a>NoSQL概论</h1><p>NoSQL 全称是 Not Only SQL（不仅仅是 SQL）它是一种非关系型数据库，相比传统 SQL 关系型数据库：</p>
<ul>
<li>不保证关系数据的 ACID 特性</li>
<li>并不遵循 SQL 标准</li>
<li>消除数据之间关联性</li>
<li>远超传统关系型数据库的性能</li>
<li>非常易于扩展</li>
<li>数据模型更加灵活</li>
<li>高可用</li>
</ul>
<p>NoSQL 数据库分为以下几种：</p>
<ul>
<li><strong>键值存储数据库：</strong>所有的数据都是以键值方式存储的，类似于我们之前学过的 HashMap，使用起来非常简单方便，性能也非常高。</li>
<li><strong>列存储数据库：</strong>这部分数据库通常是用来应对分布式存储的海量数据。键仍然存在，但是它们的特点是指向了多个列。</li>
<li><strong>文档型数据库：</strong>它是以一种特定的文档格式存储数据，比如 JSON 格式，在处理网页等复杂数据时，文档型数据库比传统键值数据库的查询效率更高。</li>
<li><strong>图形数据库：</strong>利用类似于图的数据结构存储数据，结合图相关算法实现高速访问。</li>
</ul>
<p>Redis 数据库就是一个开源的<strong>键值</strong>存储数据库，所有的数据全部存放在内存中，它的性能大大高于磁盘 IO，并且它也可以支持数据持久化，他还支持横向扩展、主从复制等。</p>
<p>实际生产中一般会配合使用 Redis 和 MySQL 以发挥它们各自的优势，取长补短。</p>
<br/>

<h1 id="使用Redis"><a href="#使用Redis" class="headerlink" title="使用Redis"></a>使用Redis</h1><p>Redis 在 Windows 上不受官方支持，因此我们使用 Linux 来学习 Redis 。</p>
<h2 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h2><p><a target="_blank" rel="noopener" href="https://redis.io/docs/getting-started/installation/install-redis-on-linux/">官方网站安装教程</a></p>
<br/>

<h2 id="配置Redis"><a href="#配置Redis" class="headerlink" title="配置Redis"></a>配置Redis</h2><p>安装完成后 Redis 的默认路径为 <code>/usr/local/bin</code></p>
<ol>
<li><strong>备份配置文件</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/bin</span><br><span class="line"><span class="built_in">mkdir</span> myconf</span><br><span class="line"><span class="built_in">cp</span> /opt/redis-6.2.0/redis.conf myconf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>更改配置文件</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br></pre></td></tr></table></figure>

<p>编辑配置文件，确保执行以下更改：</p>
<ul>
<li>将<strong>daemonize</strong>设置为 yes（默认设置为 no）。</li>
<li>将<strong>pidfile</strong>设置为<code>/var/run/redis_6379.pid</code>（根据需要修改端口）。</li>
<li>相应地更改<strong>端口</strong>。在我们的示例中，不需要它，因为默认端口已经是 6379。</li>
<li>设置您喜欢的<strong>日志级别</strong>。</li>
<li>将<strong>日志文件</strong>设置为<code>/var/log/redis_6379.log</code></li>
<li>将<strong>目录</strong>设置为<code>/var/redis/6379</code>（非常重要的一步！）</li>
</ul>
<br/>

<ol start="3">
<li><strong>启动Redis服务器</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server myconf/redis.conf</span><br></pre></td></tr></table></figure>

<br/>

<ol start="4">
<li><strong>启动Redis客户端</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6379</span><br></pre></td></tr></table></figure>

<br/>

<ol start="5">
<li><strong>关闭Redis服务器</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shutdown</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<br/>

<h2 id="测试Redis"><a href="#测试Redis" class="headerlink" title="测试Redis"></a>测试Redis</h2><p>在我们安装的 Redis 中有一个 redis-benchmark 压力测试工具，我们可以使用它来测试 Redis 的性能。Redis 性能测试是通过同时执行多个命令实现的。</p>
<br/>

<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>redis 性能测试的基本命令如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark [<span class="keyword">option</span>] [<span class="keyword">option</span> value]</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：该命令是在 redis 的目录下执行的，而不是 redis 客户端的内部指令。</p>
<br/>

<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><p>redis 性能测试工具可选参数如下所示：</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">描述</th>
<th align="center">默认值</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>-h</strong></td>
<td align="center">指定服务器主机名</td>
<td align="center">127.0.0.1</td>
</tr>
<tr>
<td align="center"><strong>-p</strong></td>
<td align="center">指定服务器端口</td>
<td align="center">6379</td>
</tr>
<tr>
<td align="center"><strong>-s</strong></td>
<td align="center">指定服务器 socket</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>-c</strong></td>
<td align="center">指定并发连接数</td>
<td align="center">50</td>
</tr>
<tr>
<td align="center"><strong>-n</strong></td>
<td align="center">指定请求数</td>
<td align="center">10000</td>
</tr>
<tr>
<td align="center"><strong>-d</strong></td>
<td align="center">以字节的形式指定 SET&#x2F;GET 值的数据大小</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center"><strong>-k</strong></td>
<td align="center">1&#x3D;keep alive 0&#x3D;reconnect</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center"><strong>-r</strong></td>
<td align="center">SET&#x2F;GET&#x2F;INCR 使用随机 key, SADD 使用随机值</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>-P</strong></td>
<td align="center">通过管道传输 <numreq> 请求</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center"><strong>-q</strong></td>
<td align="center">强制退出 redis。仅显示 query&#x2F;sec 值</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>–csv</strong></td>
<td align="center">以 CSV 格式输出</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>-l（小写 L）</strong></td>
<td align="center">生成循环，永久执行测试</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>-t</strong></td>
<td align="center">仅运行以逗号分隔的测试命令列表。</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><strong>-I（大写i）</strong></td>
<td align="center">Idle 模式。仅打开 N 个 idle 连接并等待。</td>
<td align="center"></td>
</tr>
</tbody></table>
<br/>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark -h 127.0.0.1 -p 6379 -t <span class="built_in">set</span>,lpush -n 10000 -q</span><br><span class="line"><span class="comment"># --------</span></span><br><span class="line">SET: 71428.57 requests per second, p50=0.351 msec         </span><br><span class="line">LPUSH: 66666.66 requests per second, p50=0.383 msec</span><br></pre></td></tr></table></figure>

<br/>

<h1 id="Redis基本操作"><a href="#Redis基本操作" class="headerlink" title="Redis基本操作"></a>Redis基本操作</h1><p>在我们之前修改的配置文件中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Set the number of databases. The default database is DB 0, you can select</span></span><br><span class="line"><span class="comment"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span></span><br><span class="line"><span class="comment"># dbid is a number between 0 and &#x27;databases&#x27;-1</span></span><br><span class="line">databases 16</span><br></pre></td></tr></table></figure>

<p>可以看到在 Redis 中内置了 16 个数据库。</p>
<br/>

<h2 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h2><p>根据配置文件提示，可以使用<code>SELECT &lt;dbid&gt;</code>来切换数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SELECT 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt;</span><br></pre></td></tr></table></figure>

<p>默认数据库为第 0 个</p>
<br/>

<h2 id="查看数据库大小"><a href="#查看数据库大小" class="headerlink" title="查看数据库大小"></a>查看数据库大小</h2><p>可以使用<code>DBSIZE</code>来查看当前所使用的数据库的大小：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; DBSIZE</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379[3]&gt; <span class="built_in">set</span> name xiaoA</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; DBSIZE</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[3]&gt; get name</span><br><span class="line"><span class="string">&quot;xiaoA&quot;</span></span><br></pre></td></tr></table></figure>

<p>每个数据库中存的值互不影响：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; SELECT 7</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[7]&gt; DBSIZE</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379[7]&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379[7]&gt; <span class="built_in">set</span> age 20</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="Set与Get"><a href="#Set与Get" class="headerlink" title="Set与Get"></a>Set与Get</h2><p>就像在 SQL 语言中的 <code>INSERT</code> 和 <code>SELECT</code> 一样，<code>SET</code> 和 <code>GET</code> 也是用来存值取值的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> name xiaoA</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line"><span class="string">&quot;xiaoA&quot;</span></span><br></pre></td></tr></table></figure>

<p>还可以使用 <code>mset &lt;key&gt; &lt;value&gt; ...</code> 来一次性设置多个键值对：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; MSET gender male birthday 2001-01-01</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;gender&quot;</span></span><br><span class="line">2) <span class="string">&quot;birthday&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>mget &lt;key1&gt; &lt;key2&gt; ...</code> 来一次性获取多个值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; mget gender birthday</span><br><span class="line">1) <span class="string">&quot;male&quot;</span></span><br><span class="line">2) <span class="string">&quot;2001-01-01&quot;</span></span><br></pre></td></tr></table></figure>

<p>所有存入的数据默认会以<strong>字符串</strong>的形式保存</p>
<br/>

<h2 id="删除键"><a href="#删除键" class="headerlink" title="删除键"></a>删除键</h2><p>可以使用 <code>del &lt;key&gt;</code> 来删除键：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[7]&gt; del name</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[7]&gt; keys *</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="修改键"><a href="#修改键" class="headerlink" title="修改键"></a>修改键</h2><p>可以使用 <code>rename &lt;key&gt; &lt;newkey&gt;</code> 来修改一个键：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; rename user:info:ID:name name</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>renamenx &lt;key&gt; &lt;newkey&gt;</code> 会检查新名字是否存在：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; renamenx name2 name</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379[3]&gt; renamenx name2 name3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;name&quot;</span></span><br><span class="line">2) <span class="string">&quot;name3&quot;</span></span><br><span class="line">127.0.0.1:6379[3]&gt; </span><br></pre></td></tr></table></figure>

<br/>

<h2 id="判断键是否存在"><a href="#判断键是否存在" class="headerlink" title="判断键是否存在"></a>判断键是否存在</h2><p>可以使用 <code>EXISTS &lt;key&gt;</code> 来判断一个键是否存在：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; EXISTS name</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; EXISTS name2</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="查看数据库中所有的键"><a href="#查看数据库中所有的键" class="headerlink" title="查看数据库中所有的键"></a>查看数据库中所有的键</h2><p>可以使用<code>keys *</code>来查看当前数据库中所有的键：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; <span class="built_in">set</span> gender male</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;gender&quot;</span></span><br><span class="line">2) <span class="string">&quot;name&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h2 id="清空数据库"><a href="#清空数据库" class="headerlink" title="清空数据库"></a>清空数据库</h2><p>可以使用<code>flushdb</code>来清空当前数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; KEYS *</span><br><span class="line">(empty array)</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379[3]&gt; SELECT 7</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[7]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;age&quot;</span></span><br></pre></td></tr></table></figure>

<p>使用<code>flushall</code>来清空所有数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[7]&gt; SELECT 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; <span class="built_in">set</span> name xiaoA</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; flushall</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379[3]&gt; SELECT 7</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[7]&gt; keys *</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="移动键"><a href="#移动键" class="headerlink" title="移动键"></a>移动键</h2><p>可以使用 <code>move &lt;key&gt; &lt;dbid&gt;</code> 来将一个键移动到另一个数据库中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[7]&gt; <span class="built_in">set</span> age 20</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[7]&gt; move age 3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[7]&gt; select 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;age&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h2 id="设置键的过期时间"><a href="#设置键的过期时间" class="headerlink" title="设置键的过期时间"></a>设置键的过期时间</h2><p>可以使用 <code>EXPIRE &lt;key&gt; &lt;value&gt;</code> 来为键设置过期时间，可以使用 <code>ttl &lt;key&gt;</code> 来查看距离键过期还剩多少时间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; <span class="built_in">set</span> name xiaoA</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; keys *</span><br><span class="line">1) <span class="string">&quot;name&quot;</span></span><br><span class="line">2) <span class="string">&quot;age&quot;</span></span><br><span class="line">127.0.0.1:6379[3]&gt; get name</span><br><span class="line"><span class="string">&quot;xiaoA&quot;</span></span><br><span class="line">127.0.0.1:6379[3]&gt; EXPIRE name 10</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[3]&gt; ttl name</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379[3]&gt; ttl name</span><br><span class="line">(<span class="built_in">integer</span>) -2</span><br><span class="line">127.0.0.1:6379[3]&gt; get name</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p><strong>当过期时间为 -2 时，则表示该键已过期。</strong></p>
<p>还可以使用 <code>pttl &lt;key&gt;</code> 来显示毫秒，在键未过期时使用 <code>persist &lt;key&gt;</code> 来将该键转换为永久：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; get age</span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br><span class="line">127.0.0.1:6379[3]&gt; EXPIRE age 20</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[3]&gt; ttl age</span><br><span class="line">(<span class="built_in">integer</span>) 15</span><br><span class="line">127.0.0.1:6379[3]&gt; pttl age</span><br><span class="line">(<span class="built_in">integer</span>) 11778</span><br><span class="line">127.0.0.1:6379[3]&gt; PERSIST age</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379[3]&gt; ttl age</span><br><span class="line">(<span class="built_in">integer</span>) -1</span><br><span class="line">127.0.0.1:6379[3]&gt; get age</span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>当过期时间显示 -1 时，则表示该键为永久的。</strong></p>
<br/>

<h2 id="获取键所存值的类型"><a href="#获取键所存值的类型" class="headerlink" title="获取键所存值的类型"></a>获取键所存值的类型</h2><p>可以使用 <code>type &lt;key&gt;</code> 来获取键所存值的类型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; <span class="built_in">type</span> age</span><br><span class="line">string</span><br></pre></td></tr></table></figure>

<p>对于其他更多的命令请详见官方文档：<a target="_blank" rel="noopener" href="https://redis.io/commands/">Redis Commands</a></p>
<br/>

<h1 id="Redis数据类型"><a href="#Redis数据类型" class="headerlink" title="Redis数据类型"></a>Redis数据类型</h1><blockquote>
<p>Redis is an open source (BSD licensed), in-memory <strong>data structure store</strong> used as a database, cache, message broker, and streaming engine. Redis provides data structures such as <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#strings">strings</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#hashes">hashes</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#lists">lists</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#sets">sets</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#sorted-sets">sorted sets</a> with range queries, <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#bitmaps">bitmaps</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/data-types-intro#hyperloglogs">hyperloglogs</a>, <a target="_blank" rel="noopener" href="https://redis.io/commands/geoadd">geospatial indexes</a>, and <a target="_blank" rel="noopener" href="https://redis.io/topics/streams-intro">streams</a>. Redis has built-in <a target="_blank" rel="noopener" href="https://redis.io/topics/replication">replication</a>, <a target="_blank" rel="noopener" href="https://redis.io/commands/eval">Lua scripting</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/lru-cache">LRU eviction</a>, <a target="_blank" rel="noopener" href="https://redis.io/topics/transactions">transactions</a>, and different levels of <a target="_blank" rel="noopener" href="https://redis.io/topics/persistence">on-disk persistence</a>, and provides high availability via <a target="_blank" rel="noopener" href="https://redis.io/topics/sentinel">Redis Sentinel</a> and automatic partitioning with <a target="_blank" rel="noopener" href="https://redis.io/topics/cluster-tutorial">Redis Cluster</a>.</p>
</blockquote>
<p>Redis 是一个开源（BSD许可）的内存数据结构存储，被用作数据库、缓存、消息代理和流引擎。Redis 提供的数据结构包括：<strong>字符串、哈希值、列表、集合、带范围查询的排序集合、位图、超日志、地理空间索引和流</strong>。Redis有内置的复制、Lua脚本、LRU驱逐、事务和不同级别的磁盘持久性，并通过 Redis Sentinel 和 Redis Cluster 的自动分区提供高可用性。</p>
<br/>

<h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>Redis 字符串数据类型的相关命令用于管理 redis 字符串值</p>
<h3 id="追加"><a href="#追加" class="headerlink" title="追加"></a>追加</h3><p>可以使用 <code>append &lt;key&gt; &lt;value&gt;</code> 来追加字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> key1 hello</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; append key1 <span class="string">&#x27; redis&#x27;</span></span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">&quot;hello redis&quot;</span></span><br></pre></td></tr></table></figure>

<p>当追加的键不存在时，Redis 会新建一个键来存储值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; append key2 hello2</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;key2&quot;</span></span><br><span class="line">2) <span class="string">&quot;key1&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="自增自减"><a href="#自增自减" class="headerlink" title="自增自减"></a>自增自减</h3><p>可以使用 <code>incr &lt;key&gt;</code> 来对数字进行自增 1 的操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; <span class="built_in">set</span> age 20</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; incr age</span><br><span class="line">(<span class="built_in">integer</span>) 21</span><br></pre></td></tr></table></figure>

<p>使用 <code>incrby &lt;key&gt; num</code> 来使该键对应的值进行自增 num 的操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; incrby age 2</span><br><span class="line">(<span class="built_in">integer</span>) 23</span><br></pre></td></tr></table></figure>

<p>使用 <code>decr &lt;key&gt;</code> 来对数字进行自减 1 的操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; decr age</span><br><span class="line">(<span class="built_in">integer</span>) 22</span><br></pre></td></tr></table></figure>

<p>使用 <code>decrby &lt;key&gt; num</code> 来使该键对应的值进行自减 num 的操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379[3]&gt; decrby age 12</span><br><span class="line">(<span class="built_in">integer</span>) 10</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="获取字符串长度"><a href="#获取字符串长度" class="headerlink" title="获取字符串长度"></a>获取字符串长度</h3><p>可以使用 <code>strlen &lt;key&gt;</code> 来获取字符串长度：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; strlen key1</span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="截取"><a href="#截取" class="headerlink" title="截取"></a>截取</h3><p>可以使用 <code>getrange &lt;key&gt; start end</code> 来截取字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getrange key1 0 4</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br></pre></td></tr></table></figure>

<p>要想获取全部字符串，可以将 <code>end</code> 写为 -1 ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getrange key1 0 -1</span><br><span class="line"><span class="string">&quot;hello redis&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h3><p>可以使用 <code>setrange &lt;key&gt; offset value</code> 来从指定位置开始替换字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setrange key2 1 hhello</span><br><span class="line">(<span class="built_in">integer</span>) 7</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line"><span class="string">&quot;hhhello&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="setex-与-setnx"><a href="#setex-与-setnx" class="headerlink" title="setex 与 setnx"></a>setex 与 setnx</h3><p>若想在 set 时就指定过期时间可以使用 <code>setex &lt;key&gt; seconds value	</code> (set with expire):</p>
<p>若想在该 key 不存在时再 set，可以使用<code>setnx &lt;key&gt; value</code> (set if no exists):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setex key3 30 <span class="string">&quot;i&#x27;m key3&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(<span class="built_in">integer</span>) 25</span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line"><span class="string">&quot;i&#x27;m key3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; setnx key3 <span class="string">&quot;i&#x27;m key3 new&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0		<span class="comment"># 创建失败</span></span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(<span class="built_in">integer</span>) -2</span><br><span class="line">127.0.0.1:6379&gt; setnx key3 <span class="string">&quot;i&#x27;m key3 new&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1		<span class="comment"># 创建成功</span></span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line"><span class="string">&quot;i&#x27;m key3 new&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以配合 <code>mset</code> 来使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; msetnx key3 <span class="string">&quot;i&#x27;m new key3 new&quot;</span> key4 <span class="string">&quot;i&#x27;m key4&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; get key4</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p>可以看到尽管 <code>key4</code> 不存在但由于 <code>key3</code> 已经存在了，<code>key4</code> 依然没有设置成功。因此可以看出 <code>msetnx</code> 是一个原子操作，要么一起成功要么一起失败。</p>
<p><strong>因此，<code>setnx</code> 主要在分布式锁中使用</strong></p>
<br/>

<h3 id="set-对象"><a href="#set-对象" class="headerlink" title="set 对象"></a>set 对象</h3><p>还可以使用 Redis 来 set 对象：</p>
<ul>
<li>使用 JSON 字符串保存对象信息：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> user:1 &#123;name:xiaoA,age:20&#125;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;key3&quot;</span></span><br><span class="line">2) <span class="string">&quot;key2&quot;</span></span><br><span class="line">3) <span class="string">&quot;user:1&quot;</span></span><br><span class="line">4) <span class="string">&quot;key1&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>利用 key 的设计保存对象信息：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset user:1:name xiaoB user:1:age 21</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget user:2:name user:2:age</span><br><span class="line">1) <span class="string">&quot;xiaoB&quot;</span></span><br><span class="line">2) <span class="string">&quot;21&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="getset"><a href="#getset" class="headerlink" title="getset"></a>getset</h3><p>可以使用 <code>getset</code> 来先获取值再设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getset key4 value4</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get key4</span><br><span class="line"><span class="string">&quot;value4&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; getset key4 newvalue4</span><br><span class="line"><span class="string">&quot;value4&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get key4</span><br><span class="line"><span class="string">&quot;newvalue4&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>String 类型除了字符串还可以是数字，它主要用于：</p>
<ul>
<li>计数</li>
<li>缓存基础数据</li>
<li>限制请求次数</li>
<li>签到</li>
<li>分布式锁</li>
</ul>
<br/>

<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>Redis 列表是简单的字符串列表，按照插入顺序排序。可以添加一个元素到列表的头部（左边）或者尾部（右边）</p>
<p>一个列表最多可以包含 232 - 1 个元素 (4294967295, 每个列表超过40亿个元素)。</p>
<h3 id="Push"><a href="#Push" class="headerlink" title="Push"></a>Push</h3><p>可以使用 <code>lpush &lt;key&gt; element</code> 或 <code>rpush &lt;key&gt; element</code> 来向 List 中存值：</p>
<ul>
<li><code>lpush</code> 插入到列表头部</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush list1 element1 element2 element3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 -1</span><br><span class="line">1) <span class="string">&quot;element3&quot;</span></span><br><span class="line">2) <span class="string">&quot;element2&quot;</span></span><br><span class="line">3) <span class="string">&quot;element1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list1 0 1</span><br><span class="line">1) <span class="string">&quot;element3&quot;</span></span><br><span class="line">2) <span class="string">&quot;element2&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到在使用 <code>lpush</code> 时，list 类似于栈结构。</p>
<ul>
<li><code>rpush</code> 插入到列表尾部</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush list2 element1 element2 element3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list2 0 -1</span><br><span class="line">1) <span class="string">&quot;element1&quot;</span></span><br><span class="line">2) <span class="string">&quot;element2&quot;</span></span><br><span class="line">3) <span class="string">&quot;element3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list2 0 1</span><br><span class="line">1) <span class="string">&quot;element1&quot;</span></span><br><span class="line">2) <span class="string">&quot;element2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h3><p>可以使用 <code>lpop &lt;key&gt; [count]</code> 或 <code>rpop &lt;key&gt; [count]</code> 来从 List 中取值：</p>
<ul>
<li><code>lpop</code> 弹出 List 中头部的值</li>
<li><code>rpop</code> 弹出 List 中尾部的值</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush list3 lelement1 lelement2 lelement3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush list3 relement1 relement2 relement3</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement3&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">3) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">4) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">5) <span class="string">&quot;relement2&quot;</span></span><br><span class="line">6) <span class="string">&quot;relement3&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lpop list3</span><br><span class="line"><span class="string">&quot;lelement3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpop list3</span><br><span class="line"><span class="string">&quot;relement3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">3) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">4) <span class="string">&quot;relement2&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>pop</code> 也和栈结构的操作相似，弹出后 List 中就不再存储该值。</p>
<br/>

<h3 id="获取某处的值"><a href="#获取某处的值" class="headerlink" title="获取某处的值"></a>获取某处的值</h3><p>可以使用 <code>lindex &lt;key&gt; index</code> 来从 List 中获取下标为 index 处的值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lindex list3 0</span><br><span class="line"><span class="string">&quot;lelement2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lindex list3 3</span><br><span class="line"><span class="string">&quot;relement2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="删除某处的值"><a href="#删除某处的值" class="headerlink" title="删除某处的值"></a>删除某处的值</h3><p>可以使用 <code>lrem &lt;key&gt; [count] element </code> 来移除某处的值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush list3 lelement2</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">3) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">4) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">5) <span class="string">&quot;relement2&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lrem list3 1 lelement2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">3) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">4) <span class="string">&quot;relement2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="修剪"><a href="#修剪" class="headerlink" title="修剪"></a>修剪</h3><p>可以使用 <code>ltrim &lt;key&gt; start stop</code> 来对 List 进行修剪：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ltrim list3 1 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">2) <span class="string">&quot;relement1&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：<code>ltrim</code> 只保留在 <code>start - stop</code> 范围内的值</strong></p>
<br/>

<h3 id="向指定元素前-x2F-后插入"><a href="#向指定元素前-x2F-后插入" class="headerlink" title="向指定元素前&#x2F;后插入"></a>向指定元素前&#x2F;后插入</h3><p>可以使用 <code>linsert &lt;key&gt; before/after &lt;pivot&gt; &lt;element&gt;</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; linsert list3 before relement2 relement1</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">3) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">4) <span class="string">&quot;relement2&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：若 List 中存在相同的两个元素，则向该元素前&#x2F;后插入时，会按前后顺序来插入</strong></p>
<br/>

<h3 id="获取List长度"><a href="#获取List长度" class="headerlink" title="获取List长度"></a>获取List长度</h3><p>可以使用 <code>llen &lt;key&gt;</code> 来获取 List 的长度：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; llen list3</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="判断List中是否存在某个元素"><a href="#判断List中是否存在某个元素" class="headerlink" title="判断List中是否存在某个元素"></a>判断List中是否存在某个元素</h3><p>可以使用 <code>exists &lt;key&gt;</code> 来判断键是否在List中存在：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; exists list4</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; exists list5</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="更新List中的值"><a href="#更新List中的值" class="headerlink" title="更新List中的值"></a>更新List中的值</h3><p>可以使用 <code>lset &lt;key&gt; index element</code> 来对 List 中已存在的值进行更新：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">3) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lset list3 2 relement2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">3) <span class="string">&quot;relement2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h3><p>可以使用 <code>blpop &lt;key&gt;... timeout</code> 来实现阻塞队列：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blpop &lt;key&gt;... <span class="built_in">timeout</span></span><br></pre></td></tr></table></figure>

<p>如果列表中没有元素，那么就等待，如果指定时间（秒）内被添加了数据，那么就执行pop操作，如果超时就作废，支持同时等待多个列表，只要其中一个列表有元素了，那么就能执行</p>
<br/>

<h3 id="组合指令"><a href="#组合指令" class="headerlink" title="组合指令"></a>组合指令</h3><p><code>rpoplpush source destination</code> - 弹出 source 中尾部的元素加入 destination 的头部：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush list3 lelement2</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; rpush list3 relement2</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; rpoplpush list3 list4</span><br><span class="line"><span class="string">&quot;relement2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list3 0 -1</span><br><span class="line">1) <span class="string">&quot;lelement2&quot;</span></span><br><span class="line">2) <span class="string">&quot;lelement1&quot;</span></span><br><span class="line">3) <span class="string">&quot;relement1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list4 0 -1</span><br><span class="line">1) <span class="string">&quot;relement2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><p>从 List 的使用中可以看出它实际上是一个<strong>双向链表</strong>一样的结构，但它也既可以作为队列，也可以作为栈。在对其头部和尾部进行操作时的效率是最高的。它主要用于：</p>
<ul>
<li>消息队列</li>
<li>排行榜</li>
<li>最新列表</li>
</ul>
<br/>

<h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中<strong>不能出现重复的数据。</strong></p>
<p>集合对象的编码可以是 intset 或者 hashtable。</p>
<p>Redis 中集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1)。</p>
<p>集合中最大的成员数为 232 - 1 (4294967295, 每个集合可存储40多亿个成员)。</p>
<h3 id="添加"><a href="#添加" class="headerlink" title="添加"></a>添加</h3><p>可以使用 <code>sadd &lt;key&gt; member</code> 来向 set 中添加成员：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd set1 member1 member2 member3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure>

<p><strong>注意：set 是无序的</strong></p>
<br/>

<h3 id="获取"><a href="#获取" class="headerlink" title="获取"></a>获取</h3><p>可以使用 <code>smembers &lt;key&gt;</code> 来查看 set 中的所有成员：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers set1	</span><br><span class="line">1) <span class="string">&quot;member3&quot;</span></span><br><span class="line">2) <span class="string">&quot;member2&quot;</span></span><br><span class="line">3) <span class="string">&quot;member1&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>srandmember &lt;key&gt; [count]</code> 来随机获取成员：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; srandmember set1</span><br><span class="line"><span class="string">&quot;member1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember set1</span><br><span class="line"><span class="string">&quot;member3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember set1 2</span><br><span class="line">1) <span class="string">&quot;member2&quot;</span></span><br><span class="line">2) <span class="string">&quot;member3&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="判断set中是否存在某个成员"><a href="#判断set中是否存在某个成员" class="headerlink" title="判断set中是否存在某个成员"></a>判断set中是否存在某个成员</h3><p>可以使用 <code>sismember &lt;key&gt; member</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sismember set1 member1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sismember set1 member5</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="获取set中成员数"><a href="#获取set中成员数" class="headerlink" title="获取set中成员数"></a>获取set中成员数</h3><p>可以使用 <code>scard &lt;key&gt;</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scard set1</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>可以使用 <code>srem &lt;key&gt; member</code> 来删除 set 中指定的成员：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; srem set1 member1 member2</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; smembers set1</span><br><span class="line">1) <span class="string">&quot;member3&quot;</span></span><br><span class="line">2) <span class="string">&quot;member4&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>spop &lt;key&gt; [count]</code> 来随机移除 set 中的成员：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd set1 member1 member2</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; spop set1 2</span><br><span class="line">1) <span class="string">&quot;member2&quot;</span></span><br><span class="line">2) <span class="string">&quot;member1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers set1</span><br><span class="line">1) <span class="string">&quot;member3&quot;</span></span><br><span class="line">2) <span class="string">&quot;member4&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="移动"><a href="#移动" class="headerlink" title="移动"></a>移动</h3><p>可以使用 <code>smove &lt;key&gt; source destination member </code> 来移动指定值到另一个集合中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smove set1 set2 member3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers set1</span><br><span class="line">1) <span class="string">&quot;member4&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers set2</span><br><span class="line">1) <span class="string">&quot;member3&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="set的运算"><a href="#set的运算" class="headerlink" title="set的运算"></a>set的运算</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd set2 a b c</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; sadd set3 c d e</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure>

<ul>
<li>并集</li>
</ul>
<p>使用 <code>sunion &lt;key&gt; ...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sunion set2 set3</span><br><span class="line">1) <span class="string">&quot;b&quot;</span></span><br><span class="line">2) <span class="string">&quot;c&quot;</span></span><br><span class="line">3) <span class="string">&quot;a&quot;</span></span><br><span class="line">4) <span class="string">&quot;e&quot;</span></span><br><span class="line">5) <span class="string">&quot;d&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sunion set3 set2</span><br><span class="line">1) <span class="string">&quot;c&quot;</span></span><br><span class="line">2) <span class="string">&quot;e&quot;</span></span><br><span class="line">3) <span class="string">&quot;d&quot;</span></span><br><span class="line">4) <span class="string">&quot;a&quot;</span></span><br><span class="line">5) <span class="string">&quot;b&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>交集</li>
</ul>
<p>使用 <code>sinter &lt;key&gt; ...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sinter set2 set3</span><br><span class="line">1) <span class="string">&quot;c&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sinter set3 set2</span><br><span class="line">1) <span class="string">&quot;c&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>差集</li>
</ul>
<p>使用 <code>sdiff &lt;key&gt; ...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sdiff set2 set3</span><br><span class="line">1) <span class="string">&quot;a&quot;</span></span><br><span class="line">2) <span class="string">&quot;b&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; sdiff set3 set2</span><br><span class="line">1) <span class="string">&quot;d&quot;</span></span><br><span class="line">2) <span class="string">&quot;e&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h3><p>redis set是集合类型的数据结构，那么集合类型就比较适合用于聚合分类：</p>
<ul>
<li><p>标签</p>
</li>
<li><p>共同好友功能，共同喜好，或者可以引申到二度好友之类的扩展应用</p>
</li>
<li><p>统计网站的独立IP</p>
</li>
</ul>
<br/>

<h2 id="Sorted-Set"><a href="#Sorted-Set" class="headerlink" title="Sorted Set"></a>Sorted Set</h2><p>Redis 有序集合和集合一样也是 String 类型元素的集合，且不允许重复的成员。</p>
<p>不同的是每个元素都会关联一个 Double 类型的分数。Redis 正是通过分数来为集合中的成员进行从小到大的排序。</p>
<p>有序集合的成员是唯一的，但分数(score)却可以重复。</p>
<p>集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1)。 集合中最大的成员数为 232 - 1 (4294967295, 每个集合可存储40多亿个成员)。</p>
<h3 id="添加-1"><a href="#添加-1" class="headerlink" title="添加"></a>添加</h3><p>使用 <code>zadd &lt;key&gt; [score member]...</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd key1 1 member1 2 member2 3 member3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange key1 0 -1</span><br><span class="line">1) <span class="string">&quot;member1&quot;</span></span><br><span class="line">2) <span class="string">&quot;member2&quot;</span></span><br><span class="line">3) <span class="string">&quot;member3&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>可以使用 <code>zrangebyscore &lt;key&gt; min max [withscores] [limit offset count]</code>来升序排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd salary 2000 xiaoA 3000 xiaoB 500 xiaoC</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf +inf</span><br><span class="line">1) <span class="string">&quot;xiaoC&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiaoA&quot;</span></span><br><span class="line">3) <span class="string">&quot;xiaoB&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf +inf withscores</span><br><span class="line">1) <span class="string">&quot;xiaoC&quot;</span></span><br><span class="line">2) <span class="string">&quot;500&quot;</span></span><br><span class="line">3) <span class="string">&quot;xiaoA&quot;</span></span><br><span class="line">4) <span class="string">&quot;2000&quot;</span></span><br><span class="line">5) <span class="string">&quot;xiaoB&quot;</span></span><br><span class="line">6) <span class="string">&quot;3000&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>zrevrange &lt;key&gt; start stop [withscores] </code>来降序排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrevrange salary 0 -1</span><br><span class="line">1) <span class="string">&quot;xiaoB&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiaoA&quot;</span></span><br><span class="line">3) <span class="string">&quot;xiaoC&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; zrevrange salary 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;xiaoB&quot;</span></span><br><span class="line">2) <span class="string">&quot;3000&quot;</span></span><br><span class="line">3) <span class="string">&quot;xiaoA&quot;</span></span><br><span class="line">4) <span class="string">&quot;2000&quot;</span></span><br><span class="line">5) <span class="string">&quot;xiaoC&quot;</span></span><br><span class="line">6) <span class="string">&quot;500&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="删除-1"><a href="#删除-1" class="headerlink" title="删除"></a>删除</h3><p>可以使用 <code>zrem &lt;key&gt; [member]...</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrem salary xiaoC</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange salary 0 -1</span><br><span class="line">1) <span class="string">&quot;xiaoA&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiaoB&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="获取set中成员数-1"><a href="#获取set中成员数-1" class="headerlink" title="获取set中成员数"></a>获取set中成员数</h3><p>使用 <code>zcard &lt;key&gt;</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zcard salary</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure>

<p>还可以使用 <code>zcount &lt;key&gt; min max</code> 计算在有序集合中指定区间分数的成员数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zcount salary 1500 2500</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zcount salary 2000 3000</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="使用场景-3"><a href="#使用场景-3" class="headerlink" title="使用场景"></a>使用场景</h3><p>有序集合的使用场景与集合类似，但是set集合不是自动有序的，而sorted set可以利用分数进行成员间的排序，而且是插入时就排序好。所以当你需要一个有序且不重复的集合列表时，就可以选择sorted set数据结构作为选择方案。如：</p>
<ul>
<li>排行榜</li>
<li>带权重的队列</li>
</ul>
<br/>

<h2 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h2><p>Redis hash 是一个 String 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</p>
<p>结构类似于 key-&lt;key-value&gt; 即 key-Map。</p>
<p>Redis 中每个 hash 可以存储 232 - 1 键值对（40多亿）。</p>
<h3 id="set与get"><a href="#set与get" class="headerlink" title="set与get"></a>set与get</h3><p>可以使用 <code>hset &lt;key&gt; field value ...</code> 和 <code>hget &lt;key&gt; field</code> 来存取值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset key1 field1 value1 field2 value2</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; hget key1 field1</span><br><span class="line"><span class="string">&quot;value1&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以使用 <code>hmget field ...</code> 来获取多个值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmget key1 field1 field2</span><br><span class="line">1) <span class="string">&quot;value1&quot;</span></span><br><span class="line">2) <span class="string">&quot;value2&quot;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>hegtall &lt;key&gt;</code> 来获取所有的值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hgetall key1</span><br><span class="line">1) <span class="string">&quot;field1&quot;</span></span><br><span class="line">2) <span class="string">&quot;value1&quot;</span></span><br><span class="line">3) <span class="string">&quot;field2&quot;</span></span><br><span class="line">4) <span class="string">&quot;value2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="删除-2"><a href="#删除-2" class="headerlink" title="删除"></a>删除</h3><p>可以使用 <code>hdel &lt;key&gt; field ...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hdel key1 field1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall key1</span><br><span class="line">1) <span class="string">&quot;field2&quot;</span></span><br><span class="line">2) <span class="string">&quot;value2&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="获取Hash的长度"><a href="#获取Hash的长度" class="headerlink" title="获取Hash的长度"></a>获取Hash的长度</h3><p>可以使用 <code>hlen &lt;key&gt;</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hlen key1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hset key1 field1 value1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hlen key1</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="判断Hash中是否存在某个键"><a href="#判断Hash中是否存在某个键" class="headerlink" title="判断Hash中是否存在某个键"></a>判断Hash中是否存在某个键</h3><p>可以使用 <code>hexists &lt;key&gt; field</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hexists key1 field1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hexists key1 field3</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="获取所有键-x2F-值"><a href="#获取所有键-x2F-值" class="headerlink" title="获取所有键&#x2F;值"></a>获取所有键&#x2F;值</h3><p>使用 <code>hkeys &lt;key&gt;</code> 或 <code>hvals &lt;key&gt;</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hkeys key1</span><br><span class="line">1) <span class="string">&quot;field2&quot;</span></span><br><span class="line">2) <span class="string">&quot;field1&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; hvals key1</span><br><span class="line">1) <span class="string">&quot;value2&quot;</span></span><br><span class="line">2) <span class="string">&quot;value1&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="自增自减-1"><a href="#自增自减-1" class="headerlink" title="自增自减"></a>自增自减</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset key1 field3 10</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<ul>
<li>自增</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hincrby key1 field3 5</span><br><span class="line">(<span class="built_in">integer</span>) 15</span><br></pre></td></tr></table></figure>

<ul>
<li>自减</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hincrby key1 field3 -5</span><br><span class="line">(<span class="built_in">integer</span>) 10</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="使用场景-4"><a href="#使用场景-4" class="headerlink" title="使用场景"></a>使用场景</h3><p>可以看出 Hash 的操作与 String 的操作很相似，但是 Hash 中只能存放字符串值，不允许出现嵌套的的情况。可以用于：</p>
<ul>
<li>购物车</li>
<li>存储对象</li>
</ul>
<br/>

<h2 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h2><p>Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作</p>
<h3 id="GEOADD"><a href="#GEOADD" class="headerlink" title="GEOADD"></a>GEOADD</h3><p>将指定的地理空间项目（经度、纬度、名称）添加到指定的键中。数据以排序集的形式存储到键中，这样就可以用 <code>GEOSEARCH</code> 命令查询这些项目:</p>
<p><code>geoadd key [longitude latitude member]...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.408 39.904 beijing 121.445 31.213 shanghai 104.071 30.67 chengdu 114.109 22.544 shenzhen</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure>

<p><strong>注意：两极无法添加</strong></p>
<ul>
<li>有效经度为 -180 到 180 度</li>
<li>有效纬度为 -85.05112878 到 85.05112878 度</li>
</ul>
<br/>

<h3 id="GEOPOS"><a href="#GEOPOS" class="headerlink" title="GEOPOS"></a>GEOPOS</h3><p>返回由 key 处的排序集代表的地理空间索引的所有指定成员的位置（经度，纬度）:</p>
<p><code>geopos key [member]...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city beijing chengdu</span><br><span class="line">1) 1) <span class="string">&quot;116.40800267457962036&quot;</span></span><br><span class="line">   2) <span class="string">&quot;39.90399988166036138&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;104.07099992036819458&quot;</span></span><br><span class="line">   2) <span class="string">&quot;30.67000055930392222&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="GEODIST"><a href="#GEODIST" class="headerlink" title="GEODIST"></a>GEODIST</h3><p>返回排序集所代表的地理空间索引中两个成员之间的距离。</p>
<p>给出一个代表地理空间索引的排序集，并使用 <code>GEOADD</code> 命令进行填充，该命令返回两个指定成员在指定单位中的距离。</p>
<p>如果缺少一个或两个成员，命令会返回 NULL。</p>
<p>单位:</p>
<ul>
<li>m：米(DEFALUT)</li>
<li>km：公里</li>
<li>mi：英里</li>
<li>ft：英尺</li>
</ul>
<p><code>geodist &lt;key&gt; member1 member2 [m|km|ft|mi]</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:city chengdu shenzhen km</span><br><span class="line"><span class="string">&quot;1345.3491&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="GEORADIUSBYMEMBER"><a href="#GEORADIUSBYMEMBER" class="headerlink" title="GEORADIUSBYMEMBER"></a>GEORADIUSBYMEMBER</h3><p><code>GEORADIUSBYMEMBER</code> 以指定名字的成员的位置用作查询的中心，返回距中心的最大距离（半径）指定的区域的边界内的其他成员。</p>
<p>此命令的常见用例是检索指定点附近不超过给定米数（或其他单位）的地理空间项目。例如，这允许向移动用户推荐附近地点的应用程序，比如附近的餐馆、附近的人等。</p>
<p><code>GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count [ANY]] [ASC|DESC] [STORE key] [STOREDIST key]</code></p>
<p>返回距离成都不超过 20km 的最近的一个点位（这里的COUNT 后面的数字是2，因为ASC不会排除自身）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEORADIUSBYMEMBER china:city chengdu 20 km count 2 asc withdist</span><br><span class="line">1) 1) <span class="string">&quot;chengdu&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;erxianqiao&quot;</span></span><br><span class="line">   2) <span class="string">&quot;9.7865&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，3km 以内的距离成都最近的点位是二仙桥，它们距离约 9786.5m</p>
<br/>

<h3 id="GEORADIUS"><a href="#GEORADIUS" class="headerlink" title="GEORADIUS"></a>GEORADIUS</h3><p>该命令与 <code>GEORADIUSBYMEMBER</code> 完全相同，唯一不同的是，它不以 Sorted Set 表示的地理空间索引中已存在的成员的名称作为要查询的区域的中心，而是以指定的经纬度值作为查询区域中心。</p>
<p>在使用 <code>GEORADIUS</code> 时，只需要将点位的名字改为经纬度值即可。</p>
<p><code>GEORADIUS key longitude latitude radius M | KM | FT | MI [WITHCOORD] [WITHDIST] [WITHHASH] [ COUNT count [ANY]] [ ASC | DESC] [STORE key] [STOREDIST key]</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 104 30 20 km</span><br><span class="line">1) <span class="string">&quot;chenghuadadao&quot;</span></span><br><span class="line">2) <span class="string">&quot;jinjiang&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 104 30 20 km count 1 asc withdist</span><br><span class="line">1) 1) <span class="string">&quot;chenghuadadao&quot;</span></span><br><span class="line">   2) <span class="string">&quot;12.2868&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>在 Redis 6.2.0的版本中，GEORADIUS 命令系列被视为已弃用，在新代码中优先选择 GEOSEARCH 和 GEOSEARCHSTORE。</strong></p>
<br/>

<h3 id="GEOHASH"><a href="#GEOHASH" class="headerlink" title="GEOHASH"></a>GEOHASH</h3><p>返回有效的 Geohash 字符串，表示一个或多个元素在表示地理空间索引的Sortedset中的位置（其中元素是使用 GEOADD 添加的）。</p>
<p>通常 Redis 使用 Geohash 技术的变体来表示元素的位置，其中位置使用 52 位无符号二进制整数进行编码。与标准相比，编码也不同，因为在编码和解码过程中使用的初始最小和最大坐标不同。</p>
<p><strong>我们获取到某个坐标的hash值之后，就能直接去<a target="_blank" rel="noopener" href="http://geohash.org/$%7Bhash%7D%E7%BD%91%E7%AB%99%E5%AE%9A%E4%BD%8D%E5%AE%83%E3%80%82">http://geohash.org/${hash}网站定位它。</a></strong></p>
<p><code>GEOHASH key member [member ...]</code></p>
<p>获取二仙桥坐标的 hash：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOHASH china:city erxianqiao</span><br><span class="line">1) <span class="string">&quot;wm3yyu113r0&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="GEOSEARCH"><a href="#GEOSEARCH" class="headerlink" title="GEOSEARCH"></a>GEOSEARCH</h3><p>返回使用 <code>GEOADD</code> 填充的地理空间信息的排序集的成员，这些成员在给定形状指定的区域边界内。该命令扩展了 <code>GEORADIUS</code> 命令，因此除了在圆形区域内搜索外，它还支持在矩形区域内搜索。</p>
<p><strong>应使用此命令代替已弃用的 <code>GEORADIUS</code> 和 <code>GEORADIUSBYMEMBER</code> 命令。</strong></p>
<p>查询的中心点:</p>
<ul>
<li><code>FROMMEMBER</code>：使用给定的现有 <code>&lt;member&gt;</code> 在排序集中的位置。</li>
<li><code>FROMLONLAT</code>：使用给定的 <code>&lt;longitude&gt;</code> 和 <code>&lt;latitude&gt;</code> 位置。</li>
</ul>
<p>查询的形状:</p>
<ul>
<li><code>BYRADIUS</code>：与GEORADIUS类似，根据给定的 <code>&lt;radius&gt;</code> 在圆形区域内搜索。</li>
<li><code>BYBOX</code>：在一个轴对齐的矩形内搜索，由 <code>&lt;height&gt;</code> 和 <code>&lt;width&gt;</code> 决定。</li>
</ul>
<p>返回附加信息:</p>
<ul>
<li><code>WITHDIST</code>：同时返回返回的项目与指定中心点的距离。这个距离的单位与半径或高度和宽度参数的单位相同。</li>
<li><code>WITHCOORD</code>：同时返回匹配项目的经度和纬度。</li>
<li><code>WITHHASH</code>：同时返回项目的原始地理哈希编码的排序集分数，形式为52位无符号整数。</li>
</ul>
<p>排序:</p>
<ul>
<li><code>ASC</code>：将返回的项目从最近的到最远的，相对于中心点排序。</li>
<li><code>DESC</code>：将返回的项目从最远到最近排序，相对于中心点。</li>
</ul>
<p>默认情况下，所有匹配的项目都被返回。要将结果限制在前N个匹配项，请使用 <code>COUNT</code> 选项。当使用 <code>ANY</code> 选项时，一旦找到足够的匹配项，命令就会返回。</p>
<p><code>GEOSEARCH key [FROMMEMBER member] [FROMLONLAT longitude latitude] [BYRADIUS radius m|km|ft|mi] [BYBOX width height m|km|ft|mi] [ASC|DESC] [COUNT count [ANY]] [WITHCOORD] [WITHDIST] [WITHHASH]</code></p>
<p>以 chengdu 为中心，半径为 20km 的圆形范围内的目标：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:city 104.009 30.74 jinniiu 104.049 30.102 jinjiang</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; geosearch china:city frommember chengdu byradius 20 km asc count 5 withdist</span><br><span class="line">1) 1) <span class="string">&quot;chengdu&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;erxianqiao&quot;</span></span><br><span class="line">   2) <span class="string">&quot;9.7865&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;jinniiu&quot;</span></span><br><span class="line">   2) <span class="string">&quot;9.7865&quot;</span></span><br></pre></td></tr></table></figure>

<p>以 chengdu 为中心，长款为 20km 的矩形范围内的目标：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geosearch china:city frommember chengdu bybox 20 20 km asc count 5 withdist</span><br><span class="line">1) 1) <span class="string">&quot;chengdu&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;erxianqiao&quot;</span></span><br><span class="line">   2) <span class="string">&quot;9.7865&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;jinniiu&quot;</span></span><br><span class="line">   2) <span class="string">&quot;9.7865&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="GEOSEARCHSTORE"><a href="#GEOSEARCHSTORE" class="headerlink" title="GEOSEARCHSTORE"></a>GEOSEARCHSTORE</h3><p>此命令类似于 <code>GEOSEARCH</code>，但只是将结果存储在目标 key 中，是一个写命令。</p>
<p>默认情况下，它将结果与其地理空间信息一起存储在目标 Sorted set 中，<code>score</code> 是 <code>geohash</code> 的52 位无符号二进制数的十进制形式。使用 <code>STOREDIST</code> 选项时，该命令将项目存储在一个 Sorted set 集中，该 Sorted set 中填充了它们与圆或框中心的距离浮点数作为 <code>score</code> ，单位是指定的半径单位。</p>
<p>以成都为中心，半径为 20km 的所有坐标存储在一个新的 set1 的 Sorted set 集合中，score 为 <code>geohash</code> 的整数形式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOSEARCHSTORE set1 china:city frommember chengdu byradius 20 km asc</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange set1 0 -1</span><br><span class="line">1) <span class="string">&quot;erxianqiao&quot;</span></span><br><span class="line">2) <span class="string">&quot;jinniiu&quot;</span></span><br><span class="line">3) <span class="string">&quot;chengdu&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果加上 <code>STOREDIST</code> 选项，那么新的 Sorted set 中的 <code>score</code> 就是距离，其单位与  <code>GEOSEARCHSTORE</code> 中指定的单位相同：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GEOSEARCHSTORE set1 china:city frommember chengdu byradius 20 km asc storedist</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zrange set1 0 -1 withscores</span><br><span class="line">1) <span class="string">&quot;chengdu&quot;</span></span><br><span class="line">2) <span class="string">&quot;0&quot;</span></span><br><span class="line">3) <span class="string">&quot;erxianqiao&quot;</span></span><br><span class="line">4) <span class="string">&quot;9.7865043301090093&quot;</span></span><br><span class="line">5) <span class="string">&quot;jinniiu&quot;</span></span><br><span class="line">6) <span class="string">&quot;9.7865043301090093&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="查询与删除"><a href="#查询与删除" class="headerlink" title="查询与删除"></a>查询与删除</h3><p>GEO 的底层实现原理就是 Sorted Set，因此我们可以使用对 Sorted Set 的命令来操作 GEO：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) <span class="string">&quot;chenghuadadao&quot;</span></span><br><span class="line">2) <span class="string">&quot;jinjiang&quot;</span></span><br><span class="line">3) <span class="string">&quot;erxianqiao&quot;</span></span><br><span class="line">4) <span class="string">&quot;jinniiu&quot;</span></span><br><span class="line">5) <span class="string">&quot;chengdu&quot;</span></span><br><span class="line">6) <span class="string">&quot;shenzhen&quot;</span></span><br><span class="line">7) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">8) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrem china:city jinniiu</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="Hyperloglog"><a href="#Hyperloglog" class="headerlink" title="Hyperloglog"></a>Hyperloglog</h2><p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<h3 id="基数"><a href="#基数" class="headerlink" title="基数"></a>基数</h3><p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<br/>

<h3 id="添加-2"><a href="#添加-2" class="headerlink" title="添加"></a>添加</h3><p><code>pfadd &lt;key&gt; [element]...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd set1 a b c d e f g h i </span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount set1</span><br><span class="line">(<span class="built_in">integer</span>) 9</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; pfadd set2 g h i j k l m n o</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount set2</span><br><span class="line">(<span class="built_in">integer</span>) 9</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h3><p><code>pfmerge destkey [sourcekey]...</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfmerge set3 set1 set2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pfcount set3</span><br><span class="line">(<span class="built_in">integer</span>) 15</span><br></pre></td></tr></table></figure>

<p>可以看到当我们合并后会自动去重</p>
<br/>

<h3 id="使用场景-5"><a href="#使用场景-5" class="headerlink" title="使用场景"></a>使用场景</h3><p>由于 Hyperloglogs 的占用内存小且可以合并去重，一般可以用于统计网页的UV</p>
<br/>

<h2 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h2><p>Redis 提供的 Bitmap 这个”数据结构”可以实现<strong>对位的操作</strong>。Bitmap 本身不是一种数据结构，实际上就是字符串，但是它可以对字符串的位进行操作。</p>
<p><strong>可以把 Bitmaps 想象成一个以位为单位数组</strong>，数组中的每个单元只能存 0 或者 1，<strong>数组的下标在 Bitmaps 中叫做偏移量</strong>。</p>
<p>单个 Bitmap 的最大长度是 512MB，即 2^32 个比特位。</p>
<p><strong>Bitmaps 的最大优势是节省存储空间</strong>。例如，在一个以自增id代表不同用户的系统中，我们只需要 512MB 空间就可以记录 40 亿用户的某个单一信息（比如，用户是否希望接收新闻邮件）。</p>
<p><strong>有两种类型的位操作：</strong>一类是对特定bit位的操作，比如设置&#x2F;获取某个特定比特位的值。另一类是批量bit位操作，例如在给定范围内统计为1的比特位个数。</p>
<p>Bitmap 是一串连续的 2 进制数字（0或1），每一位所在的位置为偏移(offset)，在 Bitmap 上可执行AND，OR，XOR以及其它位操作。</p>
<h3 id="添加-3"><a href="#添加-3" class="headerlink" title="添加"></a>添加</h3><p><code>setbit key offset value</code></p>
<p>记录一周的打卡情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit signed 0 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit signed 1 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit signed 2 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit signed 3 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit signed 4 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit signed 5 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit signed 6 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="获取-1"><a href="#获取-1" class="headerlink" title="获取"></a>获取</h3><p><code>getbit key offset</code></p>
<p>查看一周的打开情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getbit signed 3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit signed 4</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="统计"><a href="#统计" class="headerlink" title="统计"></a>统计</h3><p><code>bitcount key [start] [end]</code></p>
<p>统计一周打卡的天数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitcount signed 0 -1</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="运算"><a href="#运算" class="headerlink" title="运算"></a>运算</h3><p><a target="_blank" rel="noopener" href="http://redis.io/commands/bitop">bitop</a>：对两个不同字串进行位运算。可进行的运算有AND，OR，XOR以及NOT</p>
<h4 id="计算Bitmaps的交集的数量"><a href="#计算Bitmaps的交集的数量" class="headerlink" title="计算Bitmaps的交集的数量"></a>计算Bitmaps的交集的数量</h4><blockquote>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令：bitop <span class="keyword">and</span> destkey <span class="built_in">key</span>[<span class="built_in">key</span>…]</span><br><span class="line">返回：保存到 destkey 的字符串(<span class="number">1</span>字符等于<span class="number">8</span>位)的长度，和输入 <span class="built_in">key</span> 中最长的字符串长度相等。</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="计算Bitmaps的并集的数量"><a href="#计算Bitmaps的并集的数量" class="headerlink" title="计算Bitmaps的并集的数量"></a>计算Bitmaps的并集的数量</h4><blockquote>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令：bitop <span class="keyword">or</span> destkey <span class="built_in">key</span>[<span class="built_in">key</span>…]</span><br><span class="line">返回：保存到 destkey 的字符串(<span class="number">1</span>字符等于<span class="number">8</span>位)的长度，和输入 <span class="built_in">key</span> 中最长的字符串长度相等。</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="计算Bitmaps的非集的数量"><a href="#计算Bitmaps的非集的数量" class="headerlink" title="计算Bitmaps的非集的数量"></a>计算Bitmaps的非集的数量</h4><blockquote>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令：bitop<span class="built_in"> not</span> destkey<span class="built_in"> key</span></span><br><span class="line">返回：保存到 destkey 的字符串(<span class="number">1</span>字符等于<span class="number">8</span>位)的长度，和输入<span class="built_in"> key</span> 中最长的字符串长度相等。</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="计算Bitmaps的异或集的数量"><a href="#计算Bitmaps的异或集的数量" class="headerlink" title="计算Bitmaps的异或集的数量"></a>计算Bitmaps的异或集的数量</h4><blockquote>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令：bitop <span class="keyword">xor</span> destkey <span class="built_in">key</span>[<span class="built_in">key</span>..]</span><br><span class="line">返回：保存到 destkey 的字符串(<span class="number">1</span>字符等于<span class="number">8</span>位)的长度，和输入 <span class="built_in">key</span> 中最长的字符串长度相等。</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="计算Bitmaps中第一个值为targetBit的偏移量"><a href="#计算Bitmaps中第一个值为targetBit的偏移量" class="headerlink" title="计算Bitmaps中第一个值为targetBit的偏移量"></a>计算Bitmaps中第一个值为targetBit的偏移量</h4><ul>
<li><a target="_blank" rel="noopener" href="http://redis.io/commands/bitpos">bitpos</a>: 查找第一个值为0&#x2F;1的比特位的位置</li>
</ul>
<blockquote>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令：bitpos<span class="built_in"> key</span> targetBit [<span class="keyword">start</span>][<span class="keyword">end</span>]</span><br><span class="line">返回：第一个值为的偏移量</span><br></pre></td></tr></table></figure>
</blockquote>
<br/>

<h3 id="使用场景-6"><a href="#使用场景-6" class="headerlink" title="使用场景"></a>使用场景</h3><p>由于 Bitmaps 只能存储 0 和 1，因此对于只有两个状态的数据的统计很方便：</p>
<ul>
<li>打卡</li>
<li>点赞</li>
</ul>
<br/>

<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>Redis 事务可以一次执行多个命令， 并且带有以下三个重要的保证：</p>
<ul>
<li>批量操作在发送 <code>EXEC</code> 命令前被放入队列缓存</li>
<li>收到 <code>EXEC</code> 命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行</li>
<li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中</li>
</ul>
<p>一个事务从开始到执行会经历以下三个阶段：</p>
<ul>
<li>开始事务</li>
<li>命令入队</li>
<li>执行事务</li>
</ul>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p>正常执行事务:</p>
<p>使用 <code>multi</code> 开启事务，<code>exec</code> 来执行事务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> key2 value2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; get key2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> key3 value3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) <span class="string">&quot;value2&quot;</span></span><br><span class="line">4) OK</span><br></pre></td></tr></table></figure>

<p>使用 <code>discard</code> 放弃事务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> key4 value4</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; discard</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key4</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p><strong>单个 Redis 命令的执行是原子性的，但 Redis 没有在事务上增加任何维持原子性的机制，所以 Redis 事务的执行并不是原子性的。</strong></p>
<p>事务可以理解为一个打包的批量执行脚本，但批量指令并非原子化的操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做。</p>
<blockquote>
<p>It’s important to note that <strong>even when a command fails, all the other commands in the queue are processed</strong> – Redis will <em>not</em> stop the processing of commands.</p>
</blockquote>
<p>当事务中出现异常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> key1 value1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incr key1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) OK</span><br><span class="line">2) (error) ERR value is not an <span class="built_in">integer</span> or out of range</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line"><span class="string">&quot;value1&quot;</span></span><br></pre></td></tr></table></figure>

<p>可以看到其他指令并没有受到影响。</p>
<br/>

<h3 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h3><p>可以使用 <code>watch</code> 实现 Redis 监视：</p>
<ul>
<li>正常执行：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 80</span><br><span class="line">2) (<span class="built_in">integer</span>) 20</span><br><span class="line">127.0.0.1:6379&gt; get money</span><br><span class="line"><span class="string">&quot;80&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get out</span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改失败：</li>
</ul>
<p>测试多线程修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------- 1 -------</span></span><br><span class="line">127.0.0.1:6379&gt; get money</span><br><span class="line"><span class="string">&quot;80&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get out</span><br><span class="line"><span class="string">&quot;20&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 10</span><br><span class="line">QUEUED</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------- 2 -------</span></span><br><span class="line">127.0.0.1:6379&gt; get money</span><br><span class="line"><span class="string">&quot;80&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; incrby money 1000</span><br><span class="line">(<span class="built_in">integer</span>) 1080</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ------- 1 -------</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p>发现此时事务的提交返回 <code>(nil)</code> 即更新失败。<strong>无论事务是否执行成功，Redis 都会取消 Watch 监视</strong></p>
<p>在更新失败后可以再次监视获取最新值再开启事务执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 10</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1070</span><br><span class="line">2) (<span class="built_in">integer</span>) 30</span><br></pre></td></tr></table></figure>

<br/>

<h1 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h1><p>Jedis 是 Redis 官方首选的 Java 客户端开发包。</p>
<p>导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改 Redis 配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim redis.conf</span><br><span class="line">...</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">...</span><br><span class="line">protected-mode no</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="基本操作-1"><a href="#基本操作-1" class="headerlink" title="基本操作"></a>基本操作</h2><p>连接 Redis 数据库：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//创建Jedis对象</span></span><br><span class="line">    <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">  	</span><br><span class="line">    System.out.println(jedis.ping());</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">//使用之后关闭连接</span></span><br><span class="line">  	jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 Jedis 对象，我们就可以直接调用命令的同名方法来执行 Redis 命令了，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//直接使用try-with-resouse，省去close</span></span><br><span class="line">    <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>))&#123;</span><br><span class="line">        jedis.set(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;lbwnb&quot;</span>);   <span class="comment">//等同于 set test lbwnb 命令</span></span><br><span class="line">        System.out.println(jedis.get(<span class="string">&quot;test&quot;</span>));  <span class="comment">//等同于 get test 命令</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Hash类型的数据也是这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>))&#123;</span><br><span class="line">        jedis.hset(<span class="string">&quot;hhh&quot;</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;sxc&quot;</span>);   <span class="comment">//等同于 hset hhh name sxc</span></span><br><span class="line">        jedis.hset(<span class="string">&quot;hhh&quot;</span>, <span class="string">&quot;sex&quot;</span>, <span class="string">&quot;19&quot;</span>);    <span class="comment">//等同于 hset hhh age 19</span></span><br><span class="line">        jedis.hgetAll(<span class="string">&quot;hhh&quot;</span>).forEach((k, v) -&gt; System.out.println(k+<span class="string">&quot;: &quot;</span>+v));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>List:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span>(<span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>))&#123;</span><br><span class="line">        jedis.lpush(<span class="string">&quot;mylist&quot;</span>, <span class="string">&quot;111&quot;</span>, <span class="string">&quot;222&quot;</span>, <span class="string">&quot;333&quot;</span>);  <span class="comment">//等同于 lpush mylist 111 222 333 命令</span></span><br><span class="line">        jedis.lrange(<span class="string">&quot;mylist&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>)</span><br><span class="line">                .forEach(System.out::println);    <span class="comment">//等同于 lrange mylist 0 -1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只需要按照对应的操作去调用同名方法即可，所有的类型封装 Jedis 已经完成了。</p>
<br/>

<h2 id="事务-1"><a href="#事务-1" class="headerlink" title="事务"></a>事务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">//创建Jedis对象</span></span><br><span class="line">    <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">  	<span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    jsonObject.put(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">    jsonObject.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;xiaoA&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 开启事务</span></span><br><span class="line">    <span class="type">Transaction</span> <span class="variable">multi</span> <span class="operator">=</span> jedis.multi();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        multi.set(<span class="string">&quot;set1&quot;</span>, jsonObject.toJSONString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 执行事务</span></span><br><span class="line">        multi.exec();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 发生异常放弃事务</span></span><br><span class="line">        multi.dicard();</span><br><span class="line">        </span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(jedis.get(<span class="string">&quot;set1&quot;</span>));</span><br><span class="line">        <span class="comment">//使用之后关闭连接</span></span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h1 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h1><p>创建 SpringBoot 项目选择 Redis 依赖。但是在 SpringBoot 中底层没有使用 Jedis，而是Lettuce：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>starter 提供的默认配置会去连接本地的 Redis 服务器，并使用0号数据库，也可以手动进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">  	<span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">8.130</span><span class="number">.102</span><span class="number">.186</span></span><br><span class="line">    <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="comment"># 使用的数据库</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>starter已经给我们提供了两个默认的模板类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(</span></span><br><span class="line"><span class="meta">    proxyBeanMethods = false</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;RedisOperations.class&#125;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;RedisProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123;LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisAutoConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(</span></span><br><span class="line"><span class="meta">        name = &#123;&quot;redisTemplate&quot;&#125;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">    <span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(redisConnectionFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们使用 Redis 最常使用的就是 String，因此单独创建了一个 <code>StringRedisTemplate</code>。</p>
<br/>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>要使用这两个模板类需要注入 <code>RedisTemplate</code> 或 <code>StringRedisTemplate</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        redisTemplate.opsForValue();</span><br><span class="line">        redisTemplate.opsForList();</span><br><span class="line">        redisTemplate.opsForSet();</span><br><span class="line">        redisTemplate.opsForZSet();</span><br><span class="line">        redisTemplate.opsForHash();</span><br><span class="line">        redisTemplate.opsForHyperLogLog();</span><br><span class="line">        redisTemplate.opsForGeo();</span><br><span class="line">        redisTemplate.opsForCluster();</span><br><span class="line">        redisTemplate.opsForStream();</span><br><span class="line">        </span><br><span class="line">        redisTemplate.watch(<span class="string">&quot;money&quot;</span>);</span><br><span class="line">        redisTemplate.multi();</span><br><span class="line">        redisTemplate.discard();</span><br><span class="line">        redisTemplate.exec();</span><br><span class="line"></span><br><span class="line">        <span class="type">RedisConnection</span> <span class="variable">connection</span> <span class="operator">=</span> redisTemplate.getConnectionFactory().getConnection();</span><br><span class="line">        connection.flushDb();</span><br><span class="line">        connection.flushAll();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的值的操作都被封装到了 <code>ValueOperations</code> 对象中，而普通的键操作直接通过模板对象就可以使用了，大致使用方式和 Jedis 一致。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;set1&quot;</span>, <span class="string">&quot;xiaoA&quot;</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;set2&quot;</span>, <span class="string">&quot;大B&quot;</span>);</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;set1&quot;</span>));</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;set2&quot;</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以为RedisTemplate对象配置一个Serializer来实现对象的JSON存储：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoad2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//注意Student需要实现序列化接口才能存入Redis (Student implements Serializer)</span></span><br><span class="line">    template.opsForValue().set(<span class="string">&quot;student&quot;</span>, <span class="keyword">new</span> <span class="title class_">Student</span>());</span><br><span class="line">    System.out.println(template.opsForValue().get(<span class="string">&quot;student&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="自定义RedisTemplate"><a href="#自定义RedisTemplate" class="headerlink" title="自定义RedisTemplate"></a>自定义RedisTemplate</h2><p>在上一小节中我们向 Redis 中 Set 了两个键，但这两个键默认经过 JDK 序列化，因此在 Linux 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;\xac\xed\x00\x05t\x00\x04set2&quot;</span></span><br><span class="line">2) <span class="string">&quot;\xac\xed\x00\x05t\x00\x04set1&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建一个 User 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试将 User 添加到 Redis 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span>&#123;</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;user1&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;大D&quot;</span>, <span class="number">20</span>));</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;user1&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.data.redis.serializer.SerializationException: Cannot serialize;</span><br></pre></td></tr></table></figure>

<p>这是因为 User 类没有序列化，因此我们可以使用 JSON 来传递：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;大C&quot;</span>, <span class="number">20</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(user);</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;user&quot;</span>, jsonUser);</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;大C&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure>

<p>或者序列化 User 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User(name=大D, age=<span class="number">20</span>)</span><br></pre></td></tr></table></figure>

<p>在 SpringBoot 的 Redis 中默认使用的是 <code>JdkSerializationRedisSerializer</code> 来进行序列化，会出现在控制台是乱码的问题。我们可以编写自己的配置类来配置具体的序列化方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.activateDefaultTyping(LaissezFaireSubTypeValidator.instance);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key 采用 String 的序列化方式</span></span><br><span class="line">        template.setKeySerializer(RedisSerializer.string());</span><br><span class="line">        template.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line">        <span class="comment">// value 采用 JSON 的序列化方式</span></span><br><span class="line">        template.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        template.setHashValueSerializer(RedisSerializer.json());</span><br><span class="line"></span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们 <code>flushdb</code> 后重新向 Redis 中添加数据再 <code>keys *</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;user1&quot;</span></span><br><span class="line">2) <span class="string">&quot;set1&quot;</span></span><br><span class="line">3) <span class="string">&quot;user&quot;</span></span><br><span class="line">4) <span class="string">&quot;set2&quot;</span></span><br></pre></td></tr></table></figure>

<p>就不会出现乱码问题了。</p>
<br/>

<h2 id="RedisUtils"><a href="#RedisUtils" class="headerlink" title="RedisUtils"></a>RedisUtils</h2><p>工具类可以提升我们的开发效率：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RedisUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =============================common============================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定缓存失效时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">expire</span><span class="params">(String key, <span class="type">long</span> time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.expire(key, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key 获取过期时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 时间(秒) 返回0代表为永久有效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getExpire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.getExpire(key, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断key是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 可以传一个值 或多个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">del</span><span class="params">(String... key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="literal">null</span> &amp;&amp; key.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.length == <span class="number">1</span>) &#123;</span><br><span class="line">                redisTemplate.delete(key[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.delete((Collection&lt;String&gt;) CollectionUtils.arrayToList(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================String=============================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存获取</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">return</span> <span class="variable">key</span> <span class="operator">=</span>= <span class="literal">null</span> ? <span class="literal">null</span> : redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存放入</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存放入并设置时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒) time要大于0 如果time小于等于0 将设置无限期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                set(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递增</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 要增加几(大于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">incr</span><span class="params">(String key, <span class="type">long</span> delta)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;递增因子必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递减</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 要减少几(小于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">decr</span><span class="params">(String key, <span class="type">long</span> delta)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;递减因子必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, -delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================Map=================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashGet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">hget</span><span class="params">(String key, String item)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().get(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取hashKey对应的所有键值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对应的多个键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title function_">hmget</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map 对应多个键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet 并设置时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map  对应多个键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map, <span class="type">long</span> time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hset</span><span class="params">(String key, String item, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒) 注意:如果已存在的hash表有时间,这里将会替换原有的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hset</span><span class="params">(String key, String item, Object value, <span class="type">long</span> time, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除hash表中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 可以使多个 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hdel</span><span class="params">(String key, Object... item)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().delete(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断hash表中是否有该项的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hHasKey</span><span class="params">(String key, String item)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().hasKey(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash递增 如果不存在,就会创建一个 并把新增后的值返回</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   要增加几(大于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">hincr</span><span class="params">(String key, String item, <span class="type">double</span> by)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash递减</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   要减少记(小于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">hdecr</span><span class="params">(String key, String item, <span class="type">double</span> by)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, -by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================set=============================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key获取Set中的所有值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Object&gt; <span class="title function_">sGet</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据value从一个set中查询,是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sHasKey</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().isMember(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将数据放入set缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sSet</span><span class="params">(String key, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将set数据放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time   时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sSetAndTime</span><span class="params">(String key, <span class="type">long</span> time, TimeUnit timeUnit, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time, timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取set缓存的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sGetSetSize</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除值为value的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 移除的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">setRemove</span><span class="params">(String key, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForSet().remove(key, values);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===============================list=================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取list缓存的内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start 开始</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end   结束 0 到 -1代表所有值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">lGet</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().range(key, start, end);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取list缓存的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">lGetListSize</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过索引 获取list中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 索引 index&gt;=0时， 0 表头，1 第二个元素，依次类推；index&lt;0时，-1，表尾，-2倒数第二个元素，依次类推</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">lGetIndex</span><span class="params">(String key, <span class="type">long</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().index(key, index);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, Object value, <span class="type">long</span> time,TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time,timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, List&lt;Object&gt; value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, List&lt;Object&gt; value, <span class="type">long</span> time,TimeUnit timeUnit)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time,timeUnit);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据索引修改list中的某条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lUpdateIndex</span><span class="params">(String key, <span class="type">long</span> index, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().set(key, index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除N个值为value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 移除多少个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 移除的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">lRemove</span><span class="params">(String key, <span class="type">long</span> count, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">remove</span> <span class="operator">=</span> redisTemplate.opsForList().remove(key, count, value);</span><br><span class="line">            <span class="keyword">return</span> remove;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===============================HyperLogLog=================================</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">pfadd</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().add(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">pfcount</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHyperLogLog().size(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pfremove</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHyperLogLog().delete(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pfmerge</span><span class="params">(String key1, String key2)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHyperLogLog().union(key1, key2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们就可以很简单的使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span>&#123;</span><br><span class="line">    redisUtil.set(<span class="string">&quot;gender&quot;</span>, <span class="string">&quot;male&quot;</span>);</span><br><span class="line">    System.out.println(redisUtil.get(<span class="string">&quot;gender&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br/>

<h1 id="Redis-conf"><a href="#Redis-conf" class="headerlink" title="Redis.conf"></a>Redis.conf</h1><p>Redis 的配置文件位于 Redis 安装目录下，文件名为 <strong>redis.conf</strong>，在我们启动 Redis 服务时就是通过配置文件来启动的：<code>redis-server myconf/redis.conf</code>。</p>
<p>在 Redis 的配置文件中：</p>
<ul>
<li><p><code># units are case insensitive so 1GB 1Gb 1gB are all the same.</code> 说明 units 对大小写不敏感</p>
</li>
<li><p><code># include /path/to/local.conf</code></p>
<p><code># include /path/to/other.conf</code></p>
<p>Redis 的配置文件跟 Spring 一样，可以导入多个配置文件</p>
</li>
</ul>
<br/>

<h2 id="NETWORK"><a href="#NETWORK" class="headerlink" title="NETWORK"></a>NETWORK</h2><p>在 Network 栏我们可以绑定 ip、端口号、设置受保护模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line"></span><br><span class="line">protected-mode <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">port 6379</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="GENERAL"><a href="#GENERAL" class="headerlink" title="GENERAL"></a>GENERAL</h2><p>在 General 通用设置栏可以设置守护进程模式、日志、数据库数量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span>  <span class="comment"># 默认为no， 需要手动开启</span></span><br><span class="line"></span><br><span class="line">pidfile /www/server/redis/redis.pid  <span class="comment"># 如果开启守护进程模式，就需要指定一个pid文件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># debug (a lot of information, useful for development/testing)</span></span><br><span class="line"><span class="comment"># verbose (many rarely useful info, but not a mess like the debug level)</span></span><br><span class="line"><span class="comment"># notice (moderately verbose, what you want in production probably)</span></span><br><span class="line"><span class="comment"># warning (only very important / critical messages are logged)</span></span><br><span class="line">loglevel notice		<span class="comment"># 日志级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the log file name. Also the empty string can be used to force</span></span><br><span class="line"><span class="comment"># Redis to log on the standard output. Note that if you use standard</span></span><br><span class="line"><span class="comment"># output for logging but daemonize, logs will be sent to /dev/null</span></span><br><span class="line">logfile <span class="string">&quot;/www/server/redis/redis.log&quot;</span>	<span class="comment"># 日志文件</span></span><br><span class="line"></span><br><span class="line">databases 16	<span class="comment"># 数据库数量，默认16个</span></span><br><span class="line"></span><br><span class="line">always-show-logo <span class="built_in">yes</span>   <span class="comment"># 显示 Redis Logo (类似SpringBoot的banner)</span></span><br></pre></td></tr></table></figure>

<br/>

<h2 id="SNAPSHOTTING"><a href="#SNAPSHOTTING" class="headerlink" title="SNAPSHOTTING"></a>SNAPSHOTTING</h2><p>主要用于配置持久化相关的设置，由于 Redis 是内存数据库，如果没有进行持久化，则数据断电即失。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 900s 内若至少有 1个 key 进行了修改，就进行持久化操作</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持久化出错后是否继续工作</span></span><br><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否压缩 rdb 文件(会消耗CPU资源)</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存 rdb 文件时是否进行文件的校验</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rdb 文件的保存目录</span></span><br><span class="line"><span class="built_in">dir</span> /www/server/redis/</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="REPLICATION"><a href="#REPLICATION" class="headerlink" title="REPLICATION"></a>REPLICATION</h2><p>该部分配置在主从复制中介绍</p>
<br/>

<h2 id="SECURITY"><a href="#SECURITY" class="headerlink" title="SECURITY"></a>SECURITY</h2><p>Redis 默认没有密码，可以在 SECURITY 栏中设置密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置密码</span></span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="CLIENTS"><a href="#CLIENTS" class="headerlink" title="CLIENTS"></a>CLIENTS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 连接的最大客户端数量</span></span><br><span class="line">maxclients 10000</span><br></pre></td></tr></table></figure>

<br/>

<h2 id="MEMORY-MANAGEMENT"><a href="#MEMORY-MANAGEMENT" class="headerlink" title="MEMORY MANAGEMENT"></a>MEMORY MANAGEMENT</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置最大内存容量</span></span><br><span class="line">maxmemory &lt;bytes&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存达到上限的处理策略</span></span><br><span class="line">maxmemory-policy noeviction</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">策略配置</th>
<th align="center">说明</th>
<th align="center">筛选维度</th>
<th align="center">策略算法</th>
</tr>
</thead>
<tbody><tr>
<td align="center">volatile-lru</td>
<td align="center">对设置过期时间的key使用LRU算法删除</td>
<td align="center">设置过期时间的key</td>
<td align="center">LRU</td>
</tr>
<tr>
<td align="center">allkeys-lru</td>
<td align="center">对所有key使用LRU算法删除</td>
<td align="center">所有的key</td>
<td align="center">LRU</td>
</tr>
<tr>
<td align="center">volatile-lfu</td>
<td align="center">对设置了过期时间的key使用LFU算法删除</td>
<td align="center">设置过期时间的key</td>
<td align="center">LFU</td>
</tr>
<tr>
<td align="center">allkeys-lfu</td>
<td align="center">对所有key使用LFU算法删除</td>
<td align="center">所有的key</td>
<td align="center">LFU</td>
</tr>
<tr>
<td align="center">volatile-random</td>
<td align="center">对设置了过期时间的key随机</td>
<td align="center">设置过期时间的key</td>
<td align="center">random</td>
</tr>
<tr>
<td align="center">allkeys-random</td>
<td align="center">对所有的key随机</td>
<td align="center">所有的key</td>
<td align="center">random</td>
</tr>
<tr>
<td align="center">volatile-ttl</td>
<td align="center">删除马上要过期的key</td>
<td align="center">设置过期时间的key</td>
<td align="center">ttl</td>
</tr>
<tr>
<td align="center">noeviction</td>
<td align="center">不会驱逐任何key 满了会报mom错误，命令无法执行，内存大于最大内存</td>
<td align="center">所有的key</td>
<td align="center"></td>
</tr>
</tbody></table>
<br/>

<h2 id="APPEND-ONLY-MODE"><a href="#APPEND-ONLY-MODE" class="headerlink" title="APPEND ONLY MODE"></a>APPEND ONLY MODE</h2><p>AOF 的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认不开启 AOF，因为默认是使用 RDB 持久化方式</span></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持久化文件名</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同步策略</span></span><br><span class="line"><span class="comment"># appendfsync always  	# 每次修改时同步</span></span><br><span class="line">appendfsync everysec	<span class="comment"># 每秒同步</span></span><br><span class="line"><span class="comment"># appendfsync no		# 不同步</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>详细配置将会在持久化中介绍。</p>
<br/>

<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><p>Redis 是内存数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失。所以 Redis 提供了持久化功能</p>
<h2 id="RDB-Redis-DataBase"><a href="#RDB-Redis-DataBase" class="headerlink" title="RDB(Redis DataBase)"></a>RDB(Redis DataBase)</h2><p>RDB 持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是 fork 一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/98160f6c57976b8fce706c0da5031070.jpg" alt="98160f6c57976b8fce706c0da5031070.jpg"></p>
<p><strong>RDB保存的文件默认是dump.rdb</strong></p>
<p><strong>优点</strong></p>
<ul>
<li>使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 Redis 的高性能，文件体积小，恢复速度快</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>RDB 是间隔一段时间进行持久化，如果持久化之间 Redis 发生故障，会发生数据丢失。所以这种方式更适合数据要求不严谨的时候</li>
</ul>
<p>RDB 提供了三种机制去触发持久化，分别是：<strong>自动触发、save 触发、bgsave 触发</strong></p>
<br/>

<h3 id="sava-触发"><a href="#sava-触发" class="headerlink" title="sava 触发"></a>sava 触发</h3><p>Redis 处理命令的方式是以单线程形式来进行的，客户端的请求都会放入一个队列里。当执行 save 命令时，如果执行时间很长的话，后面的请求就会被阻塞，客户端发送的所有命令都会被拒绝。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>



<img src="https://s1.imagehub.cc/images/2022/04/18/v2-3036a75a8358d30a8433786839a497e9_720w.jpg" alt="v2-3036a75a8358d30a8433786839a497e9_720w.jpg" style="zoom:67%;" />

<p>执行完成时候如果存在老的 RDB 文件，就把新的替代掉旧的。我们的客户端可能都是几万或者是几十万，这种方式显然不可取。</p>
<p>这种 save 触发阻塞 Redis 服务器是因为占用了 Redis 主线程去进行 rdb 文件的处理。</p>
<br/>

<h3 id="bgsave-触发"><a href="#bgsave-触发" class="headerlink" title="bgsave 触发"></a>bgsave 触发</h3><p>与 save 不同的是，执行过程中它并不会阻塞客户端的请求。而是将持久化工作交给子进程来执行，主进程仍负责客户端请求的处理工作。</p>
<img src="https://s1.imagehub.cc/images/2022/04/18/v2-05967df1adcf64a26f0edfe54d879b5f_720w.jpg" alt="v2-05967df1adcf64a26f0edfe54d879b5f_720w.jpg" style="zoom:67%;" />

<p>具体操作是 Redis 进程执行 fork 操作创建子进程，RDB 持久化过程由子进程负责，完成后自动结束。阻塞只发生在 fork 阶段，一般时间很短。基本上 Redis 内部所有的 RDB 操作都是采用 bgsave 命令。</p>
<br/>

<h3 id="自动触发机制"><a href="#自动触发机制" class="headerlink" title="自动触发机制"></a>自动触发机制</h3><p>在 redis.conf 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># save m n //m 代表秒数，n 代表次数，表示 m 秒内发生 n 次变化时，会触发 bgsave。</span></span><br><span class="line"><span class="comment"># redis.conf 中的三个默认配置项</span></span><br><span class="line"><span class="comment"># 设置多个 save m n 命令时，满足任何一个条件都会触发持久化。</span></span><br><span class="line">save 900 1 <span class="comment"># 表示的是时间900s内，如果 Redis 中数据至少发生一次变化，就会执行bgsave</span></span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="文件恢复"><a href="#文件恢复" class="headerlink" title="文件恢复"></a>文件恢复</h3><p><img src="https://s1.imagehub.cc/images/2022/04/18/QQ20220418161747.png" alt="QQ20220418161747.png"></p>
<p>开启自动持久化后，数据会存储到名为 dump.rdb 的文件中。当 Redis 服务器重启时，检测到 dump.rdb 文件后，会自动加载进行数据恢复。</p>
<br/>

<h2 id="AOF-Append-Only-File"><a href="#AOF-Append-Only-File" class="headerlink" title="AOF(Append Only File)"></a>AOF(Append Only File)</h2><p>AOF 即<strong>文件追加持久化</strong>。与 RDB 不同的是，它以日志的形式来记录每个写操作，将 Redis 执行过的所有写指令记录下来（读操作不记录），只允许追加文件，不允许修改文件，Redis 启动之初会读取该文件重新构建数据，换句话说就是，Redis 重启时就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/79246ba78da4898308a7ca3d0a80c674.png" alt="79246ba78da4898308a7ca3d0a80c674.png"></p>
<p>写日志的方式：Redis 先执行命令把数据写入内存，然后再记录日志到文件中。</p>
<p>由于 Redis 在写入日志之前不对命令进行语法检查，所以只记录执行成功的命令，避免出现记录错误命令的情况，而且在命令执行后再写日志不会阻塞当前的写操作。</p>
<p>后写日志主要有两个风险可能会发生：</p>
<ol>
<li>数据可能会丢失：如果 Redis 刚执行完命令，此时发生故障宕机，会导致这条命令存在丢失的风险。</li>
<li>可能阻塞其他操作：AOF 日志其实也是在主线程中执行，所以当 Redis 把日志文件写入磁盘的时候，还是会阻塞后续的操作无法执行。</li>
</ol>
<p><strong>AOF保存的是appendonly.aof 文件</strong></p>
<p><strong>优点</strong></p>
<ul>
<li>数据更完整：AOF 中是及时写入的方式，数据保存更完整。恢复时降低数据的损失。</li>
<li>易读性强：AOF 中保存的数据格式是客户端的写入命令，可读性性强。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li>文件体积大：AOF 中存储客户端所有的写命令，未经压缩，随着命令的写入，文件会越来越大。</li>
<li>增加磁盘IO：AOF 文件刷盘如果采用每秒刷一次的方式会导致磁盘IO升高，影响性能。</li>
</ul>
<br/>

<h3 id="AOF-实现方式"><a href="#AOF-实现方式" class="headerlink" title="AOF 实现方式"></a>AOF 实现方式</h3><p>想要使用 AOF 持久化方式，需要启用配置文件中的 <code>appendonly</code> 参数。默认情况下，Redis 是不开启的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p>开启 AOF 持久化后每执行一条修改数据的命令，Redis 就会将该命令写入 aof_buf 缓冲区。后续还需要设置同步选项，从而确保写命令同步到磁盘文件上的时机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># appendfsync always 	# 每个写命令都同步</span></span><br><span class="line">appendfsync everysec 	<span class="comment"># 每秒同步一次 默认</span></span><br><span class="line"><span class="comment"># appendfsync no 		# 让操作系统来决定何时同步</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="AOF-重写机制"><a href="#AOF-重写机制" class="headerlink" title="AOF 重写机制"></a>AOF 重写机制</h3><p>随着命令的不断写入，AOF 文件会变得越来越大，Redis 中提供了瘦身功能，也就是重写机制。Redis 配置文件中有两个对应的参数是来决定重写机制的触发时机的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-percentage 100 	<span class="comment"># AOF文件距离上次文件增长超过多少百分比</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb 		<span class="comment"># AOF文件体积最小多大以上触发</span></span><br></pre></td></tr></table></figure>

<p>满足所设置的条件时，会自动触发 AOF 重写，此时 Redis 会扫描整个实例的数据，重新生成一个 AOF 文件来达到瘦身的效果。</p>
<p>所以 AOF 重写机制，其实是重新生成一个 AOF 日志文件，只将当前有效并存在的数据转义成符合 AOF 日志格式的记录，然后依次写入该日志文件，最后刷入硬盘。这些操作都是在子进程中进行的，应该不会阻塞主进程，而导致无法处理新的请求。</p>
<p>子进程还带来了一个问题，就是在子进程在生成 AOF 重写日志的时候，主进程还在处理新的请求，那么这段区间的写命令是没有记录下来的。Linux 的进程之间的通信可以 pipe 机制进行，Redis 通过该机制，主进程将该段区间执行的命令传递给子进程，然后子进程将这些命令追加到 AOF 重写日志的末尾，因而解决了这个问题。</p>
<br/>

<h3 id="AOF-文件恢复"><a href="#AOF-文件恢复" class="headerlink" title="AOF 文件恢复"></a>AOF 文件恢复</h3><img src="https://s1.imagehub.cc/images/2022/04/18/QQ20220418164219.png" alt="QQ20220418164219.png" style="zoom: 67%;" />

<p>和 RBD 不同的是，Redis 中是通过创建一个不带网络连接的伪客户端来进行实现的。AOF 文件中的数据格式，都是由命令组成的。通过客户端直接执行每条命令就可以将数据进行恢复。</p>
<p>在这里需要注意的是，如果服务器开启了 AOF 持久化功能，会优先使用 AOF 文件来进行恢复。只有在 AOF 关闭状态下，服务器才会使用 RDB 文件来进行还原。</p>
<br/>

<h3 id="修复AOF文件"><a href="#修复AOF文件" class="headerlink" title="修复AOF文件"></a>修复AOF文件</h3><p>如果 AOF 文件有错误 Redis 服务器是连接不上的，需要修复这个AOF文件</p>
<p>Redis 提供了一个工具：<code> redis-check-aof --fix AOF文件</code> 来修复AOF文件。</p>
<br/>

<h2 id="混合持久化"><a href="#混合持久化" class="headerlink" title="混合持久化"></a>混合持久化</h2><p><strong>混合持久化</strong>其实就是 RDB 与 AOF 的混合模式，这是 Redis4.0 之后新增的。</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/1614350-20201107154043136-1912792479.png" alt="1614350-20201107154043136-1912792479.png"></p>
<h3 id="持久化方式"><a href="#持久化方式" class="headerlink" title="持久化方式"></a>持久化方式</h3><p>混合持久化是通过 aof-use-rdb-preamble 参数来开启的。它的操作方式是这样的，在写入的时候先把数据以 RDB 的形式写入文件的开头，再将后续的写命令以 AOF 的格式追加到文件中。这样既能保证数据恢复时的速度，同时又能减少数据丢失的风险。</p>
<br/>

<h3 id="文件恢复-1"><a href="#文件恢复-1" class="headerlink" title="文件恢复"></a>文件恢复</h3><p>在 Redis 重启时，先加载 RDB 的内容，然后再重放增量 AOF 格式命令。这样就避免了 AOF 持久化时的全量加载，从而使加载速率得到大幅提升。</p>
<br/>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>RDB持久化</strong></p>
<ul>
<li>将某一时刻的数据以二进制形式写入到磁盘里，服务重启时检测到对应文件自动加载进行数据恢复。</li>
<li>有手动触发和自动触发两种机制。</li>
</ul>
<p><strong>AOF持久化</strong></p>
<ul>
<li>以文件追加的方式写入客户端执行的写命令。</li>
<li>数据恢复时，通过创建伪客户端的方式执行命令，直到恢复完成。</li>
</ul>
<p><strong>混合持久化</strong></p>
<ul>
<li>在写入的时候先把数据以 RDB 的形式写入文件的开头，再将后续的写命令以 AOF 的格式追加到文件中。</li>
</ul>
<br/>

<h1 id="Redis发布订阅"><a href="#Redis发布订阅" class="headerlink" title="Redis发布订阅"></a>Redis发布订阅</h1><p>Redis 发布订阅 (pub&#x2F;sub) 是一种<strong>消息通信模式</strong>：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。(了解即可，一般使用 MQ 来实现)</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<p>下图展示了频道 channel1，以及订阅这个频道的三个客户端 —— client2 、client5 和 client1 之间的关系：</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/pubsub1.png" alt="pubsub1.png"></p>
<p>当有新消息通过 PUBLISH 命令发送给频道 channel1 时， 这个消息就会被发送给订阅它的三个客户端：</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/pubsub2.png" alt="pubsub2.png"></p>
<br/>

<h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><p>需要开启两个 redis-cli 客户端</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; SUBSCRIBE channel1</span><br><span class="line"></span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line">2) <span class="string">&quot;channel1&quot;</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<p>重新开启个 redis 客户端，然后在同一个频道 runoobChat 发布两次消息，订阅者就能接收到消息:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; PUBLISH channel1 <span class="string">&quot;Redis PUBLISH test&quot;</span></span><br><span class="line"></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line">redis 127.0.0.1:6379&gt; PUBLISH channel1 <span class="string">&quot;channel1 test&quot;</span></span><br><span class="line"></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 订阅者的客户端会显示如下消息</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span></span><br><span class="line">2) <span class="string">&quot;channel1&quot;</span></span><br><span class="line">3) <span class="string">&quot;Redis PUBLISH test&quot;</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span></span><br><span class="line">2) <span class="string">&quot;channel1&quot;</span></span><br><span class="line">3) <span class="string">&quot;channel1 test&quot;</span></span><br></pre></td></tr></table></figure>

<br/>

<h2 id="Redis发布订阅命令"><a href="#Redis发布订阅命令" class="headerlink" title="Redis发布订阅命令"></a>Redis发布订阅命令</h2><table>
<thead>
<tr>
<th align="center">序号</th>
<th align="center">命令及描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">PSUBSCRIBE pattern [pattern …] 订阅一个或多个符合给定模式的频道。</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">PUBSUB subcommand argument [argument …] 查看订阅与发布系统状态。</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">PUBLISH channel message 将信息发送到指定的频道。</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">PUNSUBSCRIBE [pattern [pattern …]] 退订所有给定模式的频道。</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">SUBSCRIBE channel [channel …] 订阅给定的一个或多个频道的信息。</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">UNSUBSCRIBE [channel [channel …]] 指退订给定的频道。</td>
</tr>
</tbody></table>
<br/>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>Redis 是使用 C 实现的，通过分析 Redis 源码里面的 pubsub.c 文件，了解发布和订阅机制的底层实现，借此加深对 Redis 的理解。</p>
<p>Redis 通过 publish，subscribe 和 psubscribe 等命令实现发布和订阅功能。</p>
<p>通过 subscribe 命令订阅某频道后，Redis-server 里维护了一个字典，字典的键就是一个个频道，而字典的值则是一个链表，链表中保存了所有订阅这个频道的客户端。subscribe 命令的关键，就是将客户端添加到给定频道的订阅链表中。</p>
<p>通过 publish 命令向订阅者发送消息，redis-server 会使用给定的频道作为键，在它所维护的频道字典中查找记录了订阅这个频道的所有客户端的链表，遍历这个链表，将消息发布给所有订阅者。</p>
<p>pub&#x2F;sub 从字面上理解就是发布(publish)与订阅(subscribe)，在 Redis 中，可以设定对某一个 key 值进行消息发布及消息订阅，当一个 key 值上进行了消息发布后，所有订阅它的客户端都会收到相应的消息。这一功能最明显的用法就是用作实时消息系统，比如：普通的即时聊天，群聊等功能。</p>
<br/>

<h2 id="使用场景-7"><a href="#使用场景-7" class="headerlink" title="使用场景"></a>使用场景</h2><ul>
<li>实时消息系统</li>
<li>实时聊天（频道当做聊天室，将信息回显给所有人即可）</li>
<li>订阅，关注系统</li>
</ul>
<br/>

<h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h1><h2 id="单机的问题"><a href="#单机的问题" class="headerlink" title="单机的问题"></a>单机的问题</h2><p>单机即在一台机器上部署一个 Redis 节点，主要会存在以下问题：</p>
<ol>
<li><p>服务器宕机</p>
<p>数据丢失，如果数据很重要，那会造成很大的损失</p>
</li>
<li><p>内存问题</p>
</li>
</ol>
<p>​	一台服务器的内存是会达到峰值的，一台服务器也不可能无限升级</p>
<p>针对上述问题，我们需要准备多台服务器，配置主从复制。将数据保存在多台服务器上，并且保证每台服务器的数据是同步的。即使有一台服务器宕机也不影响用户的使用。Redis 可以继续实现高可用，同时实现数据的冗余备份。</p>
<br/>

<h2 id="主从复制的概念"><a href="#主从复制的概念" class="headerlink" title="主从复制的概念"></a>主从复制的概念</h2><p>主从复制：是指将一台 Redis 服务的数据，复制到其他 Redis 服务器上。前者称为主节点（master），后者称为从节点（slave）。master以写为主，slave 以读为主。数据的复制是单向的，只能从主节点到从节点。</p>
<p>默认情况下，每一台 Redis 服务都是主节点，一个主节点可以有多个从节点（也可以没有），但一个从节点只能有一个主节点。</p>
<br/>

<h2 id="主从复制的作用"><a href="#主从复制的作用" class="headerlink" title="主从复制的作用"></a>主从复制的作用</h2><ol>
<li>数据冗余，实现数据的热备份，这也是持久化实现的另一种方式。</li>
<li>针对单机故障问题，一个节点故障，其他节点可以提供服务，不影响用户使用。实现了快速恢复故障，这也是服务冗余。</li>
<li>读写分离，master 服务主要用来写，slave 服务主要用来读数据。可以提高服务器的负载能力，可以根据需求的变化，添加从节点的数量。</li>
<li>负载均衡，同时配合读写分离，由主节点提供写服务，从节点提供读服务，分担服务器的负载。在写少读多的情况下，通过多个从节点分担读负载，能够大大提高Redis服务的并发量和负载。</li>
<li>高可用的基石，主从复制是哨兵和集群模式能够实施的基础。</li>
</ol>
<br/>

<h2 id="配置主从复制"><a href="#配置主从复制" class="headerlink" title="配置主从复制"></a>配置主从复制</h2><p>查看当前库的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master		<span class="comment"># 角色</span></span><br><span class="line">connected_slaves:0	<span class="comment"># 无从机</span></span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:15fae1beb27c914323feb1ee2a21bccebf501d15</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>

<p>模拟主从机：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制三个redis.conf配置文件，分别为redis79.conf，redis80.conf，redis81.conf</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># cp redis.conf redis6379.conf</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># cp redis.conf redis6380.conf</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># cp redis.conf redis6381.conf</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># ls</span></span><br><span class="line">redis79.conf  redis80.conf  redis81.conf  redis.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改三个配置文件的端口号、开启守护进程、pid文件名、log文件名、dump.rdb名</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># vim redis6379.conf</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># vim redis6380.conf</span></span><br><span class="line">[root@Ssssv myconf]<span class="comment"># vim redis6381.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动三个 Redis 服务器</span></span><br><span class="line">[root@Ssssv bin]<span class="comment"># redis-server myconf/redis6379.conf</span></span><br><span class="line">[root@Ssssv bin]<span class="comment"># redis-server myconf/redis6380.conf</span></span><br><span class="line">[root@Ssssv bin]<span class="comment"># redis-server myconf/redis6381.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看进程</span></span><br><span class="line">[root@Ssssv bin]<span class="comment"># ps -ef|grep redis</span></span><br><span class="line">root     25342     1  0 09:35 ?        00:00:03 redis-server 127.0.0.1:6379</span><br><span class="line">root     25526     1  0 10:14 ?        00:00:00 redis-server 127.0.0.1:6380</span><br><span class="line">root     25532     1  0 10:15 ?        00:00:00 redis-server 127.0.0.1:6381</span><br><span class="line">root     25556 25538  0 10:16 pts/3    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="一主二从"><a href="#一主二从" class="headerlink" title="一主二从"></a>一主二从</h3><p>默认情况下，每一台 Redis 服务都是主节点。在我们启动三个客户端后使用 <code>info replication</code> 查看到每台服务都是 master。我们只需要去配置从机即可.</p>
<p>只需要执行 <code>slaveof &lt;host&gt; &lt;port&gt;</code> 命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6381&gt; slaveof 127.0.0.1 6379</span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>此时在主机中就能查看到从机了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2 	<span class="comment"># 从机数为2</span></span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=210,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=210,lag=1</span><br><span class="line">master_replid:3cfc9f3aa664a35ec4130b6baf1529bb7523b822</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:210</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:210</span><br></pre></td></tr></table></figure>

<p><strong>注意：真实开发中配置主从机是在配置文件中进行的，这里使用命令进行配置是临时的</strong></p>
<p>在配置文件的 REPLICATION 栏中可以配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;  	<span class="comment"># 主机ip和port</span></span><br><span class="line">masterauth &lt;master-password&gt;		<span class="comment"># 主机密码</span></span><br></pre></td></tr></table></figure>

<br/>

<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p><strong>主机可以写，从机只能读</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty list or <span class="built_in">set</span>)</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从机</span></span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">1) <span class="string">&quot;k1&quot;</span></span><br><span class="line">127.0.0.1:6380&gt; get k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line">127.0.0.1:6380&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">(error) READONLY You can<span class="string">&#x27;t write against a read only replica.</span></span><br></pre></td></tr></table></figure>

<p><strong>主机宕机，不影响从机的读</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从机</span></span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">1) <span class="string">&quot;k1&quot;</span></span><br><span class="line">127.0.0.1:6380&gt; get k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>从机下线，再次上线后会同步主机的新数据</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从机</span></span><br><span class="line">127.0.0.1:6380&gt; shutdown</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从机</span></span><br><span class="line">[root@Ssssv bin]<span class="comment"># redis-server myconf/redis6380.conf</span></span><br><span class="line">[root@Ssssv bin]<span class="comment"># redis-cli -p 6380</span></span><br><span class="line">127.0.0.1:6380&gt; get k2</span><br><span class="line"><span class="string">&quot;v2&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果6380节点不希望成为6379的从节点，可以执行 <code>slaveof on one</code> 命令，取消后6380节点的数据不会被清除，只是说后续6379节点新写入的数据不会再同步到该节点了。</p>
<p>注意：如果取消复制后想 slave 一个新的主节点，新的主节点在同步给 slave 节点数据时，会先将从节点的数据全部清除</p>
<br/>

<h2 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h2><p><strong>Redis 的复制分为全量同步和增量同步。</strong></p>
<h3 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h3><p>全量复制主节点会将 RDB 文件也就是当前状态去同步给 slave，在此期间主新写入的命令会单独记录起来，然后当 RDB 文件加载完毕之后，会通过偏移量对比将这个期间产生的写入值同步给 slave，这样就能达到数据完全同步的效果</p>
<p><strong>全量复制过程</strong></p>
<ol>
<li>在其内部有一条命令 <code>psync</code>，是做同步的命令，它可以完成全量复制和部分复制的功能，当启动 slave 节点时，它会发送 <code>psync</code> 命令给主节点，需要传递两个参数，<code>runid</code> 和 <code>offset</code>(偏移量)，也就是从向主传递主节点的 runid 以及自己的偏移量，对于第一次复制而言，就直接传递 ？和 -1，当然这个参数是由 slave 内部传的。</li>
<li>master 接收到命令后知道从希望做全量复制，主机就会将自己的 runid 和 offset 传递给从机</li>
<li>slave 节点保存 master 的基本信息</li>
<li>master 执行 <code>bgsave</code> 生成 RDB 文件，并且在此期间新产生的写入命令会被记录到<code>repl_back_buffer</code>(复制缓冲区)</li>
<li>主向从传输 RDB 文件</li>
<li>主向从发送复制缓冲区内容</li>
<li>清空从节点旧的数据</li>
<li>从节点加载 RDB 文件到内存中，同时加载缓冲区数据</li>
</ol>
<p><strong>全量复制的开销</strong></p>
<p>实际上全量复制的开销是非常大的，主要体现在如下方面</p>
<ol>
<li>bgsave 时间(对cpu、 内存、硬盘都会有一定的开销)</li>
<li>RDB 文件网络传输时间(网络带宽)</li>
<li>从节点清空数据时间(根据从节点的数据规模)</li>
<li>从节点加载 RDB 的时间</li>
<li>可能的 AOF 重写时间(在最后从加载完 RDB 之后如果开启了 AOF，会做 AOF 重写)</li>
</ol>
<img src="https://s1.imagehub.cc/images/2022/04/18/aHR0cHM6Ly9xaW5pdS5nYW9iaW56aGFuLmNvbS8yMDIwLzA2LzAzLzczNTFiMzg5NTRhYjkucG5n.png" alt="aHR0cHM6Ly9xaW5pdS5nYW9iaW56aGFuLmNvbS8yMDIwLzA2LzAzLzczNTFiMzg5NTRhYjkucG5n.png" style="zoom:67%;" />

<p>全量复制除了上述开销之外，还会有个问题：</p>
<p>假如 master 和 slave 网络发生了抖动，那一段时间内这些数据就会丢失，对于 slave 来说这段时间master 更新的数据是不知道的。最简单的方式就是再做一次全量复制，从而获取到最新的数据，在redis2.8之前是这么做的。</p>
<h3 id="增量复制"><a href="#增量复制" class="headerlink" title="增量复制"></a>增量复制</h3><p>增量复制，redis2.8之后提供。</p>
<ol>
<li>如果发生了抖动，相当于连接断开了</li>
<li>主会将写命令记录到缓冲区，repl_back_buffer</li>
<li>当 slave 再次去连接 master 时候，就是说网络抖动结束之后，会触发增量复制</li>
<li>从会执行 <code>pysnc</code> 命令，将当前自己的 offset 和主的 runid 传递给 master </li>
<li>如果发现传输的 offset 偏移量是在 buffer 内的，不在期间内就证明你已经错过了很多数据，buffer也是有限的，默认是 1M，会将 offset 开始到队列结束的数据同步给从。这样 master 和 slave 就达到了一致。</li>
</ol>
<img src="https://s1.imagehub.cc/images/2022/04/18/aHR0cHM6Ly9xaW5pdS5nYW9iaW56aGFuLmNvbS8yMDIwLzA2LzA0LzY1YjBlNzYzZjRmZDIucG5n.png" alt="aHR0cHM6Ly9xaW5pdS5nYW9iaW56aGFuLmNvbS8yMDIwLzA2LzA0LzY1YjBlNzYzZjRmZDIucG5n.png" style="zoom:67%;" />

<p>通过增量复制有效的降低了全量复制的开销。</p>
<br/>

<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><p>主从切换技术的方法是：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>哨兵模式是一种自动选择主机的模式，即在主机宕机之后，哨兵模式会根据哨兵的内部投票，自动的重新选出一个新的主机。</p>
<p>哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。</p>
<p>其原理是哨兵通过发送命令，等待 Redis 服务器响应，如果 Redis 服务器一直没有响应，说明这个 Redis 服务器可能已经宕机了，从而监控运行的多个 Redis 实例。</p>
<p>哨兵主要有两个作用</p>
<ul>
<li>通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器。</li>
<li>当哨兵监测到 master 宕机，会自动将 slave 切换成 master，然后通过发布订阅模式通知其他的从服务器，修改配置文件，让它们切换主机。</li>
</ul>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/33e280b274e04fb2214335b8438991e7.jpg" alt="33e280b274e04fb2214335b8438991e7.jpg"></p>
<p>然而一个哨兵进程对 Redis 服务器进行监控可能会出现问题，为此我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。</p>
<p>故障切换(failover)的过程：假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行 failover 过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为主观下线。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover 操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为客观下线。这样对于客户端而言，一切都是透明的。</p>
<p>如果有三个哨兵，不仅每个哨兵会监视主机和从机，而且哨兵之间也会互相监视，如下图：</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/QQ20220418185141.png" alt="QQ20220418185141.png"></p>
<br/>

<h2 id="开启哨兵模式"><a href="#开启哨兵模式" class="headerlink" title="开启哨兵模式"></a>开启哨兵模式</h2><h3 id="配置文件sentinel-conf"><a href="#配置文件sentinel-conf" class="headerlink" title="配置文件sentinel.conf"></a>配置文件sentinel.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@Ssssv myconf]<span class="comment"># vim sentinel.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sentinel monitor 被监控的服务器的名称 host port 至少几个sentinel判断主机挂了开始开始投票</span></span><br><span class="line">sentinel monitor myredis 127.0.0.1 6379 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果被监控的主机redis服务器有密码的话，还有在sentinel.conf文件中加上认证密码</span></span><br><span class="line"><span class="comment"># sentinel auth-pass 被监控的服务器的名称 password</span></span><br><span class="line">sentinel auth-pass myredis 123456</span><br></pre></td></tr></table></figure>

<br/>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@Ssssv bin]<span class="comment"># redis-sentinel myconf/sentinel.conf</span></span><br><span class="line">25584:X 04 May 2020 10:32:13.789 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">25584:X 04 May 2020 10:32:13.789 <span class="comment"># Redis version=5.0.8, bits=64, commit=00000000, modified=0, pid=25584, just started</span></span><br><span class="line">25584:X 04 May 2020 10:32:13.789 <span class="comment"># Configuration loaded</span></span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-``__ <span class="string">&#x27;&#x27;</span>-._                                             </span><br><span class="line">      _.-``    `.  `_.  <span class="string">&#x27;&#x27;</span>-._           Redis 6.2.0 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">&#x27;&#x27;</span>-._                                   </span><br><span class="line"> (    <span class="string">&#x27;      ,       .-`  | `,    )     Running in sentinel mode</span></span><br><span class="line"><span class="string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="string">&#x27;|     Port: 26379</span></span><br><span class="line"><span class="string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 25584</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|                                  </span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |           http://redis.io        </span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|                                  </span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |                                  </span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line">      `-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>                                       </span><br><span class="line">          `-._        _.-<span class="string">&#x27;                                           </span></span><br><span class="line"><span class="string">              `-.__.-&#x27;</span>                                               </span><br><span class="line"></span><br><span class="line">25584:X 04 May 2020 10:32:13.790 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">25584:X 04 May 2020 10:32:13.792 <span class="comment"># Sentinel ID is cc8ffaf50e789f4a6455ab3a174bbd3b5dc56d3b</span></span><br><span class="line">25584:X 04 May 2020 10:32:13.792 <span class="comment"># +monitor master myredis 127.0.0.1 6379 quorum 1</span></span><br><span class="line">25584:X 04 May 2020 10:32:13.793 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">25584:X 04 May 2020 10:32:13.794 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span><br></pre></td></tr></table></figure>

<p>如果主机 master 断开了，这时候就会从从机中随机选择一个服务器(投票算法):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从机6380</span></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave <span class="comment">#从机</span></span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6381  <span class="comment">#主机变成了6381</span></span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:13291</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_replid:2537105230ad1e01571df9b7b36c206a8f804750</span><br><span class="line">master_replid2:3cfc9f3aa664a35ec4130b6baf1529bb7523b822</span><br><span class="line">master_repl_offset:13291</span><br><span class="line">second_repl_offset:6807</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:13291</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从机6381</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master <span class="comment">#成为新的主机</span></span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=14507,lag=1</span><br><span class="line">master_replid:2537105230ad1e01571df9b7b36c206a8f804750</span><br><span class="line">master_replid2:3cfc9f3aa664a35ec4130b6baf1529bb7523b822</span><br><span class="line">master_repl_offset:14507</span><br><span class="line">second_repl_offset:6807</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:127</span><br><span class="line">repl_backlog_histlen:14381</span><br></pre></td></tr></table></figure>

<p>如果此时主机上线，则会当作新主机的从机.</p>
<p><strong>优点：</strong></p>
<ul>
<li>高可用，在主节点故障时能实现故障的转移</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>很难做到水平扩展</li>
<li>主从服务器的数据要经常进行主从复制造成性能下降</li>
<li>当主服务器宕机后，从服务器切换成主服务器时间服务不可用</li>
</ul>
<p>哨兵配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example sentinel.conf</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 哨兵sentinel实例运行的端口 默认26379</span></span><br><span class="line">port 26379</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 哨兵sentinel的工作目录</span></span><br><span class="line"><span class="built_in">dir</span> /tmp</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 哨兵sentinel监控的redis主节点的 ip port</span></span><br><span class="line"><span class="comment"># master-name 可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符&quot;.-_&quot;组成。</span></span><br><span class="line"><span class="comment"># quorum 当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了</span></span><br><span class="line"><span class="comment"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 当在Redis实例中开启了requirepass foobared 授权密码 这样所有连接Redis实例的客户端都要提供密码</span></span><br><span class="line"><span class="comment"># 设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码</span></span><br><span class="line"><span class="comment"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span></span><br><span class="line">sentinel auth-pass mymaster MySUPER--secret-0123passw0rd</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒</span></span><br><span class="line"><span class="comment"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，</span></span><br><span class="line"><span class="comment"># 这个数字越小，完成failover所需的时间就越长，</span></span><br><span class="line"><span class="comment"># 但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。</span></span><br><span class="line"><span class="comment"># 可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。</span></span><br><span class="line"><span class="comment"># sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;</span></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面：</span></span><br><span class="line"><span class="comment">#1. 同一个sentinel对同一个master两次failover之间的间隔时间。</span></span><br><span class="line"><span class="comment">#2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。</span></span><br><span class="line"><span class="comment">#3.当想要取消一个正在进行的failover所需要的时间。</span></span><br><span class="line"><span class="comment">#4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了</span></span><br><span class="line"><span class="comment"># 默认三分钟</span></span><br><span class="line"><span class="comment"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"> </span><br><span class="line"><span class="comment"># SCRIPTS EXECUTION</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。</span></span><br><span class="line"><span class="comment">#对于脚本的运行结果有以下规则：</span></span><br><span class="line"><span class="comment">#若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10</span></span><br><span class="line"><span class="comment">#若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。</span></span><br><span class="line"><span class="comment">#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。</span></span><br><span class="line"><span class="comment">#一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，</span></span><br><span class="line"><span class="comment">#这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，</span></span><br><span class="line"><span class="comment">#一个是事件的类型，</span></span><br><span class="line"><span class="comment">#一个是事件的描述。</span></span><br><span class="line"><span class="comment">#如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。</span></span><br><span class="line"><span class="comment">#通知脚本</span></span><br><span class="line"><span class="comment"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">sentinel notification-script mymaster /var/redis/notify.sh</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 客户端重新配置主节点参数脚本</span></span><br><span class="line"><span class="comment"># 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。</span></span><br><span class="line"><span class="comment"># 以下参数将会在调用脚本时传给脚本:</span></span><br><span class="line"><span class="comment"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span></span><br><span class="line"><span class="comment"># 目前&lt;state&gt;总是“failover”,</span></span><br><span class="line"><span class="comment"># &lt;role&gt;是“leader”或者“observer”中的一个。</span></span><br><span class="line"><span class="comment"># 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的</span></span><br><span class="line"><span class="comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的。</span></span><br><span class="line"><span class="comment"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span><br></pre></td></tr></table></figure>

<br/>

<h1 id="使用Redis做缓存"><a href="#使用Redis做缓存" class="headerlink" title="使用Redis做缓存"></a>使用Redis做缓存</h1><p>Redis 常用来作为缓存服务器。缓存的好处是减少服务器的压力，数据查询速度快，解决数据响应慢的问题。</p>
<h2 id="Mybatis二级缓存"><a href="#Mybatis二级缓存" class="headerlink" title="Mybatis二级缓存"></a>Mybatis二级缓存</h2><p>Mybatis 的二级缓存是 Mapper 级别的缓存，能够作用与所有会话。由于 Mybatis 的默认二级缓存只能是单机的，如果存在多台服务器访问同一个数据库，二级缓存只会在各自的服务器上生效，而不是多台服务器都能使用同一个二级缓存。<img src="https://s1.imagehub.cc/images/2022/04/18/5afd7713f9a97615dc3a0b1d3bc7db27.png" alt="5afd7713f9a97615dc3a0b1d3bc7db27.png"></p>
<p>我们可以将 Redis 作为 Mybatis 的二级缓存，这样就能实现多台服务器使用同一个二级缓存，所有的缓存数据全部存储在 Redis 服务器上。</p>
<p>实现 Mybatis 提供的 Cache 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现Mybatis的Cache接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMybatisCache</span> <span class="keyword">implements</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RedisTemplate&lt;Object, Object&gt; template;</span><br><span class="line"></span><br><span class="line">   	<span class="comment">// 构造方法必须带一个String类型的参数接收id</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisMybatisCache</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 初始化时通过配置类传入RedisTemplate</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setTemplate</span><span class="params">(RedisTemplate&lt;Object, Object&gt; template)</span> &#123;</span><br><span class="line">        RedisMybatisCache.template = template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object o, Object o1)</span> &#123;</span><br><span class="line">      	<span class="comment">// 向Redis数据库中存入数据</span></span><br><span class="line">        template.opsForValue().set(o, o1, <span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">      	<span class="comment">// 根据Key从Redis数据库中获取值</span></span><br><span class="line">        <span class="keyword">return</span> template.opsForValue().get(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">removeObject</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">      	<span class="comment">// 根据Key删除</span></span><br><span class="line">        <span class="keyword">return</span> template.delete(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">      	<span class="comment">// 由于template中没封装清除操作，只能通过connection来执行</span></span><br><span class="line">				template.execute((RedisCallback&lt;Void&gt;) connection -&gt; &#123;</span><br><span class="line">          	<span class="comment">// 通过connection对象执行清空操作</span></span><br><span class="line">            connection.flushDb();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSize</span><span class="params">()</span> &#123;</span><br><span class="line">      	<span class="comment">// 使用connection对象来获取当前的Key数量</span></span><br><span class="line">        <span class="keyword">return</span> template.execute(RedisServerCommands::dbSize).intValue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    RedisTemplate&lt;Object, Object&gt; template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">      	<span class="comment">// 将RedisTemplate传入RedisMybatisCache</span></span><br><span class="line">        RedisMybatisCache.setTemplate(template);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Mapper 上启用缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要修改缓存实现类implementation为RedisMybatisCache</span></span><br><span class="line"><span class="meta">@CacheNamespace(implementation = RedisMybatisCache.class)</span></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MainMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select name from student where sid = 1&quot;)</span></span><br><span class="line">    String <span class="title function_">getSid</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringBootTestApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    MainMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(mapper.getSid());</span><br><span class="line">        System.out.println(mapper.getSid());</span><br><span class="line">        System.out.println(mapper.getSid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用客户端查看 Redis 数据库，可以看到已经有一条 Mybatis 生成的缓存数据了。</p>
<br/>

<h1 id="三大缓存问题"><a href="#三大缓存问题" class="headerlink" title="三大缓存问题"></a>三大缓存问题</h1><p>Redis 经常用于系统中的缓存，这样可以解决目前 IO 设备无法满足互联网应用海量的读写请求的问题。但缓存存在一些潜在的问题。</p>
<h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>请求的 key 在缓存及数据库中都不存在。数据库查询不存在，不进行缓存设置，导致每次请求都落地到数据库。如果是恶意的请求，将造成数据库压力过大。如发起 id 为 -1 的数据或者特别大的不存在的数据。有可能是黑客利用漏洞攻击从而去压垮应用的数据库。</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/QQ20220418194935.png" alt="QQ20220418194935.png"></p>
<br/>

<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li>缓存空数据</li>
</ol>
<p>当数据库查询到的数据为空时，也将这条数据进行缓存，但缓存的有效性设置得要较短，以免影响正常数据的缓存。但当数据库出现新的 id，且之前缓存已经被设置为空值，那么过期时间内无法访问新增的数据</p>
<ol start="2">
<li>布隆过滤器</li>
</ol>
<p>布隆过滤器是一种数据结构，对所有可能查询的参数以hash形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的压力。</p>
<p>将所有可能存在的 id 存储在一个 bitmap，请求前先经过过滤器判断是否存在。但有误判的可能</p>
<blockquote>
<p>布隆过滤器是一种比较特殊的数据结构，有点类似与HashMap，在业务中我们可能会通过使用HashMap来判断一个值是否存在，它可以在<code>O(1)</code>时间复杂度内返回结果，效率极高，但是受限于存储容量，如果可能需要去判断的值超过亿级别，那么HashMap所占的内存就很可观了。</p>
<p>而<code>BloomFilter</code>解决这个问题的方案很简单。首先用多个bit位去代替HashMap中的数组，这样的话储存空间就下来了，之后就是对 Key 进行多次哈希，将 Key 哈希后的值所对应的 bit 位置为1。</p>
<p>当判断一个元素是否存在时，就去判断这个值哈希出来的比特位是否都为1，如果都为1，那么可能存在，也可能不存在（如下图F）。但是如果有一个bit位不为1，那么这个Key就肯定不存在。</p>
</blockquote>
<img src="https://s1.imagehub.cc/images/2022/04/18/1614350-20201209082514905-1720451943.png" alt="1614350-20201209082514905-1720451943.png" style="zoom: 80%;" />

<p>注意：<code>BloomFilter</code>并不支持删除操作，只支持添加操作。这一点很容易理解，因为你如果要删除数据，就得将对应的 bit 位置为0，但是这个 Key 对应的 bit 位可能其他的 Key 也对应着。</p>
<br/>

<h3 id="缓存空数据与布隆过滤器的比较"><a href="#缓存空数据与布隆过滤器的比较" class="headerlink" title="缓存空数据与布隆过滤器的比较"></a>缓存空数据与布隆过滤器的比较</h3><p>缓存空数据与布隆过滤器都能有效解决缓存穿透问题，但使用场景有着些许不同；</p>
<ul>
<li>当一些恶意攻击查询查询的 key 各不相同，而且数量巨多，此时缓存空数据不是一个好的解决方案。因为它需要存储所有的 Key，内存空间占用高。并且在这种情况下，很多 key 可能只用一次，所以存储下来没有意义。所以对于这种情况而言，使用布隆过滤器是个不错的选择；</li>
<li>而对与空数据的 Key 数量有限、Key 重复请求效率较高的场景而言，可以选择缓存空数据的方案。</li>
</ul>
<br/>

<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><h3 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h3><p>缓存击穿是指当前热点数据存储到期时，多个线程同时并发访问热点数据。因为缓存刚过期，所有并发请求都会到数据库中查询数据。</p>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/QQ20220418195434.png" alt="QQ20220418195434.png"></p>
<br/>

<h3 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li><p>将热点数据设置为永不过期；</p>
</li>
<li><p>加互斥锁：互斥锁可以控制查询数据库的线程访问，但这种方案会导致系统的吞吐量下降，需要根据实际情况使用。</p>
</li>
</ol>
<br/>

<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><h3 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h3><p>缓存雪崩发生有几种情况，比如大量缓存集中在或者缓存同时在大范围中失效，出现了大量请求去访问数据库，从而导致CPU和内存过载，甚至停机。</p>
<p>一个简单的雪崩过程：</p>
<ol>
<li>Redis 集群产生了大面积故障；</li>
<li>缓存失败，此时仍有大量请求去访问 Redis 缓存服务器；</li>
<li>在大量 Redis 请求失败后，这些请求将会去访问数据库；</li>
<li>由于应用的设计依赖于数据库和 Redis 服务，很快就会造成服务器集群的雪崩，最终导致整个系统的瘫痪。</li>
</ol>
<p><img src="https://s1.imagehub.cc/images/2022/04/18/QQ20220418195601.png" alt="QQ20220418195601.png"></p>
<br/>

<h3 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li><p>【事前】高可用缓存：高可用缓存是防止出现整个缓存故障。即使个别节点，机器甚至机房都关闭，系统仍然可以提供服务，Redis 哨兵(Sentinel) 和 Redis 集群(Cluster) 都可以做到高可用；</p>
</li>
<li><p>【事中】缓存降级（临时支持）：当访问次数急剧增加导致服务出现问题时，我们如何确保服务仍然可用。在国内使用比较多的是 Hystrix，它通过熔断、降级、限流三个手段来降低雪崩发生后的损失。只要确保数据库不死，系统总可以响应请求；</p>
</li>
<li><p>【事后】Redis 备份和快速预热：Redis 数据备份和恢复、快速缓存预热。</p>
</li>
</ol>
<br/>

<p>end</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Ssssv11 WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"># Redis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/04/29/Mybatis-Plus/" rel="prev" title="Mybatis-Plus">
                  <i class="fa fa-chevron-left"></i> Mybatis-Plus
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04/29/Docker/" rel="next" title="Docker">
                  Docker <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ssssv11</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script size="90" alpha="0.6" zIndex="-1" src="/js/ribbon/ribbon.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>

    <script src="/js/cursor/explosion.min.js"></script>

