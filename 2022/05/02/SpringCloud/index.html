<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CMicrosoft+YaHei:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CMonaco:300,300italic,400,400italic,700,700italic%7CMenlo:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ssssv11.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="Spring Cloud">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud">
<meta property="og:url" content="https://ssssv11.github.io/2022/05/02/SpringCloud/index.html">
<meta property="og:site_name" content="Ssssv">
<meta property="og:description" content="Spring Cloud">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEDm11.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEDl7D.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEDjHO.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEvvlj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OExeXR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OExr9g.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVCymd.png">
<meta property="og:image" content="https://ssssv11.github.io/Users/houjuncai/Library/Application%20Support/typora-user-images/image-20220504160731567.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVkNuD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVkRbQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVkLb4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVuY0f.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV38Xj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV8Yxe.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVtcYq.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVy6zj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVyoYF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVgROA.png">
<meta property="og:image" content="https://ssssv11.github.io/Users/houjuncai/Library/Application%20Support/typora-user-images/image-20220504195430793.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV2E01.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVRcqA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVhD2T.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV4NQO.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV4hwj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVzzAx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OZ9Rje.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OZeaPH.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OetB0e.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeUXo4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oeault.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OedMC9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oed0gI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oedf8s.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OewAGd.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OewERA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeDRe0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oe623F.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oeg1FP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeRose.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OehOiR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeWkiq.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeInaQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeTWvt.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oe7naD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeL71H.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeOFun.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeXJLn.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeX0WF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeXgdx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OevZUP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OejvAx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Om9w7j.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Om9HgK.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OmPPiR.png">
<meta property="article:published_time" content="2022-05-02T10:51:24.414Z">
<meta property="article:modified_time" content="2022-05-05T12:58:54.756Z">
<meta property="article:author" content="Ssssv11">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2022/05/04/OEDm11.png">


<link rel="canonical" href="https://ssssv11.github.io/2022/05/02/SpringCloud/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>Spring Cloud | Ssssv</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ssssv</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">23</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">40</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">微服务架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-%E6%A6%82%E8%BF%B0"><span class="nav-number">2.</span> <span class="nav-text">Spring Cloud 概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-Netflix"><span class="nav-number">3.</span> <span class="nav-text">Spring Cloud  Netflix</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">3.1.</span> <span class="nav-text">Eureka 注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.1.</span> <span class="nav-text">微服务项目结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">项目创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">数据库与配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">业务实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">服务间调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="nav-number">3.1.3.</span> <span class="nav-text">服务注册与发现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA-Eureka"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">搭建 Eureka</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.1.3.3.</span> <span class="nav-text">负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">3.1.4.</span> <span class="nav-text">注册中心高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">3.1.4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.4.2.</span> <span class="nav-text">配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadBalancer-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.1.5.</span> <span class="nav-text">LoadBalancer 负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringCloud-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">SpringCloud 负载均衡的原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-number">3.1.5.2.</span> <span class="nav-text">自定义负载均衡策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OpenFeign-%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.1.5.3.</span> <span class="nav-text">OpenFeign 实现负载均衡</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-number">3.2.</span> <span class="nav-text">Hystrix 服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E5%99%A8"><span class="nav-number">3.2.1.</span> <span class="nav-text">熔断器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Hystrix"><span class="nav-number">3.2.2.</span> <span class="nav-text">Spring Cloud Hystrix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="nav-number">3.2.3.</span> <span class="nav-text">Hystrix 服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-1"><span class="nav-number">3.2.4.</span> <span class="nav-text">Hystrix 服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E7%8A%B6%E6%80%81"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">熔断状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hystrix-%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">Hystrix 实现熔断机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B"><span class="nav-number">3.2.4.4.</span> <span class="nav-text">过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenFeign-%E5%AE%9E%E7%8E%B0%E9%99%8D%E7%BA%A7"><span class="nav-number">3.2.5.</span> <span class="nav-text">OpenFeign 实现降级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2"><span class="nav-number">3.2.6.</span> <span class="nav-text">监控页面部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateway-%E8%B7%AF%E7%94%B1%E7%BD%91%E5%85%B3"><span class="nav-number">3.3.</span> <span class="nav-text">Gateway 路由网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-%E7%BD%91%E5%85%B3"><span class="nav-number">3.3.1.</span> <span class="nav-text">API 网关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Gateway"><span class="nav-number">3.3.2.</span> <span class="nav-text">Spring Cloud Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Cloud-Gateway-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">Spring Cloud Gateway 核心概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Cloud-Gateway-%E7%9A%84%E7%89%B9%E5%BE%81"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">Spring Cloud Gateway 的特征</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.3.</span> <span class="nav-text">Gateway 的工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Predicate-%E6%96%AD%E8%A8%80"><span class="nav-number">3.3.4.</span> <span class="nav-text">Predicate 断言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E5%85%B3"><span class="nav-number">3.3.5.</span> <span class="nav-text">部署网关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.</span> <span class="nav-text">路由过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Filter-%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">3.3.6.1.</span> <span class="nav-text">Filter 的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GatewayFilter-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.2.</span> <span class="nav-text">GatewayFilter 网关过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.3.</span> <span class="nav-text">配置过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.4.</span> <span class="nav-text">全局过滤器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Config-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">3.4.</span> <span class="nav-text">Config 配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Config"><span class="nav-number">3.4.1.</span> <span class="nav-text">Spring Cloud Config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Config-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">3.4.2.</span> <span class="nav-text">Spring Cloud Config 工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Config-%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">3.4.3.</span> <span class="nav-text">Spring Cloud Config 的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">3.4.4.</span> <span class="nav-text">部署配置中心</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">3.4.5.</span> <span class="nav-text">客户端配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-Alibaba"><span class="nav-number">4.</span> <span class="nav-text">Spring Cloud Alibaba</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ssssv11"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">Ssssv11</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Ssssv11" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ssssv11" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ssssv11.github.io/2022/05/02/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="Ssssv11">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ssssv">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Cloud
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-02 18:51:24" itemprop="dateCreated datePublished" datetime="2022-05-02T18:51:24+08:00">2022-05-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-05-05 20:58:54" itemprop="dateModified" datetime="2022-05-05T20:58:54+08:00">2022-05-05</time>
      </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>Spring Cloud</center>

<span id="more"></span>

<h1 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h1><p>随着越来越多的功能不断地加入到一个 Spring Boot 项目中，接口不断增加，整个系统就要在同一时间内响应更多类型的请求，显然这种扩展方式是不可能无限使用下去的，总有一天这个 Spring Boot 项目会庞大到运行缓慢。并且所有的功能如果都集成在单端上，那么所有的请求都会全部汇集到一台服务器上，对此服务器造成巨大压力。</p>
<p>可以试想一下，如果我们的电脑已经升级到最高配，但是依然在运行项目的时候缓慢，无法同一时间响应成千上万的请求，那么这个问题就已经不是单纯升级机器配置可以解决的了。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEDm11"><img src="https://s1.ax1x.com/2022/05/04/OEDm11.png" alt="OEDm11.png"></a></p>
<p>Martin Fowler 在 2014 年阐述了“微服务”架构，它是一种全新的架构风格。</p>
<ul>
<li>微服务把一个庞大的单体应用拆分为一个个的小型服务，比如我们原来的图书管理项目中，有登录、注册、添加、删除、搜索等功能，那么我们可以将这些功能单独做成一个个小型的 Spring Boot 项目，独立运行。</li>
<li>每个小型的微服务，都可以独立部署和升级，这样，就算整个系统崩溃，那么也只会影响一个服务的运行。</li>
<li>微服务之间使用 HTTP 进行数据交互，不再是单体应用内部交互了，虽然这样会显得更麻烦，但是带来的好处也是很直接的，甚至能突破语言限制，使用不同的编程语言进行微服务开发，只需要使用 HTTP 进行数据交互即可。</li>
<li>我们可以同时购买多台主机来分别部署这些微服务，这样，单机的压力就被分散到多台机器，并且每台机器的配置不一定需要太高，这样就能节省大量的成本，同时安全性也得到很大的保证。</li>
<li>甚至同一个微服务可以同时存在多个，这样当其中一个服务器出现问题时，其他服务器也在运行同样的微服务，这样就可以保证一个微服务的高可用。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEDl7D"><img src="https://s1.ax1x.com/2022/05/04/OEDl7D.png" alt="OEDl7D.png"></a></p>
<p>可见，采用微服务架构，更加能够应对当今时代下的种种考验，传统项目的开发模式，需要进行架构上的升级。</p>
<br>

<h1 id="Spring-Cloud-概述"><a href="#Spring-Cloud-概述" class="headerlink" title="Spring Cloud 概述"></a>Spring Cloud 概述</h1><p>微服务架构的存在的问题：</p>
<ul>
<li>要实现微服务并不是说只需要简单地将项目进行拆分，我们还需要考虑对各个微服务进行管理、监控等，这样我们才能够及时地寻找和排查问题。因此微服务往往需要的是一整套解决方案，包括服务注册和发现、容灾处理、负载均衡、配置管理等。</li>
<li>它不像单体架构那种方便维护，由于部署在多个服务器，我们不得不去保证各个微服务能够稳定运行，在管理难度上肯定是高于传统单体应用的。</li>
<li>在分布式的环境下，单体应用的某些功能可能会变得比较麻烦，比如分布式事务。</li>
</ul>
<p>所以，为了更好地解决这些问题，Spring Cloud 正式登场。</p>
<p>Spring Cloud 是 Spring 提供的一套分布式解决方案，集合了一些大型互联网公司的开源产品，包括诸多组件，共同组成 Spring Cloud 框架。并且它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、熔断机制、数据监控等，都可以用 Spring Boot 的开发风格做到一键启动和部署。</p>
<p>由于中小型公司没有独立开发自己的分布式基础设施的能力，使用 Spring Cloud 解决方案能够以最低的成本应对当前时代的业务发展。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEDjHO"><img src="https://s1.ax1x.com/2022/05/04/OEDjHO.png" alt="OEDjHO.png"></a></p>
<p>Spring Cloud整体架构的亮点是非常明显的，分布式架构下的各个场景，都有对应的组件来处理，比如基于 Netflix 的开源分布式解决方案提供的组件：</p>
<ul>
<li>Eureka  -  实现服务治理（服务注册与发现），我们可以对所有的微服务进行集中管理，包括他们的运行状态、信息等。</li>
<li>Ribbon  -  为服务之间相互调用提供负载均衡算法（被 SpringCloud LoadBalancer 取代）</li>
<li>Hystrix  -  断路器，保护系统，控制故障范围</li>
<li>Zuul   -     API 网关、路由、负载均衡等多种作用（被 SpringCloud Gateway 取代）</li>
<li>Config  -  配置管理，可以实现配置文件集中管理</li>
</ul>
<br>

<h1 id="Spring-Cloud-Netflix"><a href="#Spring-Cloud-Netflix" class="headerlink" title="Spring Cloud  Netflix"></a>Spring Cloud  Netflix</h1><h2 id="Eureka-注册中心"><a href="#Eureka-注册中心" class="headerlink" title="Eureka 注册中心"></a>Eureka 注册中心</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-netflix/docs/current/reference/html/">官方文档</a></p>
<p>在学习过程中需要多看官方文档，详细的功能和用法在官方文档中都写的很清楚。</p>
<h3 id="微服务项目结构"><a href="#微服务项目结构" class="headerlink" title="微服务项目结构"></a>微服务项目结构</h3><p>现在重新设计之前的图书管理系统项目，将原有的大型项目进行拆分。项目拆分一定要尽可能保证单一职责，相同的业务不要在多个微服务中重复出现，如果出现需要借助其他业务完成的服务，那么可以使用服务之间相互调用的形式来实现：</p>
<ul>
<li>登录验证服务：用于处理用户注册、登录、密码重置等。一切与账户相关的内容，包括用户信息获取等。</li>
<li>图书管理服务：用于进行图书添加、删除、更新等操作。图书管理相关的服务，包括图书的存储等和信息获取。</li>
<li>图书借阅服务：交互性较强的服务，需要和登陆验证服务和图书管理服务进行交互。</li>
</ul>
<p>这样我们就需要重新设计项目目录结构，创建多个子项目，每一个子项目都是一个服务，由父项目统一管理依赖。</p>
<br>

<h4 id="项目创建"><a href="#项目创建" class="headerlink" title="项目创建"></a>项目创建</h4><p>首先创建一个 Spring Boot 项目：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEvvlj"><img src="https://s1.ax1x.com/2022/05/04/OEvvlj.png" alt="OEvvlj.png" style="zoom: 33%;" /></a></p>
<p>不需要勾选任何依赖点击创建即可。项目创建完成并初始化后，删除父工程的无用文件，只保留必要文件：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OExeXR"><img src="https://s1.ax1x.com/2022/05/04/OExeXR.png" alt="OExeXR.png" style="zoom:67%;" /></a></p>
<p>然后按照划分的服务创建子工程。创建一个新的 Maven 项目，注意要指定父项目：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OExr9g"><img src="https://s1.ax1x.com/2022/05/04/OExr9g.png" alt="OExr9g.png"></a></p>
<p>子项目创建好后需要在子项目中创建 Spring Boot 的启动主类：</p>
<p>![image-20220504152905751](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504152905751.png)</p>
<p>启动子项目后下方弹窗提示用服务管理窗口管理服务，点击”使用服务”，这样就可以实时查看当前整个大项目中的微服务：</p>
<p>![image-20220504153213744](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504153213744.png)</p>
<br>

<h4 id="数据库与配置"><a href="#数据库与配置" class="headerlink" title="数据库与配置"></a>数据库与配置</h4><p>编写数据库文件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : Main</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 80024</span></span><br><span class="line"><span class="comment"> Source Host           : 43.138.201.82:3306</span></span><br><span class="line"><span class="comment"> Source Schema         : cloudstudy</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 80024</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 04/05/2022 15:36:47</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for db_book</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `db_book`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `db_book` (</span><br><span class="line">  `bid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">desc</span>` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`bid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of db_book</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;深入理解Java虚拟机&#x27;</span>, <span class="string">&#x27;讲解JVM底层原理&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;Java并发编程的艺术&#x27;</span>, <span class="string">&#x27;讲解并发编程的各种技术&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;Java核心技术卷一&#x27;</span>, <span class="string">&#x27;讲解Java的基础知识等&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;计算机网络&#x27;</span>, <span class="string">&#x27;讲解计算机的网络实现原理和知识&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for db_borrow</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `db_borrow`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `db_borrow` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `uid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `bid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `unique_bid_uid` (`uid`,`bid`),</span><br><span class="line">  KEY `f_bid` (`bid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `f_bid` <span class="keyword">FOREIGN</span> KEY (`bid`) <span class="keyword">REFERENCES</span> `db_book` (`bid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `f_uid` <span class="keyword">FOREIGN</span> KEY (`uid`) <span class="keyword">REFERENCES</span> `db_user` (`uid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of db_borrow</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_borrow` (`id`, `uid`, `bid`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_borrow` (`id`, `uid`, `bid`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for db_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `db_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `db_user` (</span><br><span class="line">  `uid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `sex` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`uid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of db_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;小明&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;小红&#x27;</span>, <span class="number">17</span>, <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;小芳&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;小刚&#x27;</span>, <span class="number">17</span>, <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>导入数据库相关的依赖，这里依然使用Mybatis框架，首先在父工程中添加 MySQL 驱动和 Lombok 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于不是每个子模块都需要用到 Mybatis，因此只在父工程中进行版本管理：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在子项目中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后需要为每个服务编写它们的配置文件，给定不同的端口号并绑定数据源，分别为它们创建<code>application.yml</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8101</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://43.138.201.82:3306/cloudstudy</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hjc</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>重新启动三个子项目：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVCymd"><img src="https://s1.ax1x.com/2022/05/04/OVCymd.png" alt="OVCymd.png"></a></p>
<br>

<h4 id="业务实现"><a href="#业务实现" class="headerlink" title="业务实现"></a>业务实现</h4><p>用户查询相关的业务：</p>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_user where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.getUserById(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUserById(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目访问路径就可以获取到数据：</p>
<img src="/Users/houjuncai/Library/Application Support/typora-user-images/image-20220504160731567.png" alt="image-20220504160731567" style="zoom:67%;" />

<p>书本查询相关的业务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer bid;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span>  String desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_book where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookMapper bookMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bookMapper.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVkNuD"><img src="https://s1.ax1x.com/2022/05/04/OVkNuD.png" alt="OVkNuD.png"></a></p>
<p>这样一个完整项目的就拆分成了多个微服务，不同微服务之间是独立进行开发和部署的。</p>
<br>

<h3 id="服务间调用"><a href="#服务间调用" class="headerlink" title="服务间调用"></a>服务间调用</h3><p>完成了用户信息查询和图书信息查询，现在需要完成借阅服务。</p>
<p>借阅服务是一个关联性比较强的服务，它不仅仅需要查询借阅信息，同时可能还需要获取借阅信息下的详细信息，比如具体那个用户借阅了哪本书，并且用户和书籍的详情信息也需要被查询。这种情况下就需要去访问除了借阅表以外的用户表和图书表。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVkRbQ"><img src="https://s1.ax1x.com/2022/05/04/OVkRbQ.png" alt="OVkRbQ.png"></a></p>
<p>但这显然违反了单一职责原则——相同的业务功能不应该重复出现。若需要在此服务中使用其他服务，则可以让一个服务去调用另一个服务来获取信息。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVkLb4"><img src="https://s1.ax1x.com/2022/05/04/OVkLb4.png" alt="OVkLb4.png"></a></p>
<p>这样，图书管理微服务和用户管理微服务相对于借阅记录，就形成了一个生产者和消费者的关系，前者是生产者，后者便是消费者。</p>
<br>

<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>借阅关联信息查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Borrow</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> Integer bid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BorrowMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    List&lt;Borrow&gt; <span class="title function_">getBorrowByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    List&lt;Borrow&gt; <span class="title function_">getBorrowByBid</span><span class="params">(Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where uid = #&#123;uid&#125; adn bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Borrow <span class="title function_">getBorrow</span><span class="params">(Integer uid, Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在我们希望查到借阅信息时返回的是 User 和 Book 的详情信息，因此我们需要添加一个实体类用来封装返回的详细信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowDetail</span> &#123;</span><br><span class="line">    User user;</span><br><span class="line">    List&lt;Book&gt; bookList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但 User 类和 Book 类并不是在这个 service-borrow 的模块中定义，因此我们可以将所有服务需要用到的实体类单独放入另一个一个项目中，然后让这些项目引用集中存放实体类的那个项目，这样就可以保证每个微服务的实体类信息都可以共用了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVuY0f"><img src="https://s1.ax1x.com/2022/05/04/OVuY0f.png" alt="OVuY0f.png" style="zoom:50%;" /></a></p>
<p>再向三个服务中导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hjc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样新的公共实体类都可以在 <code>commons</code> 项目中进行定义。</p>
<p>业务实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">    BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrowList = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">				<span class="comment">// 查询到了借阅的相关信息后该如何调用其他服务？</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行远程服务调用需要使用 RestTemplate：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="comment">// RestTemplate 支持多种方式的远程调用</span></span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        <span class="comment">// 通过调用 getForObject 来请求其他服务并将结果自动封装</span></span><br><span class="line">        <span class="comment">// 获取 User 信息</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  restTemplate.getForObject(<span class="string">&quot;http://localhost:8103/user/&quot;</span> + uid, User.class);</span><br><span class="line">        <span class="comment">// 获取 Book 信息</span></span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://localhost:8101/book/&quot;</span> + b.getBid(), Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8103/user/&quot;</span> + borrow.get(<span class="number">0</span>).getUid(), User.class);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://localhost:8101/book/&quot;</span> + bid, Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByBid</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByBid(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动三个服务后访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV38Xj"><img src="https://s1.ax1x.com/2022/05/04/OV38Xj.png" alt="OV38Xj.png"></a></p>
<p>![image-20220504173354854](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504173354854.png)</p>
<p>注意：一定要保证三个服务都处于开启状态，否则远程调用会失败。</p>
<p>结果正常，远程调用成功。</p>
<br>

<h3 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h3><p>在了解了如何对单体应用进行拆分和如何进行服务之间的相互调用后，还存在一个问题：虽然服务拆分完成，但没有一个比较合理的管理机制，如果单纯只是这样编写，那么在部署和维护起来会是非常麻烦的。</p>
<p>如果某一天这些微服务的端口或是地址大规模地发生改变，我们就不得不将服务之间的调用路径大规模的同步进行修改。因此我们需要削弱服务之间的强关联性。这就需要一个集中管理微服务的平台。</p>
<p>Eureka 能够自动注册并发现微服务，然后对服务的状态、信息进行集中管理。当需要获取其他服务的信息时，只需要向 Eureka 进行查询。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV8Yxe"><img src="https://s1.ax1x.com/2022/05/04/OV8Yxe.png" alt="OV8Yxe.png"></a></p>
<p>这样，服务之间的强关联性就会被进一步削弱。</p>
<br>

<h4 id="搭建-Eureka"><a href="#搭建-Eureka" class="headerlink" title="搭建 Eureka"></a>搭建 Eureka</h4><p>只需要创建一个新的 Maven 项目 service-eureka，然后在父工程中添加 Spring Cloud 依赖的版本控制。</p>
<p>这里选用<code>2021.0.2</code>版本（Spring Cloud 最新的版本命名方式变更了，现在是 <em><strong>YEAR.x</strong></em> 命名方式，具体可以在官网查看：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud#learn%EF%BC%89%EF%BC%9A">https://spring.io/projects/spring-cloud#learn）：</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为新的 eureka 服务导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为 eureka 创建启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：要添加 <code>@EnableEurekaServer</code> 注解。</strong></p>
<p>修改 application.yaml 配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8104</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 由于是作为服务端角色，因此不需要获取服务器 设置为 false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 暂时不需要将自己注册到 Eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 将 eureka 服务端指向自己</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8104/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动 Eureka 并访问，直接输入地址 + 端口即可访问 Eureka 的管理后台：</p>
<p>![image-20220504180634723](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504180634723.png)</p>
<p>可以看到现在还没有任何的服务注册到 Eureka。</p>
<p>然后配置三个微服务，先导入 Eureka 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后修改配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 需要指向 Eureka 服务端地址才能进行注册</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8104/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动服务，然后打开 Eureka 的服务管理页面，可以看到我们刚刚开启的服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVtcYq"><img src="https://s1.ax1x.com/2022/05/04/OVtcYq.png" alt="OVtcYq.png"></a></p>
<p>可以看到三个端口上的服务器已经成功注册到 Eureka，但服务名称显示为 UNKNOWN，我们需要修改配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span></span><br></pre></td></tr></table></figure>

<p>为三个服务分别配置 application name 再次开启服务：</p>
<p>![image-20220504181725981](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504181725981.png)</p>
<p>当我们的服务启动之后，每隔一段时间就会跟 Eureka 发送一次心跳包，这样 Eureka 就能够感知到我们的服务是否处于正常运行状态。</p>
<br>

<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p>在之前如果需要对其他微服务进行远程调用，那么就必须要知道其他服务的地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> template.getForObject(<span class="string">&quot;http://localhost:8103/user/&quot;</span> + uid, User.class);</span><br></pre></td></tr></table></figure>

<p>现在可以通过 Eureka 直接查询得到对应的微服务地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">		<span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="comment">// RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line">      	<span class="comment">// 直接使用 service 的名称</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  restTemplate.getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + uid, User.class);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://bookservice/book/&quot;</span> + b.getBid(), Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="comment">// RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + borrow.get(<span class="number">0</span>).getUid(), User.class);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://bookservice/book/&quot;</span> + bid, Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还需要在 service-borrow 中将 RestTemplate 声明为一个 Bean，然后添加 <code>@LoadBalanced</code> 注解，这样 Eureka 就会对服务的调用进行自动发现，并提供负载均衡：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次访问发现调用正常：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVy6zj"><img src="https://s1.ax1x.com/2022/05/04/OVy6zj.png" alt="OVy6zj.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVyoYF"><img src="https://s1.ax1x.com/2022/05/04/OVyoYF.png" alt="OVyoYF.png"></a></p>
<br>

<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>一个服务可以注册为多个端口不同的相同服务。比如创建多个用户查询服务，将原有的端口配置删除，修改为由 IDEA 中设定的启动参数来决定，这样就可以多创建几个不同端口的启动项：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVgROA"><img src="https://s1.ax1x.com/2022/05/04/OVgROA.png" alt="OVgROA.png" style="zoom:67%;" /></a></p>
<img src="/Users/houjuncai/Library/Application Support/typora-user-images/image-20220504195430793.png" alt="image-20220504195430793" style="zoom: 67%;" />

<p>在 Eureka 中 UserService 出现了两个：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV2E01"><img src="https://s1.ax1x.com/2022/05/04/OV2E01.png" alt="OV2E01.png"></a></p>
<p>再次进行查询 borrow 会发现，两个 UserService 实例被平均分配请求。</p>
<p>这样，服务自动发现以及简单的负载均衡就实现就完成了。并且如果某个微服务挂掉，只要存在其他同样的微服务实例在运行，那么就不会导致整个微服务不可用，极大地保证了安全性。</p>
<br>

<h3 id="注册中心高可用"><a href="#注册中心高可用" class="headerlink" title="注册中心高可用"></a>注册中心高可用</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>虽然 Eureka 能够实现服务注册和发现，但如果 Eureka 服务器崩溃了那么所有需要用到服务发现的微服务也就一起不可用了。可以搭建 Eureka 集群来避免这种问题。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVRcqA"><img src="https://s1.ax1x.com/2022/05/04/OVRcqA.png" alt="OVRcqA.png"></a></p>
<br>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>首先需要修改 Eureka 服务端的配置文件，创建两个配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 由于不支持多个localhost的Eureka服务器，但是又只有本地测试环境，所以就只能自定义主机名称了</span></span><br><span class="line">    <span class="comment"># 主机名称改为eureka01</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka01</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 去掉register-with-eureka选项，让Eureka服务器自己注册到其他Eureka服务器，这样才能相互启用</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 注意这里填写其他Eureka服务器的地址，不用写自己的</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka02:8802/eureka</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka02</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka01:8801/eureka</span></span><br></pre></td></tr></table></figure>

<p>这里由于我们修改成自定义的地址，需要在 hosts 文件中将其解析到 127.0.0.1 才能回到 localhost，Mac 下文件路径为<code>/etc/hosts</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">houjuncai@HXD-MacBook-Pro ~ % sudo vim /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># Host Database</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># localhost is used to configure the loopback interface</span></span><br><span class="line"><span class="comment"># when the system is booting.  Do not change this entry.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">255.255.255.255 broadcasthost</span><br><span class="line">::1             localhost</span><br><span class="line"><span class="comment">## 添加这两行</span></span><br><span class="line">127.0.0.1       eureka01</span><br><span class="line">127.0.0.1       eureka02</span><br><span class="line"><span class="comment"># MacWk.com Hosts Start</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sublime Text</span></span><br><span class="line">127.0.0.1 www.sublimetext.com</span><br><span class="line">127.0.0.1 sublimetext.com</span><br><span class="line">127.0.0.1 license.sublimehq.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># MacWk.com Hosts End</span></span><br></pre></td></tr></table></figure>

<p>对创建的两个配置文件分别添加启动配置，使用 <code>spring.profiles.active</code> 指定启用的配置文件：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVhD2T"><img src="https://s1.ax1x.com/2022/05/04/OVhD2T.png" alt="OVhD2T.png" style="zoom:67%;" /></a></p>
<p>启动两个 Eureka 服务：</p>
<p>![image-20220504202629300](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504202629300.png)</p>
<p>可以看到下方 <code>replicas</code> 中已经包含了另一个 Eureka 服务器的地址，并且是可用状态。</p>
<p>然后修改微服务配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">    	<span class="comment"># 将两个Eureka的地址都加入，这样就算有一个Eureka挂掉，也能完成注册</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8801/eureka,</span> <span class="string">http://localhost:8802/eureka</span></span><br></pre></td></tr></table></figure>

<p>可以看到，服务全部成功注册，并且两个 Eureka 服务端都显示为已注册：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV4NQO"><img src="https://s1.ax1x.com/2022/05/04/OV4NQO.png" alt="OV4NQO.png"></a></p>
<p>模拟当有一个 Eureka 崩溃：将其中一个Eureka服务器关闭掉，可以看到它会直接变成不可用状态：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV4hwj"><img src="https://s1.ax1x.com/2022/05/04/OV4hwj.png" alt="OV4hwj.png"></a></p>
<p>但此时仍然有一个 Eureka 服务可用，因此所有的业务也都可用。如果再次重启刚刚关闭的 Eureka 服务器，则会自动同步其他 Eureka 服务器的数据。</p>
<br>

<h3 id="LoadBalancer-负载均衡"><a href="#LoadBalancer-负载均衡" class="headerlink" title="LoadBalancer 负载均衡"></a>LoadBalancer 负载均衡</h3><p>SpringCloud 的负载均衡是依靠 LoadBalancer 实现的。</p>
<p>在 2020 年前的 SpringCloud 版本是采用 Ribbon 作为负载均衡实现，但 2020 年的版本之后 SpringCloud 把 Ribbon 移除进而使用 LoadBalancer 替代。</p>
<br>

<h4 id="SpringCloud-负载均衡的原理"><a href="#SpringCloud-负载均衡的原理" class="headerlink" title="SpringCloud 负载均衡的原理"></a>SpringCloud 负载均衡的原理</h4><p>在添加 <code>@LoadBalanced</code> 注解后会启用拦截器对我们发起的服务调用请求进行拦截，叫做 <code>LoadBalancerInterceptor</code>，它实现了 <code>ClientHttpRequestInterceptor</code> 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientHttpRequestInterceptor</span> &#123;</span><br><span class="line">    ClientHttpResponse <span class="title function_">intercept</span><span class="params">(HttpRequest request, <span class="type">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一到它主要是对 <code>intercept</code> 方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ClientHttpResponse <span class="title function_">intercept</span><span class="params">(<span class="keyword">final</span> HttpRequest request, <span class="keyword">final</span> <span class="type">byte</span>[] body, <span class="keyword">final</span> ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">URI</span> <span class="variable">originalUri</span> <span class="operator">=</span> request.getURI();</span><br><span class="line">    <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> originalUri.getHost();</span><br><span class="line">    Assert.state(serviceName != <span class="literal">null</span>, <span class="string">&quot;Request URI does not contain a valid hostname: &quot;</span> + originalUri);</span><br><span class="line">    <span class="keyword">return</span> (ClientHttpResponse)<span class="built_in">this</span>.loadBalancer.execute(serviceName, <span class="built_in">this</span>.requestFactory.createRequest(request, body, execution));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以添加断点看看是如何执行的：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVzzAx"><img src="https://s1.ax1x.com/2022/05/04/OVzzAx.png" alt="OVzzAx.png"></a></p>
<p>服务端会在发起请求时执行这些拦截器。</p>
<p>首先，给过来的请求地址并不是一个有效的主机名称而是服务名称，因此需要通过 Eureka 获取真正需要访问的主机名称。</p>
<p><code>loadBalancer.execute()</code>的具体实现为<code>BlockingLoadBalancerClient</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从上一层给进来了服务的名称和具体的请求实体</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">hint</span> <span class="operator">=</span> <span class="built_in">this</span>.getHint(serviceId);</span><br><span class="line">    LoadBalancerRequestAdapter&lt;T, DefaultRequestContext&gt; lbRequest = <span class="keyword">new</span> <span class="title class_">LoadBalancerRequestAdapter</span>(request, <span class="keyword">new</span> <span class="title class_">DefaultRequestContext</span>(request, hint));</span><br><span class="line">    Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = <span class="built_in">this</span>.getSupportedLifecycleProcessors(serviceId);</span><br><span class="line">    supportedLifecycleProcessors.forEach((lifecycle) -&gt; &#123;</span><br><span class="line">        lifecycle.onStart(lbRequest);</span><br><span class="line">    &#125;);</span><br><span class="line">  	<span class="comment">// 在这里调用 choose 方法自动获取对应的服务实例信息</span></span><br><span class="line">    <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> <span class="built_in">this</span>.choose(serviceId, lbRequest);</span><br><span class="line">    <span class="keyword">if</span> (serviceInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">        supportedLifecycleProcessors.forEach((lifecycle) -&gt; &#123;</span><br><span class="line">            lifecycle.onComplete(<span class="keyword">new</span> <span class="title class_">CompletionContext</span>(Status.DISCARD, lbRequest, <span class="keyword">new</span> <span class="title class_">EmptyResponse</span>()));</span><br><span class="line">        &#125;);</span><br><span class="line">      	<span class="comment">// 没有发现任何此服务的实例就抛异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No instances available for &quot;</span> + serviceId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// 成功获取到对应服务的实例，这时就可以发起HTTP请求获取信息了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.execute(serviceId, serviceInstance, lbRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以在进行负载均衡的时候会向 Eureka 发起请求，选择一个可用的对应服务，然后会返回此服务的主机地址等信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OZ9Rje"><img src="https://s1.ax1x.com/2022/05/04/OZ9Rje.png" alt="OZ9Rje.png"></a></p>
<br>

<h4 id="自定义负载均衡策略"><a href="#自定义负载均衡策略" class="headerlink" title="自定义负载均衡策略"></a>自定义负载均衡策略</h4><p>LoadBalancer 默认提供了两种负载均衡策略：</p>
<ul>
<li>RandomLoadBalancer  -  随机分配策略</li>
<li>RoundRobinLoadBalancer  -  轮询分配策略**(默认)**</li>
</ul>
<p>如果希望修改默认的负载均衡策略，需要先创建随机分配策略的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadBalancerConfig</span> &#123;</span><br><span class="line">    <span class="comment">//将官方提供的 RandomLoadBalancer 注册为Bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ReactorServiceInstanceLoadBalancer <span class="title function_">reactorServiceInstanceLoadBalancer</span><span class="params">(Environment environment, LoadBalancerClientFactory loadBalancerClientFactory)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);</span><br><span class="line">        <span class="comment">//返回随机轮询负载均衡方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomLoadBalancer</span>(loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后需要为对应的服务指定负载均衡策略，直接使用注解即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@LoadBalancerClient(value = &quot;userservice&quot;,      // 指定为userservice服务，只要是调用此服务都会使用指定的策略  </span></span><br><span class="line"><span class="meta">                    configuration = LoadBalancerConfig.class)</span>   <span class="comment">// 指定定义好的配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    RestTemplate <span class="title function_">template</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>BlockingLoadBalancerClient</code>中添加断点，观察是否采用指定的策略进行请求：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OZeaPH"><img src="https://s1.ax1x.com/2022/05/04/OZeaPH.png" alt="OZeaPH.png"></a></p>
<br>

<h4 id="OpenFeign-实现负载均衡"><a href="#OpenFeign-实现负载均衡" class="headerlink" title="OpenFeign 实现负载均衡"></a>OpenFeign 实现负载均衡</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/">https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/</a></p>
<p>Feign 和 RestTemplate 一样，是 HTTP 客户端请求工具，但是它的使用方式更加便捷。首先是依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在启动类添加 <code>@EnableFeignClients</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BorrowApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个对应服务的接口类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span>   <span class="comment">// 声明为userservice服务的HTTP请求客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后直接创建所需类型的方法，比如之前的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> template.getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + uid, User.class);</span><br></pre></td></tr></table></figure>

<p>现在可以直接写成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 路径保证和其他微服务提供的一致即可</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> <span class="type">int</span> uid)</span>;  <span class="comment">// 参数和返回值也保持一致</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接注入使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookClient bookClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findUserById(uid);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.findBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findUserById(borrow.get(<span class="number">0</span>).getUid());</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.findBookById(bid))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以观察一下两个用户微服务的调用情况，也是以负载均衡的形式进行的。</p>
<br>

<h2 id="Hystrix-服务熔断"><a href="#Hystrix-服务熔断" class="headerlink" title="Hystrix 服务熔断"></a>Hystrix 服务熔断</h2><p>在微服务架构中，一个应用往往由多个服务组成，这些服务之间相互依赖，依赖关系错综复杂。</p>
<p>例如一个微服务系统中存在 A、B、C、D、E 、F 等多个服务，它们的依赖关系如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OetB0e"><img src="https://s1.ax1x.com/2022/05/05/OetB0e.png" alt="OetB0e.png"></a>](<a target="_blank" rel="noopener" href="https://imgtu.com/i/OeYLee">https://imgtu.com/i/OeYLee</a>)</p>
<p>当服务 E 发生故障或网络延迟时，会出现以下情况：</p>
<ol>
<li>即使其他所有服务都可用，由于服务 E 的不可用，那么用户请求就会处于阻塞状态，等待服务 E 的响应。在高并发的场景下，会导致整个服务器的线程资源在短时间内迅速消耗殆尽。</li>
<li>所有依赖于服务 E 的其他服务，例如服务 B、D 以及 F 也都会处于线程阻塞状态，等待服务 E 的响应，导致这些服务的不可用。</li>
<li>所有依赖服务B、D 和 F 的服务，例如服务 A 和服务 C 也会处于线程阻塞状态，以等待服务 D 和服务 F 的响应，导致服务 A 和服务 C 也不可用。</li>
</ol>
<p>从以上过程可以看出，当微服务系统的一个服务出现故障时，故障会沿着服务的调用链路在系统中疯狂蔓延，最终导致整个微服务系统的瘫痪，这就是“雪崩效应”。为了防止此类事件的发生，微服务架构引入了“熔断器”的一系列服务容错和保护机制。</p>
<br>

<h3 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a>熔断器</h3><p>熔断器（Circuit Breaker）一词来源物理学中的电路知识，它的作用是当线路出现故障时，迅速切断电源以保护电路的安全。</p>
<p>在微服务领域，熔断器最早是由 Martin Fowler 在他发表的 《<a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker</a>》一文中提出。与物理学中的熔断器作用相似，微服务架构中的熔断器能够在某个服务发生故障后，向服务调用方返回一个符合预期的、可处理的降级响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常。这样就保证了服务调用方的线程不会被长时间、不必要地占用，避免故障在微服务系统中的蔓延，防止系统雪崩效应的发生。</p>
<br>

<h3 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud Hystrix"></a>Spring Cloud Hystrix</h3><p>Spring Cloud Hystrix 是一款服务容错与保护组件。它是基于 Netflix 公司的开源组件 Hystrix 实现的，它提供了熔断器功能，能够有效地阻止分布式微服务系统中出现联动故障，以提高微服务系统的弹性。Spring Cloud Hystrix 具有服务降级、服务熔断、线程隔离、请求缓存、请求合并以及实时故障监控等强大功能。</p>
<p>在微服务系统中，Hystrix 能够帮助我们实现以下目标：</p>
<ul>
<li><strong>保护线程资源</strong>：防止单个服务的故障耗尽系统中的所有线程资源。</li>
<li><strong>快速失败机制</strong>：当某个服务发生了故障，不让服务调用方一直等待，而是直接返回请求失败。</li>
<li><strong>提供降级（FallBack）方案</strong>：在请求失败后，提供一个设计好的降级方案，通常是一个兜底方法，当请求失败后即调用该方法。</li>
<li><strong>防止故障扩散</strong>：使用熔断机制，防止故障扩散到其他服务。</li>
<li><strong>监控功能</strong>：提供熔断器故障监控组件 Hystrix Dashboard，随时监控熔断器的状态。</li>
</ul>
<br>

<h3 id="Hystrix-服务降级"><a href="#Hystrix-服务降级" class="headerlink" title="Hystrix 服务降级"></a>Hystrix 服务降级</h3><p>Hystrix 提供了服务降级功能，能够保证当前服务不受其他服务故障的影响，提高服务的健壮性。</p>
<p>服务降级的使用场景有以下 2 种：</p>
<ul>
<li>在服务器压力剧增时，根据实际业务情况及流量，对一些不重要、不紧急的服务进行有策略地不处理或简单处理，从而释放服务器资源以保证核心服务正常运作。</li>
<li>当某些服务不可用时，为了避免长时间等待造成服务卡顿或雪崩效应，而主动执行备用的降级逻辑立刻返回一个友好的提示，以保障主体业务不受影响。</li>
</ul>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>导入Hystrix的依赖（此项目已经停止维护，SpringCloud 依赖中不自带，需要单独导入）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在启动类添加注解开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrix</span>   <span class="comment">//启用Hystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BorrowApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们关闭用户服务和图书服务来模拟服务不可用。因此查询借阅信息的请求无法正常响应，但我们可以提供一个备选方案，当服务出现异常时返回备选方案：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 使用 @HystrixCommand 来指定备选方案</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;onError1&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;onError2&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByBid</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByBid(bid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 备选方案，返回值与主方案一致</span></span><br><span class="line">    BorrowDetail <span class="title function_">onError1</span><span class="params">(<span class="type">int</span> uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(<span class="literal">null</span>, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    BorrowDetail <span class="title function_">onError2</span><span class="params">(<span class="type">int</span> bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(<span class="literal">null</span>, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，虽然服务无法正常运行但依然可以给浏览器正常返回响应数据：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeUXo4"><img src="https://s1.ax1x.com/2022/05/05/OeUXo4.png" alt="OeUXo4.png" style="zoom:67%;" /></a></p>
<p>服务降级是一种比较温柔的解决方案，虽然服务本身的不可用，但是能够保证正常响应数据。</p>
<p>Hystrix 服务降级 FallBack 既可以放在服务端进行，也可以放在客户端进行。</p>
<p>Hystrix 会在以下场景下进行服务降级处理：</p>
<ul>
<li>程序运行异常</li>
<li>服务超时</li>
<li>熔断器处于打开状态</li>
<li>线程池资源耗尽</li>
</ul>
<br>

<h3 id="Hystrix-服务熔断-1"><a href="#Hystrix-服务熔断-1" class="headerlink" title="Hystrix 服务熔断"></a>Hystrix 服务熔断</h3><p>熔断机制是为了应对雪崩效应而出现的一种微服务链路保护机制。</p>
<p>当微服务系统中的某个微服务不可用或响应时间太长时，为了保护系统的整体可用性，熔断器会暂时切断请求对该服务的调用，并快速返回一个友好的错误响应。这种熔断状态不是永久的，在经历了一定的时间后，熔断器会再次检测该微服务是否恢复正常，若服务恢复正常则恢复其调用链路。</p>
<h4 id="熔断状态"><a href="#熔断状态" class="headerlink" title="熔断状态"></a>熔断状态</h4><p>在熔断机制中涉及了三种熔断状态：</p>
<ul>
<li>熔断关闭状态（Closed）：当务访问正常时，熔断器处于关闭状态，服务调用方可以正常地对服务进行调用。</li>
<li>熔断开启状态（Open）：默认情况下，在固定时间内接口调用出错比率达到一个阈值（例如 50%），熔断器会进入熔断开启状态。进入熔断状态后，后续对该服务的调用都会被切断，熔断器会执行本地的降级（FallBack）方法。</li>
<li>半熔断状态（Half-Open）： 在熔断开启一段时间之后，熔断器会进入半熔断状态。在半熔断状态下，熔断器会尝试恢复服务调用方对服务的调用，允许部分请求调用该服务，并监控其调用成功率。如果成功率达到预期，则说明服务已恢复正常，熔断器进入关闭状态；如果成功率仍旧很低，则重新进入熔断开启状态。</li>
</ul>
<p>三种熔断状态之间的转化关系如下图：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oeault"><img src="https://s1.ax1x.com/2022/05/05/Oeault.png" alt="Oeault.png"></a></p>
<br>

<h4 id="Hystrix-实现熔断机制"><a href="#Hystrix-实现熔断机制" class="headerlink" title="Hystrix 实现熔断机制"></a>Hystrix 实现熔断机制</h4><p>在 Spring Cloud 中，熔断机制是通过 Hystrix 实现的。Hystrix 会监控微服务间调用的状况，当失败调用到一定比例时（例如 5 秒内失败 20 次），就会启动熔断机制。</p>
<p>Hystrix 实现服务熔断的步骤如下：</p>
<ol>
<li>当服务的调用出错率达到或超过 Hystix 规定的比率（默认为 50%）后，熔断器进入熔断开启状态。</li>
<li>熔断器进入熔断开启状态后，Hystrix 会启动一个休眠时间窗，在这个时间窗内，该服务的降级逻辑会临时充当业务主逻辑，而原来的业务主逻辑不可用。</li>
<li>当有请求再次调用该服务时，会直接调用降级逻辑快速地返回失败响应，以避免系统雪崩。</li>
<li>当休眠时间窗到期后，Hystrix 会进入半熔断转态，允许部分请求对服务原来的主业务逻辑进行调用，并监控其调用成功率。</li>
<li>如果调用成功率达到预期，则说明服务已恢复正常，Hystrix 进入熔断关闭状态，服务原来的主业务逻辑恢复；否则 Hystrix 重新进入熔断开启状态，休眠时间窗口重新计时，继续重复第 2 到第 5 步。</li>
</ol>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>在方法中添加输出语句方便我们观察：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OedMC9"><img src="https://s1.ax1x.com/2022/05/05/OedMC9.png" alt="OedMC9.png"></a></p>
<p>在刚开始时候，服务会正常地去调用 Controller 对应的方法 <code>findUserBorrows</code>，发现失败然后进入备选方法。但在持续请求一段时间之后，没有再调用这个方法，而是直接调用备选方案，这便是升级到了熔断状态：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oed0gI"><img src="https://s1.ax1x.com/2022/05/05/Oed0gI.png" alt="Oed0gI.png"></a></p>
<p>继续不断地发起请求，过一段时间后会尝试正常执行一次<code>findUserBorrows</code>，但是依然是失败状态，所以继续保持熔断状态：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oedf8s"><img src="https://s1.ax1x.com/2022/05/05/Oedf8s.png" alt="Oedf8s.png"></a></p>
<p>因此，它能够对一段时间内出现的错误进行侦测，当侦测到出错次数过多时，熔断器会打开，所有的请求会直接响应失败。一段时间后，只执行一定数量的请求，如果还是出现错误，那么则继续保持打开状态，否则说明服务恢复正常运行，关闭熔断器。打开关闭的服务再测试：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OewAGd"><img src="https://s1.ax1x.com/2022/05/05/OewAGd.png" alt="OewAGd.png"></a></p>
<br>

<h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OewERA"><img src="https://s1.ax1x.com/2022/05/05/OewERA.png" alt="OewERA.png"></a></p>
<br>

<h3 id="OpenFeign-实现降级"><a href="#OpenFeign-实现降级" class="headerlink" title="OpenFeign 实现降级"></a>OpenFeign 实现降级</h3><p>Hystrix 可以配合 Feign 进行降级。可以对接口中定义的远程调用单独进行降级操作。</p>
<p>比如以用户服务宕机为例，此时远程调用是失败的，也就是说 Controller 中的方法在执行过程中会抛出异常，进而被 Hystrix 监控到并进行服务降级。</p>
<p>实际上导致方法执行异常的根源就是远程调用失败。既然用户服务调用失败，那么可以给这个远程调用添加一个替代方案。如果此远程调用失败，则使用替代方案。</p>
<p>Feign 都是以接口的形式来声明远程调用。当远程调用失效时，我们可以自行对其进行实现。创建一个实现类，对原有的接口方法进行替代方案实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>	<span class="comment">// 需要将其注册为 Bean，Feign 才能自动注入</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFallbackClient</span> <span class="keyword">implements</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">  	<span class="comment">// 自行对其进行实现，并返回替代方案</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">0</span>, <span class="string">&quot;默认用户&quot;</span>, <span class="number">0</span>, <span class="string">&quot;男&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookFallbackClient</span> <span class="keyword">implements</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">findBookById</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">0</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;默认书籍&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现完成后，需要在原有的接口中指定失败替代实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fallback参数指定为自定义的实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;bookservice&quot;, fallback = BookFallbackClient.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后去掉 <code>BorrowController</code> 的 <code>@HystrixCommand</code> 注解和备选方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByBid</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByBid(bid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在配置文件中开启熔断支持：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>启动服务，调用接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeDRe0"><img src="https://s1.ax1x.com/2022/05/05/OeDRe0.png" alt="OeDRe0.png"></a></p>
<p>已经采用替代方案作为结果。</p>
<br>

<h3 id="监控页面部署"><a href="#监控页面部署" class="headerlink" title="监控页面部署"></a>监控页面部署</h3><p>除了对服务的降级和熔断处理，Hystrix 还提供了准实时的调用监控（Hystrix Dashboard）功能，Hystrix 会持续地记录所有通过 Hystrix 发起的请求的执行信息，并以统计报表的形式展示给用户，包括每秒执行请求的数量、成功请求的数量和失败请求的数量等。</p>
<p>创建一个新的项目，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8900</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="comment"># 将localhost添加到白名单，默认是不允许的</span></span><br><span class="line">    <span class="attr">proxy-stream-allow-list:</span> <span class="string">&quot;localhost&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建主类，需要添加 <code>@EnableHystrixDashboard</code> 注解开启管理页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在需要被监控的服务中添加 Actuator 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Actuator 是 SpringBoot 程序的监控系统，可以实现健康检查，记录信息等。在使用之前需要引入 spring-boot-starter-actuator，并做简单的配置。</p>
</blockquote>
<p>这样就可以在 IDEA 中查看到服务的运行状况：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oe623F"><img src="https://s1.ax1x.com/2022/05/05/Oe623F.png" alt="Oe623F.png"></a></p>
<p>为被监控的服务的配置文件添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>启动 Hystrix 管理页面服务，访问 <a target="_blank" rel="noopener" href="http://localhost:8900/hystrix">http://localhost:8900/hystrix</a> :</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oeg1FP"><img src="https://s1.ax1x.com/2022/05/05/Oeg1FP.png" alt="Oeg1FP.png"></a></p>
<p>在中间填写要监控的服务，如借阅服务：<a target="_blank" rel="noopener" href="http://localhost:8102/actuator/hystrix.stream%EF%BC%8C%E7%84%B6%E5%90%8E%E7%82%B9%E5%87%BB">http://localhost:8102/actuator/hystrix.stream，然后点击</a> Monitor Stream 进入监控页面：</p>
<p>![image-20220505160915704](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220505160915704.png)</p>
<br>

<h2 id="Gateway-路由网关"><a href="#Gateway-路由网关" class="headerlink" title="Gateway 路由网关"></a>Gateway 路由网关</h2><p>在微服务架构中，一个系统往往由多个微服务组成，而这些服务可能部署在不同机房、不同地区、不同域名下。这种情况下，客户端（例如浏览器、手机、软件工具等）想要直接请求这些服务，就需要知道它们具体的地址信息，例如 IP 地址、端口号等。</p>
<p>这种客户端直接请求服务的方式存在以下问题：</p>
<ul>
<li>当服务数量众多时，客户端需要维护大量的服务地址，这对于客户端来说，是非常繁琐复杂的。</li>
<li>在某些场景下可能会存在跨域请求的问题。</li>
<li>身份认证的难度大，每个微服务需要独立认证。</li>
</ul>
<p>我们可以通过 API 网关来解决这些问题。</p>
<br>

<h3 id="API-网关"><a href="#API-网关" class="headerlink" title="API 网关"></a>API 网关</h3><p>API 网关是一个搭建在客户端和微服务之间的服务，我们可以在 API 网关中处理一些非业务功能的逻辑，例如权限验证、监控、缓存、请求路由等。</p>
<p>API 网关就像整个微服务系统的门面一样，是系统对外的唯一入口。有了它，客户端会先将请求发送到 API 网关，然后由 API 网关根据请求的标识信息将请求转发到微服务实例。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeRose"><img src="https://s1.ax1x.com/2022/05/05/OeRose.png" alt="OeRose.png"></a></p>
<p>对于服务数量众多、复杂度较高、规模比较大的系统来说，使用 API 网关具有以下好处：</p>
<ul>
<li>客户端通过 API 网关与微服务交互时，客户端只需要知道 API 网关地址即可，而不需要维护大量的服务地址，简化了客户端的开发。</li>
<li>客户端直接与 API 网关通信，能够减少客户端与各个服务的交互次数。</li>
<li>客户端与后端的服务耦合度降低。</li>
<li>节省流量，提高性能，提升用户体验。</li>
<li>API 网关还提供了安全、流控、过滤、缓存、计费以及监控等 API 管理功能。</li>
</ul>
<p>常见的 API 网关实现方案主要有以下 5 种：</p>
<ul>
<li>Spring Cloud Gateway</li>
<li>Spring Cloud Netflix Zuul</li>
<li>Kong</li>
<li>Nginx + Lua</li>
<li>Traefik</li>
</ul>
<p>在之前，路由的实现一般使用 Zuul，但它已经停更。现在新出现了由 Spring Cloud 官方开发的 Gateway 路由，它相比 Zuul 不仅性能上得到了一定的提升，并且是官方推出，契合性也会更好，因此我们使用 Gateway 路由。</p>
<br>

<h3 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h3><p>Spring Cloud Gateway 是 Spring Cloud 团队基于 Spring 5.0、Spring Boot 2.0 和 Project Reactor 等技术开发的高性能 API 网关组件。</p>
<p>Spring Cloud Gateway 旨在提供一种简单而有效的途径来发送 API，并为它们提供横切关注点，例如：安全性，监控&#x2F;指标和弹性。 </p>
<blockquote>
<p>Spring Cloud Gateway 是基于 WebFlux 框架实现的，而 WebFlux 框架底层则使用了高性能的 Reactor 模式通信框架 Netty。</p>
</blockquote>
<h4 id="Spring-Cloud-Gateway-核心概念"><a href="#Spring-Cloud-Gateway-核心概念" class="headerlink" title="Spring Cloud Gateway 核心概念"></a>Spring Cloud Gateway 核心概念</h4><p>Spring Cloud GateWay 最主要的功能就是路由转发，而在定义转发规则时主要涉及了以下三个核心概念，如下表。</p>
<table>
<thead>
<tr>
<th>核心概念</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Route（路由）</td>
<td>网关最基本的模块。它由一个 ID、一个目标 URI、一组断言（Predicate）和一组过滤器（Filter）组成。</td>
</tr>
<tr>
<td>Predicate（断言）</td>
<td>路由转发的判断条件，我们可以通过 Predicate 对 HTTP 请求进行匹配，例如请求方式、请求路径、请求头、参数等，如果请求与断言匹配成功，则将请求转发到相应的服务。</td>
</tr>
<tr>
<td>Filter（过滤器）</td>
<td>过滤器，我们可以使用它对请求进行拦截和修改，还可以使用它对上文的响应进行再处理。</td>
</tr>
</tbody></table>
<blockquote>
<p>注意：其中 Route 和 Predicate 必须同时声明。</p>
</blockquote>
<h4 id="Spring-Cloud-Gateway-的特征"><a href="#Spring-Cloud-Gateway-的特征" class="headerlink" title="Spring Cloud Gateway 的特征"></a>Spring Cloud Gateway 的特征</h4><p>Spring Cloud Gateway 具有以下特性：</p>
<ul>
<li>基于 Spring Framework 5、Project Reactor 和 Spring Boot 2.0 构建。</li>
<li>能够在任意请求属性上匹配路由。</li>
<li>predicates（断言） 和 filters（过滤器）是特定于路由的。</li>
<li>集成了 Hystrix 熔断器。</li>
<li>集成了 Spring Cloud DiscoveryClient（服务发现客户端）。</li>
<li>易于编写断言和过滤器。</li>
<li>能够限制请求频率。</li>
<li>能够重写请求路径。</li>
</ul>
<p>一般情况下可能并不是所有的微服务都需要直接暴露给外部调用，因此可以使用路由机制来添加一层防护，让所有的请求全部通过路由来转发到各个微服务，并且转发给多个相同微服务实例并实现负载均衡。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OehOiR"><img src="https://s1.ax1x.com/2022/05/05/OehOiR.png" alt="OehOiR.png"></a></p>
<h3 id="Gateway-的工作流程"><a href="#Gateway-的工作流程" class="headerlink" title="Gateway 的工作流程"></a>Gateway 的工作流程</h3><p>Spring Cloud Gateway 工作流程如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeWkiq"><img src="https://s1.ax1x.com/2022/05/05/OeWkiq.png" alt="OeWkiq.png"></a></p>
<p>Spring Cloud Gateway 工作流程说明如下：</p>
<ol>
<li>客户端将请求发送到 Spring Cloud Gateway 上。</li>
<li>Spring Cloud Gateway 通过 Gateway Handler Mapping 找到与请求相匹配的路由，将其发送给 Gateway Web Handler。</li>
<li>Gateway Web Handler 通过指定的过滤器链（Filter Chain），将请求转发到实际的服务节点中，执行业务逻辑返回响应结果。</li>
<li>过滤器之间用虚线分开是因为过滤器可能会在转发请求之前（pre）或之后（post）执行业务逻辑。</li>
<li>过滤器（Filter）可以在请求被转发到服务端前，对请求进行拦截和修改，例如参数校验、权限校验、流量监控、日志输出以及协议转换等。</li>
<li>过滤器可以在响应返回客户端之前，对响应进行拦截和再处理，例如修改响应内容或响应头、日志输出、流量监控等。</li>
<li>响应原路返回给客户端。</li>
</ol>
<p>总而言之，客户端发送到 Spring Cloud Gateway 的请求需要通过一定的匹配条件，才能定位到真正的服务节点。在将请求转发到服务进行处理的过程前后（pre 和 post），我们还可以对请求和响应进行一些精细化控制。</p>
<p>Predicate 就是路由的匹配条件，而 Filter 就是对请求和响应进行精细化控制的工具。有了这两个元素，再加上目标 URI，就可以实现一个具体的路由了。</p>
<h3 id="Predicate-断言"><a href="#Predicate-断言" class="headerlink" title="Predicate 断言"></a>Predicate 断言</h3><p>Spring Cloud Gateway 通过 Predicate 断言来实现 Route 路由的匹配规则。简单点说，Predicate 是路由转发的判断条件，请求只有满足了 Predicate 的条件，才会被转发到指定的服务上进行处理。</p>
<p>使用 Predicate 断言需要注意以下 3 点：</p>
<ul>
<li>Route 路由与 Predicate 断言的对应关系为“一对多”，一个路由可以包含多个不同断言。</li>
<li>一个请求想要转发到指定的路由上，就必须同时匹配路由上的所有断言。</li>
<li>当一个请求同时满足多个路由的断言条件时，请求只会被首个成功匹配的路由转发。</li>
</ul>
<p>常见的 Predicate 断言如下表（假设转发的 URI 为 <a href="http://localhost:8001）。">http://localhost:8001）。</a></p>
<table>
<thead>
<tr>
<th>断言</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Path</td>
<td>- Path&#x3D;&#x2F;dept&#x2F;list&#x2F;**</td>
<td>当请求路径与 &#x2F;dept&#x2F;list&#x2F;** 匹配时，该请求才能被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Before</td>
<td>- Before&#x3D;2022-5-5T11:47:34.255+08:00[Asia&#x2F;Shanghai]</td>
<td>在 2021 年 10 月 20 日 11 时 47 分 34.255 秒之前的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>After</td>
<td>- After&#x3D;2022-5-5T11:47:34.255+08:00[Asia&#x2F;Shanghai]</td>
<td>在 2021 年 10 月 20 日 11 时 47 分 34.255 秒之后的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Between</td>
<td>- Between&#x3D;2022-5-5T15:18:33.226+08:00[Asia&#x2F;Shanghai],2022-5-5T15:23:33.226+08:00[Asia&#x2F;Shanghai]</td>
<td>在 2021 年 10 月 20 日 15 时 18 分 33.226 秒 到 2021 年 10 月 20 日 15 时 23 分 33.226 秒之间的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 服务器上。</td>
</tr>
<tr>
<td>Cookie</td>
<td>- Cookie&#x3D;name,c.biancheng.net</td>
<td>携带 Cookie 且 Cookie 的内容为 name&#x3D;c.biancheng.net 的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Header</td>
<td>- Header&#x3D;X-Request-Id,\d+</td>
<td>请求头上携带属性 X-Request-Id 且属性值为整数的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Method</td>
<td>- Method&#x3D;GET</td>
<td>只有 GET 请求才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
</tbody></table>
<p>更多参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">官方文档</a>。</p>
<br>

<h3 id="部署网关"><a href="#部署网关" class="headerlink" title="部署网关"></a>部署网关</h3><p>创建一个新项目作为网关，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一个依赖就是网关的依赖，而第二个则跟其他微服务一样需要注册到 Eureka 才能生效。注意它使用的是 WebFlux 框架，因此不能添加 Web 依赖。</p>
<p>完善配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8801/eureka,</span> <span class="string">http://localhost:8802/eureka</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br></pre></td></tr></table></figure>

<p>编写启动类并启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeInaQ"><img src="https://s1.ax1x.com/2022/05/05/OeInaQ.png" alt="OeInaQ.png"></a></p>
<p>但现在还未对网关进行任何的路由配置，因此需要再在配置文件为其添加路由功能的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">    	<span class="comment"># 配置路由，注意这里是个列表，每一项都包含了很多信息</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">borrow-service</span>   <span class="comment"># 路由名称</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://borrowservice</span>  <span class="comment"># 路由的地址，lb表示使用负载均衡到微服务，也可以使用http正常转发</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由规则，断言什么请求会被路由</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/borrow/**</span>  <span class="comment"># 只要是访问的这个路径，一律都被路由到上面指定的服务</span></span><br></pre></td></tr></table></figure>

<p>启动网关，访问 <a target="_blank" rel="noopener" href="http://localhost:8500/borrow/user/1%EF%BC%9A">http://localhost:8500/borrow/user/1：</a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeTWvt"><img src="https://s1.ax1x.com/2022/05/05/OeTWvt.png" alt="OeTWvt.png"></a></p>
<p>现在可以直接通过路由来访问服务了，此时依然可以通过原有的服务地址进行访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oe7naD"><img src="https://s1.ax1x.com/2022/05/05/Oe7naD.png" alt="Oe7naD.png"></a></p>
<p>这样就可以将不需要外网直接访问的微服务全部放到内网环境下，而只依靠网关来对外进行交涉。</p>
<br>

<h3 id="路由过滤器"><a href="#路由过滤器" class="headerlink" title="路由过滤器"></a>路由过滤器</h3><p>通常情况下，出于安全方面的考虑，服务端提供的服务往往都会有一定的校验逻辑，例如用户登陆状态校验、签名校验等。</p>
<p>在微服务架构中，系统由多个微服务组成，所有这些服务都需要这些校验逻辑，此时我们就可以将这些校验逻辑写到 Spring Cloud Gateway 的 Filter 过滤器中。</p>
<br>

<h4 id="Filter-的分类"><a href="#Filter-的分类" class="headerlink" title="Filter 的分类"></a>Filter 的分类</h4><p>Spring Cloud Gateway 提供了以下两种类型的过滤器，可以对请求和响应进行精细化控制。</p>
<table>
<thead>
<tr>
<th>过滤器类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Pre 类型</td>
<td>这种过滤器在请求被转发到微服务之前可以对请求进行拦截和修改，例如参数校验、权限校验、流量监控、日志输出以及协议转换等操作。</td>
</tr>
<tr>
<td>Post 类型</td>
<td>这种过滤器在微服务对请求做出响应后可以对响应进行拦截和再处理，例如修改响应内容或响应头、日志输出、流量监控等。</td>
</tr>
</tbody></table>
<p>按照作用范围划分，Spring Cloud gateway 的 Filter 可以分为 2 类：</p>
<ul>
<li>GatewayFilter：应用在单个路由或者一组路由上的过滤器。</li>
<li>GlobalFilter：应用在所有的路由上的过滤器。</li>
</ul>
<br>

<h4 id="GatewayFilter-网关过滤器"><a href="#GatewayFilter-网关过滤器" class="headerlink" title="GatewayFilter 网关过滤器"></a>GatewayFilter 网关过滤器</h4><p>GatewayFilter 是 Spring Cloud Gateway 网关中提供的一种应用在单个或一组路由上的过滤器。它可以对单个路由或者一组路由上传入的请求和传出响应进行拦截，并实现一些与业务无关的功能，比如登陆状态校验、签名校验、权限校验、日志输出、流量监控等。</p>
<p>Spring Cloud Gateway 内置了很多种 GatewayFilter，下表中列举了几种常用的网关过滤器及其使用示例。</p>
<table>
<thead>
<tr>
<th>路由过滤器</th>
<th>描述</th>
<th>参数</th>
<th>使用示例</th>
</tr>
</thead>
<tbody><tr>
<td>AddRequestHeader</td>
<td>拦截传入的请求，并在请求上添加一个指定的请求头参数。</td>
<td>name：需要添加的请求头参数的 key； value：需要添加的请求头参数的 value。</td>
<td>- AddRequestHeader&#x3D;my-request-header,1024</td>
</tr>
<tr>
<td>AddRequestParameter</td>
<td>拦截传入的请求，并在请求上添加一个指定的请求参数。</td>
<td>name：需要添加的请求参数的 key； value：需要添加的请求参数的 value。</td>
<td>- AddRequestParameter&#x3D;my-request-param,c.biancheng.net</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>拦截响应，并在响应上添加一个指定的响应头参数。</td>
<td>name：需要添加的响应头的 key； value：需要添加的响应头的 value。</td>
<td>- AddResponseHeader&#x3D;my-response-header,c.biancheng.net</td>
</tr>
<tr>
<td>PrefixPath</td>
<td>拦截传入的请求，并在请求路径增加一个指定的前缀。</td>
<td>prefix：需要增加的路径前缀。</td>
<td>- PrefixPath&#x3D;&#x2F;consumer</td>
</tr>
<tr>
<td>PreserveHostHeader</td>
<td>转发请求时，保持客户端的 Host 信息不变，然后将它传递到提供具体服务的微服务中。</td>
<td>无</td>
<td>- PreserveHostHeader</td>
</tr>
<tr>
<td>RemoveRequestHeader</td>
<td>移除请求头中指定的参数。</td>
<td>name：需要移除的请求头的 key。</td>
<td>- RemoveRequestHeader&#x3D;my-request-header</td>
</tr>
<tr>
<td>RemoveResponseHeader</td>
<td>移除响应头中指定的参数。</td>
<td>name：需要移除的响应头。</td>
<td>- RemoveResponseHeader&#x3D;my-response-header</td>
</tr>
<tr>
<td>RemoveRequestParameter</td>
<td>移除指定的请求参数。</td>
<td>name：需要移除的请求参数。</td>
<td>- RemoveRequestParameter&#x3D;my-request-param</td>
</tr>
<tr>
<td>RequestSize</td>
<td>配置请求体的大小，当请求体过大时，将会返回 413 Payload Too Large。</td>
<td>maxSize：请求体的大小。</td>
<td>- name: RequestSize   args:    maxSize: 5000000</td>
</tr>
</tbody></table>
<p>更多参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">官方文档</a></p>
<br>

<h4 id="配置过滤器"><a href="#配置过滤器" class="headerlink" title="配置过滤器"></a>配置过滤器</h4><p>比如希望请求到达时，在请求头中添加一些信息再转发给服务，这时候就可以使用路由过滤器来完成，只需要对配置文件进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">borrow-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://borrowservice</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/borrow/**</span></span><br><span class="line">      <span class="comment"># 继续添加新的路由配置，以书籍管理服务为例</span></span><br><span class="line">      <span class="comment"># 一定要对齐routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">book-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://bookservice</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/book/**</span></span><br><span class="line">        <span class="attr">filters:</span>   <span class="comment"># 添加过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=Test,</span> <span class="string">HelloWorld!</span></span><br><span class="line">        <span class="comment"># AddRequestHeader 是添加请求头信息</span></span><br></pre></td></tr></table></figure>

<p>在 BookController 中获取并输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BookService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> <span class="type">int</span> bid,</span></span><br><span class="line"><span class="params">                      HttpServletRequest request)</span>&#123;</span><br><span class="line">        System.out.println(request.getHeader(<span class="string">&quot;Test&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> service.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们正常通过端口号访问和通过 Gateway 访问时页面显示相同：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeL71H"><img src="https://s1.ax1x.com/2022/05/05/OeL71H.png" alt="OeL71H.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeOFun"><img src="https://s1.ax1x.com/2022/05/05/OeOFun.png" alt="OeOFun.png"></a></p>
<p>但通过 Gateway 访问可以成功获取到由网关添加的请求头信息。</p>
<br>

<h4 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h4><p>GlobalFilter 是一种作用于所有的路由上的全局过滤器，通过它，我们可以实现一些统一化的业务功能，例如权限认证、IP 访问限制等。当某个请求被路由匹配时，那么所有的 GlobalFilter 会和该路由自身配置的 GatewayFilter 组合成一个过滤器链。</p>
<p>Spring Cloud Gateway 为我们提供了多种默认的 GlobalFilter，例如与转发、路由、负载均衡等相关的全局过滤器。但在实际的项目开发中，通常我们都会自定义一些自己的 GlobalFilter 全局过滤器以满足我们自身的业务需求，而很少直接使用 Spring Cloud Config 提供这些默认的 GlobalFilter。</p>
<blockquote>
<p>关于默认的全局过滤器的详细内容，请参考 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#global-filters">Spring Cloud 官网</a>。</p>
</blockquote>
<p>比如要实现拦截没有携带指定请求参数的请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>   <span class="comment">// 需要注册为Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line">    <span class="comment">// 只需要实现此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;   </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写判断：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>   <span class="comment">// 需要注册为Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line">    <span class="comment">// 只需要实现此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 先获取ServerHttpRequest对象，注意不是HttpServletRequest</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 打印所有的请求参数</span></span><br><span class="line">        System.out.println(request.getQueryParams());</span><br><span class="line">        <span class="comment">// 判断是否包含test参数，且参数值为1</span></span><br><span class="line">        List&lt;String&gt; value = request.getQueryParams().get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(value != <span class="literal">null</span> &amp;&amp; value.contains(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 将ServerWebExchange向过滤链的下一级传递（跟JavaWeb中的过滤器相似）</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不再传递，返回响应</span></span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们不携带参数访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeXJLn"><img src="https://s1.ax1x.com/2022/05/05/OeXJLn.png" alt="OeXJLn.png"></a></p>
<p>携带 test&#x3D;1 访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeX0WF"><img src="https://s1.ax1x.com/2022/05/05/OeX0WF.png" alt="OeX0WF.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeXgdx"><img src="https://s1.ax1x.com/2022/05/05/OeXgdx.png" alt="OeXgdx.png"></a></p>
<p>成功实现规则判断和拦截操作。</p>
<p>过滤器可以存在多个，我们可以手动指定过滤器之间的顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;   <span class="comment">//实现Ordered接口</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Order 的值越小优先级越高，并且无论是在配置文件中编写的单个路由过滤器还是全局路由过滤器，都会受 Order 值影响（配置文件中单个路由的过滤器 Order 值按从上往下的顺序从 1 开始递增），最终是按照 Order 值决定哪个过滤器优先执行，当 Order 值一样时，全局路由过滤器执行优先于单独的路由过滤器执行。</p>
<br>

<h2 id="Config-配置中心"><a href="#Config-配置中心" class="headerlink" title="Config 配置中心"></a>Config 配置中心</h2><p>在分布式微服务系统中，几乎所有服务的运行都离不开配置文件的支持，这些配置文件通常由各个服务自行管理，以 properties 或 yml 格式保存在各个微服务的类路径下，例如 application.properties 或 application.yml 等。</p>
<p>这种将配置文件散落在各个服务中的管理方式，存在以下问题：</p>
<ul>
<li><strong>管理难度大</strong>：配置文件散落在各个微服务中，难以管理。</li>
<li><strong>安全性低</strong>：配置跟随源代码保存在代码库中，容易造成配置泄漏。</li>
<li><strong>时效性差</strong>：微服务中的配置修改后，必须重启服务，否则无法生效。</li>
<li><strong>局限性明显</strong>：无法支持动态调整，例如日志开关、功能开关。</li>
</ul>
<p>为了解决这些问题，通常我们都会使用配置中心对配置进行统一管理。市面上开源的配置中心有很多，例如百度的 Disconf、淘宝的 diamond、360 的 QConf、携程的 Apollo 等都是解决这类问题的。Spring Cloud 也有自己的分布式配置中心，那就是 Spring Cloud Config。</p>
<br>

<h3 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h3><p>Spring Cloud Config 是由 Spring Cloud 团队开发的项目，它可以为微服务架构中各个微服务提供集中化的外部配置支持。</p>
<p>简单点说就是，Spring Cloud Config 可以将各个微服务的配置文件集中存储在一个外部的存储仓库或系统（例如 Git 、SVN 等）中，对配置的统一管理，以支持各个微服务的运行。</p>
<p>Spring Cloud Config 包含以下两个部分：</p>
<ul>
<li>Config Server：也被称为分布式配置中心，它是一个独立运行的微服务应用，用来连接配置仓库并为客户端提供获取配置信息、加密信息和解密信息的访问接口。</li>
<li>Config Client：指的是微服务架构中的各个微服务，它们通过 Config Server 对配置进行管理，并从 Config Sever 中获取和加载配置信息。</li>
</ul>
<p>Spring Cloud Config 默认使用 Git 存储配置信息，因此使用 Spirng Cloud Config 构建的配置服务器天然就支持对微服务配置的版本管理。我们可以使用 Git 客户端工具方便地对配置内容进行管理和访问。除了 Git 外，Spring Cloud Config 还提供了对其他存储方式的支持，例如 SVN、本地化文件系统等。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OevZUP"><img src="https://s1.ax1x.com/2022/05/05/OevZUP.png" alt="OevZUP.png"></a></p>
<br>

<h3 id="Spring-Cloud-Config-工作原理"><a href="#Spring-Cloud-Config-工作原理" class="headerlink" title="Spring Cloud Config 工作原理"></a>Spring Cloud Config 工作原理</h3><p>Spring Cloud Config 工作原理如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OejvAx"><img src="https://s1.ax1x.com/2022/05/05/OejvAx.png" alt="OejvAx.png"></a><br>Spring Cloud Config 工作流程如下：</p>
<ol>
<li>开发或运维人员提交配置文件到远程的 Git 仓库。</li>
<li>Config 服务端（分布式配置中心）负责连接配置仓库 Git，并对 Config 客户端暴露获取配置的接口。</li>
<li>Config 客户端通过 Config 服务端暴露出来的接口，拉取配置仓库中的配置。</li>
<li>Config 客户端获取到配置信息，以支持服务的运行。</li>
</ol>
<br>

<h3 id="Spring-Cloud-Config-的特点"><a href="#Spring-Cloud-Config-的特点" class="headerlink" title="Spring Cloud Config 的特点"></a>Spring Cloud Config 的特点</h3><p>Spring Cloud Config 具有以下特点：</p>
<ul>
<li>Spring Cloud Config 由 Spring Cloud 团队开发，可以说是 Spring 的亲儿子，能够与 Spring 的生态体系无缝集成。</li>
<li>Spring Cloud Config 将所有微服务的配置文件集中存储在一个外部的存储仓库或系统（例如 Git）中，统一管理。</li>
<li>Spring Cloud Config 配置中心将配置以 REST 接口的形式暴露给各个微服务，以方便各个微服务获取。</li>
<li>微服务可以通过 Spring Cloud Config 向配置中心统一拉取属于它们自己的配置信息。</li>
<li>当配置发生变化时，微服务不需要重启即可感知到配置的变化，并自动获取和应用最新配置。</li>
<li>一个应用可能有多个环境，例如开发（dev）环境、测试（test）环境、生产（prod）环境等等，开发人员可以通过 Spring Cloud Config 对不同环境的各配置进行管理，且能够确保应用在环境迁移后仍然有完整的配置支持其正常运行。</li>
</ul>
<p>更多参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-config/docs/current/reference/html/">官方文档</a></p>
<br>

<h3 id="部署配置中心"><a href="#部署配置中心" class="headerlink" title="部署配置中心"></a>部署配置中心</h3><p>创建一个新的项目，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8700</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">configserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8801/eureka,</span> <span class="string">http://localhost:8802/eureka</span></span><br></pre></td></tr></table></figure>

<p>这里以本地仓库为例。</p>
<p>首先在项目目录下创建一个本地Git仓库，打开终端，在桌面上创建一个新的本地仓库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">houjuncai@HXD-MacBook-Pro IdeaProjects % <span class="built_in">mkdir</span> config-repo</span><br><span class="line">houjuncai@HXD-MacBook-Pro IdeaProjects % <span class="built_in">cd</span> config-repo</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo % git init</span><br><span class="line">hint: Using <span class="string">&#x27;master&#x27;</span> as the name <span class="keyword">for</span> the initial branch. This default branch name</span><br><span class="line">hint: is subject to change. To configure the initial branch name to use <span class="keyword">in</span> all</span><br><span class="line">hint: of your new repositories, <span class="built_in">which</span> will suppress this warning, call:</span><br><span class="line">hint:</span><br><span class="line">hint: 	git config --global init.defaultBranch &lt;name&gt;</span><br><span class="line">hint:</span><br><span class="line">hint: Names commonly chosen instead of <span class="string">&#x27;master&#x27;</span> are <span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;trunk&#x27;</span> and</span><br><span class="line">hint: <span class="string">&#x27;development&#x27;</span>. The just-created branch can be renamed via this <span class="built_in">command</span>:</span><br><span class="line">hint:</span><br><span class="line">hint: 	git branch -m &lt;name&gt;</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /Users/houjuncai/IdeaProjects/config-repo/.git/</span><br></pre></td></tr></table></figure>

<p>然后在文件夹中创建配置文件，名称最好是 {服务名称}-{环境}.yml：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">houjuncai@HXD-MacBook-Pro config-repo % vim bookservice-dev.yml</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo % git add .</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo % git commit -m <span class="string">&quot;Init commit&quot;</span></span><br><span class="line">[master (root-commit) 3909e58] Init commit</span><br><span class="line"> 1 file changed, 6 insertions(+)</span><br><span class="line"> create mode 100644 bookservice-dev.yml</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo %</span><br></pre></td></tr></table></figure>

<p>vim 编辑：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  datasource:</span></span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line"><span class="symbol">    url:</span> jdbc:mysql:<span class="comment">//43.138.201.82:3306/cloudstudy</span></span><br><span class="line"><span class="symbol">    username:</span> hjc</span><br><span class="line"><span class="symbol">    password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>在配置文件中添加本地仓库的信息（远程仓库同理），<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-config/docs/current/reference/html/#_git_backend">详细使用教程</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">        	<span class="comment"># 这里填写的是本地仓库地址，远程仓库直接填写远程仓库地址 http://git...</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">file://$&#123;user.home&#125;/IdeaProjects/config-repo</span></span><br><span class="line">          <span class="comment"># 默认分支设定为你自己本地或是远程分支的名称</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>Spring Cloud Config 规定了一套配置文件访问规则，如下表。</p>
<table>
<thead>
<tr>
<th>访问规则</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;{application}&#x2F;{profile}[&#x2F;{label}]</td>
<td>&#x2F;config&#x2F;dev&#x2F;master</td>
</tr>
<tr>
<td>&#x2F;{application}-{profile}.{suffix}</td>
<td>&#x2F;config-dev.yml</td>
</tr>
<tr>
<td>&#x2F;{label}&#x2F;{application}-{profile}.{suffix}</td>
<td>&#x2F;master&#x2F;config-dev.yml</td>
</tr>
<tr>
<td>访问规则内各参数说明如下。</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>{application}：应用名称，即配置文件的名称，例如 config-dev。</li>
<li>{profile}：环境名，一个项目通常都有开发（dev）版本、测试（test）环境版本、生产（prod）环境版本，配置文件则以 application-{profile}.yml 的形式进行区分，例如 application-dev.yml、application-test.yml、application-prod.yml 等。</li>
<li>{label}：Git 分支名，默认是 master 分支，当访问默认分支下的配置文件时，该参数可以省略，即第二种访问方式。</li>
<li>{suffix}：配置文件的后缀，例如 config-dev.yml 的后缀为 yml。</li>
</ul>
<p>通过这套规则，我们在浏览器上就直接对配置文件进行访问。</p>
<p>比如我们要访问图书服务的生产环境代码，可以使用 <a target="_blank" rel="noopener" href="http://localhost:8700/bookservice/dex/master">http://localhost:8700/bookservice/dex/master</a> 链接，它会显示详细信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Om9w7j"><img src="https://s1.ax1x.com/2022/05/05/Om9w7j.png" alt="Om9w7j.png"></a></p>
<p>也可以使用 <a target="_blank" rel="noopener" href="http://localhost:8700/master/bookservice-dev.yml">http://localhost:8700/master/bookservice-dev.yml</a> 链接，它仅显示配置文件原文：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Om9HgK"><img src="https://s1.ax1x.com/2022/05/05/Om9HgK.png" alt="Om9HgK.png"></a></p>
<p>当然，除了使用Git来保存之外，还支持一些其他的方式，详细情况请查阅官网。</p>
<br>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>现在服务可以从服务器读取配置文件，删除原来的<code>application.yml</code>文件（也可以保留，最后无论是远端配置还是本地配置都会被加载），改用<code>bootstrap.yml</code>（在 application.yml 之前加载，可以实现配置文件远程获取）。</p>
<p>首先需要依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写 bootstrap.yaml 配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 名称，即文件名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">bookservice</span></span><br><span class="line">      <span class="comment"># 配置服务器的地址</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8700</span></span><br><span class="line">      <span class="comment"># 环境</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>配置完成之后，启动服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OmPPiR"><img src="https://s1.ax1x.com/2022/05/05/OmPPiR.png" alt="OmPPiR.png"></a></p>
<p>可以看到已经从远端获取到了配置并进行启动。</p>
<br>

<h1 id="Spring-Cloud-Alibaba"><a href="#Spring-Cloud-Alibaba" class="headerlink" title="Spring Cloud Alibaba"></a>Spring Cloud Alibaba</h1><p>前面了解的微服务是基于 Netflix 的解决方案，它里面很多框架已经停止维护了：</p>
<ul>
<li><strong>注册中心：</strong>Eureka（属于<em>Netflix</em>，2.x版本不再开源，1.x版本仍在更新）</li>
<li><strong>服务调用：</strong>Ribbon（属于<em>Netflix</em>，停止更新，已经彻底被移除）、SpringCloud Loadbalancer（属于<em>SpringCloud</em>官方，目前的默认方案）</li>
<li><strong>服务降级：</strong>Hystrix（属于<em>Netflix</em>，停止更新，已经彻底被移除）</li>
<li><strong>路由网关：</strong>Zuul（属于<em>Netflix</em>，停止更新，已经彻底被移除）、Gateway（属于<em>SpringCloud</em>官方，推荐方案）</li>
<li><strong>配置中心：</strong>Config（属于<em>SpringCloud</em>官方）</li>
</ul>
<p>可见，我们之前使用的整套解决方案中，超过半数的组件都已经处于不可用状态，并且部分组件都是 SpringCloud官方提供的框架进行解决。</p>
<p>阿里巴巴给出了一套全新的解决方案：<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/2021/zh-cn/index.html">官方网站</a></p>
<blockquote>
<p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
<p>依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里分布式应用解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p>
</blockquote>
<p>目前 Spring Cloud Alibaba 提供了如下功能:</p>
<ol>
<li><strong>服务限流降级</strong>：支持 WebServlet、WebFlux, OpenFeign、RestTemplate、Dubbo 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</li>
<li><strong>服务注册与发现</strong>：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</li>
<li><strong>分布式配置管理</strong>：支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li><strong>Rpc服务</strong>：扩展 Spring Cloud 客户端 RestTemplate 和 OpenFeign，支持调用 Dubbo RPC 服务</li>
<li><strong>消息驱动能力</strong>：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</li>
<li><strong>分布式事务</strong>：使用 @GlobalTransactional 注解， 高效并且对业务零侵入地解决分布式事务问题。</li>
<li><strong>阿里云对象存储</strong>：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li><strong>分布式任务调度</strong>：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</li>
<li><strong>阿里云短信服务</strong>：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ol>
<p>可以看到，Spring Cloud Alibaba 实际上是对 Spring Cloud 组件增强功能，是 Spring Cloud 的增强框架，可以兼容 Spring Cloud 原生组件和 Spring Cloud Alibaba 的组件。</p>
<br>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Ssssv11 WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Spring/" rel="tag"># Spring</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/05/02/RabbitMQ/" rel="prev" title="RabbitMQ">
                  <i class="fa fa-chevron-left"></i> RabbitMQ
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ssssv11</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
