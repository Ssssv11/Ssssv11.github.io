<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CMicrosoft+YaHei:300,300italic,400,400italic,700,700italic%7CRoboto+Slab:300,300italic,400,400italic,700,700italic%7CMonaco:300,300italic,400,400italic,700,700italic%7CMenlo:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ssssv11.github.io","root":"/","images":"/images","scheme":"Pisces","version":"8.2.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="Spring Cloud">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud">
<meta property="og:url" content="https://ssssv11.github.io/2022/05/02/SpringCloud/index.html">
<meta property="og:site_name" content="Ssssv">
<meta property="og:description" content="Spring Cloud">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEDm11.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEDl7D.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEDjHO.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OEvvlj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OExeXR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OExr9g.png">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2022/05/05/382e2507c5af7a2f.png">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2022/05/05/86fe8b52c26b0784.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVCymd.png">
<meta property="og:image" content="https://ssssv11.github.io/Users/houjuncai/Library/Application%20Support/typora-user-images/image-20220504160731567.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVkNuD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVkRbQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVkLb4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVuY0f.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV38Xj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV8Yxe.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVtcYq.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVy6zj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVyoYF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVgROA.png">
<meta property="og:image" content="https://ssssv11.github.io/Users/houjuncai/Library/Application%20Support/typora-user-images/image-20220504195430793.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV2E01.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVRcqA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVhD2T.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV4NQO.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OV4hwj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OVzzAx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OZ9Rje.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/04/OZeaPH.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OetB0e.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeUXo4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oeault.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OedMC9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oed0gI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oedf8s.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OewAGd.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OewERA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeDRe0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oe623F.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oeg1FP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeRose.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OehOiR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeWkiq.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeInaQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeTWvt.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Oe7naD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeL71H.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeOFun.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeXJLn.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeX0WF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OeXgdx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OevZUP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OejvAx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Om9w7j.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/Om9HgK.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/05/OmPPiR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuNQyt.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OulPf0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/Ou1Lqg.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/Ou3mJ1.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/Ou843t.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuGFUJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuYe0O.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OutXZT.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuUCtg.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuUB3d.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuUO5F.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuasG4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuraL9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuroJf.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/Ou6gQU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OucO3V.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuRW1x.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OuWKUJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKuajg.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKuN38.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKKFxS.md.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKMMTA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKQ9c8.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKQIEj.md.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKlp5R.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OK19eg.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OK1VS0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OK1Kw4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OK3m9I.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h0nng0ithgj215i0b875m.jpg">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKJvqK.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKNkHf.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKUSaT.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/06/OKUAMR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMo8M9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMoWi8.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMTW01.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMTH6H.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMORne.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMX280.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMX4rF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMXTa9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMxTaQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMzFR1.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OQSAYj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMzbwD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OMzFR1.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/Olpqpj.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/Ol9Ch4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/Ol9kcR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/Olm7NR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OluPZ4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OluztA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlMuUH.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlMa5j.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlMhGR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlMvRI.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h0ky50sw4jj219s07yabg.jpg">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OllE7D.png">
<meta property="og:image" content="http://c.biancheng.net/uploads/allimg/211210/10252343H-15.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/Ol8a3d.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlGaIU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlJpyn.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlGaIU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlJ0Tf.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlGaIU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OltJsA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/Olt2d0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/07/OlUXxe.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24egy1h0qkx2w3olj21jo0763zr.jpg">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1i9iT.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1FUBR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1Fr9O.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1Z0pV.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1Z60J.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1ZtTs.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1sIij.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1D6kd.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1g5n0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O14KpD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O14YAP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O145u9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O158v4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O15B8O.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O14YAP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1IglF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O17ZWV.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O17rFI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1HQc8.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1Hg41.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1qUyT.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1qwmF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O14KpD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1OSbD.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h0t5chy3tmj226y0u00yl.jpg">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1XnQx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1XBTg.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O1XTh9.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h1hqdnqlqsj21iu0l0myd.jpg">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O3kUcF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O3kRje.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O3kH9f.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O3AEDJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O3kUcF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/08/O3A7Z9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/O8vMiF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/O8v1z9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGNu79.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGNHuF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGUHRP.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGwPDU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGDzoF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGWKMQ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGW8I0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGWaM4.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGWrIx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OGzqpD.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJSnA0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJpmKH.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJp9bR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJpMVI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJpGRS.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJpUqs.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJ9JFx.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJ9d6e.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJCYHs.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJCR4x.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJPEGV.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJEC4A.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJV9qU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJVFIJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJZBnK.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJZ87F.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJZWct.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJeQCd.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OJxfA0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OYp90A.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/09/OYF9iR.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtV3W9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtemUU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/Otn8AK.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtmJQs.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtnwnI.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtKAWF.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtQGqA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/Ot14b9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtJp5R.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/Ot14b9.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtUBtJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtdtdU.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/OtBLFO.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/ONmLV0.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/ONKmDA.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/ONK6KJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2022/05/10/ONlf5q.png">
<meta property="article:published_time" content="2022-05-02T10:51:24.414Z">
<meta property="article:modified_time" content="2022-05-11T06:56:27.177Z">
<meta property="article:author" content="Ssssv11">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2022/05/04/OEDm11.png">


<link rel="canonical" href="https://ssssv11.github.io/2022/05/02/SpringCloud/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<title>Spring Cloud | Ssssv</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Ssssv</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">24</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">41</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">微服务架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-%E6%A6%82%E8%BF%B0"><span class="nav-number">2.</span> <span class="nav-text">Spring Cloud 概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-Netflix"><span class="nav-number">3.</span> <span class="nav-text">Spring Cloud  Netflix</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">3.1.</span> <span class="nav-text">Eureka 注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.1.</span> <span class="nav-text">微服务项目结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">项目创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.1.2.</span> <span class="nav-text">数据库与配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.1.3.</span> <span class="nav-text">业务实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">服务间调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0"><span class="nav-number">3.1.3.</span> <span class="nav-text">服务注册与发现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA-Eureka"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">搭建 Eureka</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="nav-number">3.1.3.2.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.1.3.3.</span> <span class="nav-text">负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">3.1.4.</span> <span class="nav-text">注册中心高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">3.1.4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.4.2.</span> <span class="nav-text">配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadBalancer-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.1.5.</span> <span class="nav-text">LoadBalancer 负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringCloud-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">3.1.5.1.</span> <span class="nav-text">SpringCloud 负载均衡的原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="nav-number">3.1.5.2.</span> <span class="nav-text">自定义负载均衡策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OpenFeign-%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-number">3.1.5.3.</span> <span class="nav-text">OpenFeign 实现负载均衡</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hystrix-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="nav-number">3.2.</span> <span class="nav-text">Hystrix 服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E5%99%A8"><span class="nav-number">3.2.1.</span> <span class="nav-text">熔断器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Hystrix"><span class="nav-number">3.2.2.</span> <span class="nav-text">Spring Cloud Hystrix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="nav-number">3.2.3.</span> <span class="nav-text">Hystrix 服务降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-1"><span class="nav-number">3.2.4.</span> <span class="nav-text">Hystrix 服务熔断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E7%8A%B6%E6%80%81"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">熔断状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hystrix-%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E6%9C%BA%E5%88%B6"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">Hystrix 实现熔断机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E7%A8%8B"><span class="nav-number">3.2.4.4.</span> <span class="nav-text">过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenFeign-%E5%AE%9E%E7%8E%B0%E9%99%8D%E7%BA%A7"><span class="nav-number">3.2.5.</span> <span class="nav-text">OpenFeign 实现降级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2%E9%83%A8%E7%BD%B2"><span class="nav-number">3.2.6.</span> <span class="nav-text">监控页面部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateway-%E8%B7%AF%E7%94%B1%E7%BD%91%E5%85%B3"><span class="nav-number">3.3.</span> <span class="nav-text">Gateway 路由网关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-%E7%BD%91%E5%85%B3"><span class="nav-number">3.3.1.</span> <span class="nav-text">API 网关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Gateway"><span class="nav-number">3.3.2.</span> <span class="nav-text">Spring Cloud Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Cloud-Gateway-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">Spring Cloud Gateway 核心概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Cloud-Gateway-%E7%9A%84%E7%89%B9%E5%BE%81"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">Spring Cloud Gateway 的特征</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway-%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.3.</span> <span class="nav-text">Gateway 的工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Predicate-%E6%96%AD%E8%A8%80"><span class="nav-number">3.3.4.</span> <span class="nav-text">Predicate 断言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%BD%91%E5%85%B3"><span class="nav-number">3.3.5.</span> <span class="nav-text">部署网关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.</span> <span class="nav-text">路由过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Filter-%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-number">3.3.6.1.</span> <span class="nav-text">Filter 的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GatewayFilter-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.2.</span> <span class="nav-text">GatewayFilter 网关过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.3.</span> <span class="nav-text">配置过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.3.6.4.</span> <span class="nav-text">全局过滤器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Config-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">3.4.</span> <span class="nav-text">Config 配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Config"><span class="nav-number">3.4.1.</span> <span class="nav-text">Spring Cloud Config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Config-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">3.4.2.</span> <span class="nav-text">Spring Cloud Config 工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Config-%E7%9A%84%E7%89%B9%E7%82%B9"><span class="nav-number">3.4.3.</span> <span class="nav-text">Spring Cloud Config 的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">3.4.4.</span> <span class="nav-text">部署配置中心</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">3.4.5.</span> <span class="nav-text">客户端配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-Alibaba"><span class="nav-number">4.</span> <span class="nav-text">Spring Cloud Alibaba</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nacos-%E6%9B%B4%E5%8A%A0%E5%85%A8%E8%83%BD%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.</span> <span class="nav-text">Nacos 更加全能的注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-%E7%9A%84%E7%89%B9%E6%80%A7"><span class="nav-number">4.1.1.</span> <span class="nav-text">Nacos 的特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0-1"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%81%A5%E5%BA%B7%E7%9B%91%E6%B5%8B"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">服务健康监测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">动态配置服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81-DNS-%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.1.1.4.</span> <span class="nav-text">动态 DNS 服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%8A%E5%85%B6%E5%85%83%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86"><span class="nav-number">4.1.1.5.</span> <span class="nav-text">服务及其元数据管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-%E4%B8%A4%E5%A4%A7%E7%BB%84%E4%BB%B6"><span class="nav-number">4.1.2.</span> <span class="nav-text">Nacos 两大组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.3.</span> <span class="nav-text">Nacos 服务注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%83%A8%E7%BD%B2"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">安装与部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0-1"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">服务注册与发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%88%86%E5%8C%BA"><span class="nav-number">4.1.3.3.</span> <span class="nav-text">集群分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="nav-number">4.1.3.4.</span> <span class="nav-text">配置中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">4.1.3.5.</span> <span class="nav-text">命名空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.1.3.6.</span> <span class="nav-text">实现高可用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel-%E6%B5%81%E9%87%8F%E9%98%B2%E5%8D%AB%E5%85%B5"><span class="nav-number">4.2.</span> <span class="nav-text">Sentinel 流量防卫兵</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%83%A8%E7%BD%B2-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">安装与部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="nav-number">4.2.2.</span> <span class="nav-text">流量控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E6%B5%81%E5%92%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">4.2.3.</span> <span class="nav-text">限流和异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="nav-number">4.2.4.</span> <span class="nav-text">热点参数限流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E5%92%8C%E9%99%8D%E7%BA%A7"><span class="nav-number">4.2.5.</span> <span class="nav-text">服务熔断和降级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel-%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="nav-number">4.2.5.1.</span> <span class="nav-text">Sentinel 熔断策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel-%E7%86%94%E6%96%AD%E7%8A%B6%E6%80%81"><span class="nav-number">4.2.5.2.</span> <span class="nav-text">Sentinel 熔断状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel-%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99%E5%B1%9E%E6%80%A7"><span class="nav-number">4.2.5.3.</span> <span class="nav-text">Sentinel 熔断规则属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sentinel-%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E8%BF%87%E7%A8%8B"><span class="nav-number">4.2.5.4.</span> <span class="nav-text">Sentinel 实现熔断降级过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="nav-number">4.2.5.5.</span> <span class="nav-text">实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Feign"><span class="nav-number">4.2.5.6.</span> <span class="nav-text">使用 Feign</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Seata%E4%B8%8E%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">4.3.</span> <span class="nav-text">Seata与分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">4.3.1.</span> <span class="nav-text">项目环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">4.3.2.</span> <span class="nav-text">分布式事务相关概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">4.3.3.</span> <span class="nav-text">分布式事务解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Seata-%E6%9C%BA%E5%88%B6%E7%AE%80%E4%BB%8B"><span class="nav-number">4.3.4.</span> <span class="nav-text">Seata 机制简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XID"><span class="nav-number">4.3.4.1.</span> <span class="nav-text">XID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">4.3.4.2.</span> <span class="nav-text">核心组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">4.3.4.3.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AT-%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%89%8D%E6%8F%90"><span class="nav-number">4.3.4.4.</span> <span class="nav-text">AT 模式的前提</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-File-%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="nav-number">4.3.5.</span> <span class="nav-text">使用 File 模式部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Nacos-%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="nav-number">4.3.6.</span> <span class="nav-text">使用 Nacos 模式部署</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Cloud-%E6%B6%88%E6%81%AF%E7%BB%84%E4%BB%B6"><span class="nav-number">5.</span> <span class="nav-text">Spring Cloud 消息组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringCloud-Stream"><span class="nav-number">5.1.</span> <span class="nav-text">SpringCloud Stream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-3"><span class="nav-number">5.1.1.</span> <span class="nav-text">实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">微服务应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C"><span class="nav-number">6.1.</span> <span class="nav-text">分布式权限校验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Redis-%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.1.1.</span> <span class="nav-text">使用 Redis 实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth-2-0-%E5%AE%9E%E7%8E%B0%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95"><span class="nav-number">6.2.</span> <span class="nav-text">OAuth 2.0 实现单点登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.2.1.</span> <span class="nav-text">四种授权模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">6.2.2.</span> <span class="nav-text">搭建验证服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-number">6.2.3.</span> <span class="nav-text">接口测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.2.3.1.</span> <span class="nav-text">客户端模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.2.3.2.</span> <span class="nav-text">密码模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9A%90%E5%BC%8F%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.2.3.3.</span> <span class="nav-text">隐式授权模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F"><span class="nav-number">6.2.3.4.</span> <span class="nav-text">授权码模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%B7%E6%96%B0%E4%BB%A4%E7%89%8C"><span class="nav-number">6.2.3.5.</span> <span class="nav-text">刷新令牌</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-EnableOAuth2Sso-%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.2.4.</span> <span class="nav-text">基于 @EnableOAuth2Sso 实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-EnableResourceServer-%E5%AE%9E%E7%8E%B0"><span class="nav-number">6.2.5.</span> <span class="nav-text">基于 @EnableResourceServer 实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-JWT-%E5%AD%98%E5%82%A8-Token"><span class="nav-number">6.2.6.</span> <span class="nav-text">使用 JWT 存储 Token</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ssssv11"
      src="/images/header.jpg">
  <p class="site-author-name" itemprop="name">Ssssv11</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Ssssv11" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Ssssv11" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ssssv11.github.io/2022/05/02/SpringCloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/header.jpg">
      <meta itemprop="name" content="Ssssv11">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ssssv">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Cloud
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-02 18:51:24" itemprop="dateCreated datePublished" datetime="2022-05-02T18:51:24+08:00">2022-05-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-05-11 14:56:27" itemprop="dateModified" datetime="2022-05-11T14:56:27+08:00">2022-05-11</time>
      </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <center>Spring Cloud</center>

<span id="more"></span>

<h1 id="微服务架构"><a href="#微服务架构" class="headerlink" title="微服务架构"></a>微服务架构</h1><p>随着越来越多的功能不断地加入到一个 Spring Boot 项目中，接口不断增加，整个系统就要在同一时间内响应更多类型的请求，显然这种扩展方式是不可能无限使用下去的，总有一天这个 Spring Boot 项目会庞大到运行缓慢。并且所有的功能如果都集成在单端上，那么所有的请求都会全部汇集到一台服务器上，对此服务器造成巨大压力。</p>
<p>可以试想一下，如果我们的电脑已经升级到最高配，但是依然在运行项目的时候缓慢，无法同一时间响应成千上万的请求，那么这个问题就已经不是单纯升级机器配置可以解决的了。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEDm11"><img src="https://s1.ax1x.com/2022/05/04/OEDm11.png" alt="OEDm11.png"></a></p>
<p>Martin Fowler 在 2014 年阐述了“微服务”架构，它是一种全新的架构风格。</p>
<ul>
<li>微服务把一个庞大的单体应用拆分为一个个的小型服务，比如我们原来的图书管理项目中，有登录、注册、添加、删除、搜索等功能，那么我们可以将这些功能单独做成一个个小型的 Spring Boot 项目，独立运行。</li>
<li>每个小型的微服务，都可以独立部署和升级，这样，就算整个系统崩溃，那么也只会影响一个服务的运行。</li>
<li>微服务之间使用 HTTP 进行数据交互，不再是单体应用内部交互了，虽然这样会显得更麻烦，但是带来的好处也是很直接的，甚至能突破语言限制，使用不同的编程语言进行微服务开发，只需要使用 HTTP 进行数据交互即可。</li>
<li>我们可以同时购买多台主机来分别部署这些微服务，这样，单机的压力就被分散到多台机器，并且每台机器的配置不一定需要太高，这样就能节省大量的成本，同时安全性也得到很大的保证。</li>
<li>甚至同一个微服务可以同时存在多个，这样当其中一个服务器出现问题时，其他服务器也在运行同样的微服务，这样就可以保证一个微服务的高可用。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEDl7D"><img src="https://s1.ax1x.com/2022/05/04/OEDl7D.png" alt="OEDl7D.png"></a></p>
<p>可见，采用微服务架构，更加能够应对当今时代下的种种考验，传统项目的开发模式，需要进行架构上的升级。</p>
<br>

<h1 id="Spring-Cloud-概述"><a href="#Spring-Cloud-概述" class="headerlink" title="Spring Cloud 概述"></a>Spring Cloud 概述</h1><p>微服务架构的存在的问题：</p>
<ul>
<li>要实现微服务并不是说只需要简单地将项目进行拆分，我们还需要考虑对各个微服务进行管理、监控等，这样我们才能够及时地寻找和排查问题。因此微服务往往需要的是一整套解决方案，包括服务注册和发现、容灾处理、负载均衡、配置管理等。</li>
<li>它不像单体架构那种方便维护，由于部署在多个服务器，我们不得不去保证各个微服务能够稳定运行，在管理难度上肯定是高于传统单体应用的。</li>
<li>在分布式的环境下，单体应用的某些功能可能会变得比较麻烦，比如分布式事务。</li>
</ul>
<p>所以，为了更好地解决这些问题，Spring Cloud 正式登场。</p>
<p>Spring Cloud 是 Spring 提供的一套分布式解决方案，集合了一些大型互联网公司的开源产品，包括诸多组件，共同组成 Spring Cloud 框架。并且它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、熔断机制、数据监控等，都可以用 Spring Boot 的开发风格做到一键启动和部署。</p>
<p>由于中小型公司没有独立开发自己的分布式基础设施的能力，使用 Spring Cloud 解决方案能够以最低的成本应对当前时代的业务发展。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEDjHO"><img src="https://s1.ax1x.com/2022/05/04/OEDjHO.png" alt="OEDjHO.png"></a></p>
<p>Spring Cloud整体架构的亮点是非常明显的，分布式架构下的各个场景，都有对应的组件来处理，比如基于 Netflix 的开源分布式解决方案提供的组件：</p>
<ul>
<li>Eureka  -  实现服务治理（服务注册与发现），我们可以对所有的微服务进行集中管理，包括他们的运行状态、信息等。</li>
<li>Ribbon  -  为服务之间相互调用提供负载均衡算法（被 SpringCloud LoadBalancer 取代）</li>
<li>Hystrix  -  断路器，保护系统，控制故障范围</li>
<li>Zuul   -     API 网关、路由、负载均衡等多种作用（被 SpringCloud Gateway 取代）</li>
<li>Config  -  配置管理，可以实现配置文件集中管理</li>
</ul>
<br>

<h1 id="Spring-Cloud-Netflix"><a href="#Spring-Cloud-Netflix" class="headerlink" title="Spring Cloud  Netflix"></a>Spring Cloud  Netflix</h1><h2 id="Eureka-注册中心"><a href="#Eureka-注册中心" class="headerlink" title="Eureka 注册中心"></a>Eureka 注册中心</h2><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-netflix/docs/current/reference/html/">官方文档</a></p>
<p>在学习过程中需要多看官方文档，详细的功能和用法在官方文档中都写的很清楚。</p>
<h3 id="微服务项目结构"><a href="#微服务项目结构" class="headerlink" title="微服务项目结构"></a>微服务项目结构</h3><p>现在重新设计之前的图书管理系统项目，将原有的大型项目进行拆分。项目拆分一定要尽可能保证单一职责，相同的业务不要在多个微服务中重复出现，如果出现需要借助其他业务完成的服务，那么可以使用服务之间相互调用的形式来实现：</p>
<ul>
<li>登录验证服务：用于处理用户注册、登录、密码重置等。一切与账户相关的内容，包括用户信息获取等。</li>
<li>图书管理服务：用于进行图书添加、删除、更新等操作。图书管理相关的服务，包括图书的存储等和信息获取。</li>
<li>图书借阅服务：交互性较强的服务，需要和登陆验证服务和图书管理服务进行交互。</li>
</ul>
<p>这样我们就需要重新设计项目目录结构，创建多个子项目，每一个子项目都是一个服务，由父项目统一管理依赖。</p>
<br>

<h4 id="项目创建"><a href="#项目创建" class="headerlink" title="项目创建"></a>项目创建</h4><p>首先创建一个 Spring Boot 项目：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OEvvlj"><img src="https://s1.ax1x.com/2022/05/04/OEvvlj.png" alt="OEvvlj.png" style="zoom: 33%;" /></a></p>
<p>不需要勾选任何依赖点击创建即可。项目创建完成并初始化后，删除父工程的无用文件，只保留必要文件：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OExeXR"><img src="https://s1.ax1x.com/2022/05/04/OExeXR.png" alt="OExeXR.png" style="zoom:67%;" /></a></p>
<p>然后按照划分的服务创建子工程。创建一个新的 Maven 项目，注意要指定父项目：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OExr9g"><img src="https://s1.ax1x.com/2022/05/04/OExr9g.png" alt="OExr9g.png"></a></p>
<p>子项目创建好后需要在子项目中创建 Spring Boot 的启动主类：</p>
<p><img src="https://s3.bmp.ovh/imgs/2022/05/05/382e2507c5af7a2f.png"></p>
<p>启动子项目后下方弹窗提示用服务管理窗口管理服务，点击”使用服务”，这样就可以实时查看当前整个大项目中的微服务：</p>
<p><img src="https://s3.bmp.ovh/imgs/2022/05/05/86fe8b52c26b0784.png"></p>
<br>

<h4 id="数据库与配置"><a href="#数据库与配置" class="headerlink" title="数据库与配置"></a>数据库与配置</h4><p>编写数据库文件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : Main</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 80024</span></span><br><span class="line"><span class="comment"> Source Host           : 43.138.201.82:3306</span></span><br><span class="line"><span class="comment"> Source Schema         : cloudstudy</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 80024</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 04/05/2022 15:36:47</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for db_book</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `db_book`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `db_book` (</span><br><span class="line">  `bid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">desc</span>` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`bid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of db_book</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;深入理解Java虚拟机&#x27;</span>, <span class="string">&#x27;讲解JVM底层原理&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;Java并发编程的艺术&#x27;</span>, <span class="string">&#x27;讲解并发编程的各种技术&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;Java核心技术卷一&#x27;</span>, <span class="string">&#x27;讲解Java的基础知识等&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_book` (`bid`, `title`, `<span class="keyword">desc</span>`) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;计算机网络&#x27;</span>, <span class="string">&#x27;讲解计算机的网络实现原理和知识&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for db_borrow</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `db_borrow`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `db_borrow` (</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `uid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `bid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `unique_bid_uid` (`uid`,`bid`),</span><br><span class="line">  KEY `f_bid` (`bid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `f_bid` <span class="keyword">FOREIGN</span> KEY (`bid`) <span class="keyword">REFERENCES</span> `db_book` (`bid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `f_uid` <span class="keyword">FOREIGN</span> KEY (`uid`) <span class="keyword">REFERENCES</span> `db_user` (`uid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">3</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of db_borrow</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_borrow` (`id`, `uid`, `bid`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_borrow` (`id`, `uid`, `bid`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for db_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `db_user`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `db_user` (</span><br><span class="line">  `uid` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `sex` enum(<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`uid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of db_user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;小明&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;小红&#x27;</span>, <span class="number">17</span>, <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;小芳&#x27;</span>, <span class="number">18</span>, <span class="string">&#x27;女&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `db_user` (`uid`, `name`, `age`, `sex`) <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">&#x27;小刚&#x27;</span>, <span class="number">17</span>, <span class="string">&#x27;男&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>导入数据库相关的依赖，这里依然使用Mybatis框架，首先在父工程中添加 MySQL 驱动和 Lombok 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于不是每个子模块都需要用到 Mybatis，因此只在父工程中进行版本管理：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在子项目中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后需要为每个服务编写它们的配置文件，给定不同的端口号并绑定数据源，分别为它们创建<code>application.yml</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8101</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://43.138.201.82:3306/cloudstudy</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hjc</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>重新启动三个子项目：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVCymd"><img src="https://s1.ax1x.com/2022/05/04/OVCymd.png" alt="OVCymd.png"></a></p>
<br>

<h4 id="业务实现"><a href="#业务实现" class="headerlink" title="业务实现"></a>业务实现</h4><p>用户查询相关的业务：</p>
<p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_user where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.getUserById(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUserById(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目访问路径就可以获取到数据：</p>
<img src="/Users/houjuncai/Library/Application Support/typora-user-images/image-20220504160731567.png" alt="image-20220504160731567" style="zoom:67%;" />

<p>书本查询相关的业务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer bid;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span>  String desc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_book where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookMapper bookMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bookMapper.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVkNuD"><img src="https://s1.ax1x.com/2022/05/04/OVkNuD.png" alt="OVkNuD.png"></a></p>
<p>这样一个完整项目的就拆分成了多个微服务，不同微服务之间是独立进行开发和部署的。</p>
<br>

<h3 id="服务间调用"><a href="#服务间调用" class="headerlink" title="服务间调用"></a>服务间调用</h3><p>完成了用户信息查询和图书信息查询，现在需要完成借阅服务。</p>
<p>借阅服务是一个关联性比较强的服务，它不仅仅需要查询借阅信息，同时可能还需要获取借阅信息下的详细信息，比如具体那个用户借阅了哪本书，并且用户和书籍的详情信息也需要被查询。这种情况下就需要去访问除了借阅表以外的用户表和图书表。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVkRbQ"><img src="https://s1.ax1x.com/2022/05/04/OVkRbQ.png" alt="OVkRbQ.png"></a></p>
<p>但这显然违反了单一职责原则——相同的业务功能不应该重复出现。若需要在此服务中使用其他服务，则可以让一个服务去调用另一个服务来获取信息。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVkLb4"><img src="https://s1.ax1x.com/2022/05/04/OVkLb4.png" alt="OVkLb4.png"></a></p>
<p>这样，图书管理微服务和用户管理微服务相对于借阅记录，就形成了一个生产者和消费者的关系，前者是生产者，后者便是消费者。</p>
<br>

<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>借阅关联信息查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Borrow</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line">    <span class="keyword">private</span> Integer bid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BorrowMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    List&lt;Borrow&gt; <span class="title function_">getBorrowByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    List&lt;Borrow&gt; <span class="title function_">getBorrowByBid</span><span class="params">(Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where uid = #&#123;uid&#125; adn bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Borrow <span class="title function_">getBorrow</span><span class="params">(Integer uid, Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在我们希望查到借阅信息时返回的是 User 和 Book 的详情信息，因此我们需要添加一个实体类用来封装返回的详细信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowDetail</span> &#123;</span><br><span class="line">    User user;</span><br><span class="line">    List&lt;Book&gt; bookList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但 User 类和 Book 类并不是在这个 service-borrow 的模块中定义，因此我们可以将所有服务需要用到的实体类单独放入另一个一个项目中，然后让这些项目引用集中存放实体类的那个项目，这样就可以保证每个微服务的实体类信息都可以共用了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVuY0f"><img src="https://s1.ax1x.com/2022/05/04/OVuY0f.png" alt="OVuY0f.png" style="zoom:50%;" /></a></p>
<p>再向三个服务中导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hjc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样新的公共实体类都可以在 <code>commons</code> 项目中进行定义。</p>
<p>业务实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">    BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrowList = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">				<span class="comment">// 查询到了借阅的相关信息后该如何调用其他服务？</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行远程服务调用需要使用 RestTemplate：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="comment">// RestTemplate 支持多种方式的远程调用</span></span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        <span class="comment">// 通过调用 getForObject 来请求其他服务并将结果自动封装</span></span><br><span class="line">        <span class="comment">// 获取 User 信息</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  restTemplate.getForObject(<span class="string">&quot;http://localhost:8103/user/&quot;</span> + uid, User.class);</span><br><span class="line">        <span class="comment">// 获取 Book 信息</span></span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://localhost:8101/book/&quot;</span> + b.getBid(), Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://localhost:8103/user/&quot;</span> + borrow.get(<span class="number">0</span>).getUid(), User.class);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://localhost:8101/book/&quot;</span> + bid, Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByBid</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByBid(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动三个服务后访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV38Xj"><img src="https://s1.ax1x.com/2022/05/04/OV38Xj.png" alt="OV38Xj.png"></a></p>
<p>![image-20220504173354854](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504173354854.png)</p>
<p>注意：一定要保证三个服务都处于开启状态，否则远程调用会失败。</p>
<p>结果正常，远程调用成功。</p>
<br>

<h3 id="服务注册与发现"><a href="#服务注册与发现" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h3><p>在了解了如何对单体应用进行拆分和如何进行服务之间的相互调用后，还存在一个问题：虽然服务拆分完成，但没有一个比较合理的管理机制，如果单纯只是这样编写，那么在部署和维护起来会是非常麻烦的。</p>
<p>如果某一天这些微服务的端口或是地址大规模地发生改变，我们就不得不将服务之间的调用路径大规模的同步进行修改。因此我们需要削弱服务之间的强关联性。这就需要一个集中管理微服务的平台。</p>
<p>Eureka 能够自动注册并发现微服务，然后对服务的状态、信息进行集中管理。当需要获取其他服务的信息时，只需要向 Eureka 进行查询。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV8Yxe"><img src="https://s1.ax1x.com/2022/05/04/OV8Yxe.png" alt="OV8Yxe.png"></a></p>
<p>这样，服务之间的强关联性就会被进一步削弱。</p>
<br>

<h4 id="搭建-Eureka"><a href="#搭建-Eureka" class="headerlink" title="搭建 Eureka"></a>搭建 Eureka</h4><p>只需要创建一个新的 Maven 项目 service-eureka，然后在父工程中添加 Spring Cloud 依赖的版本控制。</p>
<p>这里选用<code>2021.0.2</code>版本（Spring Cloud 最新的版本命名方式变更了，现在是 <em><strong>YEAR.x</strong></em> 命名方式，具体可以在官网查看：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud#learn%EF%BC%89%EF%BC%9A">https://spring.io/projects/spring-cloud#learn）：</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为新的 eureka 服务导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为 eureka 创建启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：要添加 <code>@EnableEurekaServer</code> 注解。</strong></p>
<p>修改 application.yaml 配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8104</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 由于是作为服务端角色，因此不需要获取服务器 设置为 false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 暂时不需要将自己注册到 Eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 将 eureka 服务端指向自己</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8104/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动 Eureka 并访问，直接输入地址 + 端口即可访问 Eureka 的管理后台：</p>
<p>![image-20220504180634723](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504180634723.png)</p>
<p>可以看到现在还没有任何的服务注册到 Eureka。</p>
<p>然后配置三个微服务，先导入 Eureka 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后修改配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 需要指向 Eureka 服务端地址才能进行注册</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8104/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动服务，然后打开 Eureka 的服务管理页面，可以看到我们刚刚开启的服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVtcYq"><img src="https://s1.ax1x.com/2022/05/04/OVtcYq.png" alt="OVtcYq.png"></a></p>
<p>可以看到三个端口上的服务器已经成功注册到 Eureka，但服务名称显示为 UNKNOWN，我们需要修改配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">userservice</span></span><br></pre></td></tr></table></figure>

<p>为三个服务分别配置 application name 再次开启服务：</p>
<p>![image-20220504181725981](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504181725981.png)</p>
<p>当我们的服务启动之后，每隔一段时间就会跟 Eureka 发送一次心跳包，这样 Eureka 就能够感知到我们的服务是否处于正常运行状态。</p>
<br>

<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p>在之前如果需要对其他微服务进行远程调用，那么就必须要知道其他服务的地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> template.getForObject(<span class="string">&quot;http://localhost:8103/user/&quot;</span> + uid, User.class);</span><br></pre></td></tr></table></figure>

<p>现在可以通过 Eureka 直接查询得到对应的微服务地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">		<span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="comment">// RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line">      	<span class="comment">// 直接使用 service 的名称</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  restTemplate.getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + uid, User.class);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://bookservice/book/&quot;</span> + b.getBid(), Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="comment">// RestTemplate restTemplate = new RestTemplate();</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> restTemplate.getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + borrow.get(<span class="number">0</span>).getUid(), User.class);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; restTemplate.getForObject(<span class="string">&quot;http://bookservice/book/&quot;</span> + bid, Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还需要在 service-borrow 中将 RestTemplate 声明为一个 Bean，然后添加 <code>@LoadBalanced</code> 注解，这样 Eureka 就会对服务的调用进行自动发现，并提供负载均衡：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次访问发现调用正常：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVy6zj"><img src="https://s1.ax1x.com/2022/05/04/OVy6zj.png" alt="OVy6zj.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVyoYF"><img src="https://s1.ax1x.com/2022/05/04/OVyoYF.png" alt="OVyoYF.png"></a></p>
<br>

<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>一个服务可以注册为多个端口不同的相同服务。比如创建多个用户查询服务，将原有的端口配置删除，修改为由 IDEA 中设定的启动参数来决定，这样就可以多创建几个不同端口的启动项：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVgROA"><img src="https://s1.ax1x.com/2022/05/04/OVgROA.png" alt="OVgROA.png" style="zoom:67%;" /></a></p>
<img src="/Users/houjuncai/Library/Application Support/typora-user-images/image-20220504195430793.png" alt="image-20220504195430793" style="zoom: 67%;" />

<p>在 Eureka 中 UserService 出现了两个：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV2E01"><img src="https://s1.ax1x.com/2022/05/04/OV2E01.png" alt="OV2E01.png"></a></p>
<p>再次进行查询 borrow 会发现，两个 UserService 实例被平均分配请求。</p>
<p>这样，服务自动发现以及简单的负载均衡就实现就完成了。并且如果某个微服务挂掉，只要存在其他同样的微服务实例在运行，那么就不会导致整个微服务不可用，极大地保证了安全性。</p>
<br>

<h3 id="注册中心高可用"><a href="#注册中心高可用" class="headerlink" title="注册中心高可用"></a>注册中心高可用</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>虽然 Eureka 能够实现服务注册和发现，但如果 Eureka 服务器崩溃了那么所有需要用到服务发现的微服务也就一起不可用了。可以搭建 Eureka 集群来避免这种问题。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVRcqA"><img src="https://s1.ax1x.com/2022/05/04/OVRcqA.png" alt="OVRcqA.png"></a></p>
<br>

<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>首先需要修改 Eureka 服务端的配置文件，创建两个配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 由于不支持多个localhost的Eureka服务器，但是又只有本地测试环境，所以就只能自定义主机名称了</span></span><br><span class="line">    <span class="comment"># 主机名称改为eureka01</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka01</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 去掉register-with-eureka选项，让Eureka服务器自己注册到其他Eureka服务器，这样才能相互启用</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 注意这里填写其他Eureka服务器的地址，不用写自己的</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka02:8802/eureka</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eurekaserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka02</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka01:8801/eureka</span></span><br></pre></td></tr></table></figure>

<p>这里由于我们修改成自定义的地址，需要在 hosts 文件中将其解析到 127.0.0.1 才能回到 localhost，Mac 下文件路径为<code>/etc/hosts</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">houjuncai@HXD-MacBook-Pro ~ % sudo vim /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># Host Database</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># localhost is used to configure the loopback interface</span></span><br><span class="line"><span class="comment"># when the system is booting.  Do not change this entry.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">255.255.255.255 broadcasthost</span><br><span class="line">::1             localhost</span><br><span class="line"><span class="comment">## 添加这两行</span></span><br><span class="line">127.0.0.1       eureka01</span><br><span class="line">127.0.0.1       eureka02</span><br><span class="line"><span class="comment"># MacWk.com Hosts Start</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sublime Text</span></span><br><span class="line">127.0.0.1 www.sublimetext.com</span><br><span class="line">127.0.0.1 sublimetext.com</span><br><span class="line">127.0.0.1 license.sublimehq.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># MacWk.com Hosts End</span></span><br></pre></td></tr></table></figure>

<p>对创建的两个配置文件分别添加启动配置，使用 <code>spring.profiles.active</code> 指定启用的配置文件：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVhD2T"><img src="https://s1.ax1x.com/2022/05/04/OVhD2T.png" alt="OVhD2T.png" style="zoom:67%;" /></a></p>
<p>启动两个 Eureka 服务：</p>
<p>![image-20220504202629300](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220504202629300.png)</p>
<p>可以看到下方 <code>replicas</code> 中已经包含了另一个 Eureka 服务器的地址，并且是可用状态。</p>
<p>然后修改微服务配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">    	<span class="comment"># 将两个Eureka的地址都加入，这样就算有一个Eureka挂掉，也能完成注册</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8801/eureka,</span> <span class="string">http://localhost:8802/eureka</span></span><br></pre></td></tr></table></figure>

<p>可以看到，服务全部成功注册，并且两个 Eureka 服务端都显示为已注册：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV4NQO"><img src="https://s1.ax1x.com/2022/05/04/OV4NQO.png" alt="OV4NQO.png"></a></p>
<p>模拟当有一个 Eureka 崩溃：将其中一个Eureka服务器关闭掉，可以看到它会直接变成不可用状态：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OV4hwj"><img src="https://s1.ax1x.com/2022/05/04/OV4hwj.png" alt="OV4hwj.png"></a></p>
<p>但此时仍然有一个 Eureka 服务可用，因此所有的业务也都可用。如果再次重启刚刚关闭的 Eureka 服务器，则会自动同步其他 Eureka 服务器的数据。</p>
<br>

<h3 id="LoadBalancer-负载均衡"><a href="#LoadBalancer-负载均衡" class="headerlink" title="LoadBalancer 负载均衡"></a>LoadBalancer 负载均衡</h3><p>SpringCloud 的负载均衡是依靠 LoadBalancer 实现的。</p>
<p>在 2020 年前的 SpringCloud 版本是采用 Ribbon 作为负载均衡实现，但 2020 年的版本之后 SpringCloud 把 Ribbon 移除进而使用 LoadBalancer 替代。</p>
<br>

<h4 id="SpringCloud-负载均衡的原理"><a href="#SpringCloud-负载均衡的原理" class="headerlink" title="SpringCloud 负载均衡的原理"></a>SpringCloud 负载均衡的原理</h4><p>在添加 <code>@LoadBalanced</code> 注解后会启用拦截器对我们发起的服务调用请求进行拦截，叫做 <code>LoadBalancerInterceptor</code>，它实现了 <code>ClientHttpRequestInterceptor</code> 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClientHttpRequestInterceptor</span> &#123;</span><br><span class="line">    ClientHttpResponse <span class="title function_">intercept</span><span class="params">(HttpRequest request, <span class="type">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一到它主要是对 <code>intercept</code> 方法的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ClientHttpResponse <span class="title function_">intercept</span><span class="params">(<span class="keyword">final</span> HttpRequest request, <span class="keyword">final</span> <span class="type">byte</span>[] body, <span class="keyword">final</span> ClientHttpRequestExecution execution)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">URI</span> <span class="variable">originalUri</span> <span class="operator">=</span> request.getURI();</span><br><span class="line">    <span class="type">String</span> <span class="variable">serviceName</span> <span class="operator">=</span> originalUri.getHost();</span><br><span class="line">    Assert.state(serviceName != <span class="literal">null</span>, <span class="string">&quot;Request URI does not contain a valid hostname: &quot;</span> + originalUri);</span><br><span class="line">    <span class="keyword">return</span> (ClientHttpResponse)<span class="built_in">this</span>.loadBalancer.execute(serviceName, <span class="built_in">this</span>.requestFactory.createRequest(request, body, execution));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以添加断点看看是如何执行的：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OVzzAx"><img src="https://s1.ax1x.com/2022/05/04/OVzzAx.png" alt="OVzzAx.png"></a></p>
<p>服务端会在发起请求时执行这些拦截器。</p>
<p>首先，给过来的请求地址并不是一个有效的主机名称而是服务名称，因此需要通过 Eureka 获取真正需要访问的主机名称。</p>
<p><code>loadBalancer.execute()</code>的具体实现为<code>BlockingLoadBalancerClient</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从上一层给进来了服务的名称和具体的请求实体</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">execute</span><span class="params">(String serviceId, LoadBalancerRequest&lt;T&gt; request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">hint</span> <span class="operator">=</span> <span class="built_in">this</span>.getHint(serviceId);</span><br><span class="line">    LoadBalancerRequestAdapter&lt;T, DefaultRequestContext&gt; lbRequest = <span class="keyword">new</span> <span class="title class_">LoadBalancerRequestAdapter</span>(request, <span class="keyword">new</span> <span class="title class_">DefaultRequestContext</span>(request, hint));</span><br><span class="line">    Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = <span class="built_in">this</span>.getSupportedLifecycleProcessors(serviceId);</span><br><span class="line">    supportedLifecycleProcessors.forEach((lifecycle) -&gt; &#123;</span><br><span class="line">        lifecycle.onStart(lbRequest);</span><br><span class="line">    &#125;);</span><br><span class="line">  	<span class="comment">// 在这里调用 choose 方法自动获取对应的服务实例信息</span></span><br><span class="line">    <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> <span class="built_in">this</span>.choose(serviceId, lbRequest);</span><br><span class="line">    <span class="keyword">if</span> (serviceInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">        supportedLifecycleProcessors.forEach((lifecycle) -&gt; &#123;</span><br><span class="line">            lifecycle.onComplete(<span class="keyword">new</span> <span class="title class_">CompletionContext</span>(Status.DISCARD, lbRequest, <span class="keyword">new</span> <span class="title class_">EmptyResponse</span>()));</span><br><span class="line">        &#125;);</span><br><span class="line">      	<span class="comment">// 没有发现任何此服务的实例就抛异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No instances available for &quot;</span> + serviceId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// 成功获取到对应服务的实例，这时就可以发起HTTP请求获取信息了</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.execute(serviceId, serviceInstance, lbRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以在进行负载均衡的时候会向 Eureka 发起请求，选择一个可用的对应服务，然后会返回此服务的主机地址等信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OZ9Rje"><img src="https://s1.ax1x.com/2022/05/04/OZ9Rje.png" alt="OZ9Rje.png"></a></p>
<br>

<h4 id="自定义负载均衡策略"><a href="#自定义负载均衡策略" class="headerlink" title="自定义负载均衡策略"></a>自定义负载均衡策略</h4><p>LoadBalancer 默认提供了两种负载均衡策略：</p>
<ul>
<li>RandomLoadBalancer  -  随机分配策略</li>
<li>RoundRobinLoadBalancer  -  轮询分配策略**(默认)**</li>
</ul>
<p>如果希望修改默认的负载均衡策略，需要先创建随机分配策略的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadBalancerConfig</span> &#123;</span><br><span class="line">    <span class="comment">//将官方提供的 RandomLoadBalancer 注册为Bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ReactorServiceInstanceLoadBalancer <span class="title function_">reactorServiceInstanceLoadBalancer</span><span class="params">(Environment environment, LoadBalancerClientFactory loadBalancerClientFactory)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);</span><br><span class="line">        <span class="comment">//返回随机轮询负载均衡方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomLoadBalancer</span>(loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后需要为对应的服务指定负载均衡策略，直接使用注解即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@LoadBalancerClient(value = &quot;userservice&quot;,      // 指定为userservice服务，只要是调用此服务都会使用指定的策略  </span></span><br><span class="line"><span class="meta">                    configuration = LoadBalancerConfig.class)</span>   <span class="comment">// 指定定义好的配置类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    RestTemplate <span class="title function_">template</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>BlockingLoadBalancerClient</code>中添加断点，观察是否采用指定的策略进行请求：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OZeaPH"><img src="https://s1.ax1x.com/2022/05/04/OZeaPH.png" alt="OZeaPH.png"></a></p>
<br>

<h4 id="OpenFeign-实现负载均衡"><a href="#OpenFeign-实现负载均衡" class="headerlink" title="OpenFeign 实现负载均衡"></a>OpenFeign 实现负载均衡</h4><p>官方文档：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/">https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/</a></p>
<p>Feign 和 RestTemplate 一样，是 HTTP 客户端请求工具，但是它的使用方式更加便捷。首先是依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在启动类添加 <code>@EnableFeignClients</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BorrowApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个对应服务的接口类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span>   <span class="comment">// 声明为userservice服务的HTTP请求客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后直接创建所需类型的方法，比如之前的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RestTemplate</span> <span class="variable">template</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> template.getForObject(<span class="string">&quot;http://userservice/user/&quot;</span> + uid, User.class);</span><br></pre></td></tr></table></figure>

<p>现在可以直接写成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 路径保证和其他微服务提供的一致即可</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> <span class="type">int</span> uid)</span>;  <span class="comment">// 参数和返回值也保持一致</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接注入使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookClient bookClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findUserById(uid);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.findBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.findUserById(borrow.get(<span class="number">0</span>).getUid());</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.findBookById(bid))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以观察一下两个用户微服务的调用情况，也是以负载均衡的形式进行的。</p>
<br>

<h2 id="Hystrix-服务熔断"><a href="#Hystrix-服务熔断" class="headerlink" title="Hystrix 服务熔断"></a>Hystrix 服务熔断</h2><p>在微服务架构中，一个应用往往由多个服务组成，这些服务之间相互依赖，依赖关系错综复杂。</p>
<p>例如一个微服务系统中存在 A、B、C、D、E 、F 等多个服务，它们的依赖关系如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OetB0e"><img src="https://s1.ax1x.com/2022/05/05/OetB0e.png" alt="OetB0e.png"></a>](<a target="_blank" rel="noopener" href="https://imgtu.com/i/OeYLee">https://imgtu.com/i/OeYLee</a>)</p>
<p>当服务 E 发生故障或网络延迟时，会出现以下情况：</p>
<ol>
<li>即使其他所有服务都可用，由于服务 E 的不可用，那么用户请求就会处于阻塞状态，等待服务 E 的响应。在高并发的场景下，会导致整个服务器的线程资源在短时间内迅速消耗殆尽。</li>
<li>所有依赖于服务 E 的其他服务，例如服务 B、D 以及 F 也都会处于线程阻塞状态，等待服务 E 的响应，导致这些服务的不可用。</li>
<li>所有依赖服务B、D 和 F 的服务，例如服务 A 和服务 C 也会处于线程阻塞状态，以等待服务 D 和服务 F 的响应，导致服务 A 和服务 C 也不可用。</li>
</ol>
<p>从以上过程可以看出，当微服务系统的一个服务出现故障时，故障会沿着服务的调用链路在系统中疯狂蔓延，最终导致整个微服务系统的瘫痪，这就是“雪崩效应”。为了防止此类事件的发生，微服务架构引入了“熔断器”的一系列服务容错和保护机制。</p>
<br>

<h3 id="熔断器"><a href="#熔断器" class="headerlink" title="熔断器"></a>熔断器</h3><p>熔断器（Circuit Breaker）一词来源物理学中的电路知识，它的作用是当线路出现故障时，迅速切断电源以保护电路的安全。</p>
<p>在微服务领域，熔断器最早是由 Martin Fowler 在他发表的 《<a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html">Circuit Breaker</a>》一文中提出。与物理学中的熔断器作用相似，微服务架构中的熔断器能够在某个服务发生故障后，向服务调用方返回一个符合预期的、可处理的降级响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常。这样就保证了服务调用方的线程不会被长时间、不必要地占用，避免故障在微服务系统中的蔓延，防止系统雪崩效应的发生。</p>
<br>

<h3 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud Hystrix"></a>Spring Cloud Hystrix</h3><p>Spring Cloud Hystrix 是一款服务容错与保护组件。它是基于 Netflix 公司的开源组件 Hystrix 实现的，它提供了熔断器功能，能够有效地阻止分布式微服务系统中出现联动故障，以提高微服务系统的弹性。Spring Cloud Hystrix 具有服务降级、服务熔断、线程隔离、请求缓存、请求合并以及实时故障监控等强大功能。</p>
<p>在微服务系统中，Hystrix 能够帮助我们实现以下目标：</p>
<ul>
<li><strong>保护线程资源</strong>：防止单个服务的故障耗尽系统中的所有线程资源。</li>
<li><strong>快速失败机制</strong>：当某个服务发生了故障，不让服务调用方一直等待，而是直接返回请求失败。</li>
<li><strong>提供降级（FallBack）方案</strong>：在请求失败后，提供一个设计好的降级方案，通常是一个兜底方法，当请求失败后即调用该方法。</li>
<li><strong>防止故障扩散</strong>：使用熔断机制，防止故障扩散到其他服务。</li>
<li><strong>监控功能</strong>：提供熔断器故障监控组件 Hystrix Dashboard，随时监控熔断器的状态。</li>
</ul>
<br>

<h3 id="Hystrix-服务降级"><a href="#Hystrix-服务降级" class="headerlink" title="Hystrix 服务降级"></a>Hystrix 服务降级</h3><p>Hystrix 提供了服务降级功能，能够保证当前服务不受其他服务故障的影响，提高服务的健壮性。</p>
<p>服务降级的使用场景有以下 2 种：</p>
<ul>
<li>在服务器压力剧增时，根据实际业务情况及流量，对一些不重要、不紧急的服务进行有策略地不处理或简单处理，从而释放服务器资源以保证核心服务正常运作。</li>
<li>当某些服务不可用时，为了避免长时间等待造成服务卡顿或雪崩效应，而主动执行备用的降级逻辑立刻返回一个友好的提示，以保障主体业务不受影响。</li>
</ul>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>导入Hystrix的依赖（此项目已经停止维护，SpringCloud 依赖中不自带，需要单独导入）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在启动类添加注解开启：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrix</span>   <span class="comment">//启用Hystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BorrowApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们关闭用户服务和图书服务来模拟服务不可用。因此查询借阅信息的请求无法正常响应，但我们可以提供一个备选方案，当服务出现异常时返回备选方案：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 使用 @HystrixCommand 来指定备选方案</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;onError1&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;onError2&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByBid</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByBid(bid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// 备选方案，返回值与主方案一致</span></span><br><span class="line">    BorrowDetail <span class="title function_">onError1</span><span class="params">(<span class="type">int</span> uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(<span class="literal">null</span>, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    BorrowDetail <span class="title function_">onError2</span><span class="params">(<span class="type">int</span> bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(<span class="literal">null</span>, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，虽然服务无法正常运行但依然可以给浏览器正常返回响应数据：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeUXo4"><img src="https://s1.ax1x.com/2022/05/05/OeUXo4.png" alt="OeUXo4.png" style="zoom:67%;" /></a></p>
<p>服务降级是一种比较温柔的解决方案，虽然服务本身的不可用，但是能够保证正常响应数据。</p>
<p>Hystrix 服务降级 FallBack 既可以放在服务端进行，也可以放在客户端进行。</p>
<p>Hystrix 会在以下场景下进行服务降级处理：</p>
<ul>
<li>程序运行异常</li>
<li>服务超时</li>
<li>熔断器处于打开状态</li>
<li>线程池资源耗尽</li>
</ul>
<br>

<h3 id="Hystrix-服务熔断-1"><a href="#Hystrix-服务熔断-1" class="headerlink" title="Hystrix 服务熔断"></a>Hystrix 服务熔断</h3><p>熔断机制是为了应对雪崩效应而出现的一种微服务链路保护机制。</p>
<p>当微服务系统中的某个微服务不可用或响应时间太长时，为了保护系统的整体可用性，熔断器会暂时切断请求对该服务的调用，并快速返回一个友好的错误响应。这种熔断状态不是永久的，在经历了一定的时间后，熔断器会再次检测该微服务是否恢复正常，若服务恢复正常则恢复其调用链路。</p>
<h4 id="熔断状态"><a href="#熔断状态" class="headerlink" title="熔断状态"></a>熔断状态</h4><p>在熔断机制中涉及了三种熔断状态：</p>
<ul>
<li>熔断关闭状态（Closed）：当务访问正常时，熔断器处于关闭状态，服务调用方可以正常地对服务进行调用。</li>
<li>熔断开启状态（Open）：默认情况下，在固定时间内接口调用出错比率达到一个阈值（例如 50%），熔断器会进入熔断开启状态。进入熔断状态后，后续对该服务的调用都会被切断，熔断器会执行本地的降级（FallBack）方法。</li>
<li>半熔断状态（Half-Open）： 在熔断开启一段时间之后，熔断器会进入半熔断状态。在半熔断状态下，熔断器会尝试恢复服务调用方对服务的调用，允许部分请求调用该服务，并监控其调用成功率。如果成功率达到预期，则说明服务已恢复正常，熔断器进入关闭状态；如果成功率仍旧很低，则重新进入熔断开启状态。</li>
</ul>
<p>三种熔断状态之间的转化关系如下图：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oeault"><img src="https://s1.ax1x.com/2022/05/05/Oeault.png" alt="Oeault.png"></a></p>
<br>

<h4 id="Hystrix-实现熔断机制"><a href="#Hystrix-实现熔断机制" class="headerlink" title="Hystrix 实现熔断机制"></a>Hystrix 实现熔断机制</h4><p>在 Spring Cloud 中，熔断机制是通过 Hystrix 实现的。Hystrix 会监控微服务间调用的状况，当失败调用到一定比例时（例如 5 秒内失败 20 次），就会启动熔断机制。</p>
<p>Hystrix 实现服务熔断的步骤如下：</p>
<ol>
<li>当服务的调用出错率达到或超过 Hystix 规定的比率（默认为 50%）后，熔断器进入熔断开启状态。</li>
<li>熔断器进入熔断开启状态后，Hystrix 会启动一个休眠时间窗，在这个时间窗内，该服务的降级逻辑会临时充当业务主逻辑，而原来的业务主逻辑不可用。</li>
<li>当有请求再次调用该服务时，会直接调用降级逻辑快速地返回失败响应，以避免系统雪崩。</li>
<li>当休眠时间窗到期后，Hystrix 会进入半熔断转态，允许部分请求对服务原来的主业务逻辑进行调用，并监控其调用成功率。</li>
<li>如果调用成功率达到预期，则说明服务已恢复正常，Hystrix 进入熔断关闭状态，服务原来的主业务逻辑恢复；否则 Hystrix 重新进入熔断开启状态，休眠时间窗口重新计时，继续重复第 2 到第 5 步。</li>
</ol>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>在方法中添加输出语句方便我们观察：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OedMC9"><img src="https://s1.ax1x.com/2022/05/05/OedMC9.png" alt="OedMC9.png"></a></p>
<p>在刚开始时候，服务会正常地去调用 Controller 对应的方法 <code>findUserBorrows</code>，发现失败然后进入备选方法。但在持续请求一段时间之后，没有再调用这个方法，而是直接调用备选方案，这便是升级到了熔断状态：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oed0gI"><img src="https://s1.ax1x.com/2022/05/05/Oed0gI.png" alt="Oed0gI.png"></a></p>
<p>继续不断地发起请求，过一段时间后会尝试正常执行一次<code>findUserBorrows</code>，但是依然是失败状态，所以继续保持熔断状态：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oedf8s"><img src="https://s1.ax1x.com/2022/05/05/Oedf8s.png" alt="Oedf8s.png"></a></p>
<p>因此，它能够对一段时间内出现的错误进行侦测，当侦测到出错次数过多时，熔断器会打开，所有的请求会直接响应失败。一段时间后，只执行一定数量的请求，如果还是出现错误，那么则继续保持打开状态，否则说明服务恢复正常运行，关闭熔断器。打开关闭的服务再测试：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OewAGd"><img src="https://s1.ax1x.com/2022/05/05/OewAGd.png" alt="OewAGd.png"></a></p>
<br>

<h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OewERA"><img src="https://s1.ax1x.com/2022/05/05/OewERA.png" alt="OewERA.png"></a></p>
<br>

<h3 id="OpenFeign-实现降级"><a href="#OpenFeign-实现降级" class="headerlink" title="OpenFeign 实现降级"></a>OpenFeign 实现降级</h3><p>Hystrix 可以配合 Feign 进行降级。可以对接口中定义的远程调用单独进行降级操作。</p>
<p>比如以用户服务宕机为例，此时远程调用是失败的，也就是说 Controller 中的方法在执行过程中会抛出异常，进而被 Hystrix 监控到并进行服务降级。</p>
<p>实际上导致方法执行异常的根源就是远程调用失败。既然用户服务调用失败，那么可以给这个远程调用添加一个替代方案。如果此远程调用失败，则使用替代方案。</p>
<p>Feign 都是以接口的形式来声明远程调用。当远程调用失效时，我们可以自行对其进行实现。创建一个实现类，对原有的接口方法进行替代方案实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>	<span class="comment">// 需要将其注册为 Bean，Feign 才能自动注入</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFallbackClient</span> <span class="keyword">implements</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">  	<span class="comment">// 自行对其进行实现，并返回替代方案</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">0</span>, <span class="string">&quot;默认用户&quot;</span>, <span class="number">0</span>, <span class="string">&quot;男&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookFallbackClient</span> <span class="keyword">implements</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">findBookById</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="number">0</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;默认书籍&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现完成后，需要在原有的接口中指定失败替代实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fallback参数指定为自定义的实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;bookservice&quot;, fallback = BookFallbackClient.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后去掉 <code>BorrowController</code> 的 <code>@HystrixCommand</code> 注解和备选方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByUid</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">findBorrowDetailByBid</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrowService.getBorrowDetailByBid(bid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在配置文件中开启熔断支持：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">circuitbreaker:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>启动服务，调用接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeDRe0"><img src="https://s1.ax1x.com/2022/05/05/OeDRe0.png" alt="OeDRe0.png"></a></p>
<p>已经采用替代方案作为结果。</p>
<br>

<h3 id="监控页面部署"><a href="#监控页面部署" class="headerlink" title="监控页面部署"></a>监控页面部署</h3><p>除了对服务的降级和熔断处理，Hystrix 还提供了准实时的调用监控（Hystrix Dashboard）功能，Hystrix 会持续地记录所有通过 Hystrix 发起的请求的执行信息，并以统计报表的形式展示给用户，包括每秒执行请求的数量、成功请求的数量和失败请求的数量等。</p>
<p>创建一个新的项目，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.10.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8900</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="comment"># 将localhost添加到白名单，默认是不允许的</span></span><br><span class="line">    <span class="attr">proxy-stream-allow-list:</span> <span class="string">&quot;localhost&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建主类，需要添加 <code>@EnableHystrixDashboard</code> 注解开启管理页面：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在需要被监控的服务中添加 Actuator 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Actuator 是 SpringBoot 程序的监控系统，可以实现健康检查，记录信息等。在使用之前需要引入 spring-boot-starter-actuator，并做简单的配置。</p>
</blockquote>
<p>这样就可以在 IDEA 中查看到服务的运行状况：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oe623F"><img src="https://s1.ax1x.com/2022/05/05/Oe623F.png" alt="Oe623F.png"></a></p>
<p>为被监控的服务的配置文件添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>

<p>启动 Hystrix 管理页面服务，访问 <a target="_blank" rel="noopener" href="http://localhost:8900/hystrix">http://localhost:8900/hystrix</a> :</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oeg1FP"><img src="https://s1.ax1x.com/2022/05/05/Oeg1FP.png" alt="Oeg1FP.png"></a></p>
<p>在中间填写要监控的服务，如借阅服务：<a target="_blank" rel="noopener" href="http://localhost:8102/actuator/hystrix.stream%EF%BC%8C%E7%84%B6%E5%90%8E%E7%82%B9%E5%87%BB">http://localhost:8102/actuator/hystrix.stream，然后点击</a> Monitor Stream 进入监控页面：</p>
<p>![image-20220505160915704](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220505160915704.png)</p>
<br>

<h2 id="Gateway-路由网关"><a href="#Gateway-路由网关" class="headerlink" title="Gateway 路由网关"></a>Gateway 路由网关</h2><p>在微服务架构中，一个系统往往由多个微服务组成，而这些服务可能部署在不同机房、不同地区、不同域名下。这种情况下，客户端（例如浏览器、手机、软件工具等）想要直接请求这些服务，就需要知道它们具体的地址信息，例如 IP 地址、端口号等。</p>
<p>这种客户端直接请求服务的方式存在以下问题：</p>
<ul>
<li>当服务数量众多时，客户端需要维护大量的服务地址，这对于客户端来说，是非常繁琐复杂的。</li>
<li>在某些场景下可能会存在跨域请求的问题。</li>
<li>身份认证的难度大，每个微服务需要独立认证。</li>
</ul>
<p>我们可以通过 API 网关来解决这些问题。</p>
<br>

<h3 id="API-网关"><a href="#API-网关" class="headerlink" title="API 网关"></a>API 网关</h3><p>API 网关是一个搭建在客户端和微服务之间的服务，我们可以在 API 网关中处理一些非业务功能的逻辑，例如权限验证、监控、缓存、请求路由等。</p>
<p>API 网关就像整个微服务系统的门面一样，是系统对外的唯一入口。有了它，客户端会先将请求发送到 API 网关，然后由 API 网关根据请求的标识信息将请求转发到微服务实例。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeRose"><img src="https://s1.ax1x.com/2022/05/05/OeRose.png" alt="OeRose.png"></a></p>
<p>对于服务数量众多、复杂度较高、规模比较大的系统来说，使用 API 网关具有以下好处：</p>
<ul>
<li>客户端通过 API 网关与微服务交互时，客户端只需要知道 API 网关地址即可，而不需要维护大量的服务地址，简化了客户端的开发。</li>
<li>客户端直接与 API 网关通信，能够减少客户端与各个服务的交互次数。</li>
<li>客户端与后端的服务耦合度降低。</li>
<li>节省流量，提高性能，提升用户体验。</li>
<li>API 网关还提供了安全、流控、过滤、缓存、计费以及监控等 API 管理功能。</li>
</ul>
<p>常见的 API 网关实现方案主要有以下 5 种：</p>
<ul>
<li>Spring Cloud Gateway</li>
<li>Spring Cloud Netflix Zuul</li>
<li>Kong</li>
<li>Nginx + Lua</li>
<li>Traefik</li>
</ul>
<p>在之前，路由的实现一般使用 Zuul，但它已经停更。现在新出现了由 Spring Cloud 官方开发的 Gateway 路由，它相比 Zuul 不仅性能上得到了一定的提升，并且是官方推出，契合性也会更好，因此我们使用 Gateway 路由。</p>
<br>

<h3 id="Spring-Cloud-Gateway"><a href="#Spring-Cloud-Gateway" class="headerlink" title="Spring Cloud Gateway"></a>Spring Cloud Gateway</h3><p>Spring Cloud Gateway 是 Spring Cloud 团队基于 Spring 5.0、Spring Boot 2.0 和 Project Reactor 等技术开发的高性能 API 网关组件。</p>
<p>Spring Cloud Gateway 旨在提供一种简单而有效的途径来发送 API，并为它们提供横切关注点，例如：安全性，监控&#x2F;指标和弹性。 </p>
<blockquote>
<p>Spring Cloud Gateway 是基于 WebFlux 框架实现的，而 WebFlux 框架底层则使用了高性能的 Reactor 模式通信框架 Netty。</p>
</blockquote>
<h4 id="Spring-Cloud-Gateway-核心概念"><a href="#Spring-Cloud-Gateway-核心概念" class="headerlink" title="Spring Cloud Gateway 核心概念"></a>Spring Cloud Gateway 核心概念</h4><p>Spring Cloud GateWay 最主要的功能就是路由转发，而在定义转发规则时主要涉及了以下三个核心概念，如下表。</p>
<table>
<thead>
<tr>
<th>核心概念</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Route（路由）</td>
<td>网关最基本的模块。它由一个 ID、一个目标 URI、一组断言（Predicate）和一组过滤器（Filter）组成。</td>
</tr>
<tr>
<td>Predicate（断言）</td>
<td>路由转发的判断条件，我们可以通过 Predicate 对 HTTP 请求进行匹配，例如请求方式、请求路径、请求头、参数等，如果请求与断言匹配成功，则将请求转发到相应的服务。</td>
</tr>
<tr>
<td>Filter（过滤器）</td>
<td>过滤器，我们可以使用它对请求进行拦截和修改，还可以使用它对上文的响应进行再处理。</td>
</tr>
</tbody></table>
<blockquote>
<p>注意：其中 Route 和 Predicate 必须同时声明。</p>
</blockquote>
<h4 id="Spring-Cloud-Gateway-的特征"><a href="#Spring-Cloud-Gateway-的特征" class="headerlink" title="Spring Cloud Gateway 的特征"></a>Spring Cloud Gateway 的特征</h4><p>Spring Cloud Gateway 具有以下特性：</p>
<ul>
<li>基于 Spring Framework 5、Project Reactor 和 Spring Boot 2.0 构建。</li>
<li>能够在任意请求属性上匹配路由。</li>
<li>predicates（断言） 和 filters（过滤器）是特定于路由的。</li>
<li>集成了 Hystrix 熔断器。</li>
<li>集成了 Spring Cloud DiscoveryClient（服务发现客户端）。</li>
<li>易于编写断言和过滤器。</li>
<li>能够限制请求频率。</li>
<li>能够重写请求路径。</li>
</ul>
<p>一般情况下可能并不是所有的微服务都需要直接暴露给外部调用，因此可以使用路由机制来添加一层防护，让所有的请求全部通过路由来转发到各个微服务，并且转发给多个相同微服务实例并实现负载均衡。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OehOiR"><img src="https://s1.ax1x.com/2022/05/05/OehOiR.png" alt="OehOiR.png"></a></p>
<h3 id="Gateway-的工作流程"><a href="#Gateway-的工作流程" class="headerlink" title="Gateway 的工作流程"></a>Gateway 的工作流程</h3><p>Spring Cloud Gateway 工作流程如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeWkiq"><img src="https://s1.ax1x.com/2022/05/05/OeWkiq.png" alt="OeWkiq.png"></a></p>
<p>Spring Cloud Gateway 工作流程说明如下：</p>
<ol>
<li>客户端将请求发送到 Spring Cloud Gateway 上。</li>
<li>Spring Cloud Gateway 通过 Gateway Handler Mapping 找到与请求相匹配的路由，将其发送给 Gateway Web Handler。</li>
<li>Gateway Web Handler 通过指定的过滤器链（Filter Chain），将请求转发到实际的服务节点中，执行业务逻辑返回响应结果。</li>
<li>过滤器之间用虚线分开是因为过滤器可能会在转发请求之前（pre）或之后（post）执行业务逻辑。</li>
<li>过滤器（Filter）可以在请求被转发到服务端前，对请求进行拦截和修改，例如参数校验、权限校验、流量监控、日志输出以及协议转换等。</li>
<li>过滤器可以在响应返回客户端之前，对响应进行拦截和再处理，例如修改响应内容或响应头、日志输出、流量监控等。</li>
<li>响应原路返回给客户端。</li>
</ol>
<p>总而言之，客户端发送到 Spring Cloud Gateway 的请求需要通过一定的匹配条件，才能定位到真正的服务节点。在将请求转发到服务进行处理的过程前后（pre 和 post），我们还可以对请求和响应进行一些精细化控制。</p>
<p>Predicate 就是路由的匹配条件，而 Filter 就是对请求和响应进行精细化控制的工具。有了这两个元素，再加上目标 URI，就可以实现一个具体的路由了。</p>
<h3 id="Predicate-断言"><a href="#Predicate-断言" class="headerlink" title="Predicate 断言"></a>Predicate 断言</h3><p>Spring Cloud Gateway 通过 Predicate 断言来实现 Route 路由的匹配规则。简单点说，Predicate 是路由转发的判断条件，请求只有满足了 Predicate 的条件，才会被转发到指定的服务上进行处理。</p>
<p>使用 Predicate 断言需要注意以下 3 点：</p>
<ul>
<li>Route 路由与 Predicate 断言的对应关系为“一对多”，一个路由可以包含多个不同断言。</li>
<li>一个请求想要转发到指定的路由上，就必须同时匹配路由上的所有断言。</li>
<li>当一个请求同时满足多个路由的断言条件时，请求只会被首个成功匹配的路由转发。</li>
</ul>
<p>常见的 Predicate 断言如下表（假设转发的 URI 为 <a href="http://localhost:8001）。">http://localhost:8001）。</a></p>
<table>
<thead>
<tr>
<th>断言</th>
<th>示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Path</td>
<td>- Path&#x3D;&#x2F;dept&#x2F;list&#x2F;**</td>
<td>当请求路径与 &#x2F;dept&#x2F;list&#x2F;** 匹配时，该请求才能被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Before</td>
<td>- Before&#x3D;2022-5-5T11:47:34.255+08:00[Asia&#x2F;Shanghai]</td>
<td>在 2021 年 10 月 20 日 11 时 47 分 34.255 秒之前的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>After</td>
<td>- After&#x3D;2022-5-5T11:47:34.255+08:00[Asia&#x2F;Shanghai]</td>
<td>在 2021 年 10 月 20 日 11 时 47 分 34.255 秒之后的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Between</td>
<td>- Between&#x3D;2022-5-5T15:18:33.226+08:00[Asia&#x2F;Shanghai],2022-5-5T15:23:33.226+08:00[Asia&#x2F;Shanghai]</td>
<td>在 2021 年 10 月 20 日 15 时 18 分 33.226 秒 到 2021 年 10 月 20 日 15 时 23 分 33.226 秒之间的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 服务器上。</td>
</tr>
<tr>
<td>Cookie</td>
<td>- Cookie&#x3D;name,c.biancheng.net</td>
<td>携带 Cookie 且 Cookie 的内容为 name&#x3D;c.biancheng.net 的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Header</td>
<td>- Header&#x3D;X-Request-Id,\d+</td>
<td>请求头上携带属性 X-Request-Id 且属性值为整数的请求，才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
<tr>
<td>Method</td>
<td>- Method&#x3D;GET</td>
<td>只有 GET 请求才会被转发到 <a target="_blank" rel="noopener" href="http://localhost:8001/">http://localhost:8001</a> 上。</td>
</tr>
</tbody></table>
<p>更多参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories">官方文档</a>。</p>
<br>

<h3 id="部署网关"><a href="#部署网关" class="headerlink" title="部署网关"></a>部署网关</h3><p>创建一个新项目作为网关，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一个依赖就是网关的依赖，而第二个则跟其他微服务一样需要注册到 Eureka 才能生效。注意它使用的是 WebFlux 框架，因此不能添加 Web 依赖。</p>
<p>完善配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8801/eureka,</span> <span class="string">http://localhost:8802/eureka</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br></pre></td></tr></table></figure>

<p>编写启动类并启动：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeInaQ"><img src="https://s1.ax1x.com/2022/05/05/OeInaQ.png" alt="OeInaQ.png"></a></p>
<p>但现在还未对网关进行任何的路由配置，因此需要再在配置文件为其添加路由功能的配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">    	<span class="comment"># 配置路由，注意这里是个列表，每一项都包含了很多信息</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">borrow-service</span>   <span class="comment"># 路由名称</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://borrowservice</span>  <span class="comment"># 路由的地址，lb表示使用负载均衡到微服务，也可以使用http正常转发</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 路由规则，断言什么请求会被路由</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/borrow/**</span>  <span class="comment"># 只要是访问的这个路径，一律都被路由到上面指定的服务</span></span><br></pre></td></tr></table></figure>

<p>启动网关，访问 <a target="_blank" rel="noopener" href="http://localhost:8500/borrow/user/1%EF%BC%9A">http://localhost:8500/borrow/user/1：</a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeTWvt"><img src="https://s1.ax1x.com/2022/05/05/OeTWvt.png" alt="OeTWvt.png"></a></p>
<p>现在可以直接通过路由来访问服务了，此时依然可以通过原有的服务地址进行访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Oe7naD"><img src="https://s1.ax1x.com/2022/05/05/Oe7naD.png" alt="Oe7naD.png"></a></p>
<p>这样就可以将不需要外网直接访问的微服务全部放到内网环境下，而只依靠网关来对外进行交涉。</p>
<br>

<h3 id="路由过滤器"><a href="#路由过滤器" class="headerlink" title="路由过滤器"></a>路由过滤器</h3><p>通常情况下，出于安全方面的考虑，服务端提供的服务往往都会有一定的校验逻辑，例如用户登陆状态校验、签名校验等。</p>
<p>在微服务架构中，系统由多个微服务组成，所有这些服务都需要这些校验逻辑，此时我们就可以将这些校验逻辑写到 Spring Cloud Gateway 的 Filter 过滤器中。</p>
<br>

<h4 id="Filter-的分类"><a href="#Filter-的分类" class="headerlink" title="Filter 的分类"></a>Filter 的分类</h4><p>Spring Cloud Gateway 提供了以下两种类型的过滤器，可以对请求和响应进行精细化控制。</p>
<table>
<thead>
<tr>
<th>过滤器类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Pre 类型</td>
<td>这种过滤器在请求被转发到微服务之前可以对请求进行拦截和修改，例如参数校验、权限校验、流量监控、日志输出以及协议转换等操作。</td>
</tr>
<tr>
<td>Post 类型</td>
<td>这种过滤器在微服务对请求做出响应后可以对响应进行拦截和再处理，例如修改响应内容或响应头、日志输出、流量监控等。</td>
</tr>
</tbody></table>
<p>按照作用范围划分，Spring Cloud gateway 的 Filter 可以分为 2 类：</p>
<ul>
<li>GatewayFilter：应用在单个路由或者一组路由上的过滤器。</li>
<li>GlobalFilter：应用在所有的路由上的过滤器。</li>
</ul>
<br>

<h4 id="GatewayFilter-网关过滤器"><a href="#GatewayFilter-网关过滤器" class="headerlink" title="GatewayFilter 网关过滤器"></a>GatewayFilter 网关过滤器</h4><p>GatewayFilter 是 Spring Cloud Gateway 网关中提供的一种应用在单个或一组路由上的过滤器。它可以对单个路由或者一组路由上传入的请求和传出响应进行拦截，并实现一些与业务无关的功能，比如登陆状态校验、签名校验、权限校验、日志输出、流量监控等。</p>
<p>Spring Cloud Gateway 内置了很多种 GatewayFilter，下表中列举了几种常用的网关过滤器及其使用示例。</p>
<table>
<thead>
<tr>
<th>路由过滤器</th>
<th>描述</th>
<th>参数</th>
<th>使用示例</th>
</tr>
</thead>
<tbody><tr>
<td>AddRequestHeader</td>
<td>拦截传入的请求，并在请求上添加一个指定的请求头参数。</td>
<td>name：需要添加的请求头参数的 key； value：需要添加的请求头参数的 value。</td>
<td>- AddRequestHeader&#x3D;my-request-header,1024</td>
</tr>
<tr>
<td>AddRequestParameter</td>
<td>拦截传入的请求，并在请求上添加一个指定的请求参数。</td>
<td>name：需要添加的请求参数的 key； value：需要添加的请求参数的 value。</td>
<td>- AddRequestParameter&#x3D;my-request-param,c.biancheng.net</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>拦截响应，并在响应上添加一个指定的响应头参数。</td>
<td>name：需要添加的响应头的 key； value：需要添加的响应头的 value。</td>
<td>- AddResponseHeader&#x3D;my-response-header,c.biancheng.net</td>
</tr>
<tr>
<td>PrefixPath</td>
<td>拦截传入的请求，并在请求路径增加一个指定的前缀。</td>
<td>prefix：需要增加的路径前缀。</td>
<td>- PrefixPath&#x3D;&#x2F;consumer</td>
</tr>
<tr>
<td>PreserveHostHeader</td>
<td>转发请求时，保持客户端的 Host 信息不变，然后将它传递到提供具体服务的微服务中。</td>
<td>无</td>
<td>- PreserveHostHeader</td>
</tr>
<tr>
<td>RemoveRequestHeader</td>
<td>移除请求头中指定的参数。</td>
<td>name：需要移除的请求头的 key。</td>
<td>- RemoveRequestHeader&#x3D;my-request-header</td>
</tr>
<tr>
<td>RemoveResponseHeader</td>
<td>移除响应头中指定的参数。</td>
<td>name：需要移除的响应头。</td>
<td>- RemoveResponseHeader&#x3D;my-response-header</td>
</tr>
<tr>
<td>RemoveRequestParameter</td>
<td>移除指定的请求参数。</td>
<td>name：需要移除的请求参数。</td>
<td>- RemoveRequestParameter&#x3D;my-request-param</td>
</tr>
<tr>
<td>RequestSize</td>
<td>配置请求体的大小，当请求体过大时，将会返回 413 Payload Too Large。</td>
<td>maxSize：请求体的大小。</td>
<td>- name: RequestSize   args:    maxSize: 5000000</td>
</tr>
</tbody></table>
<p>更多参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories">官方文档</a></p>
<br>

<h4 id="配置过滤器"><a href="#配置过滤器" class="headerlink" title="配置过滤器"></a>配置过滤器</h4><p>比如希望请求到达时，在请求头中添加一些信息再转发给服务，这时候就可以使用路由过滤器来完成，只需要对配置文件进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">borrow-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://borrowservice</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/borrow/**</span></span><br><span class="line">      <span class="comment"># 继续添加新的路由配置，以书籍管理服务为例</span></span><br><span class="line">      <span class="comment"># 一定要对齐routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">book-service</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://bookservice</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/book/**</span></span><br><span class="line">        <span class="attr">filters:</span>   <span class="comment"># 添加过滤器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=Test,</span> <span class="string">HelloWorld!</span></span><br><span class="line">        <span class="comment"># AddRequestHeader 是添加请求头信息</span></span><br></pre></td></tr></table></figure>

<p>在 BookController 中获取并输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BookService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> <span class="type">int</span> bid,</span></span><br><span class="line"><span class="params">                      HttpServletRequest request)</span>&#123;</span><br><span class="line">        System.out.println(request.getHeader(<span class="string">&quot;Test&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> service.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们正常通过端口号访问和通过 Gateway 访问时页面显示相同：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeL71H"><img src="https://s1.ax1x.com/2022/05/05/OeL71H.png" alt="OeL71H.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeOFun"><img src="https://s1.ax1x.com/2022/05/05/OeOFun.png" alt="OeOFun.png"></a></p>
<p>但通过 Gateway 访问可以成功获取到由网关添加的请求头信息。</p>
<br>

<h4 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h4><p>GlobalFilter 是一种作用于所有的路由上的全局过滤器，通过它，我们可以实现一些统一化的业务功能，例如权限认证、IP 访问限制等。当某个请求被路由匹配时，那么所有的 GlobalFilter 会和该路由自身配置的 GatewayFilter 组合成一个过滤器链。</p>
<p>Spring Cloud Gateway 为我们提供了多种默认的 GlobalFilter，例如与转发、路由、负载均衡等相关的全局过滤器。但在实际的项目开发中，通常我们都会自定义一些自己的 GlobalFilter 全局过滤器以满足我们自身的业务需求，而很少直接使用 Spring Cloud Config 提供这些默认的 GlobalFilter。</p>
<blockquote>
<p>关于默认的全局过滤器的详细内容，请参考 <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#global-filters">Spring Cloud 官网</a>。</p>
</blockquote>
<p>比如要实现拦截没有携带指定请求参数的请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>   <span class="comment">// 需要注册为Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line">    <span class="comment">// 只需要实现此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;   </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写判断：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>   <span class="comment">// 需要注册为Bean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span> &#123;</span><br><span class="line">    <span class="comment">// 只需要实现此方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 先获取ServerHttpRequest对象，注意不是HttpServletRequest</span></span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 打印所有的请求参数</span></span><br><span class="line">        System.out.println(request.getQueryParams());</span><br><span class="line">        <span class="comment">// 判断是否包含test参数，且参数值为1</span></span><br><span class="line">        List&lt;String&gt; value = request.getQueryParams().get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(value != <span class="literal">null</span> &amp;&amp; value.contains(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 将ServerWebExchange向过滤链的下一级传递（跟JavaWeb中的过滤器相似）</span></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 不再传递，返回响应</span></span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们不携带参数访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeXJLn"><img src="https://s1.ax1x.com/2022/05/05/OeXJLn.png" alt="OeXJLn.png"></a></p>
<p>携带 test&#x3D;1 访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeX0WF"><img src="https://s1.ax1x.com/2022/05/05/OeX0WF.png" alt="OeX0WF.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OeXgdx"><img src="https://s1.ax1x.com/2022/05/05/OeXgdx.png" alt="OeXgdx.png"></a></p>
<p>成功实现规则判断和拦截操作。</p>
<p>过滤器可以存在多个，我们可以手动指定过滤器之间的顺序：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered &#123;   <span class="comment">//实现Ordered接口</span></span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Order 的值越小优先级越高，并且无论是在配置文件中编写的单个路由过滤器还是全局路由过滤器，都会受 Order 值影响（配置文件中单个路由的过滤器 Order 值按从上往下的顺序从 1 开始递增），最终是按照 Order 值决定哪个过滤器优先执行，当 Order 值一样时，全局路由过滤器执行优先于单独的路由过滤器执行。</p>
<br>

<h2 id="Config-配置中心"><a href="#Config-配置中心" class="headerlink" title="Config 配置中心"></a>Config 配置中心</h2><p>在分布式微服务系统中，几乎所有服务的运行都离不开配置文件的支持，这些配置文件通常由各个服务自行管理，以 properties 或 yml 格式保存在各个微服务的类路径下，例如 application.properties 或 application.yml 等。</p>
<p>这种将配置文件散落在各个服务中的管理方式，存在以下问题：</p>
<ul>
<li><strong>管理难度大</strong>：配置文件散落在各个微服务中，难以管理。</li>
<li><strong>安全性低</strong>：配置跟随源代码保存在代码库中，容易造成配置泄漏。</li>
<li><strong>时效性差</strong>：微服务中的配置修改后，必须重启服务，否则无法生效。</li>
<li><strong>局限性明显</strong>：无法支持动态调整，例如日志开关、功能开关。</li>
</ul>
<p>为了解决这些问题，通常我们都会使用配置中心对配置进行统一管理。市面上开源的配置中心有很多，例如百度的 Disconf、淘宝的 diamond、360 的 QConf、携程的 Apollo 等都是解决这类问题的。Spring Cloud 也有自己的分布式配置中心，那就是 Spring Cloud Config。</p>
<br>

<h3 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a>Spring Cloud Config</h3><p>Spring Cloud Config 是由 Spring Cloud 团队开发的项目，它可以为微服务架构中各个微服务提供集中化的外部配置支持。</p>
<p>简单点说就是，Spring Cloud Config 可以将各个微服务的配置文件集中存储在一个外部的存储仓库或系统（例如 Git 、SVN 等）中，对配置的统一管理，以支持各个微服务的运行。</p>
<p>Spring Cloud Config 包含以下两个部分：</p>
<ul>
<li>Config Server：也被称为分布式配置中心，它是一个独立运行的微服务应用，用来连接配置仓库并为客户端提供获取配置信息、加密信息和解密信息的访问接口。</li>
<li>Config Client：指的是微服务架构中的各个微服务，它们通过 Config Server 对配置进行管理，并从 Config Sever 中获取和加载配置信息。</li>
</ul>
<p>Spring Cloud Config 默认使用 Git 存储配置信息，因此使用 Spirng Cloud Config 构建的配置服务器天然就支持对微服务配置的版本管理。我们可以使用 Git 客户端工具方便地对配置内容进行管理和访问。除了 Git 外，Spring Cloud Config 还提供了对其他存储方式的支持，例如 SVN、本地化文件系统等。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OevZUP"><img src="https://s1.ax1x.com/2022/05/05/OevZUP.png" alt="OevZUP.png"></a></p>
<br>

<h3 id="Spring-Cloud-Config-工作原理"><a href="#Spring-Cloud-Config-工作原理" class="headerlink" title="Spring Cloud Config 工作原理"></a>Spring Cloud Config 工作原理</h3><p>Spring Cloud Config 工作原理如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OejvAx"><img src="https://s1.ax1x.com/2022/05/05/OejvAx.png" alt="OejvAx.png"></a><br>Spring Cloud Config 工作流程如下：</p>
<ol>
<li>开发或运维人员提交配置文件到远程的 Git 仓库。</li>
<li>Config 服务端（分布式配置中心）负责连接配置仓库 Git，并对 Config 客户端暴露获取配置的接口。</li>
<li>Config 客户端通过 Config 服务端暴露出来的接口，拉取配置仓库中的配置。</li>
<li>Config 客户端获取到配置信息，以支持服务的运行。</li>
</ol>
<br>

<h3 id="Spring-Cloud-Config-的特点"><a href="#Spring-Cloud-Config-的特点" class="headerlink" title="Spring Cloud Config 的特点"></a>Spring Cloud Config 的特点</h3><p>Spring Cloud Config 具有以下特点：</p>
<ul>
<li>Spring Cloud Config 由 Spring Cloud 团队开发，可以说是 Spring 的亲儿子，能够与 Spring 的生态体系无缝集成。</li>
<li>Spring Cloud Config 将所有微服务的配置文件集中存储在一个外部的存储仓库或系统（例如 Git）中，统一管理。</li>
<li>Spring Cloud Config 配置中心将配置以 REST 接口的形式暴露给各个微服务，以方便各个微服务获取。</li>
<li>微服务可以通过 Spring Cloud Config 向配置中心统一拉取属于它们自己的配置信息。</li>
<li>当配置发生变化时，微服务不需要重启即可感知到配置的变化，并自动获取和应用最新配置。</li>
<li>一个应用可能有多个环境，例如开发（dev）环境、测试（test）环境、生产（prod）环境等等，开发人员可以通过 Spring Cloud Config 对不同环境的各配置进行管理，且能够确保应用在环境迁移后仍然有完整的配置支持其正常运行。</li>
</ul>
<p>更多参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-config/docs/current/reference/html/">官方文档</a></p>
<br>

<h3 id="部署配置中心"><a href="#部署配置中心" class="headerlink" title="部署配置中心"></a>部署配置中心</h3><p>创建一个新的项目，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfigApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ConfigApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8700</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">configserver</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8801/eureka,</span> <span class="string">http://localhost:8802/eureka</span></span><br></pre></td></tr></table></figure>

<p>这里以本地仓库为例。</p>
<p>首先在项目目录下创建一个本地Git仓库，打开终端，在桌面上创建一个新的本地仓库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">houjuncai@HXD-MacBook-Pro IdeaProjects % <span class="built_in">mkdir</span> config-repo</span><br><span class="line">houjuncai@HXD-MacBook-Pro IdeaProjects % <span class="built_in">cd</span> config-repo</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo % git init</span><br><span class="line">hint: Using <span class="string">&#x27;master&#x27;</span> as the name <span class="keyword">for</span> the initial branch. This default branch name</span><br><span class="line">hint: is subject to change. To configure the initial branch name to use <span class="keyword">in</span> all</span><br><span class="line">hint: of your new repositories, <span class="built_in">which</span> will suppress this warning, call:</span><br><span class="line">hint:</span><br><span class="line">hint: 	git config --global init.defaultBranch &lt;name&gt;</span><br><span class="line">hint:</span><br><span class="line">hint: Names commonly chosen instead of <span class="string">&#x27;master&#x27;</span> are <span class="string">&#x27;main&#x27;</span>, <span class="string">&#x27;trunk&#x27;</span> and</span><br><span class="line">hint: <span class="string">&#x27;development&#x27;</span>. The just-created branch can be renamed via this <span class="built_in">command</span>:</span><br><span class="line">hint:</span><br><span class="line">hint: 	git branch -m &lt;name&gt;</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /Users/houjuncai/IdeaProjects/config-repo/.git/</span><br></pre></td></tr></table></figure>

<p>然后在文件夹中创建配置文件，名称最好是 {服务名称}-{环境}.yml：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">houjuncai@HXD-MacBook-Pro config-repo % vim bookservice-dev.yml</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo % git add .</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo % git commit -m <span class="string">&quot;Init commit&quot;</span></span><br><span class="line">[master (root-commit) 3909e58] Init commit</span><br><span class="line"> 1 file changed, 6 insertions(+)</span><br><span class="line"> create mode 100644 bookservice-dev.yml</span><br><span class="line">houjuncai@HXD-MacBook-Pro config-repo %</span><br></pre></td></tr></table></figure>

<p>vim 编辑：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  datasource:</span></span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line"><span class="symbol">    url:</span> jdbc:mysql:<span class="comment">//43.138.201.82:3306/cloudstudy</span></span><br><span class="line"><span class="symbol">    username:</span> hjc</span><br><span class="line"><span class="symbol">    password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>在配置文件中添加本地仓库的信息（远程仓库同理），<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-config/docs/current/reference/html/#_git_backend">详细使用教程</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">        	<span class="comment"># 这里填写的是本地仓库地址，远程仓库直接填写远程仓库地址 http://git...</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">file://$&#123;user.home&#125;/IdeaProjects/config-repo</span></span><br><span class="line">          <span class="comment"># 默认分支设定为你自己本地或是远程分支的名称</span></span><br><span class="line">          <span class="attr">default-label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>Spring Cloud Config 规定了一套配置文件访问规则，如下表。</p>
<table>
<thead>
<tr>
<th>访问规则</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;{application}&#x2F;{profile}[&#x2F;{label}]</td>
<td>&#x2F;config&#x2F;dev&#x2F;master</td>
</tr>
<tr>
<td>&#x2F;{application}-{profile}.{suffix}</td>
<td>&#x2F;config-dev.yml</td>
</tr>
<tr>
<td>&#x2F;{label}&#x2F;{application}-{profile}.{suffix}</td>
<td>&#x2F;master&#x2F;config-dev.yml</td>
</tr>
<tr>
<td>访问规则内各参数说明如下。</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>{application}：应用名称，即配置文件的名称，例如 config-dev。</li>
<li>{profile}：环境名，一个项目通常都有开发（dev）版本、测试（test）环境版本、生产（prod）环境版本，配置文件则以 application-{profile}.yml 的形式进行区分，例如 application-dev.yml、application-test.yml、application-prod.yml 等。</li>
<li>{label}：Git 分支名，默认是 master 分支，当访问默认分支下的配置文件时，该参数可以省略，即第二种访问方式。</li>
<li>{suffix}：配置文件的后缀，例如 config-dev.yml 的后缀为 yml。</li>
</ul>
<p>通过这套规则，我们在浏览器上就直接对配置文件进行访问。</p>
<p>比如我们要访问图书服务的生产环境代码，可以使用 <a target="_blank" rel="noopener" href="http://localhost:8700/bookservice/dex/master">http://localhost:8700/bookservice/dex/master</a> 链接，它会显示详细信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Om9w7j"><img src="https://s1.ax1x.com/2022/05/05/Om9w7j.png" alt="Om9w7j.png"></a></p>
<p>也可以使用 <a target="_blank" rel="noopener" href="http://localhost:8700/master/bookservice-dev.yml">http://localhost:8700/master/bookservice-dev.yml</a> 链接，它仅显示配置文件原文：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Om9HgK"><img src="https://s1.ax1x.com/2022/05/05/Om9HgK.png" alt="Om9HgK.png"></a></p>
<p>当然，除了使用Git来保存之外，还支持一些其他的方式，详细情况请查阅官网。</p>
<br>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>现在服务可以从服务器读取配置文件，删除原来的<code>application.yml</code>文件（也可以保留，最后无论是远端配置还是本地配置都会被加载），改用<code>bootstrap.yml</code>（在 application.yml 之前加载，可以实现配置文件远程获取）。</p>
<p>首先需要依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写 bootstrap.yaml 配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 名称，即文件名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">bookservice</span></span><br><span class="line">      <span class="comment"># 配置服务器的地址</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:8700</span></span><br><span class="line">      <span class="comment"># 环境</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>配置完成之后，启动服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OmPPiR"><img src="https://s1.ax1x.com/2022/05/05/OmPPiR.png" alt="OmPPiR.png"></a></p>
<p>可以看到已经从远端获取到了配置并进行启动。</p>
<br>

<h1 id="Spring-Cloud-Alibaba"><a href="#Spring-Cloud-Alibaba" class="headerlink" title="Spring Cloud Alibaba"></a>Spring Cloud Alibaba</h1><p>前面了解的微服务是基于 Netflix 的解决方案，它里面很多框架已经停止维护了：</p>
<ul>
<li><strong>注册中心：</strong>Eureka（属于<em>Netflix</em>，2.x版本不再开源，1.x版本仍在更新）</li>
<li><strong>服务调用：</strong>Ribbon（属于<em>Netflix</em>，停止更新，已经彻底被移除）、SpringCloud Loadbalancer（属于<em>SpringCloud</em>官方，目前的默认方案）</li>
<li><strong>服务降级：</strong>Hystrix（属于<em>Netflix</em>，停止更新，已经彻底被移除）</li>
<li><strong>路由网关：</strong>Zuul（属于<em>Netflix</em>，停止更新，已经彻底被移除）、Gateway（属于<em>SpringCloud</em>官方，推荐方案）</li>
<li><strong>配置中心：</strong>Config（属于<em>SpringCloud</em>官方）</li>
</ul>
<p>可见，我们之前使用的整套解决方案中，超过半数的组件都已经处于不可用状态，并且部分组件都是 SpringCloud官方提供的框架进行解决。</p>
<p>阿里巴巴给出了一套全新的解决方案：<a target="_blank" rel="noopener" href="https://spring-cloud-alibaba-group.github.io/github-pages/2021/zh-cn/index.html">官方网站</a></p>
<blockquote>
<p>Spring Cloud Alibaba 致力于提供微服务开发的一站式解决方案。此项目包含开发分布式应用服务的必需组件，方便开发者通过 Spring Cloud 编程模型轻松使用这些组件来开发分布式应用服务。</p>
<p>依托 Spring Cloud Alibaba，您只需要添加一些注解和少量配置，就可以将 Spring Cloud 应用接入阿里分布式应用解决方案，通过阿里中间件来迅速搭建分布式应用系统。</p>
</blockquote>
<p>目前 Spring Cloud Alibaba 提供了如下功能:</p>
<ol>
<li><strong>服务限流降级</strong>：支持 WebServlet、WebFlux, OpenFeign、RestTemplate、Dubbo 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</li>
<li><strong>服务注册与发现</strong>：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</li>
<li><strong>分布式配置管理</strong>：支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li><strong>Rpc服务</strong>：扩展 Spring Cloud 客户端 RestTemplate 和 OpenFeign，支持调用 Dubbo RPC 服务</li>
<li><strong>消息驱动能力</strong>：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</li>
<li><strong>分布式事务</strong>：使用 @GlobalTransactional 注解， 高效并且对业务零侵入地解决分布式事务问题。</li>
<li><strong>阿里云对象存储</strong>：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li><strong>分布式任务调度</strong>：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</li>
<li><strong>阿里云短信服务</strong>：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ol>
<p>可以看到，Spring Cloud Alibaba 实际上是对 Spring Cloud 组件增强功能，是 Spring Cloud 的增强框架，可以兼容 Spring Cloud 原生组件和 Spring Cloud Alibaba 的组件。</p>
<br>

<h2 id="Nacos-更加全能的注册中心"><a href="#Nacos-更加全能的注册中心" class="headerlink" title="Nacos 更加全能的注册中心"></a>Nacos 更加全能的注册中心</h2><p>Nacos 英文全称为 Dynamic Naming and Configuration Service，是一个由阿里巴巴团队使用 Java 语言开发的开源项目。</p>
<p>Nacos 是一个更易于帮助构建云原生应用的动态服务发现、配置和服务管理平台（参考自 <a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/index.html">Nacos 官网</a>）。</p>
<p>Nacos 的命名是由 3 部分组成：</p>
<table>
<thead>
<tr>
<th align="left">组成部分</th>
<th>全称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Na</td>
<td>naming&#x2F;nameServer</td>
<td>即服务注册中心，与 Spring Cloud Eureka 的功能类似。</td>
</tr>
<tr>
<td align="left">co</td>
<td>configuration</td>
<td>即配置中心，与 Spring Cloud Config+Spring Cloud Bus 的功能类似。</td>
</tr>
<tr>
<td align="left">s</td>
<td>service</td>
<td>即服务，表示 Nacos 实现的服务注册中心和配置中心都是以服务为核心的。</td>
</tr>
</tbody></table>
<p>我们可以将 Nacos 理解成服务注册中心和配置中心的组合体，它可以替换 <a target="_blank" rel="noopener" href="http://c.biancheng.net/springcloud/eureka.html">Eureka</a> 作为服务注册中心，实现服务的注册与发现；还可以替换 <a target="_blank" rel="noopener" href="http://c.biancheng.net/springcloud/config.html">Spring Cloud Config</a> 作为配置中心，实现配置的动态刷新。</p>
<p>Nacos 作为服务注册中心经历了十年“双十一”的洪峰考验，具有简单易用、稳定可靠、性能卓越等优点，可以帮助用户更敏捷、容易地构建和管理微服务应用。</p>
<p>Nacos 支持几乎所有主流类型“服务”的发现、配置和管理：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes Service</a></li>
<li><a target="_blank" rel="noopener" href="https://grpc.io/docs/what-is-grpc/core-concepts#service-definition">gRPC </a>&amp; <a target="_blank" rel="noopener" href="https://dubbo.apache.org/zh/">Dubbo RPC Service</a></li>
<li>Spring Cloud RESTful Service</li>
</ul>
<br>

<h3 id="Nacos-的特性"><a href="#Nacos-的特性" class="headerlink" title="Nacos 的特性"></a>Nacos 的特性</h3><p>Nacos 提供了一系列简单易用的特性，能够帮助我们快速地实现动态服务发现、服务配置等功能。</p>
<h4 id="服务发现-1"><a href="#服务发现-1" class="headerlink" title="服务发现"></a>服务发现</h4><p>Nacos 支持基于 DNS 和 RPC 的服务发现。当服务提供者使用原生 SDK、OpenAPI 或一个独立的 Agent TODO 向 Nacos 注册服务后，服务消费者可以在 Nacos 上通过 DNS TODO 或 HTTP&amp;API 查找、发现服务。</p>
<h4 id="服务健康监测"><a href="#服务健康监测" class="headerlink" title="服务健康监测"></a>服务健康监测</h4><p>Nacos 提供对服务的实时健康检查，能够阻止请求发送到不健康主机或服务实例上。Nacos 还提供了一个健康检查仪表盘，能够帮助我们根据健康状态管理服务的可用性及流量。</p>
<h4 id="动态配置服务"><a href="#动态配置服务" class="headerlink" title="动态配置服务"></a>动态配置服务</h4><p>动态配置服务可以让我们以中心化、外部化和动态化的方式，管理所有环境的应用配置和服务配置。</p>
<p>动态配置消除了配置变更时重新部署应用和服务的需要，让配置管理变得更加高效、敏捷。</p>
<p>配置中心化管理让实现无状态服务变得更简单，让服务按需弹性扩展变得更容易。</p>
<p>Nacos 提供了一个简洁易用的 UI 帮助我们管理所有服务和应用的配置。Nacos 还提供包括配置版本跟踪、金丝雀发布、一键回滚配置以及客户端配置更新状态跟踪在内的一系列开箱即用的配置管理特性，帮助我们更安全地在生产环境中管理配置变更和降低配置变更带来的风险。</p>
<h4 id="动态-DNS-服务"><a href="#动态-DNS-服务" class="headerlink" title="动态 DNS 服务"></a>动态 DNS 服务</h4><p>Nacos 提供了动态 DNS 服务，能够让我们更容易地实现负载均衡、流量控制以及数据中心内网的简单 DNS 解析服务。</p>
<p>Nacos 提供了一些简单的 DNS APIs TODO，可以帮助我们管理服务的关联域名和可用的 IP:PORT 列表。</p>
<h4 id="服务及其元数据管理"><a href="#服务及其元数据管理" class="headerlink" title="服务及其元数据管理"></a>服务及其元数据管理</h4><p>Nacos 能让我们从微服务平台建设的视角管理数据中心的所有服务及元数据，包括管理服务的描述、生命周期、服务的静态依赖分析、服务的健康状态、服务的流量管理、路由及安全策略、服务的 SLA 以及 metrics 统计数据。</p>
<br>

<h3 id="Nacos-两大组件"><a href="#Nacos-两大组件" class="headerlink" title="Nacos 两大组件"></a>Nacos 两大组件</h3><p>与 Eureka 类似，Nacos 也采用 CS（Client&#x2F;Server，客户端&#x2F;服务器）架构，它包含两大组件，如下表。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>描述</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>Nacos Server</td>
<td>Nacos 服务端，与 Eureka Server 不同，Nacos Server 由阿里巴巴团队使用 Java 语言编写并将 Nacos Server 的下载地址给用户，用户只需要直接下载并运行即可。</td>
<td>Nacos Server 可以作为服务注册中心，帮助 Nacos Client 实现服务的注册与发现。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Nacos Server 可以作为配置中心，帮助 Nacos Client 在不重启的情况下，实现配置的动态刷新。</td>
</tr>
<tr>
<td>Nacos Client</td>
<td>Nacos 客户端，通常指的是微服务架构中的各个服务，由用户自己搭建，可以使用多种语言编写。</td>
<td>Nacos Client 通过添加依赖 spring-cloud-starter-alibaba-nacos-discovery，在服务注册中心（Nacos Server）中实现服务的注册与发现。</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Nacos Client 通过添加依赖 spring-cloud-starter-alibaba-nacos-config，在配置中心（Nacos Server）中实现配置的动态刷新。</td>
</tr>
</tbody></table>
<br>

<h3 id="Nacos-服务注册中心"><a href="#Nacos-服务注册中心" class="headerlink" title="Nacos 服务注册中心"></a>Nacos 服务注册中心</h3><p>Nacos 作为服务注册中心可以实现服务的注册与发现，流程如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuNQyt"><img src="https://s1.ax1x.com/2022/05/06/OuNQyt.png" alt="OuNQyt.png"></a></p>
<p>在图中共涉及到以下 3 个角色：</p>
<ul>
<li>服务注册中心（Register Service）：它是一个 Nacos Server，可以为服务提供者和服务消费者提供服务注册和发现功能。</li>
<li>服务提供者（Provider Service）：它是一个 Nacos Client，用于对外服务。它将自己提供的服务注册到服务注册中心，以供服务消费者发现和调用。</li>
<li>服务消费者（Consumer Service）：它是一个 Nacos Client，用于消费服务。它可以从服务注册中心获取服务列表，调用所需的服务。</li>
</ul>
<p>Nacos 实现服务注册与发现的流程如下：</p>
<ol>
<li>从 Nacos 官方提供的下载页面中，下载 Nacos Server 并运行。</li>
<li>服务提供者 Nacos Client 启动时，会把服务以服务名（spring.application.name）的方式注册到服务注册中心（Nacos Server）；</li>
<li>服务消费者 Nacos Client 启动时，也会将自己的服务注册到服务注册中心；</li>
<li>服务消费者在注册服务的同时，它还会从服务注册中心获取一份服务注册列表信息，该列表中包含了所有注册到服务注册中心上的服务的信息（包括服务提供者和自身的信息）；</li>
<li>在获取了服务提供者的信息后，服务消费者通过 HTTP 或消息中间件远程调用服务提供者提供的服务。</li>
</ol>
<br>

<h4 id="安装与部署"><a href="#安装与部署" class="headerlink" title="安装与部署"></a>安装与部署</h4><p>Nacos服务器是独立安装部署的，因此需要下载最新的 Nacos 服务端程序，下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos">https://github.com/alibaba/nacos</a> 下载 zip 文件进行解压。</p>
<p>然后将解压后的文件拖入项目文件夹下，便于在 IDEA 内部启动，添加运行配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OulPf0"><img src="https://s1.ax1x.com/2022/05/06/OulPf0.png" alt="OulPf0.png"></a></p>
<p>其中 <code>-m standalone </code>表示单节点模式，Mac 和 Linux 下记得将解释器设定为 <code>/bin/bash</code>，由于 Nacos 在 Mac&#x2F;Linux 默认是后台启动模式，需要修改它的 bash 文件让它变成前台启动，这样  IDEA 关闭了Nacos 就自动关闭：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注释掉原有的两行启动</span></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span> &gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment">#nohup $JAVA $&#123;JAVA_OPT&#125; nacos.nacos &gt;&gt; $&#123;BASE_DIR&#125;/logs/start.out 2&gt;&amp;1 &amp;</span></span><br><span class="line"><span class="comment">#echo &quot;nacos is starting，you can check the $&#123;BASE_DIR&#125;/logs/start.out&quot;</span></span><br><span class="line"><span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> nacos.nacos</span><br></pre></td></tr></table></figure>

<p>启动后访问管理页面地址 <a target="_blank" rel="noopener" href="http://localhost:8848/nacos/index.html%EF%BC%9A">http://localhost:8848/nacos/index.html：</a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ou1Lqg"><img src="https://s1.ax1x.com/2022/05/06/Ou1Lqg.png" alt="Ou1Lqg.png"></a></p>
<p>默认的用户名和管理员密码都是 <code>nacos</code>：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ou3mJ1"><img src="https://s1.ax1x.com/2022/05/06/Ou3mJ1.png" alt="Ou3mJ1.png"></a></p>
<br>

<h4 id="服务注册与发现-1"><a href="#服务注册与发现-1" class="headerlink" title="服务注册与发现"></a>服务注册与发现</h4><p>实现基于 Nacos 的服务注册与发现需要导入 SpringCloudAlibaba 相关的依赖，在父工程将依赖进行管理：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      </span><br><span class="line">      	<span class="comment">&lt;!-- 这里引入最新的SpringCloud依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">          	<span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     	  <span class="comment">&lt;!-- 这里引入最新的SpringCloudAlibaba依赖，2021.0.1.0版本支持SpringBoot2.6.X --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在子项目中添加服务发现依赖，以图书服务为例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>和注册到 Eureka 相同，也需要在配置文件中配置 Nacos 注册中心的地址：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8101</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">book-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://43.138.201.82:3306/cloudstudy</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hjc</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br></pre></td></tr></table></figure>

<p>启动图书服务，可以在 Nacos 的服务列表中找到：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ou843t"><img src="https://s1.ax1x.com/2022/05/06/Ou843t.png" alt="Ou843t.png"></a></p>
<p>按照同样的方法将另外两个服务也注册到 Nacos 中：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuGFUJ"><img src="https://s1.ax1x.com/2022/05/06/OuGFUJ.png" alt="OuGFUJ.png"></a></p>
<p>使用 OpenFeign 实现服务发现远程调用以及负载均衡，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 这里需要单独导入LoadBalancer依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> <span class="type">int</span> uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;bookservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> <span class="type">int</span> bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserClient userClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BookClient bookClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  userClient.getUserById(uid);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.getUserById(borrow.get(<span class="number">0</span>).getUid());</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在启动类上添加 <code>@EnableFeignClients</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BorrowApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuYe0O"><img src="https://s1.ax1x.com/2022/05/06/OuYe0O.png" alt="OuYe0O.png"></a></p>
<p>可以自动发现服务并访问服务。</p>
<p>然后删去图书服务和用户服务的端口配置，多配置几个实例：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OutXZT"><img src="https://s1.ax1x.com/2022/05/06/OutXZT.png" alt="OutXZT.png" style="zoom:67%;" /></a></p>
<p>然后我们在图书服务和用户服务中添加一句打印方便之后查看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;调用用户服务&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> service.getUserById(uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动全部服务：<br><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuUCtg"><img src="https://s1.ax1x.com/2022/05/06/OuUCtg.png" alt="OuUCtg.png"></a></p>
<p>可以看到 Nacos 中的实例数量已经显示为<code>2</code>：</p>
<p>然后调用借阅服务观察负载均衡远程调用：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuUB3d"><img src="https://s1.ax1x.com/2022/05/06/OuUB3d.png" alt="OuUB3d.png"></a></p>
<p>这样就实现了基于 Nacos 的服务的注册与发现，大致流程与Eureka  一致。</p>
<p>Nacos 区分了临时实例和非临时实例：</p>
<ul>
<li>临时实例：和 Eureka  一样，采用心跳机制向Nacos 发送请求保持在线状态，一旦心跳停止，代表实例下线，不保留实例信息。</li>
<li>非临时实例：由 Nacos 主动进行联系，如果连接失败，那么不会移除实例信息，而是将健康状态设定为 false，相当于会对某个实例状态持续地进行监控。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuUO5F"><img src="https://s1.ax1x.com/2022/05/06/OuUO5F.png" alt="OuUO5F.png"></a></p>
<p>可以通过配置文件进行修改临时实例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8102</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">borrow-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://43.138.201.82:3306/cloudstudy</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hjc</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment"># 将ephemeral修改为false，表示非临时实例</span></span><br><span class="line">        <span class="attr">ephemeral:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>在 Nacos 中查看会发现实例已经不是临时的了。</p>
<p>如果这时关闭此实例：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuasG4"><img src="https://s1.ax1x.com/2022/05/06/OuasG4.png" alt="OuasG4.png"></a></p>
<p>Nacos 只会将该实例的健康状态变为 false 而不会删除实例的信息。 </p>
<br>

<h4 id="集群分区"><a href="#集群分区" class="headerlink" title="集群分区"></a>集群分区</h4><p>集群分区概念在 Eureka 中也有出现：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">		<span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">    <span class="comment">## 集群分区</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:8888/eureka</span></span><br></pre></td></tr></table></figure>

<p>在一个分布式应用中，相同服务的实例可能会在不同的机器、位置上启动。比如用户管理服务 可能在成都有 1台服务器部署、重庆有 1 台服务器部署。假如在成都的服务器上启动了借阅服务，那么如果借阅服务现在要调用用户服务，就应该优先选择同一个区域的用户服务进行调用，这样会使得响应速度更快。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuraL9"><img src="https://s1.ax1x.com/2022/05/06/OuraL9.png" alt="OuraL9.png"></a></p>
<p>因此我们可以对部署在不同机房的服务进行分区，实例的分区是默认：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuroJf"><img src="https://s1.ax1x.com/2022/05/06/OuroJf.png" alt="OuroJf.png"></a></p>
<p>可以在配置文件中进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">book-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment"># 修改为成都地区的集群</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">Chengdu</span></span><br></pre></td></tr></table></figure>

<p>由于我们这里使用的是不同的启动配置，因此需要在启动配置中添加环境变量<code>spring.cloud.nacos.discovery.cluster-name</code></p>
<p>这里我们将用户服务和图书服务两个区域都分配一个，借阅服务配置为成都地区：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ou6gQU"><img src="https://s1.ax1x.com/2022/05/06/Ou6gQU.png" alt="Ou6gQU.png" style="zoom:67%;" /></a></p>
<p>修改完成后重启服务和 Nacos，观察 Nacos 中集群分布情况：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OucO3V"><img src="https://s1.ax1x.com/2022/05/06/OucO3V.png" alt="OucO3V.png"></a></p>
<p>可以看到现在有两个集群，并且都有一个实例正在运行。多次调用借阅服务，发现并没有按照区域进行优先调用，它依然使用的是轮询模式的负载均衡调用。</p>
<p>只是因为我们必须要提供 Nacos 的负载均衡实现才能开启区域优先调用机制，需要在配制文件中进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">borrow-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">Chengdu</span></span><br><span class="line">    <span class="comment"># 将loadbalancer的nacos支持开启，集成Nacos负载均衡</span></span><br><span class="line">    <span class="attr">loadbalancer:</span></span><br><span class="line">      <span class="attr">nacos:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>然后重启借阅服务并多次调用，发现优先调用的是同区域的用户和图书服务。然后可以将成都地区的服务下线：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuRW1x"><img src="https://s1.ax1x.com/2022/05/06/OuRW1x.png" alt="OuRW1x.png"></a></p>
<p>继续多次调用借阅服务，在下线之后由于本区域内没有可用服务了，借阅服务将会调用重庆区域的用户服务。</p>
<p>除了根据区域优先调用之外，同一个区域内的实例也可以单独设置权重，Nacos 会优先选择权重更大的实例进行调用，可以直接在编辑页面中进行配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OuWKUJ"><img src="https://s1.ax1x.com/2022/05/06/OuWKUJ.png" alt="OuWKUJ.png"></a></p>
<p>或在配置文件中进行配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">book-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># 权重大小，越大越优先调用，默认为1</span></span><br><span class="line">        <span class="attr">weight:</span> <span class="number">0.5</span></span><br></pre></td></tr></table></figure>

<p>通过配置权重，某些性能不太好的机器就能够更少地被使用，而更多的使用那些网络良好性能更高的主机上的实例。</p>
<br>

<h4 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h4><p>通过 SpringCloud Config 我们可以通过配置服务来加载远程配置，这样就可以在远端集中管理配置文件。</p>
<p>Nacos 也支持这样的操作。假如现在要将借阅服务的配置文件放到 Nacos 进行管理，就需要在 Nacos 中创建配置文件：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKuajg"><img src="https://s1.ax1x.com/2022/05/06/OKuajg.png" alt="OKuajg.png"></a></p>
<p>将借阅服务的配置文件全部复制过来，<strong>Data ID</strong> 的格式跟之前一样为：<code>应用名称-环境.yml</code>。如果只编写应用名称，那么代表此配置文件任何环境下都会使用。每个配置文件都可以进行分组：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKuN38"><img src="https://s1.ax1x.com/2022/05/06/OKuN38.png" alt="OKuN38.png" style="zoom:67%;" /></a></p>
<p>完成后点击发布即可：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKKFxS"><img src="https://s1.ax1x.com/2022/05/06/OKKFxS.md.png" alt="OKKFxS.md.png"></a></p>
<p>然后在项目中导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 user-servic e服务中添加<code>bootstrap.yml</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">  	<span class="comment"># 服务名称和配置文件保持一致</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">  	<span class="comment"># 环境也是和配置文件保持一致</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">      	<span class="comment"># 配置文件后缀名</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yml</span></span><br><span class="line">        <span class="comment"># 配置中心服务器地址，也就是Nacos地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br></pre></td></tr></table></figure>

<p>启动服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKMMTA"><img src="https://s1.ax1x.com/2022/05/06/OKMMTA.png" alt="OKMMTA.png"></a></p>
<p>可以看到成功读取配置文件并启动。</p>
<p>Nacos 还支持配置文件的热更新。比如我们在配置文件中添加了一个属性，而这个时候可能需要实时修改，并在后端实时更新。</p>
<p>创建一个新的 Controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.txt&#125;&quot;)</span>  <span class="comment">// 从配置文件中读取test.txt的字符串值，作为test接口的返回值</span></span><br><span class="line">    <span class="keyword">private</span> String txt;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> txt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改配置文件，然后重启服务器：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKQ9c8"><img src="https://s1.ax1x.com/2022/05/06/OKQ9c8.png" alt="OKQ9c8.png"></a></p>
<p>可以正常读取：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKQIEj"><img src="https://s1.ax1x.com/2022/05/06/OKQIEj.md.png" alt="OKQIEj.md.png"></a></p>
<p>将配置文件的值进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">txt:</span> <span class="string">ssssv2</span></span><br></pre></td></tr></table></figure>

<p>再次访问接口，发现虽然后台成功检测到值更新，但值却没改变：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKlp5R"><img src="https://s1.ax1x.com/2022/05/06/OKlp5R.png" alt="OKlp5R.png"></a></p>
<p>我们需要添加注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span>   <span class="comment">// 添加此注解就能实现自动刷新了</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.txt&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String txt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> txt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务器，再次访问。</p>
<br>

<h4 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h4><p>我们还可以将配置文件或是服务实例划分到不同的命名空间中。这样可以区分开发、生产环境或是引用归属：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OK19eg"><img src="https://s1.ax1x.com/2022/05/06/OK19eg.png" alt="OK19eg.png"></a></p>
<p>创建一个新的命名空间：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OK1VS0"><img src="https://s1.ax1x.com/2022/05/06/OK1VS0.png" alt="OK1VS0.png"></a></p>
<p>在新创建的 dev 命名空间下没有任何配置文件和服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OK1Kw4"><img src="https://s1.ax1x.com/2022/05/06/OK1Kw4.png" alt="OK1Kw4.png"></a></p>
<p>只是因为在不同的命名空间下，实例和配置都是相互之间隔离的，如果将 user-service 和 book-service 移动到 dev 命名空间：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment"># 命名空间 id</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="number">4e718562</span><span class="string">-a09d-40f9-b87a-909f3645e83e</span></span><br></pre></td></tr></table></figure>

<p>那么此时再调用 borrow-service 会发现它是无法调用 dev 命名空间中的服务的。</p>
<br>

<h4 id="实现高可用"><a href="#实现高可用" class="headerlink" title="实现高可用"></a>实现高可用</h4><p>在实际的项目开发中，一个微服务系统往往由十几，几十个甚至几百个微服务组成。 这些服务若全部注册到同一台 Nacos Server，就极有可能导致 Nacos Server 因为不堪重负而崩溃，最终导致整个微服务系统瘫痪。解决这个问题最直接的办法就是使用 Nacos Server 集群。</p>
<p>Nacos Server 的集群化部署有一个十分明显的优点，那就是可以保障系统的高可用性。在集群化部署中，只要不是所有的 Nacos Server 都停止工作，Nacos Client 就还可以从集群中正常的 Nacos Server 上获取服务信息及配置，而不会导致系统的整体瘫痪，这就是 Nacos Server 集群化部署的高可用性。</p>
<p>官方方案：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OK3m9I"><img src="https://s1.ax1x.com/2022/05/06/OK3m9I.png" alt="OK3m9I.png"></a></p>
<blockquote>
<p><a href="http://ip1:port/openAPI：直连">http://ip1:port/openAPI：直连</a> iP 模式，机器崩溃则需要修改 iP 才可以使用。</p>
<p><a href="http://SLB:port/openAPI：挂载SLB">http://SLB:port/openAPI：挂载SLB</a>  模式(内网SLB，不可暴露到公网，以免带来安全风险)，直连 SLB 即可，下面挂 S erver 真实 iP，可读性不好。</p>
<p><a href="http://nacos.com:port/openAPI：域名">http://nacos.com:port/openAPI：域名</a> + SLB模式(内网 SLB，不可暴露到公网，以免带来安全风险)，可读性好，且换 iP 方便，推荐模式</p>
</blockquote>
<p>官方推荐在所有的 Nacos 服务端之前建立负载均衡，我们通过访问负载均衡服务器来间接访问到各个 Nacos 服务器。</p>
<p>比如有三个 Nacos 服务器做集群，每个服务不会访问 Nacos 进行注册，只需要在任意 Nacos 服务器上注册就可以，Nacos 服务器之间会自动同步信息。</p>
<p>如果随意指定一台 Nacos 服务器进行注册但这台 Nacos 服务器挂了，虽然还有其他 Nacos 服务器正常，但也无法完成注册。而此时整个集群还是可用的状态。</p>
<p>因此就需要在所有 Nacos 服务器之前搭建一个 SLB（服务器负载均衡）来避免这个的问题。要实现外界对服务访问的负载均衡，可以使用 Nginx 。</p>
<p>在 SLB 上层还有 DNS 服务器。这是因为 SLB 是裸 iP。如果 SLB 服务器修改了地址，那么所有微服务注册的地址也需要修改。所以这里通过域名访问，让DNS去解析真实 iP。这样，就算改变了 iP 也只需要修改域名解析记录，域名地址是不会变化的。</p>
<p>最后是 Nacos 的数据存储模式，在单节点的情况下 Nacos 将数据存放在自带的一个嵌入式数据库中：</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0nng0ithgj215i0b875m.jpg" alt="image-20220326222343802"></p>
<p>这种模式只适用于单节点，在多节点集群模式下需要同步数据。因此 Nacos 提供了 MySQL 统一存储支持，我们只需要让所有的 Nacos 服务器连接 MySQL 进行数据存储即可件。</p>
<p>首先需导入数据库，文件在 conf 目录中：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKJvqK"><img src="https://s1.ax1x.com/2022/05/06/OKJvqK.png" alt="OKJvqK.png"></a></p>
<p>然后创建 2 个 Nacos 服务器，使用 SFTP 将 Nacos 服务端上传到 Linux 服务器。</p>
<p>解压后对其配置文件进行修改，首先是 <code>application.properties</code> 配置文件，修改以下内容，包括 MySQL 服务器的信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Default web server port:</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8801</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#*************** Config Module Related Configurations ***************#</span></span><br><span class="line"><span class="comment">### If use MySQL as datasource:</span></span><br><span class="line"><span class="attr">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### Count of DB:</span></span><br><span class="line"><span class="attr">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">### Connect URL of DB:</span></span><br><span class="line"><span class="attr">db.url.0</span>=<span class="string">jdbc:mysql://43.138.201.82:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="attr">db.user.0</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">db.password.0</span>=<span class="string">nacos</span></span><br></pre></td></tr></table></figure>

<p>然后修改集群配置，需要重命名配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-8-13-centos ~/nacos/conf]<span class="comment"># mv cluster.conf.example cluster.conf</span></span><br></pre></td></tr></table></figure>

<p>编辑配置文件，端口使用内网 iP 地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-8-13-centos ~/nacos/conf]<span class="comment"># vim cluster.conf</span></span><br><span class="line"><span class="comment">#it is ip</span></span><br><span class="line"><span class="comment">#example</span></span><br><span class="line">10.0.0.12:8801</span><br><span class="line">10.0.0.12:8802</span><br></pre></td></tr></table></figure>

<p>最后修改 Nacos 的内存分配以及前台启动，修改 <code>startup.sh</code> 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-8-13-centos ~/nacos/bin]<span class="comment"># vim startup.sh</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 注释掉原有的两行启动</span></span><br><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span>&quot;</span> &gt; <span class="variable">$&#123;BASE_DIR&#125;</span>/logs/start.out 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment">#nohup $JAVA $&#123;JAVA_OPT&#125; nacos.nacos &gt;&gt; $&#123;BASE_DIR&#125;/logs/start.out 2&gt;&amp;1 &amp;</span></span><br><span class="line"><span class="comment">#echo &quot;nacos is starting，you can check the $&#123;BASE_DIR&#125;/logs/start.out&quot;</span></span><br><span class="line"><span class="variable">$JAVA</span> <span class="variable">$&#123;JAVA_OPT&#125;</span> nacos.nacos</span><br></pre></td></tr></table></figure>

<p>将 Nacos 复制一份并将端口修改为 8802，启动这两个 Nacos 服务器。</p>
<p>然后打开管理面板，可以看到两个节点都已经启动了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKNkHf"><img src="https://s1.ax1x.com/2022/05/06/OKNkHf.png" alt="OKNkHf.png"></a></p>
<p>第三步需要添加一个 SLB，这里用 Nginx 做反向代理。</p>
<p>要让 Nginx 代理两个 Nacos 服务器：修改 <code>/etc/nginx/nginx.conf</code> 配置文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 添加我创建的两个Nacos服务器</span><br><span class="line">upstream nacos-server &#123;</span><br><span class="line">        server 10.0.0.12:8801;</span><br><span class="line">        server 10.0.0.12:8802;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen   80;</span><br><span class="line">        server_name  43.138.201.82;</span><br><span class="line"></span><br><span class="line">        location /nacos &#123;</span><br><span class="line">                proxy_pass http://nacos-server;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启 Nginx 服务器即可成功连接。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKUSaT"><img src="https://s1.ax1x.com/2022/05/06/OKUSaT.png" alt="OKUSaT.png"></a></p>
<p>然后将所有的服务全部修改为云服务器上 Nacos 的地址后启动：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OKUAMR"><img src="https://s1.ax1x.com/2022/05/06/OKUAMR.png" alt="OKUAMR.png"></a></p>
<p>这样就搭建好了 Nacos 集群。</p>
<br>

<h2 id="Sentinel-流量防卫兵"><a href="#Sentinel-流量防卫兵" class="headerlink" title="Sentinel 流量防卫兵"></a>Sentinel 流量防卫兵</h2><p>Sentinel 是由阿里巴巴中间件团队开发的开源项目，是一种面向分布式微服务架构的轻量级高可用流量控制组件。</p>
<p>Sentinel 主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度帮助用户保护服务的稳定性。</p>
<blockquote>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p>
</blockquote>
<p>Sentinel 具有以下特征:</p>
<ul>
<li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
<li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架&#x2F;库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java&#x2F;Go&#x2F;C++ 等多语言的原生实现。</li>
<li><strong>完善的 SPI 扩展机制</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li>
</ul>
<blockquote>
<p>SPI ，全称为 Service Provider Interface，是一种服务发现机制。它可以在 ClassPath 路径下的 META-INF&#x2F;services 文件夹查找文件，并自动加载文件中定义的类。</p>
</blockquote>
<p>从功能上来说，Sentinel 与 Spring Cloud Netfilx Hystrix 类似，但 Sentinel 要比 Hystrix 更加强大，例如 Sentinel 提供了流量控制功能、比 Hystrix 更加完善的实时监控功能等等。</p>
<br>

<h3 id="安装与部署-1"><a href="#安装与部署-1" class="headerlink" title="安装与部署"></a>安装与部署</h3><p>和 Nacos 相同，Sentinel 也是独立安装和部署的：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">https://github.com/alibaba/Sentinel/releases</a></p>
<p>下载后是一个 <code>.jar</code> 文件（SpringBoot 项目），需要在 IDEA 中添加运行配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMo8M9"><img src="https://s1.ax1x.com/2022/05/07/OMo8M9.png" alt="OMo8M9.png" style="zoom:67%;" /></a></p>
<p>默认端口占用 8080，如果需要修改，可以添加环境变量。然后直接启动，</p>
<p>启动后访问 Sentinel 的监控页面，用户名和密码都是<code>sentinel</code>，地址：<a target="_blank" rel="noopener" href="http://localhost:8858/#/dashboard">http://localhost:8858/#/dashboard</a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMoWi8"><img src="https://s1.ax1x.com/2022/05/07/OMoWi8.png" alt="OMoWi8.png"></a></p>
<p>这样就成功开启了监控页面，然后需要让我们的服务连接到 Sentinel 控制台，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在配置文件中添加 Sentinel 相关配置（实际上Sentinel是本地在进行管理，但是我们可以连接到监控页面，这样就可以图形化操作了）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">book-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://43.138.201.82:3306/cloudstudy</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hjc</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment"># 添加监控页面地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8858</span></span><br></pre></td></tr></table></figure>

<p>现在启动服务，然后访问一次服务，这样 Sentinel 中就会存在信息了（懒加载机制，不会一上来就加载）：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMTW01"><img src="https://s1.ax1x.com/2022/05/07/OMTW01.png" alt="OMTW01.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMTH6H"><img src="https://s1.ax1x.com/2022/05/07/OMTH6H.png" alt="OMTH6H.png" style="zoom:67%;" /></a></p>
<p>这样就可以在 Sentinel 控制台中对服务运行情况进行实时监控了。监控的内容非常的多，包括时间点、QPS(每秒查询率)、响应时间等数据。</p>
<p>按照上面的方式将所有的服务全部连接到 Sentinel 管理面板中。</p>
<br>

<h3 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h3><p>任何系统处理请求的能力都是有限的，但任意时间内到达系统的请求量往往是随机且不可控的，如果在某一个瞬时时刻请求量急剧增，那么系统就很有可能被瞬时的流量高峰冲垮。为了避免此类情况发生，我们都需要根据系统的处理能力对请求流量进行控制，这就是我们常说的“流量控制”，简称“流控”。</p>
<p>Sentinel 作为一种轻量级高可用流量控制组件，流量控制是它最主要的工作之一。</p>
<p>我们可以针对资源定义流控规则，Sentinel 会根据这些规则对流量相关的各项指标进行监控。当这些指标当达到或超过流控规则规定的阈值时，Sentinel 会对请求的流量进行限制（即“限流”），以避免系统被瞬时的流量高峰冲垮，保障系统的高可用性。</p>
<p>一条流量规则主要由下表中的属性组成，我们可以通过组合这些属性来实现不同的限流效果。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
<th>默认值</th>
</tr>
</thead>
<tbody><tr>
<td>资源名</td>
<td>流控规则的作用对象。</td>
<td>-</td>
</tr>
<tr>
<td>阈值</td>
<td>流控的阈值。</td>
<td>-</td>
</tr>
<tr>
<td>阈值类型</td>
<td>流控阈值的类型，包括 QPS 或并发线程数。</td>
<td>QPS</td>
</tr>
<tr>
<td>针对来源</td>
<td>流控针对的调用来源。</td>
<td>default，表示不区分调用来源</td>
</tr>
<tr>
<td>流控模式</td>
<td>调用关系限流策略，包括直接、链路和关联。</td>
<td>直接</td>
</tr>
<tr>
<td>流控效果</td>
<td>流控效果（直接拒绝、Warm Up、匀速排队），不支持按调用关系限流。</td>
<td>直接拒绝</td>
</tr>
</tbody></table>
<blockquote>
<p>注：QPS 表示并发请求数，换句话说就是，每秒钟最多通过的请求数。</p>
</blockquote>
<p>同一个资源可以创建多条流控规则，Sentinel 会遍历这些规则，直到有规则触发限流或者所有规则遍历完毕为止。</p>
<p>Sentinel 触发限流时，资源会抛出 BlockException 异常，此时我们可以捕捉 BlockException 来自定义被限流之后的处理逻辑。</p>
<blockquote>
<p>注意：详细的流控规则配置，请参考 <a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/flow-control.html">Sentinel 官方流控文档</a>。</p>
</blockquote>
<p>实现流量控制的策略</p>
<ul>
<li><strong>快速拒绝</strong>：不再接受新的请求，直接返回一个拒绝信息，告诉用户访问频率过高。</li>
<li><strong>预热</strong>：基于快速拒绝，但由于某些情况下高并发请求是在某一时刻突然到来的，可以缓慢地将阈值提高到指定阈值，形成一个缓冲保护。</li>
<li><strong>排队等待</strong>：不接受新的请求，但也不直接拒绝，而是先进队列等待，如果规定时间内能够执行，则执行，若超时就不执行。</li>
</ul>
<p>针对于是否超过流量阈值的判断算法：</p>
<ol>
<li><p><strong>漏桶算法</strong></p>
<p>水（请求）先进入到漏桶里，漏桶以一定的速度出水（接口有响应速率），当水流入速度过大会直接溢出（访问频率超过接口响应速率），然后就拒绝请求，可以看出漏桶算法能强行限制数据的传输速率：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMORne"><img src="https://s1.ax1x.com/2022/05/07/OMORne.png" alt="OMORne.png"></a></p>
<p>桶是有容量的，所以当桶的容量已满时就装不下水了只能丢弃请求。</p>
<p>因为漏桶的漏出速率是固定的参数，所以即使网络中不存在资源冲突（没有发生拥塞），漏桶算法也不能使流突发（burst）到端口速率。因此漏桶算法对于存在突发特性的流量来说缺乏效率。</p>
</li>
<li><p><strong>令牌桶算法</strong></p>
<p>令牌桶算法（Token Bucket）和 Leaky Bucket 效果一样但方向相反，更加容易理解。随着时间流逝，系统会按恒定 1&#x2F;QPS 时间间隔（如果 QPS&#x3D;100，则间隔是 10ms）往桶里加入 Token(想象和漏洞漏水相反，有个水龙头在不断的加水），如果桶已经满了就不再加了。新请求来临时会各自拿走一个 Token，如果没有 Token 可拿了就阻塞或者拒绝服务。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMX280"><img src="https://s1.ax1x.com/2022/05/07/OMX280.png" alt="OMX280.png"></a></p>
<p>令牌桶的另外一个好处是可以方便的改变速度。 一旦需要提高速率，则按需提高放入桶中的令牌的速率。一般会定时(比如 100 毫秒)往桶中增加一定数量的令牌，有些变种算法则实时的计算应该增加的令牌的数量。</p>
<p>当流量下降时，令牌桶中的令牌会逐渐积累，这样如果突然出现高并发，那么就能在短时间内拿到大量的令牌。</p>
</li>
<li><p><strong>固定时间窗口算法</strong></p>
<p>在固定的时间窗⼝内，可以允许固定数量的请求进⼊。超过数量就拒绝或者排队，等下⼀个时间段进⼊。</p>
<p>我们可以对某一个时间段内的请求进行统计和计数，比如在<code>14:15</code>到<code>14:16</code>这一分钟内，请求量不能超过<code>100</code>，也就是一分钟之内不能超过<code>100</code>次请求，那么就可以像下面这样进行划分：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMX4rF"><img src="https://s1.ax1x.com/2022/05/07/OMX4rF.png" alt="OMX4rF.png"></a></p>
<p>和令牌桶相⽐，这种算法不需要去等待令牌⽣成的时间，在新的时间窗⼝，可以⽴即处理⼤量的请求。</p>
<p>虽然这种模式看似比较合理，但是试想一下这种情况：</p>
<ul>
<li>14:15:59 时来了 100 个请求</li>
<li>14:16:01 时来了 100 个请求</li>
</ul>
<p>出现上面这种情况，符合固定时间窗口算法的规则，所以这 200 个请求都能正常接受。但是，我们希望的是60 秒内只有 100 个请求，但这种情况是在 3 秒内出现了 200 个请求。</p>
<p>因此当遇到临界点时，固定时间窗口算法存在安全隐患。</p>
</li>
<li><p><strong>滑动时间窗口算法</strong></p>
<p>对固定时间算法会在临界点存在瞬间⼤流量冲击的场景，滑动时间窗⼝计数器算法应运⽽⽣。它将时间窗<br>⼝划分为更⼩的时间⽚段，每过⼀个时间⽚段，我们的时间窗⼝就会往右滑动⼀格，每个时间⽚段都有独⽴的计数器。我们在计算整个时间窗⼝内的请求总数时会累加所有的时间⽚段内的计数器。时间窗⼝划分的越细，那么滑动窗⼝的滚动就越平滑，限流的统计就会越精确。</p>
<p>相对于固定窗口算法，滑动时间窗口算法更加灵活，它会动态移动窗口重新进行计算：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMXTa9"><img src="https://s1.ax1x.com/2022/05/07/OMXTa9.png" alt="OMXTa9.png"></a></p>
<p>虽然这样能够避免固定时间窗口的临界问题，但这样比固定窗口更加耗时。</p>
</li>
</ol>
<br>

<p>在 Sentinel 中进行测试：打开管理页面的簇点链路模块</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMxTaQ"><img src="https://s1.ax1x.com/2022/05/07/OMxTaQ.png" alt="OMxTaQ.png"></a></p>
<p>这里演示对我们的借阅接口进行限流，点击<code>流控</code>就可以添加流控规则。</p>
<p>这里选择<code>QPS</code>、阈值设定为<code>1</code>，流控模式选择<code>直接</code>、流控效果选择<code>快速失败</code>。这样，当我们快速地进行请求时会直接返回失败信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMzFR1"><img src="https://s1.ax1x.com/2022/05/07/OMzFR1.png" alt="OMzFR1.png"></a></p>
<p>流控模式的区别：</p>
<ul>
<li>直接：只针对于当前接口。</li>
<li>关联：当其他接口超过阈值时，会导致当前接口被限流。</li>
<li>链路：更细粒度的限流，能精确到具体的方法。</li>
</ul>
<p>关联。比如对<code>/error</code>接口进行限流：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OQSAYj"><img src="https://s1.ax1x.com/2022/05/07/OQSAYj.png" alt="OQSAYj.png"></a></p>
<p>注意限流是作用于关联资源的，一旦发现关联资源超过阈值，那么就会对当前的资源进行限流，我们现在来测试一下，这里使用 PostMan 的 Runner 连续对关联资源发起请求：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMzbwD"><img src="https://s1.ax1x.com/2022/05/07/OMzbwD.png" alt="OMzbwD.png"></a></p>
<p>开启 Postman 发现借阅服务已经不能响应：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OMzFR1"><img src="https://s1.ax1x.com/2022/05/07/OMzFR1.png" alt="OMzFR1.png"></a></p>
<p>关掉 Postman 的任务后恢复正常。</p>
<p>链路模式能够更加精准的进行流量控制。链路流控模式指的是，当从指定接口过来的资源请求达到限流条件时，开启限流。</p>
<p>我们可以对某一个方法进行限流控制，无论是谁在何处调用了它。这里需要使用到<code>@SentinelResource</code>，一旦方法被标注，那么就会进行监控：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserClient userClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BookClient bookClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="comment">//监控此方法，无论被谁执行都在监控范围内，这里给的value是自定义名称，这个注解可以加在任何方法上，包括Controller中的请求映射方法</span></span><br><span class="line">    <span class="meta">@SentinelResource(&quot;getBorrow&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  userClient.getUserById(uid);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.getUserById(borrow.get(<span class="number">0</span>).getUid());</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment"># 添加监控页面地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8858</span></span><br><span class="line">      <span class="comment"># 关闭Context收敛，这样被监控方法可以进行不同链路的单独控制</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>然后在 Sentinel 控制台中添加流控规则，注意是针对此方法，可以看到已经自动识别到 borrow 接口下调用了这个方法：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Olpqpj"><img src="https://s1.ax1x.com/2022/05/07/Olpqpj.png" alt="Olpqpj.png"></a></p>
<p>最后我们在浏览器中对这两个接口都进行测试，会发现，无论请求哪个接口，只要调用了 Service 中的<code>getUserBorrowDetailByUid</code>这个方法，都会被限流。限流的形式是后台直接抛出异常。</p>
<p>那么这个链路选项实际上就是决定只限流从哪个方向来的调用，比如我们只对<code>borrow2</code>这个接口对<code>getUserBorrowDetailByUid</code>方法的调用进行限流，那么我们就可以为其指定链路：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ol9Ch4"><img src="https://s1.ax1x.com/2022/05/07/Ol9Ch4.png" alt="Ol9Ch4.png"></a></p>
<p>发现限流效果只对我们配置的链路接口有效，而其他链路是不会被限流的。</p>
<p>除了直接对接口进行限流规则控制之外，我们也可以根据当前系统的资源使用情况，决定是否进行限流：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ol9kcR"><img src="https://s1.ax1x.com/2022/05/07/Ol9kcR.png" alt="Ol9kcR.png"></a></p>
<p>系统规则支持以下的模式：</p>
<ul>
<li><strong>Load 自适应</strong>（仅对 Linux&#x2F;Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li>
<li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
<br>

<h3 id="限流和异常处理"><a href="#限流和异常处理" class="headerlink" title="限流和异常处理"></a>限流和异常处理</h3><p>限流之后返回的是 Sentinel 默认的数据，如果需要自定义修改限流状态下的返回结果，需要创建被限流状态下需要返回的内容，定义一个请求映射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/blocked&quot;)</span></span><br><span class="line">JSONObject <span class="title function_">blocked</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    object.put(<span class="string">&quot;code&quot;</span>, <span class="number">403</span>);</span><br><span class="line">    object.put(<span class="string">&quot;success&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    object.put(<span class="string">&quot;massage&quot;</span>, <span class="string">&quot;您的请求频率过快，请稍后再试！&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在配置文件中将此页面设定为限流页面：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8858</span></span><br><span class="line">      <span class="comment"># 将编写的请求映射设定为限流页面</span></span><br><span class="line">      <span class="attr">block-page:</span> <span class="string">/blocked</span></span><br></pre></td></tr></table></figure>

<p>当被限流时就会被重定向到指定页面：	</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Olm7NR"><img src="https://s1.ax1x.com/2022/05/07/Olm7NR.png" alt="Olm7NR.png"></a></p>
<p>当某个方法被限流时，会直接在后台抛出异常。在 Hystrix 中可以添加替代方案，这样当出现异常时会直接执行我们的替代方法并返回，Sentinel 也可以。</p>
<p>比如在<code>getUserBorrowDetailByUid</code>方法上进行配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;getBorrow&quot;, blockHandler = &quot;blocked&quot;)</span>   <span class="comment">//指定blockHandler，也就是被限流之后的替代解决方案，这样就不会使用默认的抛出异常的形式了</span></span><br><span class="line"><span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">  List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  userClient.getUserById(uid);</span><br><span class="line">  List&lt;Book&gt; bookList = borrow</span><br><span class="line">    .stream()</span><br><span class="line">    .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">    .collect(Collectors.toList());</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//替代方案，注意参数和返回值需要保持一致，并且参数最后还需要额外添加一个BlockException</span></span><br><span class="line"><span class="keyword">public</span> BorrowDetail <span class="title function_">blocked</span><span class="params">(Integer uid, BlockException e)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(<span class="literal">null</span>, Collections.emptyList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，一旦被限流将执行替代方案，最后返回的结果就是：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OluPZ4"><img src="https://s1.ax1x.com/2022/05/07/OluPZ4.png" alt="OluPZ4.png"></a></p>
<p><code>blockHandler</code> 只能处理限流情况下抛出的异常，下面的热点参数限流也是同理。如果是方法本身抛出的其他类型异常，不在管控范围内，但是可以通过其他参数进行处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;test&quot;,</span></span><br><span class="line"><span class="meta">                  fallback = &quot;except&quot;,    // fallback指定出现异常时的替代方案</span></span><br><span class="line"><span class="meta">                  exceptionsToIgnore = IOException.class)</span>  <span class="comment">// 忽略那些异常，也就是说这些异常出现时不使用替代方案</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Exception！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替代方法必须和原方法返回值和参数一致，最后可以添加一个Throwable作为参数接受异常</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">except</span><span class="params">(Throwable t)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> t.getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，其他的异常也可以有替代方案了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OluztA"><img src="https://s1.ax1x.com/2022/05/07/OluztA.png" alt="OluztA.png"></a></p>
<p>特别注意这种方式会在没有配置 <code>blockHandler</code> 的情况下将 Sentinel 机制内（也就是限流的异常）的异常也一并处理了。如果配置了 <code>blockHandler</code>，那么在出现限流时依然只会执行 <code>blockHandler</code> 指定的替代方案（因为限流是在方法执行之前进行的）</p>
<br>

<h3 id="热点参数限流"><a href="#热点参数限流" class="headerlink" title="热点参数限流"></a>热点参数限流</h3><p>还可以对某一热点数据进行精准限流，比如在某一时刻，不同参数被携带访问的频率是不一样的：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8301/test2?a=10">http://localhost:8301/test2?a=10</a>  访问100次</li>
<li><a target="_blank" rel="noopener" href="http://localhost:8301/test2?b=10">http://localhost:8301/test2?b=10</a>  访问0次</li>
<li><a target="_blank" rel="noopener" href="http://localhost:8301/test2?c=10">http://localhost:8301/test2?c=10</a>  访问3次</li>
</ul>
<p>由于携带参数<code>a</code>的请求比较多，我们就可以只对携带参数<code>a</code>的请求进行限流。</p>
<p>这里我们创建一个新的测试请求映射：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test2&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(&quot;test2&quot;)</span>   <span class="comment">// 需要添加@SentinelResource，用户资源名称使用这里定义的资源名称</span></span><br><span class="line">String <span class="title function_">findUserBorrows2</span><span class="params">(<span class="meta">@RequestParam(value = &quot;a&quot;, required = false)</span> <span class="type">int</span> a,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam(value = &quot;b&quot;, required = false)</span> <span class="type">int</span> b,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam(value = &quot;c&quot;,required = false)</span> <span class="type">int</span> c)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;请求成功！a = &quot;</span> + a + <span class="string">&quot;, b = &quot;</span> + b + <span class="string">&quot;, c = &quot;</span> + c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动后在 Sentinel 里进行热点配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlMuUH"><img src="https://s1.ax1x.com/2022/05/07/OlMuUH.png" alt="OlMuUH.png"></a></p>
<p>访问测试接口。可以发现在携带参数 a 时，当访问频率超过设定值就会被限流，而且会在后台抛出异常：</p>
<p>![image-20220507212635770](&#x2F;Users&#x2F;houjuncai&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220507212635770.png)</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlMa5j"><img src="https://s1.ax1x.com/2022/05/07/OlMa5j.png" alt="OlMa5j.png"></a></p>
<p>当使用其他参数或是不带 <code>a</code> 参数就不会出现这种问题：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlMhGR"><img src="https://s1.ax1x.com/2022/05/07/OlMhGR.png" alt="OlMhGR.png"></a></p>
<p>除了直接对某个参数精准限流外，还可以对参数携带的指定值单独设定阈值。比如现在不仅希望对参数 <code>a</code> 限流，还希望当参数 <code>a</code> 的值为 10 时，QPS 达到 5 再进行限流：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlMvRI"><img src="https://s1.ax1x.com/2022/05/07/OlMvRI.png" alt="OlMvRI.png"></a></p>
<p>这样，当请求携带参数 <code>a</code> 且参数 <code>a</code> 的值为 10 时，阈值将按照指定的特例进行计算。</p>
<br>

<h3 id="服务熔断和降级"><a href="#服务熔断和降级" class="headerlink" title="服务熔断和降级"></a>服务熔断和降级</h3><p>除了流量控制以外，对调用链路中不稳定资源的熔断降级，也是保障服务高可用的重要措施之一。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0ky50sw4jj219s07yabg.jpg" alt="image-20220324141706946"></p>
<p>如果在某一时刻服务 B 出现故障（卡住），而这时服务 A 依然有大量的请求在调用服务B。由于服务 A 没办法在短时间内完成处理，新来的请求就会导致线程数不断地增加。这样，CPU 的资源很快就会被耗尽。</p>
<p>要防止这种情况，需要进行隔离。</p>
<ol>
<li><p><strong>线程池隔离</strong></p>
<p>线程池隔离就是对每个服务的远程调用单独开放线程池。比如服务 A 调用服务 B 只会基于固定数量的线程池。这样即使在短时间内出现大量请求也会因为没有线程可以分配而不会导致资源耗尽。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OllE7D"><img src="https://s1.ax1x.com/2022/05/07/OllE7D.png" alt="OllE7D.png"></a></p>
</li>
<li><p><strong>信号量隔离</strong></p>
<p>信号量隔离是使用 <code>Semaphore</code> 类实现的。也是限定指定的线程数量能够同时进行服务调用，但是它相对于线程池隔离开销会更小且使用效果同样优秀，同时也支持超时等。</p>
<p>Sentinel 采用的正是信号量隔离的方案。</p>
</li>
</ol>
<p>在分布式微服务架构中，一个系统往往由多个服务组成，不同服务之间相互调用，组成复杂的调用链路。如果链路上的某一个服务出现故障，那么故障就会沿着调用链路在系统中蔓延，最终导致整个系统瘫痪。Sentinel 提供了熔断降级机制就可以解决这个问题。</p>
<p>Sentinel 的熔断将机制会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），暂时切断对这个资源的调用，以避免局部不稳定因素导致整个系统的雪崩。</p>
<p>熔断降级作为服务保护自身的手段，通常在客户端（调用端）进行配置，资源被熔断降级最直接的表现就是抛出 DegradeException 异常。</p>
<br>

<h4 id="Sentinel-熔断策略"><a href="#Sentinel-熔断策略" class="headerlink" title="Sentinel 熔断策略"></a>Sentinel 熔断策略</h4><p>Sentinel 提供了 3 种熔断策略：</p>
<table>
<thead>
<tr>
<th>熔断策略</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>慢调用比例 (SLOW_REQUEST_RATIO）</td>
<td>选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大响应时间），若请求的响应时间大于该值则统计为慢调用。  当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。  经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则再次被熔断。</td>
</tr>
<tr>
<td>异常比例 (ERROR_RATIO)</td>
<td>当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目且异常的比例大于阈值，则在接下来的熔断时长内请求会自动被熔断。  经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</td>
</tr>
<tr>
<td>异常数 (ERROR_COUNT)</td>
<td>当单位统计时长内的异常数目超过阈值之后会自动进行熔断。  经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</td>
</tr>
</tbody></table>
<blockquote>
<p>注意：Sentinel 1.8.0 版本对熔断降级特性进行了全新的改进升级，以上熔断策略针对的是 Sentinel 1.8.0 及以上版本。</p>
</blockquote>
<br>

<h4 id="Sentinel-熔断状态"><a href="#Sentinel-熔断状态" class="headerlink" title="Sentinel 熔断状态"></a>Sentinel 熔断状态</h4><p>Sentinel 熔断降级中共涉及 3 种状态，熔断状态的之间的转换过程：</p>
<p><img src="http://c.biancheng.net/uploads/allimg/211210/10252343H-15.png" alt="Sentinel 熔断状态转换"></p>
<p>Sentinel 熔断降级中共涉及 3 种状态：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
<th>触发条件</th>
</tr>
</thead>
<tbody><tr>
<td>熔断关闭状态 （CLOSED）</td>
<td>处于关闭状态时，请求可以正常调用资源。</td>
<td>满足以下任意条件，Sentinel 熔断器进入熔断关闭状态：全部请求访问成功。单位统计时长（statIntervalMs）内请求数目小于设置的最小请求数目。未达到熔断标准，例如服务超时比例、异常数、异常比例未达到阈值。处于探测恢复状态时，下一个请求访问成功。</td>
</tr>
<tr>
<td>熔断开启状态 （OPEN）</td>
<td>处于熔断开启状态时，熔断器会一定的时间（规定的熔断时长）内，暂时切断所有请求对该资源的调用，并调用相应的降级逻辑使请求快速失败避免系统崩溃。</td>
<td>满足以下任意条件，Sentinel 熔断器进入熔断开启状态：单位统计时长内请求数目大于设置的最小请求数目，且已达到熔断标准，例如请求超时比例、异常数、异常比例达到阈值。处于探测恢复状态时，下一个请求访问失败。</td>
</tr>
<tr>
<td>探测恢复状态 （HALF-OPEN）</td>
<td>处于探测恢复状态时，Sentinel 熔断器会允许一个请求调用资源。则若接下来的一个请求成功完成（没有错误）则结束熔断，熔断器进入熔断关闭（CLOSED）状态；否则会再次被熔断，熔断器进入熔断开启（OPEN）状态。</td>
<td>在熔断开启一段时间（降级窗口时间或熔断时长，单位为 s）后，Sentinel 熔断器自动会进入探测恢复状态。</td>
</tr>
</tbody></table>
<br>

<h4 id="Sentinel-熔断规则属性"><a href="#Sentinel-熔断规则属性" class="headerlink" title="Sentinel 熔断规则属性"></a>Sentinel 熔断规则属性</h4><p>Sentinel 熔断降级规则包含多个重要属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
<th>默认值</th>
<th>使用范围</th>
</tr>
</thead>
<tbody><tr>
<td>资源名</td>
<td>规则的作用对象。</td>
<td>-</td>
<td>所有熔断策略</td>
</tr>
<tr>
<td>熔断策略</td>
<td>Sentinel 支持3 中熔断策略：慢调用比例、异常比例、异常数策略。</td>
<td>慢调用比例</td>
<td>所有熔断策略</td>
</tr>
<tr>
<td>最大 RT</td>
<td>请求的最大相应时间，请求的响应时间大于该值则统计为慢调用。</td>
<td>-</td>
<td>慢调用比例</td>
</tr>
<tr>
<td>熔断时长</td>
<td>熔断开启状态持续的时间，超过该时间熔断器会切换为探测恢复状态（HALF-OPEN），单位为 s。</td>
<td>-</td>
<td>所有熔断策略</td>
</tr>
<tr>
<td>最小请求数</td>
<td>熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）。</td>
<td>5</td>
<td>所有熔断策略</td>
</tr>
<tr>
<td>统计时长</td>
<td>熔断触发需要统计的时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）。</td>
<td>1000 ms</td>
<td>所有熔断策略</td>
</tr>
<tr>
<td>比例阈值</td>
<td>分为慢调用比例阈值和异常比例阈值，即慢调用或异常调用占所有请求的百分比，取值范围 [0.0,1.0]。</td>
<td>-</td>
<td>慢调用比例 、异常比例</td>
</tr>
<tr>
<td>异常数</td>
<td>请求或调用发生的异常的数量。</td>
<td>-</td>
<td>异常数</td>
</tr>
</tbody></table>
<br>

<h4 id="Sentinel-实现熔断降级过程"><a href="#Sentinel-实现熔断降级过程" class="headerlink" title="Sentinel 实现熔断降级过程"></a>Sentinel 实现熔断降级过程</h4><p>Sentinel 实现熔断降级的步骤如下：</p>
<ol>
<li>在项目中，使用 @SentinelResource 注解的 fallback 属性可以为资源指定熔断降级逻辑（方法）。</li>
<li>通过 Sentinel 控制台或代码定义熔断规则，包括熔断策略、最小请求数、阈值、熔断时长以及统计时长等。</li>
<li>若单位统计时长（statIntervalMs）内，请求数目大于设置的最小请求数目且达到熔断标准（例如请求超时比例、异常数、异常比例达到阈值），Sentinel 熔断器进入熔断开启状态（OPEN）。</li>
<li>处于熔断开启状态时， @SentinelResource 注解的 fallback 属性指定的降级逻辑会临时充当主业务逻辑，而原来的主逻辑则暂时不可用。当有请求访问该资源时，会直接调用降级逻辑使请求快速失败，而不会调用原来的主业务逻辑。</li>
<li>在经过一段时间（在熔断规则中设置的熔断时长）后，熔断器会进入探测恢复状态（HALF-OPEN），此时 Sentinel 会允许一个请求对原来的主业务逻辑进行调用，并监控其调用结果。</li>
<li>若请求调用成功，则熔断器进入熔断关闭状态（CLOSED ），服务原来的主业务逻辑恢复，否则重新进入熔断开启状态（OPEN）。</li>
</ol>
<br>

<h4 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h4><p>Sentinel 中进行熔断和降级。</p>
<ol>
<li><strong>慢调用比例</strong></li>
</ol>
<p>然后修改一下接口的执行，我们模拟一下慢调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/borrow/user2/&#123;uid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">findUserBorrows2</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">  Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> “Oops”;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务，然后创建一个新的熔断规则：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ol8a3d"><img src="https://s1.ax1x.com/2022/05/07/Ol8a3d.png" alt="Ol8a3d.png"></a></p>
<p>访问超时触发熔断，进入到阻止页面：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlGaIU"><img src="https://s1.ax1x.com/2022/05/07/OlGaIU.png" alt="OlGaIU.png"></a></p>
<br>

<ol start="2">
<li><strong>异常比例</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/borrow/user2/&#123;uid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">findUserBorrows2</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务器，添加熔断规则：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlJpyn"><img src="https://s1.ax1x.com/2022/05/07/OlJpyn.png" alt="OlJpyn.png"></a></p>
<p>访问后会发现后台报错然后熔断：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlGaIU"><img src="https://s1.ax1x.com/2022/05/07/OlGaIU.png" alt="OlGaIU.png"></a></p>
<br>

<ol start="3">
<li><strong>异常数</strong></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlJ0Tf"><img src="https://s1.ax1x.com/2022/05/07/OlJ0Tf.png" alt="OlJ0Tf.png"></a></p>
<p>不断访问此接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlGaIU"><img src="https://s1.ax1x.com/2022/05/07/OlGaIU.png" alt="OlGaIU.png"></a></p>
<br>

<p>对于服务降级，只需要在 <code>@SentinelResource</code> 中配置 <code>blockHandler</code> 参数（与之前方法限流的配置相同。如果添加了 <code>@SentinelResource</code> 注解，就会进行方法级别细粒度的限制。和方法级别的限流一样会在降级之后直接抛出异常。如果不添加则返回默认的限流页面，<code>blockHandler</code>的目的就是处理这种 Sentinel 机制上的异常，所以这里和之前的限流配置是一个道理，因此熔断的配置也应该对<code>value</code>自定义名称的资源进行配置才能作用到此方法上）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/borrow/user2/&#123;uid&#125;&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;findUserBorrows2&quot;, blockHandler = &quot;test3&quot;)</span></span><br><span class="line"><span class="keyword">public</span> BorrowDetail <span class="title function_">findUserBorrows2</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> BorrowDetail <span class="title function_">test3</span><span class="params">(Integer uid, BlockException e)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(<span class="keyword">new</span> <span class="title class_">User</span>(), Collections.emptyList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>熔断配置，对添加的 <code>@SentinelResource</code> 中指定名称的 <code>findUserBorrows2</code> 进行配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OltJsA"><img src="https://s1.ax1x.com/2022/05/07/OltJsA.png" alt="OltJsA.png"></a></p>
<p>熔断后服务降级的效果：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Olt2d0"><img src="https://s1.ax1x.com/2022/05/07/Olt2d0.png" alt="Olt2d0.png"></a></p>
<p>使用 <code>@SentinelResource</code> 注解的 <code>blockHandler</code> 属性时，需要注意以下事项：</p>
<ul>
<li>返回值类型必须与原函数返回值类型一致；</li>
<li>方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常；</li>
<li><code>fallback</code> 函数默认需要和原方法在同一个类中，若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ul>
<br>

<h4 id="使用-Feign"><a href="#使用-Feign" class="headerlink" title="使用 Feign"></a>使用 Feign</h4><p>首先在配置文件中开启支持：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>创建实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClientFallback</span> <span class="keyword">implements</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(<span class="type">int</span> uid)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;替代方案&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为 UserClient 指定 fallback：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;user-service&quot;, fallback = UserClientFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> <span class="type">int</span> uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后直接启动，中途把吧用户服务全部关闭，可以看到正常使用替代方案：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OlUXxe"><img src="https://s1.ax1x.com/2022/05/07/OlUXxe.png" alt="OlUXxe.png"></a></p>
<p>也可以使用 <code>@SentinelRestTemplate</code> 注解实现 <code>RestTemplate</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@LoadBalanced</span></span><br><span class="line"><span class="meta">@SentinelRestTemplate(blockHandler = &quot;handleException&quot;, blockHandlerClass = ExceptionUtil.class,</span></span><br><span class="line"><span class="meta">    fallback = &quot;fallback&quot;, fallbackClass = ExceptionUtil.class)</span> <span class="comment">//这里同样可以设定fallback等参数</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="Seata与分布式事务"><a href="#Seata与分布式事务" class="headerlink" title="Seata与分布式事务"></a>Seata与分布式事务</h2><p>随着业务的不断发展，单体架构已经无法满足我们的需求，分布式微服务架构逐渐成为大型互联网平台的首选，但所有使用分布式微服务架构的应用都必须面临一个十分棘手的问题，那就是“分布式事务”问题。</p>
<p>在分布式微服务架构中，几乎所有业务操作都需要多个服务协作才能完成。对于其中的某个服务而言，它的数据一致性可以交由其自身数据库事务来保证，但从整个分布式微服务架构来看，其全局数据的一致性却是无法保证的。</p>
<p><strong>官方文档：</strong><a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/overview/what-is-seata.html">https://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p>
<p>数据库事务的特性：</p>
<ul>
<li><strong>原子性：</strong>一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</li>
<li><strong>一致性：</strong>在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。</li>
<li><strong>隔离性：</strong>数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读已提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。</li>
<li><strong>持久性：</strong>事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li>
</ul>
<p>例如，用户在某电商系统下单购买了一件商品后，电商系统会执行下 4 步：</p>
<ol>
<li>调用订单服务创建订单数据</li>
<li>调用库存服务扣减库存</li>
<li>调用账户服务扣减账户金额</li>
<li>最后调用订单服务修改订单状态</li>
</ol>
<p>虽然看似是个很简单的流程，但如果没有事务的支持则很有可能会中途出错。比如整个流程中订单服务出现问题，就会导致库存扣了但订单并没有生成，用户也没有付款。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h0qkx2w3olj21jo0763zr.jpg" alt="image-20220329111304542"></p>
<p>为了保证数据的正确性和一致性，我们必须保证所有这些操作要么全部成功，要么全部失败，否则就可能出现类似于商品库存已扣减，但用户账户资金尚未扣减的情况。各服务自身的事务特性显然是无法实现这一目标的，此时，我们可以通过分布式事务框架来解决这个问题。</p>
<p>Seata 就是这样一个分布式事务处理框架，它是由阿里巴巴和蚂蚁金服共同开源的分布式事务解决方案，能够在微服务架构下提供高性能且简单易用的分布式事务服务。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1i9iT"><img src="https://s1.ax1x.com/2022/05/08/O1i9iT.png" alt="O1i9iT.png"></a></p>
<p>Seata 是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA 和 XA 事务模式，为用户打造一站式的分布式解决方案。</p>
<br>

<h3 id="项目环境搭建"><a href="#项目环境搭建" class="headerlink" title="项目环境搭建"></a>项目环境搭建</h3><p>对之前的图书管理系统进行升级：</p>
<ul>
<li>每个用户最多只能同时借阅 2 本不同的书。</li>
<li>图书馆中所有的书都有 3 本。</li>
<li>用户借书流程：先调用图书服务书籍数量减 1 -&gt;  添加借阅记录  -&gt;  调用用户服务用户可借阅数量减 1</li>
</ul>
<p>对数据库进行修改，在用户表中添加一个字段用于存储用户能够借阅的书籍数量：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1FUBR"><img src="https://s1.ax1x.com/2022/05/08/O1FUBR.png" alt="O1FUBR.png"></a></p>
<p>修改书籍信息，添加一个字段用于记录剩余数量：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1Fr9O"><img src="https://s1.ax1x.com/2022/05/08/O1Fr9O.png" alt="O1Fr9O.png"></a></p>
<p>编写对应的服务：</p>
<p>用户服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_user where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select book_count from db_user where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    Integer <span class="title function_">getUserBookRemain</span><span class="params">(Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update db_user set book_count = #&#123;bookCount&#125; where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    Integer <span class="title function_">updateBookCount</span><span class="params">(Integer uid, Integer bookCount)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.getUserById(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getRemain</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.getUserBookRemain(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">setRemain</span><span class="params">(Integer uid, Integer count)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.updateBookCount(uid, count) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getUserById(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/remain/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getRemain</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getRemain(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/borrow/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">userBorrow</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">remain</span> <span class="operator">=</span> userService.getRemain(uid);</span><br><span class="line">        <span class="keyword">return</span> userService.setRemain(uid, remain - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图书服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_book where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select count from db_book  where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Integer <span class="title function_">getRemain</span><span class="params">(Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&quot;update db_book set count = #&#123;count&#125;  where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Integer <span class="title function_">setRemain</span><span class="params">(Integer bid, Integer count)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BookService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookMapper bookMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">getBookById</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bookMapper.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">setRemain</span><span class="params">(Integer bid, Integer count)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bookMapper.setRemain(bid, count) &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getRemain</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bookMapper.getRemain(bid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.getBookById(bid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/remain/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">bookRemain</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.getRemain(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/borrow/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">bookBorrow</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer uid)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">remain</span> <span class="operator">=</span> bookService.getRemain(uid);</span><br><span class="line">        <span class="keyword">return</span> bookService.setRemain(uid, remain - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>借阅服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;userservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/borrow/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">userBorrow</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/remain/&#123;uid&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">userRemain</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;bookservice&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/borrow/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">bookBorrow</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/remain/&#123;bid&#125;&quot;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">bookRemain</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BorrowMapper</span> &#123;</span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where uid = #&#123;uid&#125;&quot;)</span></span><br><span class="line">    List&lt;Borrow&gt; <span class="title function_">getBorrowByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    List&lt;Borrow&gt; <span class="title function_">getBorrowByBid</span><span class="params">(Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from db_borrow where uid = #&#123;uid&#125; adn bid = #&#123;bid&#125;&quot;)</span></span><br><span class="line">    Borrow <span class="title function_">getBorrow</span><span class="params">(Integer uid, Integer bid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into db_borrow(uid, bid) values(#&#123;uid&#125;, #&#123;bid&#125;)&quot;)</span></span><br><span class="line">    Integer <span class="title function_">addBorrow</span><span class="params">(Integer uid, Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BorrowService borrowService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/&#123;uid&#125;&quot;)</span></span><br><span class="line">    UserBorrowDetail <span class="title function_">findUserBorrows</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> <span class="type">int</span> uid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> service.getUserBorrowDetailByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/borrow/take/&#123;uid&#125;/&#123;bid&#125;&quot;)</span></span><br><span class="line">    JSONObject <span class="title function_">borrow</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid,</span></span><br><span class="line"><span class="params">                      <span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>&#123;</span><br><span class="line">        borrowService.doBorrow(uid, bid);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        object.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;200&quot;</span>);</span><br><span class="line">        object.put(<span class="string">&quot;success&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        object.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;借阅成功！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BorrowMapper borrowMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BookClient bookClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserBorrowDetail <span class="title function_">getUserBorrowDetailByUid</span><span class="params">(<span class="type">int</span> uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowsByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.getUserById(uid);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserBorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">doBorrow</span><span class="params">(Integer uid, Integer bid)</span> &#123;</span><br><span class="line">      	<span class="comment">//1. 判断图书和用户是否都支持借阅</span></span><br><span class="line">        <span class="keyword">if</span>(bookClient.bookRemain(bid) &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;图书数量不足&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(userClient.userRemain(uid) &lt; <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户借阅量不足&quot;</span>);</span><br><span class="line">      	<span class="comment">//2. 首先将图书的数量-1</span></span><br><span class="line">        <span class="keyword">if</span>(!bookClient.bookBorrow(bid))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在借阅图书时出现错误！&quot;</span>);</span><br><span class="line">      	<span class="comment">//3. 添加借阅信息</span></span><br><span class="line">        <span class="keyword">if</span>(borrowMapper.getBorrow(uid, bid) != <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;此书籍已经被此用户借阅了！&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(borrowMapper.addBorrow(uid, bid) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在录入借阅信息时出现错误！&quot;</span>);</span><br><span class="line">      	<span class="comment">//4. 用户可借阅-1</span></span><br><span class="line">        <span class="keyword">if</span>(!userClient.userBorrow(uid))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在借阅时出现错误！&quot;</span>);</span><br><span class="line">      	<span class="comment">//完成</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，只要图书借阅过程中任何一步出现问题都会抛出异常。</p>
<p>测试：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1Z0pV"><img src="https://s1.ax1x.com/2022/05/08/O1Z0pV.png" alt="O1Z0pV.png"></a></p>
<p>再次尝试借阅，后台会直接报错：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1Z60J"><img src="https://s1.ax1x.com/2022/05/08/O1Z60J.png" alt="O1Z60J.png"></a></p>
<p>虽然借阅信息添加失败但图书的数量依然被 -1。但我们希望中途出现异常之后，之前的操作全部回滚：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1ZtTs"><img src="https://s1.ax1x.com/2022/05/08/O1ZtTs.png" alt="O1ZtTs.png"></a></p>
<p>而这里由于是在另一个服务中进行的数据库操作，所以传统的<code>@Transactional</code>注解无效。因此需要借助 Seata 提供分布式事务了。</p>
<br>

<h3 id="分布式事务相关概念"><a href="#分布式事务相关概念" class="headerlink" title="分布式事务相关概念"></a>分布式事务相关概念</h3><p>分布式事务主要涉及以下概念：</p>
<ul>
<li><strong>事务</strong>：由一组操作构成的可靠、独立的工作单元，事务具备 ACID 的特性，即原子性、一致性、隔离性和持久性。</li>
<li><strong>本地事务</strong>：本地事务由本地资源管理器（通常指数据库管理系统 DBMS，例如 MySQL、Oracle 等）管理，严格地支持 ACID 特性，高效可靠。本地事务不具备分布式事务的处理能力，隔离的最小单位受限于资源管理器，即本地事务只能对自己数据库的操作进行控制，对于其他数据库的操作则无能为力。</li>
<li><strong>全局事务</strong>：全局事务指的是一次性操作多个资源管理器完成的事务，由一组分支事务组成。</li>
<li><strong>分支事务</strong>：在分布式事务中，就是一个个受全局事务管辖和协调的本地事务。</li>
</ul>
<p>我们可以将分布式事务理解成一个包含了若干个分支事务的全局事务。全局事务的职责是协调其管辖的各个分支事务达成一致，要么一起成功提交，要么一起失败回滚。此外，通常分支事务本身就是一个满足 ACID 特性的本地事务。</p>
<br>

<h3 id="分布式事务解决方案"><a href="#分布式事务解决方案" class="headerlink" title="分布式事务解决方案"></a>分布式事务解决方案</h3><ol>
<li><p><strong>XA 分布式事务协议 - 2PC（两阶段提交实现）</strong></p>
<p>PC 指的是 Prepare 和 Commit。它分为准备和提交两个阶段，整个过程的参与者一共有两个角色，一个是事务的执行者，一个是事务的协调者。分布式事务的运作都需要依靠协调者来维持：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1sIij"><img src="https://s1.ax1x.com/2022/05/08/O1sIij.png" alt="O1sIij.png"></a></p>
<p>在准备和提交阶段：</p>
<ul>
<li><p><strong>准备阶段：</strong></p>
<p>一个分布式事务是由协调者来开启的，首先协调者会向所有的事务执行者发送事务内容，等待所有的事务执行者答复。</p>
<p>各个事务执行者开始执行事务操作，但是不进行提交，并将 undo 和 redo 信息记录到事务日志中。</p>
<p>如果事务执行者执行事务成功，就告诉协调者成功，否则告诉协调者失败且不能提交事务。</p>
</li>
<li><p><strong>提交阶段：</strong></p>
<p>当所有的执行者都反馈完成之后，进入提交阶段。</p>
<p>协调者会检查各个执行者的反馈内容。如果所有的执行者都返回成功，那么就告诉所有的执行者可以提交事务，最后释放锁资源。</p>
<p>如果有至少一个执行者返回失败或超时，则让所有的执行者都回滚，分布式事务执行失败。</p>
</li>
</ul>
<p>虽然这种方式比较简单，但是存在几个问题：</p>
<ul>
<li>事务协调者是非常核心的角色，一旦出现问题，将导致整个分布式事务不能正常运行。</li>
<li>如果提交阶段发生网络问题而使某些事务执行者没有收到协调者发来的提交命令，这就将导致某些执行者提交而某些执行者没提交。</li>
</ul>
</li>
<li><p><strong>XA 分布式事务协议 - 3PC（三阶段提交实现）</strong></p>
<p>三阶段提交是在二阶段提交基础上的改进版本，在协调者和执行者中都引入了超时机制。</p>
<p>三个阶段分别进行：</p>
<ul>
<li><p><strong>CanCommit 阶段：</strong></p>
<p>协调者向执行者发送 CanCommit 请求，询问是否可以执行事务提交操作，然后开始等待执行者的响应。</p>
<p>执行者接收到请求之后，正常情况下，如果其自身认为可以顺利执行事务，则返回 Yes 响应，并进入预备状态，否则返回 No</p>
</li>
<li><p><strong>PreCommit 阶段：</strong></p>
<p>协调者根据执行者的反应情况来决定是否可以进入第二阶段事务的 PreCommit 操作。</p>
<p>如果所有的执行者都返回 Yes，则协调者向所有执行者发送 PreCommit 请求，并进入 Prepared 阶段，执行者接收到请求后执行事务操作，并将 undo 和 redo 信息记录到事务日志中。如果成功执行，则返回成功响应。</p>
<p>如果所有的执行者至少有一个返回 No，则协调者向所有执行者发送 abort 请求，所有的执行者在收到请求或是超过一段时间没有收到任何请求时，会直接中断事务。</p>
</li>
<li><p><strong>DoCommit 阶段：</strong></p>
<p>该阶段进行真正的事务提交。</p>
<p>协调者接收到所有执行者发送的成功响应后将从 PreCommit 状态进入到 DoCommit 状态，并向所有执行者发送 doCommit 请求，执行者接收到 doCommit 请求后开始执行事务提交，并在完成事务提交后释放所有事务资源，最后向协调者发送确认响应。协调者接收到所有执行者的确认响应后完成事务（如果因为网络问题导致执行者没有收到 doCommit 请求，执行者会在超时之后直接提交事务。由于之前的两个流程都正常执行，所以能够在一定程度上认为本次事务是成功的，因此会直接提交）</p>
<p>协调者没有接收至少一个执行者发送的成功响应（也可能是响应超时）就会执行中断事务，协调者会向所有执行者发送 abort 请求。执行者接收到 abort 请求后，利用其在 PreCommit 阶段记录的 undo 信息来执行事务的回滚操作，并在完成回滚之后释放所有的事务资源。执行者完成事务回滚后会向协调者发送确认消息， 协调者接收到参与者反馈的确认消息后执行事务的中断。</p>
</li>
</ul>
<p>相比两阶段提交，三阶段提交的优势是显而易见的，但它也有缺点：</p>
<ul>
<li>3PC 在 2PC 的第一阶段和第二阶段中插入一个准备阶段，保证了在最后提交阶段之前各参与节点的状态是一致的。</li>
<li>一旦参与者无法及时收到来自协调者的信息之后，会默认执行 Commit，这样就不会因为协调者单方面的故障导致全局出现问题。</li>
<li>超时之后的 Commit 决策是有风险的。如果此时协调者发送的是 abort 请求但超时未接收则会导致数据一致性问题。</li>
</ul>
</li>
<li><p><strong>TCC（补偿事务）</strong></p>
<p>补偿事务 TCC 就是 Try、Confirm、Cancel，它对业务有侵入性，分为三个阶段。</p>
<ul>
<li><p><strong>Try 阶段：</strong></p>
<p>比如需要在借书时将书籍的库存 -1 并且用户的借阅量也 -1。这个操作除了对库存和借阅量进行修改外，还需要将减去的值单独存放到冻结表中。但此时不会创建借阅信息，即只是预先把关键操作处理而把业务资源预留。</p>
</li>
<li><p><strong>Confirm 阶段：</strong></p>
<p>如果 Try 执行成功就进入 Confirm 阶段。这个阶段是真正的创建借阅信息，只能使用 Try 阶段预留的业务资源。如果创建成功就解冻 Try 阶段冻结的值完成整个流程。如果失败则进入 Cancel 阶段。</p>
</li>
<li><p><strong>Cancel 阶段：</strong></p>
<p>在这个解读会取消执行本次操作并将修改的数据还原。</p>
</li>
</ul>
<p>跟 XA 协议相比，TCC 没有协调者这一角色的参与。TCC 自主通过上一阶段的执行情况来确保正常，充分利用了集群的优势，性能也是有很大的提升。但缺点也很明显，它与业务具有一定的关联性，需要开发者去编写更多的补偿代码，同时并不一定所有的业务流程都适用于这种形式。</p>
<br></li>
</ol>
<h3 id="Seata-机制简介"><a href="#Seata-机制简介" class="headerlink" title="Seata 机制简介"></a>Seata 机制简介</h3><p>Seata 对分布式事务的协调和控制，主要是通过 XID 和 3 个核心组件实现的。</p>
<h4 id="XID"><a href="#XID" class="headerlink" title="XID"></a>XID</h4><p>XID 是全局事务的唯一标识，它可以在服务的调用链路中传递，绑定到服务的事务上下文中。</p>
<h4 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h4><p>Seata 定义了 3 个核心组件：</p>
<ul>
<li>TC（Transaction Coordinator）：事务协调器，它是事务的协调者（这里指的是 Seata 服务器），主要负责维护全局事务和分支事务的状态，驱动全局事务提交或回滚。</li>
<li>TM（Transaction Manager）：事务管理器，它是事务的发起者，负责定义全局事务的范围，并根据 TC 维护的全局事务和分支事务状态，做出开始事务、提交事务、回滚事务的决议。</li>
<li>RM（Resource Manager）：资源管理器，它是资源的管理者（这里可以将其理解为各服务使用的数据库）。它负责管理分支事务上的资源，向 TC 注册分支事务，汇报分支事务状态，驱动分支事务的提交或回滚。</li>
</ul>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><p>以上三个组件相互协作，TC 以 Seata 服务器（Server）形式独立部署，TM 和 RM 则是以 Seata Client 的形式集成在微服务中运行，其整体工作流程如下图。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1D6kd"><img src="https://s1.ax1x.com/2022/05/08/O1D6kd.png" alt="O1D6kd.png"></a></p>
<blockquote>
<p>Seata 的整体工作流程如下：</p>
<ol>
<li>TM 向 TC 申请开启一个全局事务，全局事务创建成功后，TC 会针对这个全局事务生成一个全局唯一的 XID；</li>
<li>XID 通过服务的调用链传递到其他服务;</li>
<li>RM 向 TC 注册一个分支事务，并将其纳入 XID 对应全局事务的管辖；</li>
<li>TM 根据 TC 收集的各个分支事务的执行结果，向 TC 发起全局事务提交或回滚决议；</li>
<li>TC 调度 XID 下管辖的所有分支事务完成提交或回滚操作。</li>
</ol>
</blockquote>
<p>Seata 提供了 AT、TCC、SAGA 和 XA 四种事务模式，可以快速有效地对分布式事务进行控制。</p>
<p>在这四种事务模式中使用最多，最方便的就是 AT 模式。与其他事务模式相比，AT 模式可以应对大多数的业务场景，且基本可以做到无业务入侵，开发人员能够有更多的精力关注于业务逻辑开发。</p>
<p>官网文档：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/overview/what-is-seata.html">https://seata.io/zh-cn/docs/overview/what-is-seata.html</a></p>
<ul>
<li><p>AT：本质上是 2PC 的升级版，在 AT 模式下，用户只需关心自己的 “业务 SQL”</p>
<ol>
<li>一阶段，Seata 会拦截“业务 SQL”。首先解析 SQL 语义，找到“业务 SQL”要更新的业务数据，在业务数据被更新前会将其保存成“before image”，然后执行“业务 SQL”更新业务数据。在业务数据更新之后，再将其保存成“after image”，最后生成行锁。以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</li>
<li>二阶段，如果确认提交，由于“业务 SQL”在一阶段已经提交至数据库， 所以 Seata 框架只需将一阶段保存的快照数据和行锁删除来完成数据清理。若需要回滚则可以使用“before image”还原业务数据。但在还原前需要校验脏写：对比“数据库当前业务数据”和 “after image”，如果两份数据完全一致说明没有脏写可以还原业务数据；如果不一致说明有脏写，出现脏写就需要转人工处理。</li>
</ol>
</li>
<li><p>TCC</p>
</li>
<li><p>XA：要求数据库本身支持这种模式。</p>
</li>
<li><p>SAGA：用于处理长事务，每个执行者需要实现事务的正向操作和补偿操作。</p>
</li>
</ul>
<br>

<h4 id="AT-模式的前提"><a href="#AT-模式的前提" class="headerlink" title="AT 模式的前提"></a>AT 模式的前提</h4><p>任何应用想要使用 Seata 的 AT 模式对分布式事务进行控制，必须满足以下 2 个前提：</p>
<ul>
<li>必须使用支持本地 ACID 事务特性的关系型数据库，例如 MySQL、Oracle 等；</li>
<li>应用程序必须是使用 JDBC 对数据库进行访问的 Java 应用。</li>
</ul>
<br>

<h3 id="使用-File-模式部署"><a href="#使用-File-模式部署" class="headerlink" title="使用 File 模式部署"></a>使用 File 模式部署</h3><p>Seata 也是以服务端形式进行部署的，每个服务都是客户端。Seata 服务端支持本地部署或是基于注册发现中心部署（如 Nacos、Eureka、Zookeeper 等）。</p>
<p>事务分组是 Seata 提供的一种 TC（Seata Server） 服务查找机制。</p>
<p>Seata 通过事务分组获取 TC 服务，流程如下：</p>
<ol>
<li>在应用中配置事务分组。</li>
<li>应用通过配置中心去查找配置：<code>service.vgroupMapping.&#123;事务分组&#125;</code>，该配置的值就是 TC 集群的名称。</li>
<li>获得集群名称后，应用通过一定的前后缀 + 集群名称去构造服务名。</li>
<li>得到服务名后，去注册中心去拉取服务列表，获得后端真实的 TC 服务列表。</li>
</ol>
<p>这样，事务分组可以作为资源的逻辑隔离单位，出现某集群故障时可以快速 failover。只切换对应分组可以把故障缩减到服务级别。</p>
<p>服务端下载地址：<a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases/download/v1.4.2/seata-server-1.4.2.zip">https://github.com/seata/seata/releases/download/v1.4.2/seata-server-1.4.2.zip</a></p>
<p>源码下：<a target="_blank" rel="noopener" href="https://github.com/seata/seata/archive/refs/heads/develop.zip">https://github.com/seata/seata/archive/refs/heads/develop.zip</a></p>
<p>下载完成后放入 IDEA 项目目录中，添加启动配置使用端口 8868：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1g5n0"><img src="https://s1.ax1x.com/2022/05/08/O1g5n0.png" alt="O1g5n0.png" style="zoom:67%;" /></a></p>
<p>然后需要将各个服务作为 Seate 的客户端，导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">    	<span class="comment"># 需要对事务组做映射，默认的分组名为 应用名称-seata-service-group，将其映射到default集群</span></span><br><span class="line">      <span class="attr">bookservice-seata-service-group:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">grouplist:</span></span><br><span class="line">      <span class="attr">default:</span> <span class="string">localhost:8868</span></span><br></pre></td></tr></table></figure>

<p>然后配置开启分布式事务，首先在启动类添加注解，此注解会添加一个后置处理器将数据源封装为支持分布式事务的代理数据源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAutoDataSourceProxy</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BookApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着需要在开启分布式事务的方法上添加 <code>@GlobalTransactional</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">doBorrow</span><span class="params">(Integer uid, Integer bid)</span> &#123;</span><br><span class="line">  <span class="comment">// 每个服务都打印XID，如果打印的是同一个XID，表示使用的是同一个事务</span></span><br><span class="line">  System.out.println(RootContext.getXID());</span><br><span class="line">  <span class="keyword">if</span>(bookClient.bookRemain(bid) &lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;图书数量不足&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(userClient.userRemain(uid) &lt; <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户借阅量不足&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!bookClient.bookBorrow(bid))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在借阅图书时出现错误！&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(borrowMapper.getBorrow(uid, bid) != <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;此书籍已经被此用户借阅了！&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(borrowMapper.addBorrow(uid, bid) &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在录入借阅信息时出现错误！&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(!userClient.userBorrow(uid))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;在借阅时出现错误！&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Seata 会分析修改数据的 SQL，同时生成对应的反向回滚 SQL。这个回滚记录会存放在 undo_log 表中。所以要求每一个 Client 都有一个对应的 undo_log 表（每个服务连接的数据库都需要创建这样一个表），表 SQL 定义如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `undo_log`</span><br><span class="line">(</span><br><span class="line">  `id`            <span class="type">BIGINT</span>(<span class="number">20</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `branch_id`     <span class="type">BIGINT</span>(<span class="number">20</span>)   <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `xid`           <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `context`       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rollback_info` LONGBLOB     <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_status`    <span class="type">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_created`   DATETIME     <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `log_modified`  DATETIME     <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `ext`           <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`, `branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8;</span><br></pre></td></tr></table></figure>

<p>创建完成后启动三个服务，测试当出现异常时是否会正常回滚：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O14KpD"><img src="https://s1.ax1x.com/2022/05/08/O14KpD.png" alt="O14KpD.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O14YAP"><img src="https://s1.ax1x.com/2022/05/08/O14YAP.png" alt="O14YAP.png"></a></p>
<p>第一次借书时正常完成借阅操作，再次进行请求则会出现异常：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O145u9"><img src="https://s1.ax1x.com/2022/05/08/O145u9.png" alt="O145u9.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O158v4"><img src="https://s1.ax1x.com/2022/05/08/O158v4.png" alt="O158v4.png"></a></p>
<p>在栈追踪信息中看到 seata 相关的包说明分布式事务已经开始工作了，通过日志可以看到出现了回滚操作：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O15B8O"><img src="https://s1.ax1x.com/2022/05/08/O15B8O.png" alt="O15B8O.png"></a></p>
<p>并且数据库中也回滚了扣除操作：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O14YAP"><img src="https://s1.ax1x.com/2022/05/08/O14YAP.png" alt="O14YAP.png"></a></p>
<p>这样，我们就通过 Seata 简单地实现了分布式事务。</p>
<br>

<h3 id="使用-Nacos-模式部署"><a href="#使用-Nacos-模式部署" class="headerlink" title="使用 Nacos 模式部署"></a>使用 Nacos 模式部署</h3><p>使用 Nacos 进行部署，利用 Nacos 的配置管理和服务发现机制 Seata 能够更好地工作。</p>
<p>首先单独为 Seata 配置一个命名空间：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1IglF"><img src="https://s1.ax1x.com/2022/05/08/O1IglF.png" alt="O1IglF.png"></a></p>
<p>打开 Seata 的 <code>conf</code>目录中的<code>registry.conf</code>配置文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">registry</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">	# 注册配置</span></span><br><span class="line"><span class="comment">	# 选择类型，默认是普通的file类型，即本地文件的形式进行注册配置</span></span><br><span class="line"><span class="comment">	# 支持的类型如下，对应的类型在下面都有对应的配置</span></span><br><span class="line"><span class="comment">  # file、nacos、eureka、redis、zk、consul、etcd3、sofa</span></span><br><span class="line">  <span class="attr">type</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	# 采用nacos方式会将seata服务端也注册到nacos中，这样客户端就可以利用服务发现自动找到seata服务</span></span><br><span class="line"><span class="comment">	# 就不需要手动指定IP和端口了</span></span><br><span class="line">  <span class="attr">nacos</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  	# 应用名称</span></span><br><span class="line">    <span class="attr">application</span> = <span class="string">&quot;seata-server&quot;</span></span><br><span class="line"><span class="comment">    # Nacos服务器地址</span></span><br><span class="line">    <span class="attr">serverAddr</span> = <span class="string">&quot;127.0.0.1:8848&quot;</span></span><br><span class="line"><span class="comment">    # 这里使用SEATA_GROUP组，注册到Nacos中的组</span></span><br><span class="line">    <span class="attr">group</span> = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line"><span class="comment">    # 使用为seata配置的命名空间的ID</span></span><br><span class="line">    <span class="attr">namespace</span> = <span class="string">&quot;2bf6fa3e-ca47-48ef-b8a4-6d2f823961ed&quot;</span></span><br><span class="line"><span class="comment">    # 集群名称</span></span><br><span class="line">    <span class="attr">cluster</span> = <span class="string">&quot;default&quot;</span></span><br><span class="line"><span class="comment">    # Nacos的用户名和密码</span></span><br><span class="line">    <span class="attr">username</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line">    <span class="attr">password</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">  	#...</span></span><br></pre></td></tr></table></figure>

<p>注册信息配置完成后需要将配置文件也放到 Nacos 中让 Nacos 管理配置。这样就可以对配置进行热更新了，一旦环境需要变化，只需要在 Nacos 中修改。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">	# 这里也使用nacos</span></span><br><span class="line"><span class="comment">  # file、nacos 、apollo、zk、consul、etcd3</span></span><br><span class="line">  <span class="attr">type</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nacos</span> <span class="string">&#123;</span></span><br><span class="line"><span class="comment">  	# 跟上面一样</span></span><br><span class="line">    <span class="attr">serverAddr</span> = <span class="string">&quot;127.0.0.1:8848&quot;</span></span><br><span class="line">    <span class="attr">namespace</span> = <span class="string">&quot;2bf6fa3e-ca47-48ef-b8a4-6d2f823961ed&quot;</span></span><br><span class="line">    <span class="attr">group</span> = <span class="string">&quot;SEATA_GROUP&quot;</span></span><br><span class="line">    <span class="attr">username</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line">    <span class="attr">password</span> = <span class="string">&quot;nacos&quot;</span></span><br><span class="line">    <span class="attr">dataId</span> = <span class="string">&quot;seataServer.properties&quot;</span></span><br><span class="line">  <span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后导入到 Nacos 中。打开下载的源码 <code>script/config-center/nacos</code> 目录，这是官方提供的上传脚本，直接运行，这里使用这个可交互的版本：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O17ZWV"><img src="https://s1.ax1x.com/2022/05/08/O17ZWV.png" alt="O17ZWV.png" style="zoom:50%;" /></a></p>
<p>按照提示输入就可以了，不输入就使用的默认值。</p>
<p>导入成功之后，可以在对应的命名空间下看到对应的配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O17rFI"><img src="https://s1.ax1x.com/2022/05/08/O17rFI.png" alt="O17rFI.png"></a></p>
<p>还需要将对应的事务组映射配置也添加上，DataId 格式为<code>service.vgroupMapping.事务组名称</code>，值全部使用 default：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1HQc8"><img src="https://s1.ax1x.com/2022/05/08/O1HQc8.png" alt="O1HQc8.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1Hg41"><img src="https://s1.ax1x.com/2022/05/08/O1Hg41.png" alt="O1Hg41.png"></a></p>
<p>这样就完成了服务端的 Nacos 配置。</p>
<p>然后需要对客户端也进行 Nacos 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="comment"># 注册</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="comment"># 使用Nacos</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="comment"># 使用Seata的命名空间  由于组使用的是默认值SEATA_GROUP，所以不需要配置</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">2bf6fa3e-ca47-48ef-b8a4-6d2f823961ed</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="comment"># 配置</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">2bf6fa3e-ca47-48ef-b8a4-6d2f823961ed</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br></pre></td></tr></table></figure>

<p>现在就可以启动这三个服务了，可以在 Nacos 中看到 Seata 以及三个服务正常注册：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1qUyT"><img src="https://s1.ax1x.com/2022/05/08/O1qUyT.png" alt="O1qUyT.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1qwmF"><img src="https://s1.ax1x.com/2022/05/08/O1qwmF.png" alt="O1qwmF.png"></a></p>
<p>访问服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O14KpD"><img src="https://s1.ax1x.com/2022/05/08/O14KpD.png" alt="O14KpD.png"></a></p>
<p>效果和之前是一样的，但现在的注册和配置都在 Nacos 中进行。</p>
<p>还可以配置事务会话信息的存储方式，默认是 file 类型，会在项目目录下创建<code>file_store</code>目录，我们可以将其搬到数据库中存储，只需要修改一下配置：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1OSbD"><img src="https://s1.ax1x.com/2022/05/08/O1OSbD.png" alt="O1OSbD.png"></a></p>
<p>将<code>store.session.mode</code>和<code>store.mode</code>的值修改为<code>db</code></p>
<p>对数据库信息进行一下配置：</p>
<ul>
<li>数据库驱动</li>
<li>数据库URL</li>
<li>数据库用户名密码</li>
</ul>
<p>其他的默认即可：</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h0t5chy3tmj226y0u00yl.jpg" alt="image-20220331163100436"></p>
<p>然后需要将对应的数据库进行创建，创建 seata 数据库，执行以下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used when storeMode is &#x27;db&#x27; --------------------------------</span></span><br><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `global_table`</span><br><span class="line">(</span><br><span class="line">    `xid`                       <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`            <span class="type">BIGINT</span>,</span><br><span class="line">    `status`                    TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `application_id`            <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_service_group` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `transaction_name`          <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `timeout`                   <span class="type">INT</span>,</span><br><span class="line">    `begin_time`                <span class="type">BIGINT</span>,</span><br><span class="line">    `application_data`          <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`                DATETIME,</span><br><span class="line">    `gmt_modified`              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`xid`),</span><br><span class="line">    KEY `idx_status_gmt_modified` (`status` , `gmt_modified`),</span><br><span class="line">    KEY `idx_transaction_id` (`transaction_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `branch_table`</span><br><span class="line">(</span><br><span class="line">    `branch_id`         <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`               <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `transaction_id`    <span class="type">BIGINT</span>,</span><br><span class="line">    `resource_group_id` <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `resource_id`       <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `branch_type`       <span class="type">VARCHAR</span>(<span class="number">8</span>),</span><br><span class="line">    `status`            TINYINT,</span><br><span class="line">    `client_id`         <span class="type">VARCHAR</span>(<span class="number">64</span>),</span><br><span class="line">    `application_data`  <span class="type">VARCHAR</span>(<span class="number">2000</span>),</span><br><span class="line">    `gmt_create`        DATETIME(<span class="number">6</span>),</span><br><span class="line">    `gmt_modified`      DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`branch_id`),</span><br><span class="line">    KEY `idx_xid` (`xid`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `lock_table`</span><br><span class="line">(</span><br><span class="line">    `row_key`        <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `xid`            <span class="type">VARCHAR</span>(<span class="number">128</span>),</span><br><span class="line">    `transaction_id` <span class="type">BIGINT</span>,</span><br><span class="line">    `branch_id`      <span class="type">BIGINT</span>       <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource_id`    <span class="type">VARCHAR</span>(<span class="number">256</span>),</span><br><span class="line">    `table_name`     <span class="type">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    `pk`             <span class="type">VARCHAR</span>(<span class="number">36</span>),</span><br><span class="line">    `status`         TINYINT      <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> COMMENT <span class="string">&#x27;0:locked ,1:rollbacking&#x27;</span>,</span><br><span class="line">    `gmt_create`     DATETIME,</span><br><span class="line">    `gmt_modified`   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`row_key`),</span><br><span class="line">    KEY `idx_status` (`status`),</span><br><span class="line">    KEY `idx_branch_id` (`branch_id`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `distributed_lock`</span><br><span class="line">(</span><br><span class="line">    `lock_key`       <span class="type">CHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `lock_value`     <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `expire`         <span class="type">BIGINT</span>,</span><br><span class="line">    <span class="keyword">primary</span> key (`lock_key`)</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br><span class="line">  <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `distributed_lock` (lock_key, lock_value, expire) <span class="keyword">VALUES</span> (<span class="string">&#x27;HandleAllSession&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>然后重启 Seata 服务端即可：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1XnQx"><img src="https://s1.ax1x.com/2022/05/08/O1XnQx.png" alt="O1XnQx.png"></a></p>
<p>数据源初始化成功，现在已经在使用数据库进行会话存储了。</p>
<p>如果 Seata 服务端出现报错，可能是自定义事务组的名称太长了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1XBTg"><img src="https://s1.ax1x.com/2022/05/08/O1XBTg.png" alt="O1XBTg.png"></a></p>
<p>将<code>globle_table</code>表的字段<code>transaction_server_group</code>长度适当增加一下即可：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O1XTh9"><img src="https://s1.ax1x.com/2022/05/08/O1XTh9.png" alt="O1XTh9.png"></a></p>
<br>

<h1 id="Spring-Cloud-消息组件"><a href="#Spring-Cloud-消息组件" class="headerlink" title="Spring Cloud 消息组件"></a>Spring Cloud 消息组件</h1><h2 id="SpringCloud-Stream"><a href="#SpringCloud-Stream" class="headerlink" title="SpringCloud Stream"></a>SpringCloud Stream</h2><p><strong>官方文档：</strong><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-stream/docs/3.2.2/reference/html/">https://docs.spring.io/spring-cloud-stream/docs/3.2.2/reference/html/</a></p>
<p>有些时候我们可能会遇到不同的系统在用不同的消息队列，比如系统 A 使用 Kafka、系统 B 使用 RabbitMQ，但是我们现在并不会使用 Kafka。</p>
<p>Spring Cloud Stream 就能够屏蔽底层实现，使用统一的消息队列操作方式就能操作多种不同类型的消息队列。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1hqdnqlqsj21iu0l0myd.jpg" alt="image-20220421225215709"></p>
<p>它屏蔽了 RabbitMQ 底层操作，让我们使用统一的 Input 和 Output 形式，以 Binder 为中间件，这样就算我们切换了不同的消息队列，也无需修改代码，而具体某种消息队列的底层实现是交给 Stream 做的。</p>
<br>

<h3 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h3><p>依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--  RabbitMQ的Stream实现  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>生产者</li>
</ol>
<p>首先是配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span>   <span class="comment"># 配置要绑定的rabbitmq的服务信息</span></span><br><span class="line">        <span class="attr">local-server:</span> <span class="comment"># 绑定名称</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span> <span class="comment"># 消息组件类型，这里使用的是RabbitMQ</span></span><br><span class="line">          <span class="attr">environment:</span>  <span class="comment"># 服务器相关信息</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.6</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">                <span class="attr">virtual-host:</span> <span class="string">/test</span></span><br><span class="line">     <span class="attr">bindings:</span></span><br><span class="line">       <span class="attr">test-out-0:</span></span><br><span class="line">         <span class="attr">destination:</span> <span class="string">test.exchange</span></span><br></pre></td></tr></table></figure>

<p>然后编写 Controller，访问一次这个接口就向消息队列发送一个数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PublishController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    StreamBridge bridge;  <span class="comment">//通过bridge来发送消息</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/publish&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">publish</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//第一个参数其实就是RabbitMQ的交换机名称（数据会发送给这个交换机，到达哪个消息队列，不由我们决定）</span></span><br><span class="line">      	<span class="comment">//这个交换机的命名稍微有一些规则:</span></span><br><span class="line">      	<span class="comment">//输入:    &lt;名称&gt; + -in- + &lt;index&gt;</span></span><br><span class="line">      	<span class="comment">//输出:    &lt;名称&gt; + -out- + &lt;index&gt;</span></span><br><span class="line">      	<span class="comment">//这里我们使用输出的方式，来将数据发送到消息队列，注意这里的名称会和之后的消费者Bean名称进行对应</span></span><br><span class="line">        bridge.send(<span class="string">&quot;test-out-0&quot;</span>, <span class="string">&quot;HelloWorld!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;消息发送成功！&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们来将生产者启动一下，访问一下接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O3kUcF"><img src="https://s1.ax1x.com/2022/05/08/O3kUcF.png" alt="O3kUcF.png"></a></p>
<p>消息成功发送，RabbitMQ 中：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O3kRje"><img src="https://s1.ax1x.com/2022/05/08/O3kRje.png" alt="O3kRje.png"></a></p>
<p>新增了一个<code>test-in-0</code>交换机，并且此交换机是topic类型的。</p>
<p>但是目前没有任何队列绑定到此交换机上，刚刚发送的消息没有给到任何队列。</p>
<ol start="2">
<li>消费者</li>
</ol>
<p>只需要定义一个 Consumer ，其他配置相同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(&quot;test&quot;)</span>   <span class="comment">// 这里填写交换机名称中&quot;名称&quot;，这样生产者发送的数据才会正确到达</span></span><br><span class="line">    <span class="keyword">public</span> Consumer&lt;String&gt; <span class="title function_">consumer</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.out::println;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件修改目标交换机：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">    	<span class="string">...</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">      	<span class="comment"># 消费者是输入，默认名称为 方法名-in-index</span></span><br><span class="line">        <span class="attr">test-in-0:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">test.exchange</span></span><br></pre></td></tr></table></figure>

<p>启动，可以看到启动之后自动创建了一个新的队列：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O3kH9f"><img src="https://s1.ax1x.com/2022/05/08/O3kH9f.png" alt="O3kH9f.png"></a></p>
<p>而这个队列就是消费者等待数据到达的队列：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O3AEDJ"><img src="https://s1.ax1x.com/2022/05/08/O3AEDJ.png" alt="O3AEDJ.png"></a></p>
<p>发现当前队列绑定到了刚刚创建的交换机上，并且<code>routingKey</code>是<code>#</code>，因此消息会直接发送过来。</p>
<p>访问消息发送接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O3kUcF"><img src="https://s1.ax1x.com/2022/05/08/O3kUcF.png" alt="O3kUcF.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O3A7Z9"><img src="https://s1.ax1x.com/2022/05/08/O3A7Z9.png" alt="O3A7Z9.png"></a></p>
<p>消费者成功地进行消费了。</p>
<p>这样就通过使用 Spring Cloud Stream 屏蔽掉底层 RabbitMQ 直接进行消息的操作了。</p>
<br>

<h1 id="微服务应用"><a href="#微服务应用" class="headerlink" title="微服务应用"></a>微服务应用</h1><h2 id="分布式权限校验"><a href="#分布式权限校验" class="headerlink" title="分布式权限校验"></a>分布式权限校验</h2><p>之前进行权限校验服务器判定请求来自的用户：</p>
<ul>
<li>浏览器向服务端发送请求访问网站。</li>
<li>服务端收到请求后创建一个 SESSION ID 暂时存储在服务端，然后发送给浏览器作为 Cookie 保存。</li>
<li>之后浏览器会一直携带此 Cookie 访问服务器。这样在收到请求后就能根据携带的 Cookie 中的 SESSION ID 判断来自哪个用户了。</li>
<li>这样服务端和浏览器之间可以轻松地建立会话了。</li>
</ul>
<p>但在分布式的系统中通过用户服务进行登录后，其他服务如图书服务和借阅服务并不知道用户是否登录：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O8vMiF"><img src="https://s1.ax1x.com/2022/05/09/O8vMiF.png" alt="O8vMiF.png"></a></p>
<p>在登录到用户服务之后，Session 中的用户数据只会在用户服务的应用中保存，而在其他服务中并没有对应的信息。但我们希望所有的服务都能够同步这些 Session 信息，这样才能实现在用户服务登录后其他服务都能知道。</p>
<p>实现 Session 的同步：</p>
<ol>
<li>在每台服务器上都复制一份 Session。但这样显然很浪费时间，并且用户验证数据占用的内存会不断增加。</li>
<li>将 Session 移出服务器用统一存储存放。比如可以在 Redis 或 MySQL 中存放用户的 Session 信息，这样所有的服务器在需要 Session 信息时统一访问 Redis 或 MySQL 即可。这样就能保证所有服务都可以同步 Session 了。</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/O8v1z9"><img src="https://s1.ax1x.com/2022/05/09/O8v1z9.png" alt="O8v1z9.png"></a></p>
<br>

<h3 id="使用-Redis-实现"><a href="#使用-Redis-实现" class="headerlink" title="使用 Redis 实现"></a>使用 Redis 实现</h3><p>为每个服务都添加验证机制，首先导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  SpringSession Redis支持  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  添加Redis的Starter  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后使用 SpringSecurity 框架作为权限校验框架，为借阅服务添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后为在每个服务编写对应的配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">session:</span></span><br><span class="line">  	<span class="comment"># 存储类型修改为redis</span></span><br><span class="line">    <span class="attr">store-type:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">  	<span class="comment"># Redis服务器的信息</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">43.138</span><span class="number">.201</span><span class="number">.82</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>这样在默认情况下，每个服务的接口都会被 SpringSecurity 所保护，只有登录成功之后才可以被访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGNu79"><img src="https://s1.ax1x.com/2022/05/09/OGNu79.png" alt="OGNu79.png"></a></p>
<p>可以看到重定向到了登陆页面，必须登陆之后才能访问。去访问其他服务也是一样的效果。</p>
<p>由于现在是统一 Session 存储，因此就可以在任意一个服务登录后正常访问其他服务而不需要重复登录：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGNHuF"><img src="https://s1.ax1x.com/2022/05/09/OGNHuF.png" alt="OGNHuF.png"></a></p>
<p>同时其他服务也能正常访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGUHRP"><img src="https://s1.ax1x.com/2022/05/09/OGUHRP.png" alt="OGUHRP.png"></a></p>
<p>查看 Redis 服务器中存储的 Session 信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGwPDU"><img src="https://s1.ax1x.com/2022/05/09/OGwPDU.png" alt="OGwPDU.png"></a></p>
<p>但发现借阅服务报错了，在 RestTemplate 进行远程调用时，由于我们的请求没有携带对应 Session 的 Cookie，所以导致验证失败访问不成功返回401。虽然这种方案看起来比较合理，但在实际使用中不便。</p>
<br>

<h2 id="OAuth-2-0-实现单点登录"><a href="#OAuth-2-0-实现单点登录" class="headerlink" title="OAuth 2.0 实现单点登录"></a>OAuth 2.0 实现单点登录</h2><p>虽然可以使用统一存储来解决 Session 共享问题，但是就算实现了 Session 共享也还会存在一些问题。</p>
<p>由于每个服务都有自己的验证模块，因此整个系统是存在冗余功能的，这种登录模式被称为多点登录。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGDzoF"><img src="https://s1.ax1x.com/2022/05/09/OGDzoF.png" alt="OGDzoF.png"></a></p>
<p>一种全新的登录方式：<strong>OAuth 2.0</strong>。</p>
<p>OAuth2 是一种认证框架（authorization framework），他是用于允许第三方应用经用户授权后访问对应的 Http 服务或资源。 基于上述概念，我们需要明确的是 OAuth2 是一种认证框架，不仅是一种狭义的协议（狭义的协议指双方互相沟通应遵守的规则），OAuth2 作为一种框架，他定义了多个角色、授权类型以及对应的使用场景。 另外，我们可以看到 OAuth2 推出的核心场景是用于对第三方应用的授权访问。有些项目中会使用 OAuth 协议在自己的客户端上鉴权，这是使用了密码模式。因为我们认为即使是自己开发的客户端，其实也是属于第三方应用，因为客户端是分散在外部的，实际上服务端并不完全可控。因此使用 OAuth 协议密码模式的客户端，有责任保障安全性。</p>
<br>

<h3 id="四种授权模式"><a href="#四种授权模式" class="headerlink" title="四种授权模式"></a>四种授权模式</h3><p>OAuth 2.0 的四种授权模式：</p>
<ol>
<li><p><strong>客户端模式（Client Credentials）</strong></p>
<p>最简单的模式。直接向验证服务器请求 Token（当Token 的意思是“令牌”，是服务端生成的一串字符串，作为客户端进行请求的一个标识。我们需要在验证服务器<strong>（User Account And Authentication）</strong>服务拿到令牌之后才能去访问资源。这样资源服务器才知道是否成功登录以及登录的是谁）</p>
<p>这里的前端页面只是一个例子，它可以是其他任何类型的<strong>客户端</strong>，比如 App、小程序甚至是第三方应用的服务。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGWKMQ"><img src="https://s1.ax1x.com/2022/05/09/OGWKMQ.png" alt="OGWKMQ.png"></a></p>
<p>虽然这种模式比较简便，但是已经失去了用户验证的意义，更适用于服务内部调用的场景。</p>
</li>
<li><p><strong>密码模式（Resource Owner Password Credentials）</strong></p>
<p>密码模式相比客户端模式多了用户名和密码的信息，用户需要提供对应账号的用户名和密码，才能获取到 Token。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGW8I0"><img src="https://s1.ax1x.com/2022/05/09/OGW8I0.png" alt="OGW8I0.png"></a></p>
<p>这种模式通常用于一个企业不同服务之间的账号互联互通。</p>
</li>
<li><p><strong>隐式授权模式（Implicit Grant）</strong></p>
<p>用户访问页面时会重定向到认证服务器，然后认证服务器给用户一个认证页面，等待用户授权，用户填写信息完成授权后，认证服务器返回 Token。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGWaM4"><img src="https://s1.ax1x.com/2022/05/09/OGWaM4.png" alt="OGWaM4.png"></a></p>
<p>这种模式适用于没有服务端的第三方应用页面。它验证都是在验证服务器进行的，敏感信息不易泄露，但 Token 依然存在泄露的风险。</p>
</li>
<li><p><strong>授权码模式（Authrization Code）</strong></p>
<p>授权码模式是 OAuth2 授权最广泛的方式，其能保障安全的核心原因是用户在浏览器中授权，并且分两步获得 Token。</p>
<p>相比隐式授权模式，它并不会直接返回 Token 而是返回授权码，真正的 Token 是通过应用服务器访问验证服务器获得的。在一开始的时候，应用服务器（客户端通过访问自己的应用服务器来进而访问其他服务）和验证服务器之间会共享一个 secret，而验证服务器在用户验证完成后会返回一个授权码，应用服务器最后将授权码和 secret 一起交给验证服务器进行验证，并且 Token 也是在服务端之间传递，不会直接给到客户端。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGWrIx"><img src="https://s1.ax1x.com/2022/05/09/OGWrIx.png" alt="OGWrIx.png"></a></p>
<p>这样，就算有人中途窃取了授权码也毫无意义。因为 Token 的获取必须同时携带授权码和 secret，但 secret 第三方是无法得知的，并且 Token 不会直接给客户端，大大减少了泄露的风险。</p>
</li>
</ol>
<p>我们可以使用 OAuth 2 来实现单点登录，只是缺少了资源服务器这个角色，客户端就是我们的整个系统。</p>
<br>

<h3 id="搭建验证服务器"><a href="#搭建验证服务器" class="headerlink" title="搭建验证服务器"></a>搭建验证服务器</h3><p>搭建一个验证服务器，它是我们进行权限校验的核心。验证服务器有很多第三方实现，这里使用 Spring 官方提供的验证服务器。</p>
<p>在父项目中添加 SpringCloud 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后创建一个新的模块<code>auth-service</code>，添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--  OAuth2.0依赖 需要指定版本  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">  	<span class="comment"># 为了防止一会在服务之间跳转导致Cookie冲突（因为所有服务地址都是localhost，都会存JSESSIONID）</span></span><br><span class="line">  	<span class="comment"># 修改context-path，这样保存的Cookie会使用指定的路径</span></span><br><span class="line">  	<span class="comment"># 注意之后的请求都需要在最前面加上这个路径</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/sso</span></span><br></pre></td></tr></table></figure>

<p>创建完启动类后编写配置类，这里需要两个配置类，一个是 OAuth2 的配置类，还有一个是 SpringSecurity 的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin().permitAll();       <span class="comment">// 使用表单登录</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BCryptPasswordEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">        auth</span><br><span class="line">                .inMemoryAuthentication()       <span class="comment">// 创建用户</span></span><br><span class="line">                .passwordEncoder(encoder)</span><br><span class="line">                .withUser(<span class="string">&quot;test&quot;</span>).password(encoder.encode(<span class="string">&quot;test&quot;</span>)).roles(<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>   <span class="comment">// 将 AuthenticationManager 注入到 Spring 容器， 需要在 OAuth 2 配置中使用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAuthorizationServer</span>  <span class="comment">// 开启认证服务器</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2Configuration</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BCryptPasswordEncoder</span> <span class="variable">encoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置客户端详情服务</span></span><br><span class="line"><span class="comment">     * 一个验证服务器可以预设多个客户端，</span></span><br><span class="line"><span class="comment">     * 之后这些指定的客户端就可以按照下面指定的方式进行验证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clients 客户端配置工具</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients</span><br><span class="line">                .inMemory()     <span class="comment">// 硬编码创建，可以那样自定义或使用JDBC从数据库读取</span></span><br><span class="line">                .withClient(<span class="string">&quot;web&quot;</span>)  <span class="comment">// 客户端id</span></span><br><span class="line">                .secret(encoder.encode(<span class="string">&quot;123456&quot;</span>)) <span class="comment">// 只与客户端共享的 secret</span></span><br><span class="line">                .autoApprove(<span class="literal">false</span>) <span class="comment">// 是否自动授权</span></span><br><span class="line">                .scopes(<span class="string">&quot;book&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;borrow&quot;</span>) <span class="comment">// 授权范围</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;client_credentials&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;implicit&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>); <span class="comment">// 授权类型</span></span><br><span class="line">                <span class="comment">// 除了之前的四种还有一种刷新令牌模式</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        security</span><br><span class="line">                .passwordEncoder(encoder) <span class="comment">// 密码加密器</span></span><br><span class="line">                .allowFormAuthenticationForClients()    <span class="comment">// 允许表单认证</span></span><br><span class="line">                .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>); <span class="comment">// 允许所有的Token查询请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 由于SpringSecurity新版本的一些底层改动，这里需要配置authenticationManager才能正常使用password模式</span></span><br><span class="line">        endpoints</span><br><span class="line">                .authenticationManager(authenticationManager); <span class="comment">// 认证管理器</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<br>

<h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><p>启动服务器，然后使用 Postman 进行接口测试。</p>
<h4 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h4><p>首先从最简单的客户端模式进行测试，客户端模式只需要提供 ID 和 secret 即可获取到 Token。注意需要再添加 grant_type 来表明我们的授权方式，默认请求路径为 <a target="_blank" rel="noopener" href="http://localhost:8500/sso/oauth/token">http://localhost:8500/sso/oauth/token</a></p>
<p>发起请求后，返回了JSON格式的 Token：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OGzqpD"><img src="https://s1.ax1x.com/2022/05/09/OGzqpD.png" alt="OGzqpD.png"></a></p>
<p>还可以访问 <a target="_blank" rel="noopener" href="http://localhost:8500/sso/oauth/check_token">http://localhost:8500/sso/oauth/check_token</a> 来验证 Token 是否有效：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJSnA0"><img src="https://s1.ax1x.com/2022/05/09/OJSnA0.png" alt="OJSnA0.png"></a></p>
<p>可以看到 active 为 true，表示我们刚刚申请到的 Token 是有效的。</p>
<br>

<h4 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h4><p>然后测试 password 模式，需要提供具体的用户名和密码，授权模式定义为 password ：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJpmKH"><img src="https://s1.ax1x.com/2022/05/09/OJpmKH.png" alt="OJpmKH.png"></a></p>
<p>需要在请求头中添加 Basic 验证信息，填写 ID 和 secret ：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJp9bR"><img src="https://s1.ax1x.com/2022/05/09/OJp9bR.png" alt="OJp9bR.png"></a></p>
<p>可以看到在请求头中自动生成了 Basic 验证相关内容：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJpMVI"><img src="https://s1.ax1x.com/2022/05/09/OJpMVI.png" alt="OJpMVI.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJpGRS"><img src="https://s1.ax1x.com/2022/05/09/OJpGRS.png" alt="OJpGRS.png"></a></p>
<p>响应成功得到 Token 信息，并且还多个 refresh_token，这是用于刷新 Token 的。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJpUqs"><img src="https://s1.ax1x.com/2022/05/09/OJpUqs.png" alt="OJpUqs.png"></a></p>
<p>查询 Token 信息还可以看到登录的具体用户以及角色权限等。</p>
<br>

<h4 id="隐式授权模式"><a href="#隐式授权模式" class="headerlink" title="隐式授权模式"></a>隐式授权模式</h4><p>隐式授权模式需要在验证服务器上进行登录操作而不是直接请求 Token，验证登录请求地址：<a target="_blank" rel="noopener" href="http://localhost:8500/sso/oauth/authorize?client_id=web&amp;response_type=token">http://localhost:8500/sso/oauth/authorize?client_id=web&amp;response_type=token</a></p>
<p>注意 response_type 一定要是 token 类型，这样才会直接返回 Token。浏览器发起请求后会进入 Spring Security 的登录界面：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJ9JFx"><img src="https://s1.ax1x.com/2022/05/09/OJ9JFx.png" alt="OJ9JFx.png"></a></p>
<p>输入我们指定的用户名和密码登录后会出现一个错误：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJ9d6e"><img src="https://s1.ax1x.com/2022/05/09/OJ9d6e.png" alt="OJ9d6e.png"></a></p>
<p>这是因为登录成功之后验证服务器需要将结果给回客户端，所以需要提供客户端的回调地址，这样浏览器就会被重定向到指定的回调地址并且请求中会携带 Token 信息。因此需要配置一个回调地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients</span><br><span class="line">                .inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;web&quot;</span>)</span><br><span class="line">                .secret(encoder.encode(<span class="string">&quot;123456&quot;</span>))</span><br><span class="line">                .autoApprove(<span class="literal">false</span>)</span><br><span class="line">                .scopes(<span class="string">&quot;book&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;borrow&quot;</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://localhost:8101/login&quot;</span>) <span class="comment">// 授权回调地址</span></span><br><span class="line">          			<span class="comment">// 可以写多个，当有多个时需要在验证请求中指定使用哪个地址进行回调	</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;client_credentials&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;implicit&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重启验证服务器再次访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJCYHs"><img src="https://s1.ax1x.com/2022/05/09/OJCYHs.png" alt="OJCYHs.png"></a></p>
<p>这里会让我们选择哪些范围进行授权可以自由决定是否给客户端授予访问这些资源的权限，这里选择全部授予：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJCR4x"><img src="https://s1.ax1x.com/2022/05/09/OJCR4x.png" alt="OJCR4x.png"></a></p>
<p>授予后浏览器被重定向到指定的回调地址中并且携带了 Token 信息，校验 Token：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJPEGV"><img src="https://s1.ax1x.com/2022/05/09/OJPEGV.png" alt="OJPEGV.png"></a></p>
<p> Token 也是有效的且 JSON 内容和密码模式基本一致。</p>
<br>

<h4 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h4><p>授权码模式流程与前面一样的，但请求的是 code 类型：<a target="_blank" rel="noopener" href="http://localhost:8500/sso/oauth/authorize?client_id=web&amp;response_type=code">http://localhost:8500/sso/oauth/authorize?client_id=web&amp;response_type=code</a></p>
<p>访问后也会要求进行登录然后进入到回调地址，但此时返回的是授权码而不是直接给 Token：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJEC4A"><img src="https://s1.ax1x.com/2022/05/09/OJEC4A.png" alt="OJEC4A.png"></a></p>
<p>需要携带授权码和 secret 一起请求才能获取 Token，正常情况下是由回调的服务器进行处理，这里我们在 Postman 中进行：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJV9qU"><img src="https://s1.ax1x.com/2022/05/09/OJV9qU.png" alt="OJV9qU.png"></a></p>
<p>正常返回 Token 信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJVFIJ"><img src="https://s1.ax1x.com/2022/05/09/OJVFIJ.png" alt="OJVFIJ.png"></a></p>
<br>

<h4 id="刷新令牌"><a href="#刷新令牌" class="headerlink" title="刷新令牌"></a>刷新令牌</h4><p>当 Token 过期时可以使用 refresh_token 来申请一个新的 Token，refresh_token 的值是请求后返回的：</p>
<p>[![OJ<a target="_blank" rel="noopener" href="https://imgtu.com/i/OJZBnK"><img src="https://s1.ax1x.com/2022/05/09/OJZBnK.png" alt="OJZBnK.png"></a>](<a target="_blank" rel="noopener" href="https://imgtu.com/i/OJVzYd">https://imgtu.com/i/OJVzYd</a>)</p>
<p>但执行后出现了一个内部错误，</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJZ87F"><img src="https://s1.ax1x.com/2022/05/09/OJZ87F.png" alt="OJZ87F.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJZWct"><img src="https://s1.ax1x.com/2022/05/09/OJZWct.png" alt="OJZWct.png"></a></p>
<p>查看日志得知这里还需要配置一个 UserDetailsService，把 Security 中的实例注册为 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsServiceBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.userDetailsServiceBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 Endpoint 中设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  endpoints</span><br><span class="line">    .userDetailsService(userDetailsService)</span><br><span class="line">    .authenticationManager(authenticationManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务后重新请求：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJeQCd"><img src="https://s1.ax1x.com/2022/05/09/OJeQCd.png" alt="OJeQCd.png"></a></p>
<br>

<h3 id="基于-EnableOAuth2Sso-实现"><a href="#基于-EnableOAuth2Sso-实现" class="headerlink" title="基于 @EnableOAuth2Sso 实现"></a>基于 @EnableOAuth2Sso 实现</h3><p>验证服务器搭建完成后就可以实现单点登陆了。Spring Cloud 提供了客户端的直接实现，只需要添加一个注解和少量配置即可将我们的服务作为一个单点登陆应用，使用的是授权码模式。</p>
<p>这种模式只是将验证方式由原本的默认登录形式改变为统一在授权服务器登陆的形式。</p>
<p>首先导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在启动类上添加 <code>@EnableOAuth2Sso</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableOAuth2Sso</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BookApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不需要进行额外的配置这个注解已经帮我们完成了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@EnableOAuth2Client</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;OAuth2SsoProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Import(&#123;OAuth2SsoDefaultConfiguration.class, OAuth2SsoCustomConfiguration.class, ResourceServerTokenServicesConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableOAuth2Sso &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它注册了 OAuth2SsoDefaultConfiguration，而这个类就是帮助我们对 Security 进行配置的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Conditional(&#123;NeedsWebSecurityCondition.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2SsoDefaultConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  	<span class="comment">// 继承了WebSecurityConfigurerAdapter把验证设置配置好了</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">OAuth2SsoDefaultConfiguration</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后需要在配置文件中配置验证服务器相关信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment"># Token获取地址</span></span><br><span class="line">      <span class="attr">access-token-uri:</span> <span class="string">http://localhost:8500/sso/oauth/token</span></span><br><span class="line">      <span class="comment"># 验证页面地址</span></span><br><span class="line">      <span class="attr">user-authorization-uri:</span> <span class="string">http://localhost:8500/sso/oauth/authorize</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="comment"># Token信息获取和校验地址</span></span><br><span class="line">      <span class="attr">token-info-uri:</span> <span class="string">http://localhost:8500/sso/oauth/check_token</span></span><br></pre></td></tr></table></figure>

<p>开启图书服务，调用图书接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OJxfA0"><img src="https://s1.ax1x.com/2022/05/09/OJxfA0.png" alt="OJxfA0.png"></a></p>
<p>可以看到在没有登录验证时会跳转到授权页面进行授权登录，登录后才可以继续访问图书服务：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OYp90A"><img src="https://s1.ax1x.com/2022/05/09/OYp90A.png" alt="OYp90A.png"></a></p>
<p>获取 SpringSecurity 的 Context 查看用户信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">Book <span class="title function_">findBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> <span class="type">int</span> bid)</span>&#123;</span><br><span class="line">  	<span class="comment">//通过SecurityContextHolder将用户信息取出</span></span><br><span class="line">    <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">    System.out.println(context.getAuthentication());</span><br><span class="line">    <span class="keyword">return</span> service.getBookById(bid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次访问图书管理接口，可以看到控制台输出：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OAuth2Authentication [Principal=<span class="built_in">test</span>, Credentials=[PROTECTED], Authenticated=<span class="literal">true</span>, Details=remoteAddress=0:0:0:0:0:0:0:1, sessionId=&lt;SESSION&gt;, tokenType=bearertokenValue=&lt;TOKEN&gt;, Granted Authorities=[ROLE_USER]]</span><br></pre></td></tr></table></figure>

<p>这里使用的不是 UsernamePasswordAuthenticationToken 也不是 RememberMeAuthenticationToken，而是新的 OAuth2Authentication，它保存了验证服务器的一些信息以及经过我们之前的登陆流程后，验证服务器发放给客户端的 Token 信息，并通过 Token 信息在验证服务器进行验证获取用户信息，最后保存到 Session 中，表示用户已验证。因此还是要依赖浏览器存 Cookie 的。</p>
<p>然后将所有的服务都使用这种方式进行验证，把重定向地址给所有服务都加上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients</span><br><span class="line">                .inMemory()</span><br><span class="line">                .withClient(<span class="string">&quot;web&quot;</span>)</span><br><span class="line">                .secret(encoder.encode(<span class="string">&quot;123456&quot;</span>))</span><br><span class="line">                .autoApprove(<span class="literal">true</span>) <span class="comment">// 开启自动授权</span></span><br><span class="line">                .scopes(<span class="string">&quot;book&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;borrow&quot;</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://localhost:8101/login&quot;</span>, <span class="string">&quot;http://localhost:8102/login&quot;</span>, <span class="string">&quot;http://localhost:8103/login&quot;</span>) <span class="comment">// 添加其他的回调地址</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;client_credentials&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;implicit&quot;</span>, <span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这样实现了只在验证服务器登陆而可以访问其他服务。</p>
<p>但由于 SESSION 不同步，每次切换不同的服务进行访问都会重新到验证服务器验证一次：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OYF9iR"><img src="https://s1.ax1x.com/2022/05/09/OYF9iR.png" alt="OYF9iR.png"></a></p>
<p>解决方案：</p>
<ul>
<li>用 Redis 或 MySQL 做 SESSION 统一存储</li>
<li>设置 context-path 路径为每个服务单独设置</li>
</ul>
<p>但这样依然没法解决服务间调用的问题，所以仅仅依靠单点登陆的模式不行。</p>
<br>

<h3 id="基于-EnableResourceServer-实现"><a href="#基于-EnableResourceServer-实现" class="headerlink" title="基于 @EnableResourceServer 实现"></a>基于 @EnableResourceServer 实现</h3><p>如果以第三方应用进行访问就需要将我们的服务作为资源服务。作为资源服务不会再提供验证的过程，而是要求请求时携带 Token。验证过程使用 Postman 完成。</p>
<p>这种方式只需要携带 Token 就能访问资源服务器，而客户端被独立出来用于携带 Token 去访问这些服务。</p>
<p>只需要添加一个注解和少量配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(BookApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置中只需要：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">client-id:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">client-secret:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="comment"># 资源服务器需要验证Token是否有访问此资源的权限以及用户信息，因此需要一个验证地址</span></span><br><span class="line">      <span class="attr">token-info-uri:</span> <span class="string">http://localhost:8500/sso/oauth/check_token</span></span><br></pre></td></tr></table></figure>

<p>配置完成后启动服务并访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtV3W9"><img src="https://s1.ax1x.com/2022/05/10/OtV3W9.png" alt="OtV3W9.png"></a></p>
<p>这是因为请求头中没有携带 Token 信息，有两种方式可以访问此资源：</p>
<ul>
<li>在 URL 后面添加 <code>access_token</code>请求参数，值为 Token 值</li>
<li>在请求头中添加 <code>Authorization</code>，值为 <code>Bearer + Token值</code></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtemUU"><img src="https://s1.ax1x.com/2022/05/10/OtemUU.png" alt="OtemUU.png"></a></p>
<p>第二种需要使用 Postman 来完成：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Otn8AK"><img src="https://s1.ax1x.com/2022/05/10/Otn8AK.png" alt="Otn8AK.png"></a>](<a target="_blank" rel="noopener" href="https://imgtu.com/i/Otm3WQ">https://imgtu.com/i/Otm3WQ</a>)</p>
<p>添加验证信息后，会被转换成请求头信息：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtmJQs"><img src="https://s1.ax1x.com/2022/05/10/OtmJQs.png" alt="OtmJQs.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtnwnI"><img src="https://s1.ax1x.com/2022/05/10/OtnwnI.png" alt="OtnwnI.png"></a></p>
<p>然后对资源服务器进行深度自定义，编写一个配置类，如希望用户被授权了某个 Scope 才可以访问此服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceConfiguration</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().access(<span class="string">&quot;#oauth2.hasScope(&#x27;none&#x27;)&quot;</span>);  <span class="comment">// 添加自定义规则</span></span><br><span class="line">                <span class="comment">// Token必须要有scope授权才可以访问此资源</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当没有对应的 Scope 授权时会返回 <code>insufficient_scope</code> 错误：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtKAWF"><img src="https://s1.ax1x.com/2022/05/10/OtKAWF.png" alt="OtKAWF.png"></a></p>
<p>实际上资源服务器没有必要将 Security 的信息保存在 Session 中。只需要将 Token 告诉资源服务器就可以联系验证服务器得到用户信息而不需要 Session 存储机制了。因此 HttpSession 中没有 <strong>SPRING_SECURITY_CONTEXT</strong>，现在 Security 信息是通过连接资源服务器获取的。</p>
<p>将三个服务都改为资源服务器。</p>
<p>测试发现在使用 RestTemplate 进行服务间的远程调用时会得到以下错误：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtQGqA"><img src="https://s1.ax1x.com/2022/05/10/OtQGqA.png" alt="OtQGqA.png"></a></p>
<p>这是因为在服务调用时并没有携带 Token 信息，我们需要把用户传来的 Token 信息在进行远程调用时携带上。</p>
<p>可以使用 OAuth2RestTemplate 实现，它会在请求其他服务时携带当前请求的 Token 信息。它继承自 RestTemplate。</p>
<p>定义 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    OAuth2ClientContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2RestTemplate</span>(<span class="keyword">new</span> <span class="title class_">ClientCredentialsResourceDetails</span>(), context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后替换之前的 RestTemplate ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    BorrowMapper mapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    OAuth2RestTemplate template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserBorrowDetail <span class="title function_">getUserBorrowDetailByUid</span><span class="params">(<span class="type">int</span> uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = mapper.getBorrowsByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> template.getForObject(<span class="string">&quot;http://localhost:8101/user/&quot;</span>+uid, User.class);</span><br><span class="line">        <span class="comment">//获取每一本书的详细信息</span></span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; template.getForObject(<span class="string">&quot;http://localhost:8201/book/&quot;</span>+b.getBid(), Book.class))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserBorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以成功调用服务了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ot14b9"><img src="https://s1.ax1x.com/2022/05/10/Ot14b9.png" alt="Ot14b9.png"></a></p>
<p> 然后导入 Nacos 并通过 Feign 实现远程调用。</p>
<p>导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>所有服务都已经注册成功了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtJp5R"><img src="https://s1.ax1x.com/2022/05/10/OtJp5R.png" alt="OtJp5R.png"></a></p>
<p>配置借阅服务的负载均衡：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    OAuth2ClientContext context;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@LoadBalanced</span>   <span class="comment">// 添加注解</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OAuth2RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OAuth2RestTemplate</span>(<span class="keyword">new</span> <span class="title class_">ClientCredentialsResourceDetails</span>(), context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务并访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Ot14b9"><img src="https://s1.ax1x.com/2022/05/10/Ot14b9.png" alt="Ot14b9.png"></a></p>
<p>然后来把它替换为 Feign ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;user-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/user/&#123;uid&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;uid&quot;)</span> Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;book-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BookClient</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/book/&#123;bid&#125;&quot;)</span></span><br><span class="line">    Book <span class="title function_">getBookById</span><span class="params">(<span class="meta">@PathVariable(&quot;bid&quot;)</span> Integer bid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就不需要再使用刚刚编写的 WebConfiguration 配置类类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BorrowServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BorrowService</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BorrowMapper borrowMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserClient userClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> BookClient bookClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByUid</span><span class="params">(Integer uid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByUid(uid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span>  userClient.getUserById(uid);</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BorrowDetail <span class="title function_">getBorrowDetailByBid</span><span class="params">(Integer bid)</span> &#123;</span><br><span class="line">        List&lt;Borrow&gt; borrow = borrowMapper.getBorrowByBid(bid);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userClient.getUserById(borrow.get(<span class="number">0</span>).getUid());</span><br><span class="line">        List&lt;Book&gt; bookList = borrow</span><br><span class="line">                .stream()</span><br><span class="line">                .map(b -&gt; bookClient.getBookById(b.getBid()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BorrowDetail</span>(user, bookList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在启动类上添加 <code>@EnableFeignClients</code> 后启动服务，但这样又出现刚刚的问题，OpenFeign 也没有携带 Token 进行访问：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtUBtJ"><img src="https://s1.ax1x.com/2022/05/10/OtUBtJ.png" alt="OtUBtJ.png"></a></p>
<p>需要两个配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">  	<span class="comment">#开启Oauth支持，这样就会在请求头中携带Token了</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#同时开启负载均衡支持</span></span><br><span class="line">    <span class="attr">load-balanced:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>重启服务器，可以看到结果OK了：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtdtdU"><img src="https://s1.ax1x.com/2022/05/10/OtdtdU.png" alt="OtdtdU.png"></a></p>
<p>这样就成功将三个服务都作为了资源服务器。与客户端不同，作为客户端只需要验证通过且需要保存 Session 信息，相当于只是将登录流程换到统一的验证服务器上进行。而将其作为资源服务器需要另外的客户端（可以是浏览器、小程序、App、第三方服务等）来访问，并且也需要先进行验证然后再携带 Token 进行访问。这种模式是比较常见的模式。</p>
<br>

<h3 id="使用-JWT-存储-Token"><a href="#使用-JWT-存储-Token" class="headerlink" title="使用 JWT 存储 Token"></a>使用 JWT 存储 Token</h3><p>官网：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io</a></p>
<p>JSON Web Token令牌（JWT）是一个开放标准（<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>），它定义了一种紧凑和自成一体的方式，用于在各方之间作为 JSON 对象安全地传输信息。由于它是数字签名因此这些信息可以被验证和信任。JWT 可以使用密钥（使用 <strong>HMAC</strong> 算法）或使用 <strong>RSA</strong> 或 <strong>ECDSA</strong> 进行公钥&#x2F;私钥对进行签名。</p>
<p>实际上，我们之前都是携带 Token 向资源服务器发起请求后，资源服务器由于不知道我们 Token 的用户信息，所以需要向验证服务器询问此 Token 的认证信息，这样才能得到 Token 代表的用户信息，但是各位是否考虑过，如果每次用户请求都去查询用户信息，那么在大量请求下，验证服务器的压力可能会非常的大。而使用 JWT 之后，Token 中会直接保存用户信息，这样资源服务器就不再需要询问验证服务器，自行就可以完成解析，我们的目标是不联系验证服务器就能直接完成验证。</p>
<p>JWT 令牌的格式如下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/OtBLFO"><img src="https://s1.ax1x.com/2022/05/10/OtBLFO.png" alt="OtBLFO.png"></a></p>
<p>一个 JWT 令牌由 3 部分组成：标头(Header)、有效载荷(Payload)和签名(Signature)。</p>
<p>在传输时会将 JWT 的 3 部分分别进行 Base64 编码后使用<code>.</code>进行连接形成最终需要传输的字符串。</p>
<ul>
<li>标头：包含一些元数据信息，如 JWT 签名所使用的加密算法和类型。</li>
<li>有效载荷：包括用户名称、令牌发布时间、过期时间、JWT ID 等。t也可以添加自定义字段，用户信息一般都在这里存放。</li>
<li>签名：首先需要指定一个密钥，该密钥仅仅保存在服务器中保证不能让其他用户知道。然后使用 Header 中指定的算法对 Header 和 Payload 进行 Base64 加密之后的结果通过密钥计算哈希值，得出一个签名哈希。用于验证内容是否被篡改。</li>
</ul>
<p>补充概念：</p>
<ul>
<li><p><strong>Base64：</strong>包括小写字母 a-z、大写字母 A-Z、数字 0-9、符号 “+”、”&#x2F;“ 一共 64 个字符的字符集（末尾还有一个或多个<code>=</code>用来凑够字节数），任何的符号都可以转换成这个字符集中的字符，这个转换过程就叫做 Base64 编码，编码之后会生成只包含上述 64 个字符的字符串。如果需要原本的内容可以进行 Base64 解码到原数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;Base64编码测试&quot;</span>;</span><br><span class="line">  	<span class="comment">// Base64可以对字符串和任何byte[]数据进行编码，编码结果可以是byte[]和字符串</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">encodeStr</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(str.getBytes());</span><br><span class="line">    System.out.println(<span class="string">&quot;Base64编码后的字符串：&quot;</span> + encodeStr);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;解码后的字符串：&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(Base64.getDecoder().decode(encodeStr)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Base64 不是加密算法，是一种信息的编码方式。</p>
</li>
<li><p><strong>加密算法：</strong>加密算法分为对称加密和非对称加密。<strong>对称加密（Symmetric Cryptography）</strong>使用一个密钥来加密和解密数据，双方使用的密钥必须是相同的。这些加密算法和密钥是轻量级的，因为它们旨在提高处理大型数据块或数据流的速度。</p>
<p><strong>非对称加密（Asymmetric Cryptography）</strong>需要两个密钥：公钥 (publickey) 和私钥 (privatekey)。公钥和私钥是一对，如果用公钥对数据加密，那么只能用对应的私钥解密。如果用私钥对数据加密，只能用对应的公钥进行解密。因为加密和解密用的是不同的密钥，所以称为非对称加密。</p>
<p>非对称加密算法的保密性好，它消除了最终用户交换密钥的需要。但是加解密速度要远远慢于对称加密，在某些极端情况下，甚至能比对称加密慢上1000倍。</p>
<p>对称加密和非对称加密都有很多的算法，对称加密：DES、IDEA、RC2，非对称加密：RSA、DAS、ECC</p>
</li>
<li><p><strong>不可逆加密算法：</strong>常见的不可逆加密算法有 MD5，HMAC，SHA-1，SHA-224，SHA-256，SHA-384 和 SHA-512，其中 SHA-224、SHA-256、SHA-384 和 SHA-512 可以统称为 SHA2 加密算法，SHA 加密算法的安全性要比 MD5 更高，而 SHA2 加密算法比 SHA1 的要高。SHA 后面的数字表示的是加密后的字符串长度，SHA1 默认会产生一个 160 位的信息摘要。经过不可逆加密算法得到的加密结果是无法解密回去的。用于对一段信息产生摘要以<strong>防止被篡改</strong>。</p>
</li>
</ul>
<p>我们可以利用 JWT 将 Token 采用新的方式进行存储：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ONmLV0"><img src="https://s1.ax1x.com/2022/05/10/ONmLV0.png" alt="ONmLV0.png"></a></p>
<p>这里采用对称密钥方式，对验证服务器进行修改：</p>
<p>SecurityConfiguration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">tokenConverter</span><span class="params">()</span>&#123;  <span class="comment">//Token转换器，将其转换为JWT</span></span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        converter.setSigningKey(<span class="string">&quot;key&quot;</span>);   <span class="comment">//对称密钥 资源服务器也需要指定</span></span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">(JwtAccessTokenConverter converter)</span>&#123;  <span class="comment">//Token存储方式改为JWT存储</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(converter);  <span class="comment">//传入转换器</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>OAuth2Configuration:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">    TokenStore store;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    JwtAccessTokenConverter converter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AuthorizationServerTokenServices <span class="title function_">serverTokenServices</span><span class="params">()</span>&#123; </span><br><span class="line">        <span class="type">DefaultTokenServices</span> <span class="variable">services</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();</span><br><span class="line">        services.setSupportRefreshToken(<span class="literal">true</span>);   <span class="comment">// 允许Token刷新</span></span><br><span class="line">        services.setTokenStore(store);   <span class="comment">// 添加TokenStore</span></span><br><span class="line">        services.setTokenEnhancer(converter);   <span class="comment">// 添加Token增强 添加一些自定义的数据到JWT中</span></span><br><span class="line">        <span class="keyword">return</span> services;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> &#123;</span><br><span class="line">        endpoints</span><br><span class="line">                .tokenServices(serverTokenServices())   <span class="comment">//设定为刚刚配置的AuthorizationServerTokenServices</span></span><br><span class="line">                .userDetailsService(userDetailsService)</span><br><span class="line">                .authenticationManager(authenticationManager);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>重启验证服务器在 Postman 中测试：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ONKmDA"><img src="https://s1.ax1x.com/2022/05/10/ONKmDA.png" alt="ONKmDA.png"></a></p>
<p>可以看到成功获取了 AccessToken，这里的格式跟之前的格式大不相同，它是 JWT 令牌，我们可以对其进行 Base64 解码：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ONK6KJ"><img src="https://s1.ax1x.com/2022/05/10/ONK6KJ.png" alt="ONK6KJ.png"></a></p>
<p>可以看到所有的验证信息包含在内，现在我们对资源服务器进行配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">oauth2:</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">jwt:</span></span><br><span class="line">        <span class="attr">key-value:</span> <span class="string">key</span> <span class="comment"># 跟验证服务器的密钥一致</span></span><br></pre></td></tr></table></figure>

<p>然后启动资源服务器请求一下接口：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ONlf5q"><img src="https://s1.ax1x.com/2022/05/10/ONlf5q.png" alt="ONlf5q.png"></a></p>
<br>

<p>end</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>Buy me a coffee</div>
  <button onclick="document.querySelector('.post-reward').classList.toggle('active');">
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Ssssv11 WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Spring/" rel="tag"># Spring</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/05/02/RabbitMQ/" rel="prev" title="RabbitMQ">
                  <i class="fa fa-chevron-left"></i> RabbitMQ
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/05/12/MySQL%E4%BC%98%E5%8C%96/" rel="next" title="MySQL优化">
                  MySQL优化 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ssssv11</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
